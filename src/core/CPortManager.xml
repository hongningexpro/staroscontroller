<?xml version="1.0" encoding="UTF-8"?>
<starlang xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
	<class name="CPort">
		<private>
			<string name="m_type" />
			<string name="m_speed" />
			<string name="m_enabled" />
			<string name="m_name" />
			<string name="m_flags" />
			<string name="m_advertised" />
			<string name="m_config" />
			<string name="m_curr" />
			<string name="m_currspeed" />
			<string name="m_hwaddr" />
			<string name="m_maxspeed" />
			<string name="m_peer" />
			<string name="m_state" />
			<string name="m_supported" />
			<string name="m_portno" />
			<string name="m_elinks_dest" />
			<!--PortState-->
			<string name="m_rxpackets" />
			<string name="m_txpackets" />
			<string name="m_rxbytes" />
			<string name="m_txbytes" />
			
			<string name="m_rxdropped" />
			<string name="m_txdropped" />
			<string name="m_rxerrors" />
			<string name="m_txerrors"/>
			
			<string name="m_rxframeerr" />
			<string name="m_rxovererr" />
			<string name="m_rxcrcerr" />
			<string name="m_collisions" />
						
			<string name="m_durationsec" />
			<string name="m_durationnsec" />
			
			<!--qiulei 20170907   add variable name="m_transportid" type="string"-->
			<string name="m_transportid"/>
		</private>
		<public>
			<function name="CPort">
				<parameters>
					<string name="advertised"/>
					<string name="portno"/>
					<string name="config"/>
					<string name="curr"/>
					<string name="currspeed"/>
					<string name="hwaddr"/>
					<string name="maxspeed"/>
					<string name="name"/>
					<string name="peer"/>
					<string name="state"/>
					<string name="supported"/>
					<!--qiulei 20170907-->
					<string name="transportid"/>
					
				</parameters>
				<set name="thisclass.m_advertised" value="context.advertised.toString()"/>
				<set name="thisclass.m_portno" value="context.portno.toString()"/>
				<set name="thisclass.m_config" value="context.config.toString()"/>
				<set name="thisclass.m_curr" value="context.curr.toString()"/>
				<set name="thisclass.m_currspeed" value="context.currspeed.toString()"/>
				<set name="thisclass.m_hwaddr" value="context.hwaddr.toString()"/>
				<set name="thisclass.m_name" value="context.name.toString()"/>
				<set name="thisclass.m_peer" value="context.peer.toString()"/>
				<set name="thisclass.m_state" value="context.state.toString()"/>
				<set name="thisclass.m_supported" value="context.supported.toString()"/>
				<set name="thisclass.m_type" value="'Copper'"/>
				<!--qiulei 20170907-->
				<set name="thisclass.m_transportid" value="context.transportid.toString()"/>
				
				<if cond="thisclass.m_state.toString() !='0'">
					<then>
						<function>
							<set name="thisclass.m_enabled" value="'false'"/>
						</function>
					</then>
					<else>
						<function>
							<set name="thisclass.m_enabled" value="'true'"/>
						</function>
					</else>
				</if>
			</function>
			<function name="ForDeviceDetailReqJson">
				<parameters>
					<string name="outjson" />
				</parameters>
				<string name="outdetail"  />
				<script><![CDATA[
					var onearray = new Object();
					if (thisclass.m_portno.toString() == 4294967294){ 						
						onearray.id = "Local";						
					}else{
						onearray.id=thisclass.m_portno.toString();
					}
					onearray.type=thisclass.m_type.toString();
					onearray.speed=thisclass.m_currspeed.toString();
					onearray.enabled=thisclass.m_enabled.toString();
					onearray.name=thisclass.m_name.toString();
					onearray.elinks_dest="";
					var strjson = JSON.stringify(onearray);
					context.outdetail.setValue(strjson);
				]]></script>
				<set name="outjson" value="context.outdetail.toString()"/>
			</function>
			
			<function name="IsReservedPort">
				<parameters>
					<boolean name="returnbool" />
				</parameters>
				<if cond="thisclass.m_portno.toString()=='4294967295' || thisclass.m_portno.toString()=='4294967294' || thisclass.m_portno.toString()=='‭4294967040‬' || thisclass.m_portno.toString()=='4294967288‬'|| thisclass.m_portno.toString()=='4294967289'|| thisclass.m_portno.toString()=='4294967290'|| thisclass.m_portno.toString()=='4294967291'|| thisclass.m_portno.toString()=='4294967292'|| thisclass.m_portno.toString()=='4294967293'">
					<then>
						<set name="returnbool" value="true"/>
					</then>
					<else>
						<set name="returnbool" value="false"/>
					</else>
				</if>
			</function>
			<function name="GetPortState">
				<parameters>
					<string name="outstate"/>
				</parameters>
				<set name="outstate" value="thisclass.m_state.toString()"/>
			</function>
			
			<!--qiulei 20170907 start-->
			<function name="IsEdgePort">
				<parameters>
					<boolean name="returnbool"/>
				</parameters>
				
				<object name="openflowdevice"/>
				<set name="openflowdevice" value="context.openflowserverobj.ptr.getDevice(thisclass.m_transportid.toString())"/>
				<if cond="context.openflowdevice!=null">
					<then>
						<long name="number"/>
						<set name="number" value="context.openflowdevice.getNeigborSize(thisclass.m_portno.toString())"/>
						<if cond="context.number.toLong()==0">
							<then>
								<function>
									<set name="returnbool" value="true"/>
								</function>
							</then>
							<else>
								<function>
									<set name="returnbool" value="false"/>
								</function>
							</else>
						</if>
					</then>
					<else>
						<log>insert CPortManager's IsEdgePort first if's else</log>
						<log>openflowdevice is null</log>
					</else>
				</if>
				
			</function>
			<!--qiulei 20170907 end-->
			
			<function name="IsValidatePort">
				<parameters>
					<boolean name="returnbool" />
				</parameters>				
				<if cond="thisclass.m_portno.toString()=='4294967295' || thisclass.m_portno.toString()=='4294967294' || thisclass.m_portno.toString()=='‭4294967040‬' || thisclass.m_portno.toString()=='4294967288‬'|| thisclass.m_portno.toString()=='4294967289'|| thisclass.m_portno.toString()=='4294967290'|| thisclass.m_portno.toString()=='4294967291'|| thisclass.m_portno.toString()=='4294967292'|| thisclass.m_portno.toString()=='4294967293'">
					<then>
						<function>
							<set name="returnbool" value="false"/>
						</function>
					</then>
					<else>
						<function>
							<if cond="thisclass.m_state.toString()=='0'">
								<then>
									<function>
										<set name="returnbool" value="true"/>
									</function>
								</then>
								<else>
									<function>
										<set name="returnbool" value="false"/>
									</function>
								</else>
							</if>
						</function>
					</else>
				</if>
			</function>

			<function name="UpdatePortState">
				<parameters>
					<string name="portstate" />
				</parameters>
				<if cond="context.portstate.toString()!=''">
					<then>
						<script><![CDATA[
							var info = JSON.parse(context.portstate.toString());
							
							thisclass.m_rxpackets.setValue(info.rxpackets);
							thisclass.m_txpackets.setValue(info.txpackets);
							thisclass.m_rxbytes.setValue(info.rxbytes);
							thisclass.m_txbytes.setValue(info.txbytes);
							thisclass.m_rxdropped.setValue(info.rxdropped);
							thisclass.m_txdropped.setValue(info.txdropped);
							thisclass.m_rxerrors.setValue(info.rxerrors);
							thisclass.m_txerrors.setValue(info.txerrors);
							
							thisclass.m_rxframeerr.setValue(info.rxframeerr);
							thisclass.m_rxovererr.setValue(info.rxovererr);
							thisclass.m_rxcrcerr.setValue(info.rxcrcerr);
							thisclass.m_collisions.setValue(info.collisions);
							thisclass.m_durationsec.setValue(info.durationsec);
							thisclass.m_durationnsec.setValue(info.durationnsec);
					
						]]></script>
					</then>
					<else>
						<exit/>
					</else>
					
				</if>
	
			</function>
			<function name="GetPortsStateJsonData">
				<parameters>	
					<string name="jsonstring" />
				</parameters>
				<script><![CDATA[
						var json = new Object();
						
						json['id']=thisclass.m_portno.toString();
						json['pkt_rx']=thisclass.m_rxpackets.toString();
						json['pkt_tx']=thisclass.m_txpackets.toString();
						json['bytes_rx']=thisclass.m_rxbytes.toString();
						json['bytes_tx']=thisclass.m_txbytes.toString();
						json['pkt_rx_drp']=thisclass.m_rxdropped.toString();
						json['pkt_tx_drp']=thisclass.m_txdropped.toString();
						json['duration']=thisclass.m_durationsec.toString();
						var jsonstring=JSON.stringify(json);
						context.jsonstring.setValue(jsonstring);
					]]></script>
			</function>
		</public>
	</class>
	<class name="CPortManager">
		<private>
			<hashmap name="portContainer" keytype="string" valuetype="object"/>
			<string name="m_transportid"/>
		</private>
		<public>
			<function name="CPortManager">
				<parameters>
					<string name="transportid" />
				</parameters>
				<set name="thisclass.m_transportid" value="context.transportid.toString()"/>
			<function name="MultiPartPortDescRequest"/>
			</function>
			<function name="addPort">
				<parameters>
					<string name="advertised"/>
					<string name="portno"/>
					<string name="config"/>
					<string name="curr"/>
					<string name="currspeed"/>
					<string name="hwaddr"/>
					<string name="maxspeed"/>
					<string name="name"/>
					<string name="peer"/>
					<string name="state"/>
					<string name="supported"/>
				</parameters>
				<object name="portobj"/>
				<new name="portobj" class="CPort">
					<parameters>
						<string name="advertised" in="context.advertised.toString()"/>			
						<string name="portno"  in="context.portno.toString()"/>
						<string name="config"  in="context.config.toString()"/>			
						<string name="curr"  in="context.curr.toString()"/>
						<string name="currspeed"  in="context.currspeed.toString()"/>	
						<string name="hwaddr"  in="context.hwaddr.toString()"/>
						<string name="maxspeed"  in="context.maxspeed.toString()"/>	
						<string name="name"  in="context.name.toString()"/>	
						<string name="peer"  in="context.peer.toString()"/>
						<string name="state"  in="context.state.toString()"/>	
						<string name="supported"  in="context.supported.toString()"/>
						<string name="transportid"  in="thisclass.m_transportid.toString()"/>
						
					</parameters>
				</new>
				<insert name="portContainer" key="context.portno.toString()" value="context.portobj"/>
			</function>
			<function name="ForDeviceDetailReqJson">
				<parameters>
					<string name="outjson"/>
				</parameters>
				<object name="portobj"/>
				<list name="jsonlist" valuetype="string"/>
				<string name="strjson"/>
				<pair name="oneportpair" keytype="string" valuetype="object"/>
				<for var="oneportpair" in="context.portContainer">
					<function>
						<set name="portobj" value="context.oneportpair.second()"/>
						<if cond="context.portobj.ptr == null">
							<then>
								<log>portobj is null </log>
								<exit/>
							</then>
						</if>
						<function name="ForDeviceDetailReqJson" class="context.portobj">
							<parameters>
								<string name="outjson"  out="context.strjson"/>
							</parameters>
							</function>
						<insert name="jsonlist" value="context.strjson.toString()"/>
						</function>
					</for>
				<script><![CDATA[
					var portsArray=new Array();    

					var firststr=context.jsonlist.getFirst();
					while(firststr!=null){
						context.print(firststr);
						var port = firststr;	
						var info = JSON.parse(port);						
						portsArray.push(info);
						firststr=context.jsonlist.getNext();
					}

					var strjson=JSON.stringify(portsArray);
					context.outjson.setValue(strjson);
				]]></script>
			</function>
			
			<function name="ForPortDetailReqJson">
				<parameters>
					<string name="outjson"/>
				</parameters>
				<script><![CDATA[
					
				]]></script>
			</function>
			
			<function name="GetPortNumberSize">
				<parameters>
					<long name="portnumber" />
				</parameters>										
				<set name="portnumber" value="context.portContainer.size()"/>										
			</function>

			<function name="PacketOutToAllPort">
				<parameters>	
					<string name="transportid"/>
					<string name="inportid"/>
					<string name="pkoutjson"/>
					<messageblock name="msgblock"/>
				</parameters>
				<object name="portobj"/>
				<boolean name="isvalidataport"/>
				<boolean name="isedgeport"/>
				<pair name="oneportpair" keytype="string" valuetype="object"/>
				<for var="oneportpair" in="context.portContainer">
					<set name="portobj" value="context.oneportpair.second()"/>
					<if cond="context.portobj.ptr == null">
						<then>
							<log>portobj is null </log>
							<exit/>
						</then>
					</if>
					<function name="IsValidatePort" class="context.portobj">
						<parameters>
							<boolean name="returnbool" out="context.isvalidataport"/>
						</parameters>
					</function>
					<!--qiulei 20170907 add IsEdgePort Function-->
					<function name="IsEdgePort" class="context.portobj">
						<parameters>
							<boolean name="returnbool" out="context.isedgeport"/>
						</parameters>
					</function>
					
					<if cond="(context.isvalidataport.toBoolean()==true) &amp;&amp;(context.isedgeport.toBoolean()==true)">
						<then>
							<function>
								<if cond="context.inportid.toString()!=context.oneportpair.first()">
									<then>
										<function name="SendOpenFlowPacketOut">
											<parameters>
												<string name="outputport"  in="context.oneportpair.first()"/>
												<string name="payloadjson"  in="context.pkoutjson.toString()"/>
												<string name="transportid"  in="context.transportid.toString()"/>
												<messageblock name="msgblock" in="context.msgblock"/>
											</parameters>
										</function>
									</then>						
								</if>
							</function>						
						</then>
					</if>
				</for>
			</function>
			
			<!--qiulei 20170823 pm-->
			<function name="PacketOutToPort">
				<parameters>
					<string name="outputport"/>
					<string name="pkoutjson"/>
					<string name="transportid"/>
					<messageblock name="msgblock"/>
					<string name="inportid"/>
				</parameters>
				<object name="portobj"/>
				<boolean name="isvalidataport"/>
				<if cond="context.portContainer.hasValue(context.outputport.toString())">
					<then>
						<set name="portobj" value="context.portContainer.getValue(context.outputport.toString())"/>
						<if cond="context.portobj.ptr == null">
							<then>
								<log>portobj is null </log>
								<exit/>
							</then>
						</if>
						<function name="IsValidatePort" class="context.portobj">
							<parameters>
								<boolean name="returnbool" out="context.isvalidataport"/>
							</parameters>
						</function>
						<if cond="context.isvalidataport.toBoolean()==true">
							<then>
								<function name="SendOpenFlowPacketOut">
									<parameters>
										<string name="outputport" in="context.outputport.toString()"/>
										<string name="payloadjson" in="context.pkoutjson.toString()"/>
										<string name="transportid" in="context.transportid.toString()"/>
										<messageblock name="msgblock" in="context.msgblock"/>
									</parameters>
								</function>
							</then>
						</if>
					</then>
					<else>
						<log>--------------------2017.08.23 已发送 else--------------------</log>
					</else>
				</if>
			</function>
			
			<function name="UpdatePortState">
				<parameters>
					<string name="portstatestring"/>
				</parameters>
				<if cond="context.portstatestring.toString()!=''">
					<then>
						<string name="portno"/>
						<object name="portobj"/>
						<script><![CDATA[
								var info = JSON.parse(context.portstatestring.toString());
								//var stringportno=JSON.stringify(info.portno);
								context.portno.setValue(info.portno);
							]]></script>
						<function name="dumpinfo"/>
						<if cond="context.portContainer.hasValue(context.portno.toString())==true">
							<then>
								<set name="portobj" value="context.portContainer.getValue(context.portno.toString())"/>
								<if cond="context.portobj.ptr == null">
									<then>
										<log>portobj is null </log>
										<exit/>
									</then>
								</if>
								<function name="UpdatePortState" class="context.portobj">
									<parameters>
										<string name="portstate"  in="context.portstatestring.toString()"/>
									</parameters>
								</function>
							</then>
							<else>
								<log> don't have the port</log>
							</else>
						</if>
					</then>
					<else>
						<exit/>
					</else>
				</if>
				
				</function>
				
			<function name="dumpinfo">
				<string name="ports"/>
				<pair name="onehostpair" keytype="string" valuetype="object"/>
				<for var="onehostpair" in="context.portContainer">
					<set name="ports" value="context.onehostpair.first()"/>
				</for>
			</function>
			<function name="GetPortsStateJsonData">
				<parameters>	
					<string name="jsonstring"/>
				</parameters>
				<object name="ports"/>
				<list name="infolist" valuetype="string"/>
				<string name="stringports"/>
				<pair name="onehostpair" keytype="string" valuetype="object"/>
				<for var="onehostpair" in="context.portContainer">
					<set name="ports" value="context.onehostpair.second()"/>
					<if cond="context.ports == null">
						<then>
							<log>ports is null </log>
							<exit/>
						</then>
					</if>
					<function name="GetPortsStateJsonData" class="ports">
						<parameters>	
							<string name="jsonstring"  out="context.stringports"/>
						</parameters>
					</function>
					<insert name="infolist" value="context.stringports.toString()"/>
				</for>
				<script><![CDATA[
					var info = new Object();
					info["event"]="portDataResponse";
					var arrayport =new Array();
					var ports = new Object();
					var firstr=context.infolist.getFirst();
					while(firstr!=null){
						var oneportstate = firstr;
						var jsoninfo = JSON.parse(oneportstate);
						arrayport.push(jsoninfo);
						firstr=context.infolist.getNext()
					}
					ports["ports"]=arrayport;
					info["payload"]=ports;
					var msg = new Object();
					msg["no_rows_msg"]="No ports found";
					info["annots"]=msg;
					var inforstring=JSON.stringify(info);
					context.jsonstring.setValue(inforstring);
				]]></script>
			</function>
				
			<function name="MultiPartPortDescRequest">
				<string name="strjson"/>
				<long name="xid" />
				<string name="replyjson"/>
				<hashmap name="portinfo" keytype="string" valuetype="string"/>
				<hashmap name="deviceportinfo" keytype="string" valuetype="hashmap"/>
				<pair name="onedeviceportinfopair" keytype="string" valuetype="hashmap"/>
				<set name="xid" value="context.openflowserverobj.ptr.getIncreaseXID()"/>
				<function>
					<reference variable="strjson">
						<jsonbody><![CDATA[ 
								{
									"xid":"<%=context.xid.toString()%>",
									"flags":"0"
								}
						]]></jsonbody>
					</reference>
					<function name="Send_OFPT13_MULTIPART_REQUEST.OFP13MP_PORT_DESC">
						<parameters>
							<string name="transportid"  in="thisclass.m_transportid.toString()"/>
							<string name="strjson"  in="context.strjson.toString()"/>
						</parameters>
					</function>
					<log><![CDATA[for test out wait=<%=context.m_transportid.toString()%>]]></log>
					<wait event="openflow.OFPT13_MULTIPART_REPLY.OFP13MP_PORT_DESC,openflow.OFPT13_ERROR" transportid="thisclass.m_transportid.toString()"  xid="context.xid.toLong()" timeout="5000">
						<function>
							<log><![CDATA[for test in wait=<%=context.m_transportid.toString()%>]]></log>
							<set name="replyjson" value="event.getParam('eventdata').toString()"/>
							<script><![CDATA[							
								var info = JSON.parse(context.replyjson.toString());
								if (info.portlist!=null)
								{
									context.print(info.portlist.length);
									for(var i=0;i<info.portlist.length;i++)
									{
										//yijian add for null var
										var ofport = context.createHashMap("string","string");
										if (ofport != null)
										{
											ofport.addValue('advertised', info.portlist[i].advertised);
											ofport.addValue('portno', info.portlist[i].portno);
											ofport.addValue('config', info.portlist[i].config);
											ofport.addValue('curr', info.portlist[i].curr);
											ofport.addValue('currspeed', info.portlist[i].currspeed);
											ofport.addValue('hwaddr', info.portlist[i].hwaddr);
											ofport.addValue('maxspeed', info.portlist[i].maxspeed);
											ofport.addValue('name', info.portlist[i].name);
											ofport.addValue('peer', info.portlist[i].peer);
											ofport.addValue('state', info.portlist[i].state);
											ofport.addValue('supported', info.portlist[i].supported);
											context.deviceportinfo.addValue(info.portlist[i].portno, ofport);
											context.destroyHashMap(ofport);
										}
									}
								}
							]]></script>
							<log><![CDATA[deviceportinfo size=<%=context.deviceportinfo.size().toString()%>]]></log>
							<for var="onedeviceportinfopair" in="context.deviceportinfo">
								<function>
									<set name="portinfo" value="context.onedeviceportinfopair.second()"/>
									<log><![CDATA[portinfo size=<%=context.portinfo.size().toString()%>]]></log>
									<function name="addPort">
										<parameters>
											<string name="advertised"  in="context.portinfo.getValue('advertised').toString()"/>			
											<string name="portno"  in="context.portinfo.getValue('portno').toString()"/>
											<string name="config"  in="context.portinfo.getValue('config').toString()"/>			
											<string name="curr"  in="context.portinfo.getValue('curr').toString()"/>
											<string name="currspeed"  in="context.portinfo.getValue('currspeed').toString()"/>	
											<string name="hwaddr"  in="context.portinfo.getValue('hwaddr').toString()"/>
											<string name="maxspeed"  in="context.portinfo.getValue('maxspeed').toString()"/>	
											<string name="name"  in="context.portinfo.getValue('name').toString()"/>	
											<string name="peer"  in="context.portinfo.getValue('peer').toString()"/>
											<string name="state"  in="context.portinfo.getValue('state').toString()"/>	
											<string name="supported"  in="context.portinfo.getValue('supported').toString()"/>
										</parameters>
									</function>
								</function>
							</for>
						</function>
					</wait>
				</function>
			</function>	
			<!-- hu 20170904 SendPortStateRequest 
			1)get portstatslist and portstatestring
			2)send port portstatestring
			-->
			<function name="HandlePortStateResponse">
				<parameters>
					<string name="portstatejson" />
				</parameters>
				<if cond="context.portstatejson.toString()!=''">
					<then>
						<list name="portstatelist" valuetype="string"/>
					
						<string name="portstatestring" />
						<string name="i" />
						<script><![CDATA[
								var info = JSON.parse(context.portstatejson.toString());
										if (info.portstatslist != null)
										{
											for(var i=0;i<info.portstatslist.length;i++)
											{
												var portstats = info.portstatslist[i];
												var portstrjson=JSON.stringify(portstats);
												context.portstatelist.addValue(portstrjson);
											}
										}
									]]></script>
						<for var="i" in="context.portstatelist">
							
							<function name="UpdatePortState">
								<parameters>
									<string name="portstatestring"  in="context.i.toString()"/>
								</parameters>
							</function>
						</for>
					</then>
					<else>
						<exit/>
					</else>
				</if>
			
			</function>
		<function name="SendPortStateRequest">
				<long name="xid" />
				<set name="xid" value="context.openflowserverobj.ptr.getIncreaseXID()"/>
				<function name="OpenFlowMultiPartPortStatsRequest">
					<parameters>
						<string name="portno"  in="'0xffffffff'"/>
						<string name="transportid" in="thisclass.m_transportid"/>
						<long name="xid"  in="context.xid.toLong()"/>
					</parameters>
				</function>
			</function>
		</public>
	</class>
</starlang>