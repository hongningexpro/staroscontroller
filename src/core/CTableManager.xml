<?xml version="1.0" encoding="UTF-8"?>
<starlang xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
	<class name="CTable">
		<private>
			<string name="m_tableid"/>
			<string name="m_activecount"/>
			<string name="m_lookupcount"/>
			<string name="m_matchcount"/>
		</private>
		<public>
			<function name="CTable">
				<parameters>
					<string name="tableid"/>
					<string name="activecount"/>
					<string name="lookupcount"/>
					<string name="matchcount"/>
				</parameters>
				<set name="thisclass.m_tableid" value="context.tableid.toString()"/>
				<set name="thisclass.m_activecount" value="context.activecount.toString()"/>
				<set name="thisclass.m_lookupcount" value="context.lookupcount.toString()"/>
				<set name="thisclass.m_matchcount" value="context.matchcount.toString()"/>
			</function>
			<function name="UpdateTableInfo">
				<parameters>
					<string name="tableid"/>
					<string name="activecount"/>
					<string name="lookupcount"/>
					<string name="matchcount"/>
				</parameters>
				<set name="thisclass.m_tableid" value="context.tableid.toString()"/>
				<set name="thisclass.m_activecount" value="context.activecount.toString()"/>
				<set name="thisclass.m_lookupcount" value="context.lookupcount.toString()"/>
				<set name="thisclass.m_matchcount" value="context.matchcount.toString()"/>
			</function>
		</public>
	</class>
	<class name="CTableManager">
		<private>
			<hashmap name="tableContainer" keytype="string" valuetype="object"/>
			<string name="m_transportid"/>
			<string name="m_tablejson"/>
		</private>
		<public>

			<function name="CTableManager">
				<parameters>
					<string name="transportid"/>
				</parameters>	
				<log>CTableManager is create</log>
				<set name="thisclass.m_transportid" value="context.transportid.toString()"/>
			</function>
			<function name="UpdateTableState">
				<parameters>
					<string name="tablestatestring"/>
				</parameters>
				
				<string name="tableid"/>
				<string name="activecount"/>
				<string name="lookupcount"/>
				<string name="matchcount"/>
				<object name="table"/>
				<script><![CDATA[
						var info = JSON.parse(context.tablestatestring.toString());
						
						context.tableid.setValue(info.tableid);
						context.activecount.setValue(info.activecount);

						context.lookupcount.setValue(info.lookupcount);
						context.matchcount.setValue(info.matchedcount);
					]]></script>
				<if cond="thisclass.tableContainer.hasValue(context.tableid.toString())==false">
					<then>
						<new name="table" class="CTable">
							<parameters>
								<string name="tableid" in="context.tableid.toString()"/>
								<string name="activecount" in="context.activecount.toString()"/>
								<string name="lookupcount" in="context.lookupcount.toString()"/>
								<string name="matchcount" in="context.matchcount.toString()" />
							</parameters>
						</new>
						<insert name="tableContainer" key="context.tableid.toString()" value="context.table"/>
					</then>
					<else>
						<set name="table" value="thisclass.tableContainer.getValue(context.tableid.toString())"/>
						<if cond="context.table == null">
							<then>
								<log>table is null </log>
								<exit/>
							</then>
						</if>
						<function name="UpdateTableInfo" class="context.table">
							<parameters>
								<string name="tableid" in="context.tableid.toString()"/>
								<string name="activecount" in="context.activecount.toString()"/>
								<string name="lookupcount" in="context.lookupcount.toString()"/>
								<string name="matchcount" in="context.matchcount.toString()" />
							</parameters>
						</function>
					</else>
				</if>
			</function>
				
			<function name="dumpinfo">
				<string name="tables"/>
				<pair name="onetableContainer" keytype="string" valuetype="object"/>
					<for var="onetableContainer" in="context.tableContainer">
						<set name="tables" value="context.onetableContainer.first()"/>
						<log><![CDATA[dumpinfo: tableid=<%=context.tables.toString()%>]]></log>
					</for>
			</function>
			
			<function name="SendTableRequest">
				<long name="xid"/>							
				<set name="xid" value="context.openflowserverobj.ptr.getIncreaseXID()"/>
				<list name="tablestatslist" valuetype="string"/>
				<string name="tablestatestring"/>
				<function name="OpenFlowMultiPartTableRequest">
					<parameters>
						<long name="xid" in="context.xid.toLong()"/>
						<string name="transportid" in="thisclass.m_transportid.toString()"/>
					</parameters>
				</function>
			</function>
			<function name="SetTableJson">
				<parameters>
					<string name="tablejson"/>
				</parameters>
				<set name="thisclass.m_tablejson" value="context.tablejson.toString()"/>
				</function>
			<!-- 
				YY 20170831
				return TableManager's data
				1) put TableManager's variable m_tablejson package in JSON
				2) Put JSON in parameter : data
				parameter:
							json :
									type :	string
									style :	out
			-->
			<function name="GetTableData">
				<parameters>
					<string name="data"/>
				</parameters>				
				<string name="outjsonstring"/>
				<script><![CDATA[
					var payload = new Object();
					var tablelist = JSON.parse(thisclass.m_tablejson.toString());
					
					var json = new Object();
					json.event = "tableDataResponse";
					var twoobject = new Object();
					twoobject.no_rows_msg = "No tables found";
					payload.tables = tablelist.tablestatslist;
					payload.annots = twoobject;
					json.payload = payload;
					var strjson=JSON.stringify(json);												
					context.outjsonstring.setValue(strjson);								
				]]></script>				
				<set name="data" value="context.outjsonstring.toString()"/>
			</function>
		</public>
	</class>
</starlang>