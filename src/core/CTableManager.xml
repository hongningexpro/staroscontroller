<?xml version="1.0" encoding="UTF-8"?>
<starosxml xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
	<class name="CTable">
		<private>
			<variable name="m_tableid" type="string" />
			<variable name="m_activecount" type="string" />
			<variable name="m_lookupcount" type="string" />
			<variable name="m_matchcount" type="string" />
		</private>
		<public>
			<function name="CTable">
				<parameters>
					<parameter name="tableid" type="string"/>
					<parameter name="activecount" type="string"/>
					<parameter name="lookupcount" type="string"/>
					<parameter name="matchcount" type="string"/>
				</parameters>
				<set name="thisclass.m_tableid" value="context.tableid.toString()"/>
				<set name="thisclass.m_activecount" value="context.activecount.toString()"/>
				<set name="thisclass.m_lookupcount" value="context.lookupcount.toString()"/>
				<set name="thisclass.m_matchcount" value="context.matchcount.toString()"/>
			</function>
			<function name="UpdateTableInfo">
				<parameters>
					<parameter name="tableid" type="string"/>
					<parameter name="activecount" type="string"/>
					<parameter name="lookupcount" type="string"/>
					<parameter name="matchcount" type="string"/>
				</parameters>
				<set name="thisclass.m_tableid" value="context.tableid.toString()"/>
				<set name="thisclass.m_activecount" value="context.activecount.toString()"/>
				<set name="thisclass.m_lookupcount" value="context.lookupcount.toString()"/>
				<set name="thisclass.m_matchcount" value="context.matchcount.toString()"/>
			</function>
		</public>
	</class>
	<class name="CTableManager">
		<private>
			<container name="tableContainer" type="hashmap" keytype="string" valuetype="class"/>
			<variable name="m_transportid" type="string"/>
			<variable name="m_tablejson" type="string"/>
		</private>
		<public>

			<function name="CTableManager">
				<parameters>
					<parameter name="transportid" type="string"/>
				</parameters>	
				<log>CTableManager is create</log>
				<set name="thisclass.m_transportid" value="context.transportid.toString()"/>
			</function>
			<function name="UpdateTableState">
				<parameters>
					<parameter name="tablestatestring" type="string"/>
				</parameters>
				
				<variable name="tableid" type="string"/>
				<variable name="activecount" type="string"/>
				<variable name="lookupcount" type="string"/>
				<variable name="matchcount" type="string"/>
				<variable name="table" type="class"/>
				<script><![CDATA[
						var info = JSON.parse(context.tablestatestring.toString());
						
						context.tableid.setValue(info.tableid);
						context.activecount.setValue(info.activecount);

						context.lookupcount.setValue(info.lookupcount);
						context.matchcount.setValue(info.matchedcount);
					]]></script>
				<if cond="thisclass.tableContainer.hasValue(context.tableid.toString())==false">
					<then>
						<new name="table" class="CTable">
							<parameters>
								<parameter name="tableid" type="string" in="context.tableid.toString()"/>
								<parameter name="activecount" type="string" in="context.activecount.toString()"/>
								<parameter name="lookupcount" type="string" in="context.lookupcount.toString()"/>
								<parameter name="matchcount" type="string" in="context.matchcount.toString()" />
							</parameters>
						</new>
						<insert name="tableContainer" key="context.tableid.toString()" value="context.table"/>
					</then>
					<else>
						<set name="table" value="thisclass.tableContainer.getValue(context.tableid.toString())"/>
						<function name="UpdateTableInfo" class="context.table">
							<parameters>
								<parameter name="tableid" type="string" in="context.tableid.toString()"/>
								<parameter name="activecount" type="string" in="context.activecount.toString()"/>
								<parameter name="lookupcount" type="string" in="context.lookupcount.toString()"/>
								<parameter name="matchcount" type="string" in="context.matchcount.toString()" />
							</parameters>
						</function>
					</else>
				</if>
			</function>
				
			<function name="dumpinfo">
				<variable name="tables" type="string"/>
				<container name="onetableContainer" type="pair" keytype="string" valuetype="class"/>
					<for var="onetableContainer" in="context.tableContainer">
						<set name="tables" value="context.onetableContainer.first()"/>
						<log><![CDATA[dumpinfo: tableid=<%=context.tables.toString()%>]]></log>
					</for>
			</function>
			
			<function name="SendTableRequest">
				<variable name="xid" type="long"/>
				<!--<log>SendTableRequest !!!!!!!!!!!!!hu</log>-->
				
				<set name="xid" value="context.openflowserverobj.getIncreaseXID()"/>
				<container name="tablestatslist" type="list"  valuetype="string"/>
				<variable name="tablestatestring" type="string"/>
				<function name="OpenFlowMultiPartTableRequest">
					<parameters>
						<parameter name="xid" type="long" in="context.xid.toLong()"/>
						<parameter name="transportid" type="string" in="thisclass.m_transportid.toString()"/>
					</parameters>
				</function>
				<!--wait event="openflow.OFPT13_MULTIPART_REPLY.OFP13MP_TABLE,openflow.OFPT13_ERROR" transportid="context.m_transportid.toString()" xid="context.xid.toLong()">
					<set name="thisclass.m_tablejson" value="event.getParam('eventdata').toString()"/>
				</wait-->
			</function>
			<function name="SetTableJson">
				<parameters>
					<parameter name="tablejson" type="string"/>
				</parameters>
				<set name="thisclass.m_tablejson" value="context.tablejson.toString()"/>
			</function>
			<!-- 
				YY 20170831
				return TableManager's data
				1) put TableManager's variable m_tablejson package in JSON
				2) Put JSON in parameter : data
				parameter:
							json :
									type :	string
									style :	out
			-->
			<function name="GetTableData">
				<parameters>
					<parameter name="data" type="string"/>
				</parameters>				
				<variable name="outjsonstring" type="string"/>
				<script><![CDATA[
					var payload = new Object();
					var tablelist = JSON.parse(thisclass.m_tablejson.toString());
					
					var json = new Object();
					json.event = "tableDataResponse";
					var twoobject = new Object();
					twoobject.no_rows_msg = "No tables found";
					payload.tables = tablelist.tablestatslist;
					payload.annots = twoobject;
					json.payload = payload;
					var strjson=JSON.stringify(json);												
					context.outjsonstring.setValue(strjson);								
				]]></script>				
				<set name="data" value="context.outjsonstring.toString()"/>
			</function>
		</public>
	</class>
</starosxml>