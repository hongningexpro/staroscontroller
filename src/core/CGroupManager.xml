<?xml version="1.0" encoding="UTF-8"?>
<starosxml xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
	<variable name="testresourceid" type="string"/>
	<class name="CGroupManager">
		<private>
			<container name="groupContainer" type="hashmap" keytype="string" valuetype="string"/>
		</private>
		<public>
			<function name="InstallGroupRequest">
				<parameters>
					<parameter name="in_datapathid" type="string"/>
					<parameter name="in_strjson" type="string"/>
					<parameter name="in_resourceid" type="string"/>
				</parameters>
				<container name="switchgroup" type="hashmap" keytype="string" valuetype="string"/>
				<variable name="sresourceid" type="string"/>
				<variable name="transportid" type="string"/>
				<set name="sresourceid" value="context.allocResourceId()"/>
				<!--qiulei modify 20170807-->
				<insert name="groupContainer" key="context.sresourceid.toString()" value="context.in_strjson.toString()"/>
				<function name="GetTransportIdFromDevice" class="DeviceManager">
					<parameters>
						<parameter name="datapathid" type="string" in="context.in_datapathid"/>
						<parameter name="transportid" type="string" out="context.transportid"/>
					</parameters>
				</function>
				<function name="Send_OFPT13_GROUP_MOD">
					<parameters>
						<parameter name="transportid" type="string" in="context.transportid"/>
						<parameter name="strjson" type="string" in="context.in_strjson.toString()"/>
					</parameters>
				</function>
				<set name="in_resourceid" value="context.sresourceid.toString()"/>
			</function>
			<function name="UnInstallGroupRequest">
				<parameters>
					<parameter name="datapathid" type="string"/>
					<parameter name="resourceid" type="string"/>
				</parameters>
				<variable name="transportid" type="string"/>
				<variable name="jsongroup" type="string"/>
				<variable name="sendflowmodjson" type="string"/>
				<if cond="context.groupContainer.hasValue(context.resourceid.toString()) ==true">
					<then>
						<function>
							<lookup name="groupContainer" key="context.resourceid.toString()" output="context.jsongroup"/>
						</function>
					</then>
					<else>
						<function>
							<log>UnInstallGroupRequest exit</log>
							<exit/>
						</function>
					</else>
				</if>
				<log><![CDATA[jsongroup=<%=context.jsongroup.toString()%>]]></log>
				<script><![CDATA[
						var info = JSON.parse(context.jsongroup.toString());
						info.command='2';
						var strjson=JSON.stringify(info);
						context.sendflowmodjson.setValue(strjson);
				]]></script>
				<function name="GetTransportIdFromDevice" class="DeviceManager">
					<parameters>
						<parameter name="datapathid" type="string" in="context.datapathid"/>
						<parameter name="transportid" type="string" out="context.transportid"/>
					</parameters>
				</function>
				<function name="Send_OFPT13_GROUP_MOD">
					<parameters>
						<parameter name="transportid" type="string" in="context.transportid"/>
						<parameter name="strjson" type="string" in="context.sendflowmodjson.toString()"/>
					</parameters>
				</function>
				<remove name="groupContainer" key="context.resourceid.toString()"/>
			</function>
			<!--
				OFPGT_ALL = 0, /* All (multicast/broadcast) group. */
				OFPGT_SELECT = 1, /* Select group. */
				OFPGT_INDIRECT = 2, /* Indirect group. */
				OFPGT_FF = 3, /* Fast failover group. */
			-->
			<function name="testaddgroup">			
				<parameters>
						<parameter name="datapathid" type="string"/>
				</parameters>
				<variable name="modstrjson" type="string"/>
				<variable name="returnresourceid" type="string"/>
				<reference variable="modstrjson">
					<jsonbody><![CDATA[ 
						{
							"xid":"<%=context.openflowserverobj.getIncreaseXID()%>",
							"command":"0",
							"grouptype":"1",
							"groupid":"1",
							"bucketlist":[
								{
									"weight":"1",
									"watchport":"1000",
									"watchgroup":"1000",
									"actions":[
										{
											"type":"0",
											"outport":"0xfffffffd",
											"maxlen":"0xffff"
										}
									]
								}
							]
						}	
					]]></jsonbody>
				</reference>
				<function name="InstallGroupRequest">
					<parameters>
						<parameter name="in_datapathid" type="string" in="context.datapathid.toString()"/>
						<parameter name="in_strjson" type="string" in="context.modstrjson.toString()"/>
						<parameter name="in_resourceid" type="string" out="context.returnresourceid"/>
					</parameters>
				</function>
				<log><![CDATA[testaddgroup returnresourceid=<%=context.returnresourceid.toString()%>]]></log>
				<set name="testresourceid" value="context.returnresourceid.toString()"/>
			</function>
			<function name="testremovegroup">			
				<parameters>
					<parameter name="datapathid" type="string"/>
				</parameters>
				<function name="UnInstallGroupRequest">
					<parameters>
						<parameter name="datapathid" type="string" in="context.datapathid.toString()"/>
						<parameter name="resourceid" type="string" in="context.testresourceid.toString()"/>
					</parameters>
				</function>
				<log><![CDATA[testremovegroup testresourceid=<%=context.testresourceid.toString()%>]]></log>
				
			</function>
		</public>
	</class>
</starosxml>