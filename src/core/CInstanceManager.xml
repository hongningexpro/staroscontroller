<?xml version="1.0" encoding="UTF-8"?>
<starlang xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
	<class name="CInstance">
		<private>
			<string name="m_id" />
			<string name="m_ip" />
			<boolean name="m_online" />
			<boolean name="m_ready"/>
			<boolean name="m_uiAttached"/>
			<string name="m_labels"/>
		</private>
		<public>
			<function name="CInstance">
				<parameters>
					<string name="id"/>			
					<string name="ip" />
				</parameters>
				<set name="thisclass.m_id" value="context.id.toString()"/>
				<set name="thisclass.m_ip" value="context.ip.toString()"/>
				<set name="thisclass.m_online" value="true"/>
				<set name="thisclass.m_ready" value="true"/>
				<set name="thisclass.m_uiAttached" value="true"/>
				<set name="thisclass.m_labels" value="context.id.toString()"/>
			</function>
			<function name="ToJson">
				<parameters>
					<string name="jsonstring" />			
				</parameters>
				<string name="values"  />
				<reference variable="values">
					<jsonbody>
					<![CDATA[
						{
							"event":"addInstance",
							"payload":
								{
									"id":"<%=thisclass.m_id.toString()%>",
									"ip":"<%=thisclass.m_ip.toString()%>",
									"online":<%=thisclass.m_online.toString()%>,
									"ready":<%=thisclass.m_ready.toString()%>,
									"uiAttached":<%=thisclass.m_uiAttached.toString()%>,
									"switches":1,
									"labels":[
										"<%=thisclass.m_uiAttached.toString()%>",
										"<%=thisclass.m_uiAttached.toString()%>"
									]
								}
						}
					]]>
					</jsonbody>
				</reference>
				<set name="jsonstring" value="context.values.toString()"/>
			</function>
		</public>
	</class>
	<class name="CInstanceManager">
		<private>
			<hashmap name="m_instanceContainer"  keytype="string" valuetype="object"/>
		</private>
		<public>
			<function name="CInstanceManager">
				<function name="addInstance">
					<parameters>
						<string name="id"  in="'127.0.0.1'"/>			
						<string name="ip"  in="'127.0.0.1'"/>
					</parameters>
				</function>
			</function>
			<function name="addInstance">
				<parameters>
					<string name="id" />			
					<string name="ip" />
				</parameters>
				<object name="instance"/>
				<new name="instance" class="CInstance">
					<parameters>
						<string name="id"  in="context.id.toString()"/>			
						<string name="ip"  in="context.ip.toString()"/>
					</parameters>
				</new>
				<insert name="m_instanceContainer" key="context.id.toString()" value="context.instance"/>
			</function>
			<function name="AddInstanceRequest">
				<parameters>
					<string name="transportid" />						
				</parameters>
				<object name="instance" />
				<string name="instancejson" />
				<pair name="oneinstancepair"  keytype="string" valuetype="object"/>
				<for var="oneinstancepair" in="context.m_instanceContainer">
					<function>			
						<set name="instance" value="context.oneinstancepair.second()"/>
						<if cond="context.instance.ptr == null">
							<then>
								<log>instance is null </log>
								<exit/>
							</then>
						</if>
						<function name="ToJson" class="instance">
							<parameters>
								<string name="jsonstring"  out="instancejson"/>			
							</parameters>
						</function>
					</function>
				</for>
				<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
					<jsonsrc src="instancejson"/>
				</websocket>
			</function>
		</public>
	</class>
</starlang>