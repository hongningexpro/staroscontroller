<?xml version="1.0" encoding="UTF-8"?>
<starosxml xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
	<class name="CInstance">
		<private>
			<variable name="m_id" type="string"/>
			<variable name="m_ip" type="string"/>
			<variable name="m_online" type="boolean"/>
			<variable name="m_ready" type="boolean"/>
			<variable name="m_uiAttached" type="boolean"/>
			<variable name="m_labels" type="string"/>
		</private>
		<public>
			<function name="CInstance">
				<parameters>
					<parameter name="id" type="string"/>			
					<parameter name="ip" type="string"/>
				</parameters>
				<set name="thisclass.m_id" value="context.id.toString()"/>
				<set name="thisclass.m_ip" value="context.ip.toString()"/>
				<set name="thisclass.m_online" value="true"/>
				<set name="thisclass.m_ready" value="true"/>
				<set name="thisclass.m_uiAttached" value="true"/>
				<set name="thisclass.m_labels" value="context.id.toString()"/>
			</function>
			<function name="ToJson">
				<parameters>
					<parameter name="jsonstring" type="string"/>			
				</parameters>
				<variable name="values" type="string" />
				<reference variable="values">
					<jsonbody>
					<![CDATA[
						{
							"event":"addInstance",
							"payload":
								{
									"id":"<%=thisclass.m_id.toString()%>",
									"ip":"<%=thisclass.m_ip.toString()%>",
									"online":<%=thisclass.m_online.toString()%>,
									"ready":<%=thisclass.m_ready.toString()%>,
									"uiAttached":<%=thisclass.m_uiAttached.toString()%>,
									"switches":1,
									"labels":[
										"<%=thisclass.m_uiAttached.toString()%>",
										"<%=thisclass.m_uiAttached.toString()%>"
									]
								}
						}
					]]>
					</jsonbody>
				</reference>
				<set name="jsonstring" value="context.values.toString()"/>
			</function>
		</public>
	</class>
	<class name="CInstanceManager">
		<private>
			<container name="m_instanceContainer" type="hashmap" keytype="string" valuetype="class"/>
		</private>
		<public>
			<function name="CInstanceManager">
				<function name="addInstance">
					<parameters>
						<parameter name="id" type="string" in="'127.0.0.1'"/>			
						<parameter name="ip" type="string" in="'127.0.0.1'"/>
					</parameters>
				</function>
			</function>
			<function name="addInstance">
				<parameters>
					<parameter name="id" type="string"/>			
					<parameter name="ip" type="string"/>
				</parameters>
				<variable name="instance" type="class"/>
				<new name="instance" class="CInstance">
					<parameters>
						<parameter name="id" type="string" in="context.id.toString()"/>			
						<parameter name="ip" type="string" in="context.ip.toString()"/>
					</parameters>
				</new>
				<insert name="m_instanceContainer" key="context.id.toString()" value="context.instance"/>
			</function>
			<function name="AddInstanceRequest">
				<parameters>
					<parameter name="transportid" type="string"/>						
				</parameters>
				<variable name="instance" type="class"/>
				<variable name="instancejson" type="string"/>
				<container name="oneinstancepair" type="pair" keytype="string" valuetype="class"/>
				<for var="oneinstancepair" in="context.m_instanceContainer">
					<function>			
						<set name="instance" value="context.oneinstancepair.second()"/>
						<function name="ToJson" class="instance">
							<parameters>
								<parameter name="jsonstring" type="string" out="instancejson"/>			
							</parameters>
						</function>
					</function>
				</for>
				<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
					<jsonsrc src="instancejson"/>
				</websocket>
			</function>
		</public>
	</class>
</starosxml>