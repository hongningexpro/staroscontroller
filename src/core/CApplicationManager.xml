<?xml version="1.0" encoding="UTF-8"?>
<starosxml xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
	<class name="CApplication">
		<private>
			<variable name="pathname" type="string" />
			<variable name="id" type="string" />
			<variable name="bundleid" type="long" />
			<variable name="state" type="string" />
			<variable name="_iconid_state" type="string" />
			<variable name="icon" type="string" />
			<variable name="version" type="string" />
			<variable name="category" type="string" />
			<variable name="origin" type="string" />
			<variable name="title" type="string" />
			<variable name="desc" type="string" />
			<variable name="url" type="string" />
			<variable name="readme" type="string" />
			<variable name="role" type="string" />
			<container name="required_apps" type="list"  valuetype="string"/>
			<container name="features" type="list" valuetype="string"/>
			<container name="permissions" type="list" valuetype="string"/>
		</private>
		<public>
			<function name="CApplication">
				<parameters>
					<parameter name="appid" type="string"/>
					<parameter name="appversion" type="string"/>
					<parameter name="appcategory" type="string"/>
					<parameter name="apporigin" type="string"/>
					<parameter name="apptitle" type="string"/>
					<parameter name="appdesc" type="string"/>		
					<parameter name="appurl" type="string"/>
					<parameter name="appbundleid" type="long"/>
				</parameters>
				<set name="thisclass.id" value="context.appid.toString()"/>
				<set name="thisclass.version" value="context.appversion.toString()"/>
				<set name="thisclass.category" value="context.appcategory.toString()"/>
				<set name="thisclass.origin" value="context.apporigin.toString()"/>
				<set name="thisclass.title" value="context.apptitle.toString()"/>
				<set name="thisclass.desc" value="context.appdesc.toString()"/>
				<set name="thisclass.url" value="context.appurl.toString()"/>
				<set name="thisclass.bundleid" value="context.appbundleid.toString()"/>
				<set name="thisclass.state" value="'ACTIVE'"/>
				<set name="thisclass._iconid_state" value="'active'"/>
				<log><![CDATA[app_id=<%=context.appid.toString()%>]]></log>
				<log><![CDATA[app_version=<%=context.appversion.toString()%>]]></log>
				<log><![CDATA[app_category=<%=context.appcategory.toString()%>]]></log>
				<log><![CDATA[app_origin=<%=context.apporigin.toString()%>]]></log>
				<log><![CDATA[app_title=<%=context.apptitle.toString()%>]]></log>
				<log><![CDATA[app_desc=<%=context.appdesc.toString()%>]]></log>
				<log><![CDATA[app_url=<%=context.appurl.toString()%>]]></log>
				<log><![CDATA[app_bundleid=<%=context.appbundleid.toLong()%>]]></log>
			</function>
			<function name="GetApplicationId">
				<parameters>
					<parameter name="outappid" type="string"/>
				</parameters>
				<log><![CDATA[GetApplicationId id=<%=thisclass.id.toString()%>]]></log>
				<set name="outappid" value="thisclass.id.toString()"/>
			</function>
			<function name="SetApplicationInfo">
				<parameters>
					<parameter name="appid" type="string"/>
					<parameter name="appversion" type="string"/>
					<parameter name="appcategory" type="string"/>
					<parameter name="apporigin" type="string"/>
					<parameter name="apptitle" type="string"/>
					<parameter name="appdesc" type="string"/>		
					<parameter name="appurl" type="string"/>
					<parameter name="appbundleid" type="long"/>
					<parameter name="apppath" type="string"/>
				</parameters>
				<set name="thisclass.id" value="context.appid.toString()"/>
				<set name="thisclass.version" value="context.appversion.toString()"/>
				<set name="thisclass.category" value="context.appcategory.toString()"/>
				<set name="thisclass.origin" value="context.apporigin.toString()"/>
				<set name="thisclass.title" value="context.apptitle.toString()"/>
				<set name="thisclass.desc" value="context.appdesc.toString()"/>
				<set name="thisclass.url" value="context.appurl.toString()"/>
				<set name="thisclass.bundleid" value="context.appbundleid.toString()"/>
				<set name="thisclass.pathname" value="context.apppath.toString()"/>
				<log><![CDATA[app_id=<%=context.appid.toString()%>]]></log>
				<log><![CDATA[app_version=<%=context.appversion.toString()%>]]></log>
				<log><![CDATA[app_category=<%=context.appcategory.toString()%>]]></log>
				<log><![CDATA[app_origin=<%=context.apporigin.toString()%>]]></log>
				<log><![CDATA[app_title=<%=context.apptitle.toString()%>]]></log>
				<log><![CDATA[app_desc=<%=context.appdesc.toString()%>]]></log>
				<log><![CDATA[app_url=<%=context.appurl.toString()%>]]></log>
				<log><![CDATA[app_bundleid=<%=context.appbundleid.toLong()%>]]></log>
				<log><![CDATA[pathname=<%=context.apppath.toString()%>]]></log>
			</function>
			<function name="ActiveApplication">
				<parameters>
					<parameter name="app_path" type="string"/>
				</parameters>
				<set name="bundleid" value="context.newBundleId()"/>
				<log><![CDATA[ActiveApplication=<%=context.app_path.toString()%>]]></log>
				<createbundle bundleid="bundleid" src="context.app_path.toString()"/>
				<set name="thisclass.state" value="'ACTIVE'"/>
				<set name="thisclass._iconid_state" value="'active'"/>
			</function>
			<function name="DeactiveApplication">
				<destroybundle bundleid="bundleid"/>
				<set name="thisclass.state" value="'INSTALLED'"/>
				<set name="thisclass._iconid_state" value="'appInactive'"/>
			</function>
			<function name="ToJsonString">
				<parameters>
					<!--appjson is return value-->
					<parameter name="appjson" type="string"/>
				</parameters>
				<log>ToJsonString</log>
				<variable name="values" type="string" />
				<reference variable="values">
					<jsonbody><![CDATA[ 
						{
							"state":"<%=thisclass.state.toString()%>",
							"_iconid_state":"<%=thisclass._iconid_state.toString()%>",
							"id":"<%=thisclass.id.toString()%>",
							"icon":"<%=thisclass.icon.toString()%>",
							"version":"<%=thisclass.version.toString()%>",
							"category":"<%=thisclass.category.toString()%>",
							"origin":"<%=thisclass.origin.toString()%>",
							"title":"<%=thisclass.title.toString()%>",
							"desc":"<%=thisclass.desc.toString()%>",
							"url":"<%=thisclass.url.toString()%>",
							"readme":"<%=thisclass.readme.toString()%>",
							"role":"<%=thisclass.role.toString()%>",
							"required_apps":[],
							"features":[],
							"permissions":[]
						}
					]]></jsonbody>
				</reference>
				<set name="appjson" value="context.values.toString()"/>
			</function>
		</public>
	</class>
	<class name="CApplicationManager">
		<private>
			<container name="appsContainer" type="hashmap" keytype="string" valuetype="class"/>
			<container name="appsPaths" type="hashmap" keytype="string" valuetype="string"/>
		</private>
		<public>
			<function name="CApplicationManager">
				<log> i am CApplicationManager contructio function</log>
				<container name="listdir" type="list" valuetype="string"/>
				<variable name="appname" type="string"/>
				<variable name="appdir" type="string"/>
				<variable name="bundleid" type="long"/>
				<variable name="pathname" type="string"/>
				<variable name="appparam" type="params"/>
				<readdir dir="'/opt/staros.xyz/staroscontroller/starlang/apps/'" list="context.listdir"/>
				<log><![CDATA[dirlist size = '<%=context.listdir.size()%>']]></log>
				<for var="i" from="0" to="context.listdir.size()-1">
					<set name="appname" value="context.listdir.getValueByIndex(context.i.toLong())"/>
					<log><![CDATA[appname=<%=context.appname.toString()%>]]></log>
					<set name="appdir" value="'/opt/staros.xyz/staroscontroller/starlang/apps/'+context.appname.toString()"/>
					<if cond="context.isDir(context.appdir.toString())">
						<then>
							<set name="pathname" value="'/opt/staros.xyz/staroscontroller/starlang/apps/'+context.appname.toString()+'/'+context.appname.toString()+'.xml'"/>
							<log><![CDATA[pathname=<%=context.pathname.toString()%>]]></log>
							<set name="bundleid" value="context.newBundleId()"/>
							<set name="appparam" paramname="pathname" value="context.pathname.toString()"/>
							<createbundle bundleid="bundleid" src="context.pathname.toString()"/>
							<insert name="appsPaths" key="context.appname.toString()" value="context.pathname.toString()"/>
						</then>
					</if>
				</for>
			</function>
			<function name="GetAppJsonString">
				<parameters>
					<!--appjson is return value-->
					<parameter name="appjson" type="string"/>
				</parameters>
				<variable name="jsononeapp" type="class" />
				<container name="allapplist" type="list" valuetype="string" />
				<variable name="appstring" type="string"/>
				<for var="i" from="0" to="context.appsContainer.size()-1">
					<log><![CDATA[portLength=<%=context.appsContainer.size()%>]]></log>
					<function>
						<set name="jsononeapp" value="context.appsContainer.getValueByIndex(context.i.toLong())"/>
						<function name="ToJsonString" class="context.jsononeapp">
							<parameters>
								<parameter name="appjson" type="string" out="context.appstring"/>
							</parameters>
						</function>
						<insert name="allapplist" value="context.appstring.toString()"/>
					</function>
				</for>
				<log>####################GetAppJsonString##################</log>
				<script><![CDATA[
						var json = new Object();
						var payload = new Object();
						var apps = new Array();
						json['event'] = "appDataResponse";
						for(var i=0;i<context.allapplist.size();i++){
							var oneapps = new Object();
							var values=context.allapplist.getValueByIndex(i).toString();	
							var oneappsinfo = JSON.parse(values);
							//context.print(values);
							//oneapps=values;
							apps.push(oneappsinfo);
						}
						payload['apps'] = apps;	
						json['payload'] = payload;	
						var strjson=JSON.stringify(json);
						context.appjson.setValue(strjson);
					]]></script>	
					
			</function>
			
			<function name="GetAppdetalJsonString">
				<log>####################GetAppJsonString##################</log>
				<parameters>
					<!--appdetaljson is return value-->
					<parameter name="appdetailjson" type="string"/>
					<parameter name="app_id" type="string"/>
				</parameters>
				<variable name="oneapp" type="class" />
				<variable name="appstringjson" type="string" />
				<if cond="thisclass.appsContainer.hasValue(context.app_id.toString())">
					<then>
						<function>
							<lookup name="appsContainer" key="context.app_id.toString()" output="context.oneapp"/>
							<function name="ToJsonString" class="oneapp">
								<parameters>
									<!--appjson is return value-->
									<parameter name="appjson" type="string" out="context.appstringjson"/>
								</parameters>
							</function>
							<script><![CDATA[
								var jsonroot = new Object();
								var jsondetails = new Object();
								var appsinfo=JSON.parse(context.appstringjson.toString());
								jsondetails['details']=appsinfo;
								jsonroot['event']="appDetailsResponse";
								jsonroot['payload']=jsondetails;
								var strjson=JSON.stringify(jsonroot);
								context.appdetailjson.setValue(strjson);
							]]></script>
						</function>
					</then>
				</if>
			</function>
			
			<function name="AddAppEvent">
				<variable name="oneapp" type="class" />
				<log>####################AddAppEvent##################</log>
				<parameters>
					<parameter name="id" type="string"/>
					<parameter name="version" type="string"/>
					<parameter name="category" type="string"/>
					<parameter name="origin" type="string"/>
					<parameter name="title" type="string"/>
					<parameter name="desc" type="string"/>		
					<parameter name="url" type="string"/>
					<parameter name="bundleid" type="long"/>
					<parameter name="path" type="string"/>
				</parameters>
				<variable name="appidout" type="string"/>
				<new name="oneapp" class="CApplication">
					<parameters>
						<parameter name="appid" type="string" in="context.id.toString()"/>
						<parameter name="appversion" type="string" in="context.version.toString()"/>
						<parameter name="appcategory" type="string" in="context.category.toString()"/>
						<parameter name="apporigin" type="string" in="context.origin.toString()"/>
						<parameter name="apptitle" type="string" in="context.title.toString()"/>
						<parameter name="appdesc" type="string" in="context.desc.toString()"/>		
						<parameter name="appurl" type="string" in="context.url.toString()"/>
						<parameter name="appbundleid" type="long" in="context.bundleid.toLong()"/>
						<parameter name="apppath" type="string" in="context.path.toLong()"/>
					</parameters> 
				</new>
				<remove name="appsContainer" key="context.id.toString()"/>
				<insert name="appsContainer" key="context.id.toString()" value="context.oneapp"/>
				<function name="GetApplicationId" class="oneapp">
					<parameters>
						<parameter name="outappid" type="string" out="context.appidout"/>
					</parameters>
				</function>
				<log><![CDATA[appidout id=<%=context.appidout.toString()%>]]></log>
			</function>
		
			<function name="AppDeactiveEvent">
				<parameters>
					<parameter name="id" type="string"/>
				</parameters>
				<variable name="oneapp" type="class" />
				<if cond="thisclass.appsContainer.hasValue(context.id.toString())">
					<then>
						<function>
							<lookup name="appsContainer" key="context.id.toString()" output="context.oneapp"/>
							<function name="DeactiveApplication" class="oneapp"/>
						</function>
					</then>
				</if>
			</function>
			<function name="AppActiveEvent">
				<parameters>
					<parameter name="id" type="string"/>
				</parameters>
				<variable name="oneapp" type="class" />
				<variable name="apppath" type="string" />
				<variable name="strkey" type="string" />
				<variable name="strvalue" type="string" />
				<set name="apppath" value="context.appsPaths.getValue(context.id.toString()).toString()"/>
				<log><![CDATA[AppActiveEvent apppath=<%=context.apppath.toString()%>]]></log>
				<log><![CDATA[AppActiveEvent id=<%=context.id.toString()%>]]></log>
				<log><![CDATA[AppActiveEvent appsPaths size=<%=context.appsPaths.size()%>]]></log>
				<for var="i" from="0" to="context.appsPaths.size()-1">
					<log><![CDATA[appsPaths=<%=context.appsPaths.size()%>]]></log>
					<function>
						<set name="strkey" value="context.appsPaths.getKeyByIndex(context.i.toLong())"/>
						<set name="strvalue" value="context.appsPaths.getValueByIndex(context.i.toLong())"/>
						<log><![CDATA[strkey=<%=context.strkey.toString()%>]]></log>
						<log><![CDATA[strvalue=<%=context.strvalue.toString()%>]]></log>
					</function>
				</for>
				<if cond="thisclass.appsContainer.hasValue(context.id.toString())">
					<then>
						<function>
							<lookup name="appsContainer" key="context.id.toString()" output="context.oneapp"/>
							<function name="ActiveApplication" class="oneapp">
								<parameters>
									<parameter name="app_path" type="string" in="context.apppath.toString()"/>
								</parameters>
							</function>
						</function>
					</then>
				</if>
			</function>
		</public>
	</class>
</starosxml>