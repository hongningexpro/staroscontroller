<?xml version="1.0" encoding="UTF-8"?>
<starosxml xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
		<!--
			Author:
					hupeng
			Date:
					2017-09-11
			Copyright: 
					Nanjing StarOS Inc. All rights reserved.
		-->
	<class name="CApplication">
		<private>
			<variable name="pathname" type="string" />
			<variable name="id" type="string" />
			<variable name="bundleid" type="long" />
			<variable name="state" type="string" />
			<variable name="_iconid_state" type="string" />
			<variable name="icon" type="string" />
			<variable name="version" type="string" />
			<variable name="category" type="string" />
			<variable name="origin" type="string" />
			<variable name="title" type="string" />
			<variable name="desc" type="string" />
			<variable name="url" type="string" />
			<variable name="readme" type="string" />
			<variable name="role" type="string" />
			<container name="required_apps" type="list"  valuetype="string"/>
			<container name="features" type="list" valuetype="string"/>
			<container name="permissions" type="list" valuetype="string"/>
			
			<variable name="m_apppath" type="string" />
			<variable name="pathends" type="string" />
			
		</private>
		<public>
		
		
			<function name="CApplication">
				<parameters>
					<parameter name="apppath" type="string" />
					<parameter name="appid" type="string"/>
					<parameter name="appstate" type="string"/>
					<parameter name="appiconstate" type="string"/>
					<parameter name="apppathname" type="string"/>	
				</parameters>
				<set name="thisclass.state" value="context.appstate.toString()"/>
				<set name="thisclass.id" value="context.appid.toString()"/>
				<set name="thisclass.m_apppath" value="context.apppath.toString()"/>
				<set name="thisclass._iconid_state" value="context.appiconstate.toString()"/>
				<set name="thisclass.pathname" value="context.apppathname.toString()"/>
			</function>
		
			<!-- 
					auth:hupeng
					data:2017-09-11
					From CApplicationManager function send some information to this
			-->
			<function name="Setallinfo" class="oneapp">
				<parameters>
					<parameter name="appversion" type="string"/>
					<parameter name="appcategory" type="string" />
					<parameter name="apporigin" type="string"/>
					<parameter name="apptitle" type="string"/>
					<parameter name="appdesc" type="string"/>		
					<parameter name="appurl" type="string"/>
					<parameter name="appbundleid" type="long"/>
				</parameters> 
				<function name="SetApplicationInfo">
					<parameters>
						<parameter name="appversion" type="string" in="context.appversion.toString()"/>
						<parameter name="appcategory" type="string" in="context.appcategory.toString()"/>
						<parameter name="apporigin" type="string" in="context.apporigin.toString()"/>
						<parameter name="apptitle" type="string" in="context.apptitle.toString()"/>
						<parameter name="appdesc" type="string" in="context.appdesc.toString()"/>		
						<parameter name="appurl" type="string" in="context.appurl.toString()"/>
						<parameter name="appbundleid" type="long" in="context.appbundleid.toLong()"/>
					</parameters>
				</function>
				<log><![CDATA[app_version=<%=context.appversion.toString()%>]]></log>
				<log><![CDATA[app_category=<%=context.appcategory.toString()%>]]></log>
				<log><![CDATA[app_origin=<%=context.apporigin.toString()%>]]></log>
				<log><![CDATA[app_title=<%=context.apptitle.toString()%>]]></log>
				<log><![CDATA[app_desc=<%=context.appdesc.toString()%>]]></log>
				<log><![CDATA[app_url=<%=context.appurl.toString()%>]]></log>
				<log><![CDATA[app_bundleid=<%=context.appbundleid.toLong()%>]]></log>	
				<log><![CDATA[!!!!thisclass.state=<%=thisclass.state.toString()%>]]></log>
				<!-- 
					auth:hupeng
					data:2017-09-11
					judge state whether is "ACTIVE"
				-->
				<if cond="thisclass.state.toString()=='ACTIVE'">
					<then>
						<log>ACTIVE!!!!!!!!!!!!!!</log>
						<function name="ActiveApplication"/>
					</then>
					<else>
						<log>DEACTIVE!!!!!!!!!!!!!!</log>
						<function name="DeactiveApplication"/>
					</else>
				</if>
			</function>
				<!-- 
					auth:hupeng
					data:2017-09-11
					get app path
				-->
			<function name="Getpath">
				<parameters>
					<parameter name="apppath" type="string"/>
				</parameters> 
				<set name="apppath" value="thisclass.pathname"/>
			</function>
			
				<!-- 
					auth:hupeng
					data:2017-09-11
					get appactionid
				-->
			<function name="GetApplicationId">
				<parameters>
					<parameter name="outappid" type="string"/>
				</parameters>
				<log><![CDATA[GetApplicationId id=<%=thisclass.id.toString()%>]]></log>
				<set name="outappid" value="thisclass.id.toString()"/>
			</function>
			
			

			<function name="SetApplicationInfo">
				<parameters>
					<parameter name="appversion" type="string"/>
					<parameter name="appcategory" type="string"/>
					<parameter name="apporigin" type="string"/>
					<parameter name="apptitle" type="string"/>
					<parameter name="appdesc" type="string"/>		
					<parameter name="appurl" type="string"/>
					<parameter name="appbundleid" type="long"/>
				</parameters>
				<set name="thisclass.version" value="context.appversion.toString()"/>
				<set name="thisclass.category" value="context.appcategory.toString()"/>
				<set name="thisclass.origin" value="context.apporigin.toString()"/>
				<set name="thisclass.title" value="context.apptitle.toString()"/>
				<set name="thisclass.desc" value="context.appdesc.toString()"/>
				<set name="thisclass.url" value="context.appurl.toString()"/>
				<set name="thisclass.bundleid" value="context.appbundleid.toLong()"/>
		
				<log><![CDATA[app_version=<%=context.appversion.toString()%>]]></log>
				<log><![CDATA[app_category=<%=context.appcategory.toString()%>]]></log>
				<log><![CDATA[app_origin=<%=context.apporigin.toString()%>]]></log>
				<log><![CDATA[app_title=<%=context.apptitle.toString()%>]]></log>
				<log><![CDATA[app_desc=<%=context.appdesc.toString()%>]]></log>
				<log><![CDATA[app_url=<%=context.appurl.toString()%>]]></log>
				<log><![CDATA[app_bundleid=<%=context.appbundleid.toLong()%>]]></log>
				
			</function>
			
			<!-- 
					auth:hupeng
					data:2017-09-11
					active application
			-->
			
			<function name="ActiveApplication">
				<variable name="filecontent" type="string" value="'0'"/>
				<activebundle bundleid="thisclass.bundleid"/>
				<set name="thisclass.state" value="'ACTIVE'"/>
				<set name="thisclass._iconid_state" value="'active'"/>
				<set name="filecontent" value="'1'"/>
				<log><![CDATA[id!!!!!!!!!!!=<%=thisclass.id.toString()%>]]></log>
				
				<script><![CDATA[
					context.print(thisclass.id.toString());
					var pathend ="/opt/staros.xyz/staroscontroller/starlang/apps/"+thisclass.id.toString()+"/active";
					context.pathends.setValue(pathend);
				]]></script>
				<file method="deletefile" name="context.pathends.toString()"/>
				<file method="writefile" name="context.pathends.toString()" data="context.filecontent.toMessageBlock()"/>
				<log dest="stdout"><![CDATA[pathends!!!!!!!!!!!=<%=context.pathends.toString()%>]]></log>
				<log dest="stdout"><![CDATA[filecontent!!!!!!!!!!!=<%=context.filecontent.toString()%>]]></log>
			</function>
			
			<!-- 
					auth:hupeng
					data:2017-09-11
					deactive application
			-->
			<function name="DeactiveApplication">

				<variable name="filecontent" type="string" value="'0'"/>
				<deactivebundle bundleid="thisclass.bundleid"/>
				<set name="thisclass.state" value="'INSTALLED'"/>
				<set name="thisclass._iconid_state" value="'appInactive'"/>
				<log><![CDATA[id!!!!!!!!!!!=<%=thisclass.id.toString()%>]]></log>
						<script><![CDATA[
						context.print(thisclass.id.toString());
						var pathend ="/opt/staros.xyz/staroscontroller/starlang/apps/"+thisclass.id.toString()+"/active";
						context.pathends.setValue(pathend);
					]]></script>
				<file method="deletefile" name="context.pathends.toString()"/>
				<file method="writefile" name="context.pathends.toString()" data="context.filecontent.toMessageBlock()"/>
				<log dest="stdout"><![CDATA[filecontent!!!!!!!!!!!=<%=context.filecontent.toString()%>]]></log>
			</function>
			

			<function name="ToJsonString">
				<parameters>
					<!--appjson is return value-->
					<parameter name="appjson" type="string"/>
				</parameters>
				<log>ToJsonString</log>
				<variable name="values" type="string" />
				<reference variable="values">
					<jsonbody><![CDATA[ 
						{
							"state":"<%=thisclass.state.toString()%>",
							"_iconid_state":"<%=thisclass._iconid_state.toString()%>",
							"id":"<%=thisclass.id.toString()%>",
							"icon":"<%=thisclass.icon.toString()%>",
							"version":"<%=thisclass.version.toString()%>",
							"category":"<%=thisclass.category.toString()%>",
							"origin":"<%=thisclass.origin.toString()%>",
							"title":"<%=thisclass.title.toString()%>",
							"desc":"<%=thisclass.desc.toString()%>",
							"url":"<%=thisclass.url.toString()%>",
							"readme":"<%=thisclass.readme.toString()%>",
							"role":"<%=thisclass.role.toString()%>",
							"required_apps":[],
							"features":[],
							"permissions":[]
						}
					]]></jsonbody>
				</reference>
				<set name="appjson" value="context.values.toString()"/>
			</function>
			<function name="GetBundleID">
				<parameters>
					<parameter name="id" type="long"/>
				</parameters>
				<set name="id" value="thisclass.bundleid.toLong()"/>
			</function>
		</public>
	</class>
	<class name="CApplicationManager">
		<private>
			<variable name="currentappname" type="string"/>
			<container name="appsContainer" type="hashmap" keytype="string" valuetype="class"/>
		</private>
		<public>
			<function name="CApplicationManager">
				<log> i am CApplicationManager contructio function</log>
				<function name="LoadApplication"/>
			</function>
			<function name="GetCurrentappname">
				<parameters>
					<parameter name="outappname" type="string" />
				</parameters>
				<set name="outappname" value="thisclass.currentappname"/>
			</function>
			<function name="SetCurrentappname">
				<parameters>
					<parameter name="inappname" type="string" />
				</parameters>
				<set name="thisclass.currentappname" value="context.inappname"/>
			</function>
			
			<!-- 
					auth:hupeng
					data:2017-09-11
					load application
					1):find all apps floder and apps
					2):judge whether is floder and judge active file whether exist (if active file not exist 
						create file and if active file exist judge content whether is 0)
					3)create application object and send value
					4)create createbundle

			-->
			<function name="LoadApplication">
				<log>LoadApplication</log>
				<container name="listdir" type="list" valuetype="string"/>
				<variable name="appdir" type="string"/>
				<variable name="bundleid" type="long"/>
				<variable name="pathname" type="string"/>
				<variable name="appparam" type="params"/>
				<variable name="filecontent" type="string"/>
				<variable name="activitefile" type="string"/>
				<variable name="isfile" type="boolean"/>
				<variable name="oneapp" type="class" />
				
				<variable name="apppath" type="string"/>
				<variable name="appname" type="string"/>
				<variable name="appstate" type="string" />
				<variable name="appiconstate" type="string" />
				<variable name="appfolder" type="string"/>
				
				<variable name="appobject" type="class" />
				<variable name="i" type="string" />
				<messageblock name="filecontentss"/>
				<readdir dir="'/opt/staros.xyz/staroscontroller/starlang/apps/'" list="context.listdir"/>
				<log><![CDATA[dirlist size = '<%=context.listdir.size()%>']]></log>
				<clear name="appsContainer"/>
				<for var="i" in="context.listdir">
					<set name="appname" value="context.i.toString()"/>
					<log><![CDATA[appname=<%=context.appname.toString()%>]]></log>
					<set name="appdir" value="'/opt/staros.xyz/staroscontroller/starlang/apps/'+context.appname.toString()"/>
					<if cond="context.isDir(context.appdir.toString())">
						<then>
							<log>listdir huhu!!!!!!!</log>
							<set name="appfolder" value="'/opt/staros.xyz/staroscontroller/starlang/apps/'+context.appname.toString()"/>
							<set name="pathname" value="'/opt/staros.xyz/staroscontroller/starlang/apps/'+context.appname.toString()+'/'+context.appname.toString()+'.xml'"/>
							<log><![CDATA[pathname=<%=context.pathname.toString()%>]]></log>
							<set name="bundleid" value="context.newBundleId()"/>
							<set name="appparam" paramname="pathname" value="context.appdir.toString()"/>
						
							<set name="activitefile" value="'/opt/staros.xyz/staroscontroller/starlang/apps/'+context.appname.toString()+'/active'"/>
							<set name="isfile" value="context.isFile(context.activitefile.toString())"/>
							<if cond="context.isfile.toBoolean()==false">
								<then>	
									<log> isfile is false!!!!!!!!!!!!!!</log>
									<set name="filecontent" value="'0'"/>
									<file method="writefile" name="context.activitefile.toString()" data="context.filecontent.toMessageBlock()"/>
									<log dest="stdout"><![CDATA[filecontent = '<%=context.filecontent.toString()%>']]></log>
									<set name="appstate" value="'INSTALLED'"/>
									<set name="appiconstate" value="'appInactive'"/>
								</then>
								<else>
									<log> isfile is true!!!!!!!!!!!!!!</log>
									<log><![CDATA[readfilehuhu=<%=context.activitefile.toString()%>]]></log>
									<file method="readfile" name="context.activitefile.toString()" data="context.filecontentss"/>
									<log dest="stdout"><![CDATA[filecontent = '<%=context.filecontentss.toString()%>']]></log>
									<script><![CDATA[
										var file=context.filecontentss.toString();
										var filesize=file.length;
										context.print(filesize);
									]]></script>	
									<if cond="context.filecontentss.toString()!='0'">	
										<then>
											<set name="appstate" value="'ACTIVE'"/>
											<set name="appiconstate" value="'active'"/>	
										</then>
										<else>
											<set name="appstate" value="'INSTALLED'"/>
											<set name="appiconstate" value="'appInactive'"/>	
										</else>
									</if>
								</else>
							</if>	
							<new name="appobject" class="CApplication">
								<parameters>
									<parameter name="apppath" type="string" in="context.pathname.toString()"/>
									<parameter name="appid" type="string" in="context.appname.toString()"/>
									<parameter name="appstate" type="string" in="context.appstate.toString()"/>
									<parameter name="appiconstate" type="string" in="context.appiconstate.toString()"/>
									<parameter name="apppathname" type="string" in="context.appfolder.toString()"/>	
								</parameters>
							</new>
							<insert name="appsContainer" key="context.appname.toString()" value="context.appobject"/>
							<createbundle bundleid="bundleid" src="context.pathname.toString()"/>				
						</then>
					</if>
				</for>
			</function>
			<function name="GetAppJsonString">
				<parameters>
					<!--appjson is return value-->
					<parameter name="appjson" type="string"/>
				</parameters>
				<variable name="jsononeapp" type="class" />
				<container name="allapplist" type="list" valuetype="string" />
				<variable name="appstring" type="string"/>
				<container name="oneapppair" type="pair" keytype="string" valuetype="class"/>
				<for var="oneapppair" in="context.appsContainer">
					<log><![CDATA[portLength=<%=context.appsContainer.size()%>]]></log>
					<function>
						<set name="jsononeapp" value="context.oneapppair.second()"/>
						<function name="ToJsonString" class="context.jsononeapp">
							<parameters>
								<parameter name="appjson" type="string" out="context.appstring"/>
							</parameters>
						</function>
						<insert name="allapplist" value="context.appstring.toString()"/>
					</function>
				</for>
				<log>####################GetAppJsonString##################</log>
				<script><![CDATA[
						var json = new Object();
						var payload = new Object();
						var apps = new Array();
						json['event'] = "appDataResponse";
						
						//qiulei 20170918 am
						var firstString=context.allapplist.getFirst();
						while(firstString!=null){
							var oneapps = new Object();
							var values=firstString;	
							var oneappsinfo = JSON.parse(values);
							//context.print(values);
							//oneapps=values;
							apps.push(oneappsinfo);
							firstString=context.allapplist.getNext();
						}
						
						payload['apps'] = apps;	
						json['payload'] = payload;	
						var strjson=JSON.stringify(json);
						context.appjson.setValue(strjson);
					]]></script>	
					
			</function>
			
			<function name="GetAppdetalJsonString">
				<log>####################GetAppJsonString##################</log>
				<parameters>
					<!--appdetaljson is return value-->
					<parameter name="appdetailjson" type="string"/>
					<parameter name="app_id" type="string"/>
				</parameters>
				<variable name="oneapp" type="class" />
				<variable name="appstringjson" type="string" />
				<if cond="thisclass.appsContainer.hasValue(context.app_id.toString())">
					<then>
						<function>
							<lookup name="appsContainer" key="context.app_id.toString()" output="context.oneapp"/>
							<function name="ToJsonString" class="oneapp">
								<parameters>
									<!--appjson is return value-->
									<parameter name="appjson" type="string" out="context.appstringjson"/>
								</parameters>
							</function>
							<script><![CDATA[
								var jsonroot = new Object();
								var jsondetails = new Object();
								var appsinfo=JSON.parse(context.appstringjson.toString());
								jsondetails['details']=appsinfo;
								jsonroot['event']="appDetailsResponse";
								jsonroot['payload']=jsondetails;
								var strjson=JSON.stringify(jsonroot);
								context.appdetailjson.setValue(strjson);
							]]></script>
						</function>
					</then>
				</if>
			</function>
			<!-- 
				auth:hupeng
				data:2017-09-11
				regist application 
				get value from every app.xml file
			
			
			-->
			<function name="RegistApplication">
				<parameters>
					<parameter name="id" type="string"/>
					<parameter name="version" type="string"/>
					<parameter name="category" type="string"/>
					<parameter name="origin" type="string"/>
					<parameter name="title" type="string"/>
					<parameter name="desc" type="string"/>		
					<parameter name="url" type="string"/>
					<parameter name="bundleid" type="long"/>
				</parameters>
				<variable name="oneapp" type="class" />
				<log>####################AddAppEvent##################</log>
				<lookup name="appsContainer" key="context.id.toString()" output="context.oneapp"/>
				<variable name="appidout" type="string"/>
				<function name="Setallinfo" class="oneapp">
					<parameters>
						<parameter name="appversion" type="string" in="context.version.toString()"/>
						<parameter name="appcategory" type="string" in="context.category.toString()"/>
						<parameter name="apporigin" type="string" in="context.origin.toString()"/>
						<parameter name="apptitle" type="string" in="context.title.toString()"/>
						<parameter name="appdesc" type="string" in="context.desc.toString()"/>		
						<parameter name="appurl" type="string" in="context.url.toString()"/>
						<parameter name="appbundleid" type="long" in="context.bundleid.toLong()"/>
					</parameters> 	
				</function>
		
			</function>
			<!--
			
				 make  app deactive
			
			-->
			<function name="AppDeactiveEvent">
				<parameters>
					<parameter name="id" type="string"/>
				</parameters>
				<variable name="oneapp" type="class" />
				<if cond="thisclass.appsContainer.hasValue(context.id.toString())">
					<then>
						<function>
							<lookup name="appsContainer" key="context.id.toString()" output="context.oneapp"/>
							<if cond="context.oneapp!=null">
								<then>
									<function name="DeactiveApplication" class="oneapp"/>
								</then>
								<else>
									<log> can not find the app</log>
									<exit/>
								</else>
							</if>
						</function>
					</then>
				</if>
			</function>
			<!--
			
				 make  app active
			
			-->
			<function name="AppActiveEvent">
				<parameters>
					<parameter name="id" type="string"/>
				</parameters>
				<variable name="oneapp" type="class" />
				<variable name="apppath" type="string" />
				<variable name="strkey" type="string" />
				<variable name="strvalue" type="string" />

				<if cond="thisclass.appsContainer.hasValue(context.id.toString())">
					<then>
						<function>
							<lookup name="appsContainer" key="context.id.toString()" output="context.oneapp"/>
							<function name="ActiveApplication" class="oneapp"/>
						</function>
					</then>
				</if>
			</function>
			
			<!--	
				 make  app uninstall and floder delete
			-->
			<function name="UninstallApp">
				<parameters>
					<parameter name="id" type="string"/>
				</parameters>
				<variable name="apppath" type="string" />
				<variable name="oneapp" type="class" />
				<lookup name="appsContainer" key="context.id.toString()" output="context.oneapp"/>
				
				<function name="Getpath" class="oneapp">
					<parameters>
						<parameter name="apppath" type="string" out="context.apppath"/>
					</parameters> 
				</function>

				<if cond="thisclass.appsContainer.hasValue(context.id.toString())">
					<then>
						<function>
							<remove name="thisclass.appsContainer" key="context.id.toString()"/>
						</function>
					</then>
				</if>
				<log><![CDATA[UninstallApp id=<%=context.id.toString()%>]]></log>
				<file method="deletefile" name="context.apppath.toString()"/>
			</function>
			
			<function name="GetBundleID">
				<parameters>
					<parameter name="appid" type="string"/>
					<parameter name="bundleid" type="long"/>
				</parameters>
				<variable name="oneapp" type="class" />
				<if cond="thisclass.appsContainer.hasValue(context.appid.toString())">
					<then>
						<function>
							<lookup name="appsContainer" key="context.appid.toString()" output="context.oneapp"/>
							<function name="GetBundleID" class="oneapp">
								<parameters>
									<parameter name="id" type="string" out="context.bundleid"/>
								</parameters>
							</function>
						</function>
					</then>
				</if>
			</function>
		</public>
	</class>
</starosxml>