<?xml version="1.0" encoding="UTF-8"?>
<starosxml xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">	
	<class name="CDeviceManager">
		<private>
			<container name="deviceContainer" type="hashmap" keytype="string" valuetype="class"/>
			<container name="t2dContainer" type="hashmap" keytype="string" valuetype="string"/>
		</private>
		<public>
			<function name="CDeviceManager">
				<log>CDeviceManager is create</log>
			</function>
			<function name="getDevice">
				<parameters>
					<parameter name="outdevice" type="class"/>
					<parameter name="datapathid" type="string"/>
				</parameters>
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())">
					<then>
						<function>
							<set name="outdevice" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
						</function>
					</then>
				</if>
			</function>
			<function name="addDevice">
				<parameters>
					<parameter name="mfrdesc" type="string"/>
					<parameter name="swdesc" type="string"/>
					<parameter name="serialnum" type="string"/>
					<parameter name="dpdesc" type="string"/>
					<parameter name="hwdesc" type="string"/>
					<parameter name="transportid" type="string"/>
					<parameter name="datapathid" type="string"/>
					<parameter name="localipaddr" type="string"/>
					<parameter name="peeripaddr" type="string"/>
					<parameter name="masterid" type="string"/>	
					<parameter name="type" type="string"/>
					<parameter name="online" type="string"/>
					<parameter name="protocol" type="string"/>					
				</parameters>
				<variable name="deviceobject" type="class"/>
				<variable name="outtransid" type="string"/>
				<new name="deviceobject" class="CDevice">
					<parameters>
						<parameter name="mfrdesc" type="string" in="context.mfrdesc.toString()"/>
						<parameter name="swdesc" type="string" in="context.swdesc.toString()"/>
						<parameter name="serialnum" type="string" in="context.serialnum.toString()"/>
						<parameter name="dpdesc" type="string" in="context.dpdesc.toString()"/>
						<parameter name="hwdesc" type="string" in="context.hwdesc.toString()"/>
						<parameter name="transportid" type="string" in="context.transportid.toString()"/>
						<parameter name="datapathid" type="string" in="context.datapathid.toString()"/>
						<parameter name="localipaddr" type="string" in="context.localipaddr.toString()"/>
						<parameter name="peeripaddr" type="string" in="context.peeripaddr.toString()"/>
						<parameter name="masterid" type="string" in="context.masterid.toString()"/>		
						<parameter name="type" type="string" in="context.type.toString()"/>
						<parameter name="online" type="string" in="context.online.toString()"/>
						<parameter name="protocol" type="string" in="context.protocol.toString()"/>	
					</parameters>
				</new>
				<insert name="deviceContainer" key="context.datapathid.toString()" value="context.deviceobject"/>
				<insert name="t2dContainer" key="context.transportid.toString()" value="context.datapathid.toString()"/>
				<variable name="onlinejson" type="string"/>
				<function name="SendDefaultFlow" class="deviceobject"/>
				<function name="ToOnlineJson" class="deviceobject">
					<parameters>
						<parameter name="strjson" type="string" out="onlinejson"/>
					</parameters>
				</function>
				<log><![CDATA[onlinejson =<%=context.onlinejson.toString()%>]]></log>
				<function name="SendToAllClient" class="WebSocketManager">
					<parameters>
						<parameter name="strjson" type="string" in="context.onlinejson.toString()"/>
					</parameters>
				</function>
				<function name="GetTransportId" class="deviceobject">
					<parameters>
						<parameter name="outtransport" type="string" out="outtransid"/>
					</parameters>
				</function>
				
				
				<log><![CDATA[addDevice outtransid =<%=context.outtransid.toString()%>]]></log>
			</function>
				
			<function name="findDevice">
				<parameters>
					<parameter name="datapathid" type="string"/>
					<parameter name="deviceobject" type="class"/>
				</parameters>
				<variable name="deviceinfo" type="class"/>
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())==true">
					<then>
						<function>
							<lookup name="deviceContainer" key="context.datapathid.toString()" output="context.deviceinfo"/>
						</function>
					</then>
				</if>
				<set name="deviceobject" value="context.deviceinfo"/>
			</function>
			
			<function name="removeDevice">
				<parameters>
					<parameter name="datapathid" type="string"/>
				</parameters>
				<log><![CDATA[removeDevice device size=<%=context.deviceContainer.size()%>]]></log>
				<variable name="deviceobject" type="class"/>
				<variable name="offlinejson" type="string"/>
				<variable name="devicetransportid" type="string"/>
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())==true">
					<then>
						<function>
							<lookup name="deviceContainer" key="context.datapathid.toString()" output="context.deviceobject"/>
							<if cond="context.deviceobject == null">
								<then>
									<exit/>
								</then>
							</if>
							<function name="ToOfflineJson" class="deviceobject">
								<parameters>
									<parameter name="strjson" type="string" out="offlinejson"/>
								</parameters>
							</function>
							<function name="SendToAllClient" class="WebSocketManager">
								<parameters>
									<parameter name="strjson" type="string" in="context.offlinejson.toString()"/>
								</parameters>
							</function>
							<function name="GetTransportId" class="deviceobject">
								<parameters>
									<parameter name="outtransport" type="string" out="context.devicetransportid"/>
								</parameters>
							</function>
							<remove name="deviceContainer" key="context.datapathid.toString()"/>
							<remove name="t2dContainer" key="context.devicetransportid.toString()"/>
						</function>
					</then>
				</if>
			</function>
			<function name="GetDatapathIdByTransportid">
				<parameters>
					<parameter name="transportid" type="string"/>
					<parameter name="datapathid" type="string"/>
				</parameters>
				<set name="datapathid" value="context.t2dContainer.getValue(context.transportid.toString())"/>
			</function>
			<function name="GetTransportIdFromDevice">
				<parameters>
					<parameter name="datapathid" type="string"/>
					<parameter name="transportid" type="string"/>
				</parameters>
				<variable name="deviceinfo" type="class"/>
				<variable name="devicedatapathid" type="string"/>
				<!--qiulei 20170821 Monday am-->
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())">
					<then>
						<function>
							<set name="deviceinfo" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
							<!--qiulei 20170908 add if judge-->
							<if cond="context.deviceinfo != null">
								<then>
									<function name="GetTransportId" class="deviceinfo">
										<parameters>
											<parameter name="outtransport" type="string" out="transportid"/>
										</parameters>
									</function>
								</then>
							</if>
						</function>
					</then>
				</if>
			</function>
			<function name="removeDeviceByTransportId">
				<parameters>
					<parameter name="transportid" type="string"/>
				</parameters>
				<variable name="deviceinfo" type="class"/>
				<variable name="devicetransportid" type="string"/>
				<variable name="devicedatapathid" type="string"/>
				<variable name="oneremove" type="string"/>
				<log><![CDATA[removeDeviceByTransportId device size=<%=context.deviceContainer.size()%>]]></log>
				<log><![CDATA[transportid=<%=context.transportid.toString()%>]]></log>
				<container name="removelist" type="list" valuetype="string"/>
				
				<container name="oneapppair" type="pair" keytype="string" valuetype="class"/>
				<for var="oneapppair" in="context.deviceContainer">
					<function>
						<set name="deviceinfo" value="context.oneapppair.second()"/>
						
						<if cond="context.deviceinfo != null">
							<then>
								<function name="GetTransportId" class="deviceinfo">
									<parameters>
										<parameter name="outtransport" type="string" out="context.devicetransportid"/>
									</parameters>
								</function>
							</then>
						</if>
						<log><![CDATA[devicetransportid =<%=context.devicetransportid.toString()%>]]></log>
						<if cond="context.devicetransportid.toString() == context.transportid.toString()">
							<then>
								<function name="GetDatapathId" class="deviceinfo">
									<parameters>
										<parameter name="outdatapathid" type="string" out="context.devicedatapathid"/>
									</parameters>
								</function>
								<insert name="removelist" value="context.devicedatapathid.toString()"/>
							</then>
						</if>
					</function>
				</for>
				<for var="oneremove" in="context.removelist">
					<function>
						<function name="removeDevice">
							<parameters>
								<parameter name="datapathid" type="string" in="context.oneremove.toString()"/>
							</parameters>
						</function>
					</function>
				</for>
			</function>
			<function name="SendAddAllDeviceToWebClient">
				<parameters>
					<parameter name="transportid" type="string"/>
				</parameters>
				<variable name="jsonstr" type="string"/>
				<variable name="switchdevice" type="class"/>
				
				<log>2017.09.18 enter CDeviceManager.SendAddAllDeviceToWebClient method</log>
				
				<container name="oneapppair" type="pair" keytype="string" valuetype="class"/>
				<for var="oneapppair" in="context.deviceContainer">
					<log><![CDATA[SendAddAllDeviceToWebClient device size=<%=context.deviceContainer.size()%>]]></log>
					<function>
						<set name="switchdevice" value="context.oneapppair.second()"/>
						
						<if cond="context.switchdevice != null">
							<then>
								
								<log>2017.09.18 enter CDeviceManager.SendAddAllDeviceToWebClient method    switchdevice is Not null</log>
								<function name="ToAddDeviceJson" class="context.switchdevice">
									<parameters>
										<parameter name="strjson" type="string" out="jsonstr"/>
									</parameters>
								</function>
							</then>
						</if>
						<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
							<jsonsrc src="jsonstr"/>
						</websocket>
					</function>
				</for>
			</function>
			<function name="SendAddAllLinkToWebClient">
				<parameters>
					<parameter name="transportid" type="string"/>
				</parameters>
				<log>2017.09.18 enter CDeviceManager.SendAddAllLinkToWebClient method</log>
				<variable name="srcdevice" type="class"/>
				<variable name="dstdevice" type="class"/>
				<variable name="srcport" type="string"/>
				<variable name="srcdevicedpid" type="string"/>
				<variable name="dstdevicedpid" type="string"/>
				<variable name="dstport" type="string"/>
				<variable name="json" type="string"/>
				<variable name="strlink" type="string" value=""/>
				<variable name="binvalidlink" type="string" value="false"/>
				
				
				<container name="oneDevicePair1" type="pair" keytype="string" valuetype="class"/>
				<for var="oneDevicePair1" in="context.deviceContainer">
					<log><![CDATA[SendAddAllDeviceToWebClient device size=<%=context.deviceContainer.size()%>]]></log>
					<function>
						<set name="srcdevice" value="context.oneDevicePair1.second()"/>
						<if cond="context.srcdevice != null">
							<then>
								<function name="GetDatapathId" class="srcdevice">
									<parameters>
										<parameter name="outdatapathid" type="string" out="srcdevicedpid"/>
									</parameters>
								</function>
							</then>
						</if>
						<function>
							<container name="oneDevicePair2" type="pair" keytype="string" valuetype="class"/>
							<for var="oneDevicePair2" in="context.deviceContainer">
								<set name="dstdevice" value="context.oneDevicePair2.second()"/>
								<log>2017.09.18 enter CDeviceManager.SendAddAllLinkToWebClient method    ent inner for</log>
								<if cond="context.dstdevice != null">
									<then>
										<function name="GetDatapathId" class="dstdevice">
											<parameters>
												<parameter name="outdatapathid" type="string" out="dstdevicedpid"/>
											</parameters>
										</function>
									</then>
								</if>
								<if cond="context.srcdevicedpid.toString()!=context.dstdevicedpid.toString()">
									<then>
										<function>
											<set name="strlink" value="context.openflowserverobj.getShortestPath(context.srcdevicedpid.toString(), context.dstdevicedpid.toString())"/>
												<function name="getShortestPath" class="TopoService">
													<parameters>												
														<parameter name="link" type="string" in="context.strlink.toString()"/>
														<parameter name="outjson" type="string" out="context.json"/>
													</parameters>												
												</function>
											
											<log><![CDATA[strlink=<%=context.strlink.toString()%>]]></log>
												<script><![CDATA[
														if (context.strlink.toString().length>0)
														{
															var info = JSON.parse(context.strlink.toString());
															if (info.paths.length==1)
															{
																context.dstport.setValue(info.paths[0].dst.port);
																context.srcport.setValue(info.paths[0].src.port);
																context.binvalidlink.setValue('true');
															}
															else 
															{	
																context.binvalidlink.setValue('false');
															}
														}
														else 
														{
															context.binvalidlink.setValue('false');
														}
												]]></script>
												<function>
													<if cond="context.binvalidlink.toString()=='true'">
														<then>
															<function>
																<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
																	<jsonbody>
																		<![CDATA[
																		{
																		"event":"addLink","payload":
																		{"id":"of:<%=context.srcdevicedpid.toString()%>/<%=context.srcport.toString()%>-of:<%=context.dstdevicedpid.toString()%>/<%=context.dstport.toString()%>",
																		"type":"direct",
																		"expected":false,
																		"online":true,
																		"linkWidth":1.2,
																		"src":"of:<%=context.srcdevicedpid.toString()%>",
																		"srcPort":"<%=context.srcport.toString()%>",
																		"dst":"of:<%=context.dstdevicedpid.toString()%>",
																		"dstPort":"<%=context.dstport.toString()%>"
																		}
																		}
																						]]>
																	</jsonbody>
																</websocket>
															</function>
														</then>
													</if>
												</function>
										</function>
									</then>
								</if>
							</for>
						</function>
					</function>
				</for>
			</function>
			<function name="SendDeviceInfoToWebClient">
				<parameters>
					<parameter name="transportid" type="string"/>
				</parameters>
				<variable name="jsonstr" type="string"/>
				<variable name="sendjsonstr" type="string"/>
				<variable name="switchdevice" type="class"/>
				<container name="deviceinfolist" type="list" valuetype="string"/>
				
				<log><![CDATA[SendDeviceInfoToWebClient devicesize=<%=context.deviceContainer.size()%>]]></log>
				<container name="oneDevicePair" type="pair" keytype="string" valuetype="class"/>
				<for var="oneDevicePair" in="context.deviceContainer">
					<function>
						<set name="switchdevice" value="context.oneDevicePair.second()"/>
						<if cond="context.switchdevice != null">
							<then>
								<function name="GetDeviceInfoJson" class="context.switchdevice">
									<parameters>
										<parameter name="strjson" type="string" out="jsonstr"/>
									</parameters>
								</function>
								<insert name="deviceinfolist" value="context.jsonstr.toString()"/>
							</then>
						</if>	
						
					</function>
				</for>
				<script><![CDATA[
					var json = new Object();
					var myArray=new Array();  
					
					
					//	qiulei 20170918
					var firstString=context.deviceinfolist.getFirst();
					while(firstString!=null){
						var onearray = JSON.parse(firstString);
						myArray.push(onearray);
						firstString=context.deviceinfolist.getNext();
					}
					
					json['event']='deviceDataResponse';
					
					var payload = new Object();
					payload['devices']=myArray;
					
					var annots = new Object();
					annots['no_rows_msg']='No devices found';
					payload['annots']=annots;
					json['payload']=payload;
					var strjson=JSON.stringify(json);
					context.sendjsonstr.setValue(strjson);
				]]></script>
				<log><![CDATA[SendDeviceInfoToWebClient transportid=<%=context.transportid.toString()%>]]></log>
				<log><![CDATA[SendDeviceInfoToWebClient sendjsonstr=<%=context.sendjsonstr.toString()%>]]></log>
				<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
					<jsonsrc src="sendjsonstr"/>
				</websocket>
			</function>
			<function name="SendDetailDeviceInfoToWebClient">
				<parameters>
					<parameter name="transportid" type="string"/>
				</parameters>
				<variable name="jsonstr" type="string"/>
				<variable name="sendjsonstr" type="string"/>
				<variable name="switchdevice" type="class"/>
				<container name="deviceinfolist" type="list" valuetype="string"/>
				
				<log><![CDATA[SendDeviceInfoToWebClient devicesize=<%=context.deviceContainer.size()%>]]></log>
				<container name="oneDevicePair" type="pair" keytype="string" valuetype="class"/>
				<for var="oneDevicePair" in="context.deviceContainer">
					<function>
						<set name="switchdevice" value="context.oneDevicePair.second()"/>
						<if cond="context.switchdevice != null">
							<then>
								<function name="GetDeviceInfoJson" class="context.switchdevice">
									<parameters>
										<parameter name="strjson" type="string" out="jsonstr"/>
									</parameters>
								</function>
							</then>
						</if>
						<insert name="deviceinfolist" value="context.jsonstr.toString()"/>
					</function>
				</for>
				<script><![CDATA[
					var json = new Object();
					var myArray=new Array();  
					
					
					//	qiulei 20170918
					var firstString=context.deviceinfolist.getFirst();
					while(firstString!=null){
						var onearray = JSON.parse(firstString);
						myArray.push(onearray);
						firstString=context.deviceinfolist.getNext();
					}
					
					json['event']='deviceDataResponse';
					
					var payload = new Object();
					payload['devices']=myArray;
					
					var annots = new Object();
					annots['no_rows_msg']='No devices found';
					payload['annots']=annots;
					json['payload']=payload;
					var strjson=JSON.stringify(json);
					context.sendjsonstr.setValue(strjson);
				]]></script>
				<log><![CDATA[SendDeviceInfoToWebClient transportid=<%=context.transportid.toString()%>]]></log>
				<log><![CDATA[SendDeviceInfoToWebClient sendjsonstr=<%=context.sendjsonstr.toString()%>]]></log>
				<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
					<jsonsrc src="sendjsonstr"/>
				</websocket>
			</function>
			<function name="Detect">
				<variable name="thisswitch" type="class"/>
				<variable name="transportid" type="string"/>
				<log>Device Manager Detect</log>
				
				<container name="oneDevicePair" type="pair" keytype="string" valuetype="class"/>
				<for var="oneDevicePair" in="context.deviceContainer">
					<function>
						<set name="thisswitch" value="context.oneDevicePair.second()"/>
						<if cond="context.thisswitch != null">
							<then>
								<function name="TimeOut" class="context.thisswitch"/>
							</then>
						</if>
					</function>
				</for>
				<!--SendPortState-->
				<log> SendPortStateRequest !!!!!!!!!!!!!!!!!!!</log>
				<!--function name="SendPortStateRequest"/-->
												<!--function name="SendFlowRequest"/-->
			</function>
			<function name="DeviceDetailsReqJson">
				<parameters>
					<parameter name="transportid" type="string"/>
					<parameter name="datapathid" type="string"/>
				</parameters>
				<variable name="thisswitch" type="class"/>
				<variable name="sendjsonstr" type="string"/>
				<set name="thisswitch" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
				<if cond="context.thisswitch != null">
					<then>
						<function name="ForDeviceDetailReqJson" class="thisswitch">
							<parameters>
								<parameter name="outjson" type="string" out="sendjsonstr"/>
							</parameters>
						</function>
					</then>
				</if>
				<log><![CDATA[DeviceDetailsReqJson sendjsonstr=<%=context.sendjsonstr.toString()%>]]></log>
				<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
					<jsonsrc src="sendjsonstr"/>
				</websocket>
			</function>
			<!--YY sendlinks 2017-08-18 -->
			<function name="SendLinks">
				<parameters>
					<parameter name="transportid" type="string"/>
				</parameters>
				<variable name="binvalidlink" type="boolean" value="false"/>
				<variable name="srcport" type="string"/>
				<variable name="srcdevicedpid" type="string"/>
				<variable name="dstdevicedpid" type="string"/>
				<variable name="dstport" type="string"/>
				<variable name="strlink" type="string" value=""/>	
				<variable name="linkarray" type="string"/>				
				<container name="linklist" type="list" valuetype="string"/>
				<variable name="srcdevice" type="class"/>
				<variable name="dstdevice" type="class"/>
				<function>	

				
					<container name="oneDevicePair" type="pair" keytype="string" valuetype="class"/>
					<for var="oneDevicePair" in="context.deviceContainer">
						<function>
						<log>2017.9.18 oneDevicePair </log>
							<set name="srcdevice" value="context.oneDevicePair.second()"/>
							<log><![CDATA[2017.9.18 oneDevicePair  context.oneDevicePair.second()=<%=context.oneDevicePair.first()%>>]]></log>
							<if cond="context.srcdevice != null">
								<then>
								
									<log>2017.9.18 srcdevice 非空 </log>
									<function name="GetDatapathId" class="srcdevice">
										<parameters>
											<parameter name="outdatapathid" type="string" out="srcdevicedpid"/>
										</parameters>
									</function>
									<log><![CDATA[srcdevicedpid=<%=context.srcdevicedpid.toString()%>>]]></log>
								</then>
							</if>
							<function>
							
								<container name="oneDevicePair2" type="pair" keytype="string" valuetype="class"/>
								<for var="oneDevicePair2" in="context.deviceContainer">
									<log>第二层</log>
									<set name="dstdevice" value="context.oneDevicePair2.second()"/>
									<if cond="context.dstdevice != null">
										<then>
											<log>第二层 第一个if</log>
											<function name="GetDatapathId" class="dstdevice">
												<parameters>
													<parameter name="outdatapathid" type="string" out="dstdevicedpid"/>
												</parameters>
											</function>
											<log><![CDATA[dstdevicedpid=<%=context.dstdevicedpid.toString()%>>]]></log>
										</then>
									</if>
									<if cond="context.srcdevicedpid.toString()!=context.dstdevicedpid.toString()">
										<then>
											<log>第二层 第二个if</log>
											<function>
												<set name="strlink" value="context.openflowserverobj.getShortestPath(context.srcdevicedpid.toString(), context.dstdevicedpid.toString())"/>									
												<log><![CDATA[strlink = <%=context.strlink.toString()%>]]></log>
												<script><![CDATA[
														if (context.strlink.toString().length>0)
														{
															context.print("进入js 第一个if");
															var info = JSON.parse(context.strlink.toString());
															if (info.paths.length == 1)
															{
																context.print("进入js 第二个if");
																var array = new Object();
																array.one = "of:" + context.srcdevicedpid.toString() + "/" + info.paths[0].src.port;
																array.two = "of:" + context.dstdevicedpid.toString() + "/" + info.paths[0].dst.port;
																array.type = "Direct";
																array._iconid_state = "active";
																array.direction = "A &harr; B";
																array.durable = "false";
																var strjson=JSON.stringify(array);
																context.linklist.addValue(strjson);
																context.binvalidlink.setValue('true');
															}
															else 
															{	
																context.binvalidlink.setValue('false');
															}
														}
														else 
														{
															context.binvalidlink.setValue('false');
														}
												]]></script>
												<function>
													<if cond="context.binvalidlink.toString()=='true'">
														<then>
															<function>
																<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
																	<jsonsrc src="linkarray"/>
																</websocket>
															</function>
														</then>
													</if>
												</function>
											</function>
										</then>
									</if>
								</for>
							</function>
						</function>
					</for>
					<log><![CDATA[linklist size=<%=context.linklist.size()%>]]></log>
					<script><![CDATA[				
						var json = new Object();
						var myArray=new Array();
						
						//	qiulei 20170918
						var firstString=context.linklist.getFirst();
						while(firstString!=null){
							var jsoninfo = JSON.parse(firstString);
							myArray.push(jsoninfo);
							
							firstString=context.linklist.getNext();
						}
						
						json['event'] = "linkDataResponse";							
						var payload = new Object();
						payload['links'] = myArray;				
						var annots_arr = new Array();
						var paytwoarray = new Object();
						paytwoarray.no_rows_msg = "No links found";
						annots_arr.push(paytwoarray);
						payload['annots'] = annots_arr;	
						json['payload'] = payload;				
						var strjson=JSON.stringify(json);				
						context.linkarray.setValue(strjson);				
						context.print(strjson);
						context.binvalidlink.setValue(true);
					]]></script>
				</function>
				
				
				<if cond="context.binvalidlink.toBoolean()==true">
					<then>
						<function>
							<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
								<jsonsrc src="linkarray"/>
							</websocket>
						</function>
					</then>
				</if>
			</function>
			<!--Send Request Device Detail information -->
			
			
			
			
			
			<!--hupeng 20170818 send label 4pps-->
			
			<function name="sendhighlights">
				<parameters>
					<parameter name="transportid" type="string"/>
					<parameter name="trafficType" type="string"/>
				</parameters>
				<variable name="binvalidlink" type="boolean" value="false"/>
				<variable name="srcdevicedpid" type="string"/>
				<variable name="dstdevicedpid" type="string"/>
				<variable name="strlink" type="string" value=""/>	
				<variable name="linkarray" type="string"/>				
				<container name="linklist" type="list" valuetype="string"/>
				<variable name="srcdevice" type="class"/>
				<variable name="dstdevice" type="class"/>
				<log><![CDATA[sendhighlights!!!!!!!!!!!!!!! size=<%=context.deviceContainer.size()%>]]></log>
				<function>
					<container name="oneDevicePair" type="pair" keytype="string" valuetype="class"/>
					<for var="oneDevicePair" in="context.deviceContainer">
						<function>
							<set name="srcdevice" value="context.oneDevicePair.second()"/>
							<if cond="context.srcdevice != null">
								<then>
									<function name="GetDatapathId" class="srcdevice">
										<parameters>
											<parameter name="outdatapathid" type="string" out="srcdevicedpid"/>
										</parameters>
									</function>
								</then>
							</if>	
							<function>
								<container name="oneDevicePair2" type="pair" keytype="string" valuetype="class"/>
								<for var="oneDevicePair2" in="context.deviceContainer">
									<set name="dstdevice" value="context.oneDevicePair2.second()"/>
									
									<if cond="context.dstdevice != null">
										<then>
											<function name="GetDatapathId" class="dstdevice">
												<parameters>
													<parameter name="outdatapathid" type="string" out="dstdevicedpid"/>
												</parameters>
											</function>
										</then>
									</if>
									<if cond="context.srcdevicedpid.toString()!=context.dstdevicedpid.toString()">
										<then>
											<function>
												<set name="strlink" value="context.openflowserverobj.getShortestPath(context.srcdevicedpid.toString(), context.dstdevicedpid.toString())"/>									
												<script><![CDATA[
														if (context.strlink.toString().length>0)
														{
															var info = JSON.parse(context.strlink.toString());
															if (info.paths.length == 1)
															{
																context.binvalidlink.setValue("true");										
																if (context.trafficType.toString()=="portStatsPktSec")
																{
																	var onearray = new Object();
																	onearray.id = "of:" + context.srcdevicedpid.toString()  + "/" + info.paths[0].src.port +"-of:" + context.dstdevicedpid.toString() + "/" + info.paths[0].dst.port;
																	onearray.label = "4pps";
																	onearray.css = "secondary port-traffic-green";	
																	var strjson=JSON.stringify(onearray);
																	context.linklist.addValue(strjson);
																}
																
															}
															else 
															{	
																context.binvalidlink.setValue('false');
															}
														}
														else 
														{
															context.binvalidlink.setValue('false');
														}
												
												]]></script>
												
											</function>
										</then>
									</if>
								</for>
							</function>
						</function>
					</for>
					<log><![CDATA[linklist size=<%=context.linklist.size()%>]]></log>
					<script><![CDATA[				
						var json = new Object();
						var myArray=new Array();
						
						//	qiulei 20170918 am
						var firstString=context.linklist.getFirst();
						while(firstString!=null){
							
							var jsoninfo = JSON.parse(firstString);
							myArray.push(jsoninfo);
							
							firstString=context.linklist.getNext();
						}
						
						json['event'] = "showHighlights";							
						var payload = new Object();
						var devices = new Array();	
						payload['devices'] = devices;	
						var hosts = new Array();
						payload['hosts'] = hosts;
						payload['links'] = myArray;						
						json['payload'] = payload;				
						var strjson=JSON.stringify(json);				
						context.linkarray.setValue(strjson);				
						context.print(strjson);
						
						
					]]></script>
				</function>
					<function>
							<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
								<jsonsrc src="linkarray"/>
							</websocket>
					</function>
					
			</function>
			
			<function name="SendDetails">	
				<parameters>	
					<parameter name="transportid" type="string"/>
					<parameter name="datapathid" type="string"/>	
				</parameters>
				<variable name="deviceobject" type="class"/>
				<set name="deviceobject" value="thisclass.deviceContainer.getValue(context.datapathid.toString())"/>
				<if cond="context.deviceobject != null">
					<then>
						<function name="SendDetails" class="deviceobject">
							<parameters>
								<parameter name="transportid" type="string" in="context.transportid.toString()"/>
							</parameters>	
						</function>
					</then>
				</if>
			</function>
			<!--Send Packet To All Port By DeviceId-->
			<function name="PacketOutToAllPort">	
				<parameters>
					<parameter name="datapathid" type="string"/>
					<parameter name="inportid" type="string"/>	
					<parameter name="pkoutjson" type="string"/>
					<parameter name="msgblock" type="messageblock"/>
				</parameters>
				<variable name="device" type="class"/>
				<log>PacketOutToAllPort !!!!!!!!!!!!!!</log>
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())">
					<then>
						<set name="device" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
						<if cond="context.device != null">
							<then>
								<function name="PacketOutToAllPort" class="context.device">
									<parameters>	
										<parameter name="inportid" type="string" in="context.inportid.toString()"/>	
										<parameter name="pkoutjson" type="string" in="context.pkoutjson.toString()"/>
										<parameter name="msgblock" type="messageblock" in="context.msgblock"/>								
									</parameters>
								</function>	
							</then>
						</if>
					</then>
				</if>
			</function>
			
			<!--
				PacketOutToAllDevicePort function Author: qiulei
				Date: 20170912 am
				effect(作用):向所有设备上的端口发,
				thinking analysis(思路分析):通过deviceContainer 遍历所有device,
											得到device对象调用该对象的PacketOutToAllPort方法向device设备上的所有端口发,-->
			<function name="PacketOutToAllDevicePort">	
				<parameters>
					<parameter name="inportid" type="string"/>	
					<parameter name="pkoutjson" type="string"/>
					<parameter name="msgblock" type="messageblock"/>
				</parameters>
				
				<variable name="device" type="class"/>
				
				<container name="oneDevicePair" type="pair" keytype="string" valuetype="class"/>
				<for var="oneDevicePair" in="context.deviceContainer">
					<function>
						<set name="device" value="context.oneDevicePair.second()"/>
					
						<if cond="context.device != null">
							<function name="PacketOutToAllPort" class="context.device">
								<parameters>	
									<parameter name="inportid" type="string" in="context.inportid.toString()"/>	
									<parameter name="pkoutjson" type="string" in="context.pkoutjson.toString()"/>
									<parameter name="msgblock" type="messageblock" in="context.msgblock"/>								
								</parameters>
							</function>
						</if>
					</function>
				</for>
			</function>

			
			<!--qiulei 2017.08.23   Send Packet To one Port By DeviceId   -->
			<function name="PacketOutToPort">
				<parameters>
					<parameter name="outputport" type="string"/>
					<parameter name="pkoutjson" type="string"/>
					<parameter name="msgblock" type="messageblock"/>
					<parameter name="inportid" type="string"/>
					<parameter name="datapathid" type="string"/>
				</parameters>
				<variable name="device" type="class"/>
				<log>PacketOutToPort !!!!!!!!!!!!!!</log>
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())">
					<then>
						<set name="device" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
						<if cond="context.device != null">
							<then>
								<function name="PacketOutToPort" class="context.device">
									<parameters>
										<parameter name="outputport" type="string" in="context.outputport.toString()"/>
										<parameter name="pkoutjson" type="string" in="context.pkoutjson.toString()"/>
										<parameter name="msgblock" type="messageblock" in="context.msgblock"/>
										<parameter name="inportid" type="string" in="context.inportid.toString()"/>
									</parameters>
								</function>
							</then>
						</if>
					</then>
				</if>
			</function>
			
			<function name="GetDatapathId">	
				<parameters>	
					<parameter name="transportid" type="string"/>
				</parameters>
				<variable name="device" type="class"/>				
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())">
					<then>
						<set name="device" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
						<if cond="context.device != null">
							<then>
								<function name="PacketOutToAllPort" class="context.device">
									<parameters>	
										<parameter name="inportid" type="string" in="context.inportid.toString()"/>	
										<parameter name="pkoutjson" type="string" in="context.pkoutjson.toString()"/>	
									</parameters>
								</function>	
							</then>
						</if>	
					</then>
				</if>			
			</function>
			<function name="SendTableRequest">
				<variable name="device" type="class"/>
				
				
				<container name="oneDevicePair" type="pair" keytype="string" valuetype="class"/>
				<for var="oneDevicePair" in="context.deviceContainer">
					<function>
						<set name="device" value="context.oneDevicePair.second()"/>
						<if cond="context.device != null">
							<then>
								<function name="SendTableRequest" class="device"/>
							</then>
						</if>
					</function>
				</for>
			</function>
			<function name="GetPortsStateJsonData">	
				<parameters>
					<parameter name="datapathid" type="string"/>
					<parameter name="jsonstring" type="string"/>
				</parameters>
				<variable name="device" type="class"/>
				<log>GetPortsStateJsonData !!!!!!!!!!!!!!</log>
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())">
					<then>
						<set name="device" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
						<if cond="context.device != null">
							<then>
								<function name="GetPortsStateJsonData" class="context.device">
									<parameters>	
										<parameter name="jsonstring" type="string" out="context.jsonstring"/>
									</parameters>
								</function>	
							</then>
						</if>		
					</then>
				</if>
			</function>
			
			<!-- wangkang 2017/09/01 -->
			<function name="GetDeviceByTransportId">
				<log>##### Get Device By TransportId #####</log>
				<parameters>
					<parameter name="transportid" type="string"/>
					<parameter name="onedeviceobj" type="class"/>
				</parameters>
				<log><![CDATA[t2dContainer size=<%=context.t2dContainer.size()%>]]></log>
				<function name="DumpT2d"/>
				
				<variable name="datapathid" type="string"/>
				<set name="datapathid" value="context.t2dContainer.getValue(context.transportid.toString())"/>
				<set name="onedeviceobj" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
				<log><![CDATA[GetDeviceByTransportId datapathid=<%=context.datapathid.toString()%>]]></log>
				<log><![CDATA[GetDeviceByTransportId transportid=<%=context.transportid.toString()%>]]></log>
			</function>
			<function name="DumpT2d">
				<variable name="t2dkey" type="string"/>
				<log>===========DumpT2dStart===============</log>
				
				
				<container name="oneDevicePair" type="pair" keytype="string" valuetype="string"/>
				<for var="oneDevicePair" in="context.t2dContainer">
					<set name="t2dkey" value="context.oneDevicePair.first()"/>
					<log><![CDATA[t2dkey=<%=context.t2dkey.toString()%>]]></log>
				</for>
				<log>===========DumpT2dEnd===============</log>
			</function>
			
			<!-- qiulei 20170912 am  Get the number of devices-->
			<function name="GetDeviceCounts">
				<parameters>
					<parameter name="deviceCounts" type="long"/>	
				</parameters>
				<set name="deviceCounts" value="context.deviceContainer.size()"/>	
			</function>
		</public>
	</class>
</starosxml>