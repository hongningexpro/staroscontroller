<?xml version="1.0" encoding="UTF-8"?>
<!--
	Copyright (C) 2013-2016 Nanjing StarOS Technology Co., Ltd
	All rights reserved.
	
	@file 		Capplicatpn。xml
	@brief 		device管理
	@version 	1.1.0
	@auth 		qiulei
	@date		2017/11/27

	Licensed under the Apache License, Version 2.0 (the "License");
	you may not use this file except in compliance with the License.
	You may obtain a copy of the License at

	http://www.apache.org/licenses/LICENSE-2.0

	Unless required by applicable law or agreed to in writing, software
	distributed under the License is distributed on an "AS IS" BASIS,
	WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
	See the License for the specific language governing permissions and
	limitations under the License.
-->
<starlang xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
	<class name="CDeviceManager" extends="CListenerBase">
		<private>
			<hashmap name="deviceContainer" keytype="string" valuetype="object"/>
			<hashmap name="t2dContainer" keytype="string" valuetype="string"/>
		</private>
		<public>
			<function name="CDeviceManager">
				<log>CDeviceManager is create</log>
			</function>
			<!--qiulei 20171117pm-->
			<!--
				@brief		以json字符创返回所有device
				@auth 		qiulei
				@date		2017/11/27 pm
				Input:
				Output:     AllDevicesJsonString
			-->
			<function name="AllDevicesToJsonStr">
				<parameters>
					<string name="AllDevicesJsonString"/>
				</parameters>
				
				<string name="jsonstr"/>
				<object name="switchdevice"/>
				<list name="deviceinfolist" valuetype="string"/>
				
				<pair name="oneDevicePair" keytype="string" valuetype="object"/>
				<for var="oneDevicePair" in="context.deviceContainer">
					<function>
						<set name="switchdevice" value="context.oneDevicePair.second()"/>
						<if cond="context.switchdevice != null">
							<then>
								<function name="GetDeviceInfoForDetailRequest" class="context.switchdevice">
									<parameters>
										<string name="strjson" out="jsonstr"/>
									</parameters>
								</function>
								<insert name="deviceinfolist" value="context.jsonstr.toString()"/>
							</then>
						</if>	
						
					</function>
				</for>
				
				<script><![CDATA[
					var jsonroot = new Object();
					var myArray=new Array();  
					
					var firstString=context.deviceinfolist.getFirst();
					while(firstString!=null){
						var onearray = JSON.parse(firstString);
						myArray.push(onearray);
						firstString=context.deviceinfolist.getNext();
					}
					
					jsonroot['devices']=myArray;
					jsonroot['resultCode']="0";
					jsonroot["resultDesc"]="ok";
					
					var strjson=JSON.stringify(jsonroot);
					context.AllDevicesJsonString.setValue(strjson);
				]]></script>
			</function>
			
			
			
			<!--
				@brief		传入datapathid,返回device对象
				@auth 		qiulei
				@date		2017/11/27 pm
				Input:
				Output:
			-->
			<function name="getDevice">
				<parameters>
					<object name="outdevice"/>
					<string name="datapathid"/>
				</parameters>
				
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())">
					<then>
						<function>
							<set name="outdevice" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
						</function>
						<if cond="context.outdevice==null">
							<then>
								<log>insert second if</log>
								<log>outdevice is null</log>
							</then>
						</if>
					</then>
				</if>
			</function>
			
			<!--
				@brief		添加device
				@auth 		qiulei
				@date		2017/11/27 pm
				Input:
				Output:
			-->
			<function name="addDevice">
				<parameters>
					<string name="mfrdesc"/>
					<string name="swdesc"/>
					<string name="serialnum"/>
					<string name="dpdesc"/>
					<string name="hwdesc"/>
					<string name="transportid"/>
					<string name="datapathid"/>
					<string name="localipaddr"/>
					<string name="peeripaddr"/>
					<string name="type"/>
					<string name="online"/>
					<string name="protocol"/>	
				</parameters>
				<log level="100">addDevice start</log>			
				<object name="deviceobject"/>
				<string name="outtransid"/>
				<log level="100"><![CDATA[CDeviceManager deviceContainer  = <%=thisclass.deviceContainer.size().toString()%>]]></log>
				<log level="100"><![CDATA[CDevice addDevice datapathid = <%=context.datapathid.toString()%>]]></log>
				<if cond="context.datapathid.toString() == ''">
					<then>
						<exit/>
					</then>
				</if>
				<if cond="thisclass.deviceContainer.hasValue(context.datapathid.toString()) == true">
					<then>
						<log level="100">this device already have</log>
						<lookup name="thisclass.deviceContainer" key="context.datapathid.toString()" output="context.deviceobject"/>
					</then>
					<else>
						<new name="deviceobject" class="CDevice">
							<parameters>
								<string name="mfrdesc" in="context.mfrdesc.toString()"/>
								<string name="swdesc" in="context.swdesc.toString()"/>
								<string name="serialnum" in="context.serialnum.toString()"/>
								<string name="dpdesc" in="context.dpdesc.toString()"/>
								<string name="hwdesc" in="context.hwdesc.toString()"/>
								<string name="transportid" in="context.transportid.toString()"/>
								<string name="datapathid" in="context.datapathid.toString()"/>
								<string name="localipaddr" in="context.localipaddr.toString()"/>
								<string name="peeripaddr" in="context.peeripaddr.toString()"/>	
								<string name="type" in="context.type.toString()"/>
								<string name="online" in="context.online.toString()"/>
								<string name="protocol" in="context.protocol.toString()"/>	
							</parameters>
						</new>
						<remove name="deviceContainer" key="context.datapathid.toString()"/>
						<insert name="deviceContainer" key="context.datapathid.toString()" value="context.deviceobject"/>
						<remove name="t2dContainer" key="context.transportid.toString()"/>
						<insert name="t2dContainer" key="context.transportid.toString()" value="context.datapathid.toString()"/>
						<log level="100"><![CDATA[CDeviceManager deviceContainer  = <%=thisclass.deviceContainer.size().toString()%>]]></log>
					</else>
				</if>
				<string name="functionname"/>
				<for var="context.functionname" in="context.listernellist">
					<function callback="functionname">
						<parameters>
								<string name="type" in="'add'"/>
								<object name="deviceobj" in="context.deviceobject"/>					
						</parameters>
					</function>		
				</for>

				<string name="onlinejson"/>
	
				<log level="100">ClearFlow start</log>
				<function name="ClearFlow" class="deviceobject"/>				
				<wait event="NorFoundEvent" timeout="3000"/>
				<log level="100">ClearFlow end</log>
			
				<function name="SendDefaultFlow" class="deviceobject"/>

				<function name="ToOnlineJson" class="deviceobject">
					<parameters>
						<string name="strjson" out="onlinejson"/>
					</parameters>
				</function>
				<function name="SendToAllClient" class="WebSocketManager">
					<parameters>
						<string name="strjson" in="context.onlinejson.toString()"/>
					</parameters>
				</function>
				<function name="GetTransportId" class="deviceobject">
					<parameters>
						<string name="outtransport" out="outtransid"/>
					</parameters>
				</function>
				<log>star device end</log>
				<function name="ProcessAddDeviceEvent" class="DeviceService">
					<parameters>
						<string name="datapathid" in="context.datapathid.toString()"/>
					</parameters>
				</function>									
			</function>
			
			
			<!--
				@brief		根据datapathid,找到device对象
				@auth 		qiulei
				@date		2017/11/28 pm
				Input:
				Output:
			-->
			<function name="findDevice">
				<parameters>
					<string name="datapathid"/>
					<object name="deviceobject"/>
				</parameters>
				<object name="deviceinfo"/>
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())==true">
					<then>
						<function>
							<lookup name="deviceContainer" key="context.datapathid.toString()" output="context.deviceinfo"/>
						</function>
					</then>
				</if>
				<if cond="context.deviceinfo != null">
					<then>
						<set name="deviceobject" value="context.deviceinfo"/>
					</then>
				</if>	
			</function>
			
			
			<!--
				@brief		根据datapathid,删除device对象
				@auth 		qiulei
				@date		2017/11/28 pm
				Input:
				Output:
			-->
			<function name="removeDevice">
				<parameters>
					<string name="datapathid"/>
				</parameters>
				<object name="deviceobject"/>
				<string name="offlinejson"/>
				<string name="devicetransportid"/>
				<log level="100"> CDeviceManager removeDevice </log>
				<function name="ProcessRemoveDeviceEvent" class="DeviceService">
					<parameters>
						<string name="datapathid" in="context.datapathid.toString()"/>
					</parameters>
				</function>
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())==true">
					<then>
						<function>
							<lookup name="deviceContainer" key="context.datapathid.toString()" output="context.deviceobject"/>
							<if cond="context.deviceobject.ptr == null">
								<then>
									<exit/>
								</then>
							</if>
							<string name="functionname"/>
							<for var="context.functionname" in="context.listernellist">
								<function callback="functionname">
									<parameters>
										<string name="type" in="'remove'"/>
										<object name="deviceobj" in="context.deviceobject"/>					
									</parameters>
								</function>		
							</for>
							<function name="ToOfflineJson" class="deviceobject">
								<parameters>
									<string name="strjson" out="offlinejson"/>
								</parameters>
							</function>
							<function name="SendToAllClient" class="WebSocketManager">
								<parameters>
									<string name="strjson" in="context.offlinejson.toString()"/>
								</parameters>
							</function>
							<function name="GetTransportId" class="deviceobject">
								<parameters>
									<string name="outtransport" out="context.devicetransportid"/>
								</parameters>
							</function>
							<remove name="deviceContainer" key="context.datapathid.toString()"/>
							<remove name="t2dContainer" key="context.devicetransportid.toString()"/>
						</function>
					</then>
				</if>
			</function>
			
			<!--
				@brief		根据Transportid,得到datapathid
				@auth 		qiulei
				@date		2017/11/28
				Input:
				Output:
			-->
			<function name="GetDatapathIdByTransportid">
				<parameters>
					<string name="transportid"/>
					<string name="datapathid"/>
				</parameters>
				<set name="datapathid" value="context.t2dContainer.getValue(context.transportid.toString())"/>
			</function>
			
			<!--
				@brief		根据datapathid找到transportid
				@auth 		qiulei
				@date		2017/11/28 pm
				Input:
				Output:
			-->
			<function name="GetTransportIdFromDevice">
				<parameters>
					<string name="datapathid"/>
					<string name="transportid"/>
				</parameters>
				<object name="deviceinfo"/>
				<string name="devicedatapathid"/>
				<!--qiulei 20170821 Monday am-->
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())">
					<then>
						<function>
							<set name="deviceinfo" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
							<!--qiulei 20170908 add if judge-->
							<if cond="context.deviceinfo != null">
								<then>
									<function name="GetTransportId" class="deviceinfo">
										<parameters>
											<string name="outtransport" out="transportid"/>
										</parameters>
									</function>
								</then>
							</if>
						</function>
					</then>
				</if>
			</function>
			
			<!--
				@brief		根据transportid,删除device
				@auth 		qiulei
				@date		2017/11/28 pm
				Input:
				Output:
			-->
			<function name="removeDeviceByTransportId">
				<parameters>
					<string name="transportid"/>
				</parameters>
				<object name="deviceinfo"/>
				<string name="devicetransportid"/>
				<string name="devicedatapathid"/>
				<string name="oneremove"/>
				<list name="removelist" valuetype="string"/>
				<log level="100">CDeviceManager removeDeviceByTransportId</log>
				<pair name="oneapppair" keytype="string" valuetype="object"/>
				<for var="oneapppair" in="context.deviceContainer">
					<function>
						<set name="deviceinfo" value="context.oneapppair.second()"/>
						
						<if cond="context.deviceinfo != null">
							<then>
								<function name="GetTransportId" class="deviceinfo">
									<parameters>
										<string name="outtransport" out="context.devicetransportid"/>
									</parameters>
								</function>
							</then>
						</if>
						<if cond="context.devicetransportid.toString() == context.transportid.toString()">
							<then>
								<function name="GetDatapathId" class="deviceinfo">
									<parameters>
										<string name="outdatapathid" out="context.devicedatapathid"/>
									</parameters>
								</function>
								<log level="100"><![CDATA[removeDevice datapathid= <%=context.devicedatapathid.toString()%>]]></log>
								<insert name="removelist" value="context.devicedatapathid.toString()"/>
							</then>
						</if>
					</function>
				</for>
				<for var="oneremove" in="context.removelist">
					<function>
						<function name="removeDevice">
							<parameters>
								<string name="datapathid" in="context.oneremove.toString()"/>
							</parameters>
						</function>
					</function>
				</for>
			</function>
			
			<!--
				@brief		将添加的所有device发送到前端
				@auth 		qiulei
				@date		2017/11/28 pm
				Input:
				Output:
			-->
			<function name="SendAddAllDeviceToWebClient">
				<parameters>
					<string name="transportid"/>
				</parameters>
				<string name="jsonstr"/>
				<object name="switchdevice"/>
				
				<pair name="oneapppair" keytype="string" valuetype="object"/>
				<for var="oneapppair" in="context.deviceContainer">
					<function>
						<set name="switchdevice" value="context.oneapppair.second()"/>
						
						<if cond="context.switchdevice != null">
							<then>
								<function name="ToAddDeviceJson" class="context.switchdevice">
									<parameters>
										<string name="strjson" out="jsonstr"/>
									</parameters>
								</function>
							</then>
						</if>
						<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
							<jsonsrc src="jsonstr"/>
						</websocket>
					</function>
				</for>
			</function>
			
			<!--
				@brief		将添加的所有Link发送到前端
				@auth 		qiulei
				@date		2017/11/28 pm
				Input:
				Output:
			-->
			<function name="SendAddAllLinkToWebClient">
				<parameters>
					<string name="transportid"/>
				</parameters>
				<log level="100">2017.09.18 enter CDeviceManager.SendAddAllLinkToWebClient method</log>
				<object name="srcdevice"/>
				<object name="dstdevice"/>
				<string name="srcport"/>
				<string name="srcdevicedpid"/>
				<string name="dstdevicedpid"/>
				<string name="dstport"/>
				<string name="json"/>
				<string name="strlink" value=""/>
				<string name="binvalidlink" value="false"/>
				<string name="srcdevicedpid2"/>
				<pair name="oneDevicePair2" keytype="string" valuetype="object"/>
				<pair name="oneDevicePair1" keytype="string" valuetype="object"/>
				<list name="listsrcdevice" valuetype="string"/>
				<for var="oneDevicePair1" in="context.deviceContainer">
					<function>
						<set name="srcdevice" value="context.oneDevicePair1.second()"/>
						<if cond="context.srcdevice != null">
							<then>
								<function name="GetDatapathId" class="srcdevice">
									<parameters>
										<string name="outdatapathid" out="srcdevicedpid"/>
									</parameters>
								</function>
								<insert name="listsrcdevice" value="context.srcdevicedpid.toString()"/>
							</then>
						</if>
					</function>
				</for>
				<for var="srcdevicedpid2" in="context.listsrcdevice">
					<function>
						<for var="oneDevicePair2" in="context.deviceContainer">
							<set name="dstdevice" value="context.oneDevicePair2.second()"/>
							<log>2017.09.18 enter CDeviceManager.SendAddAllLinkToWebClient method    ent inner for</log>
							<if cond="context.dstdevice != null">
								<then>
									<function name="GetDatapathId" class="dstdevice">
										<parameters>
											<string name="outdatapathid" out="dstdevicedpid"/>
										</parameters>
									</function>
								</then>
							</if>
							<if cond="context.srcdevicedpid2.toString()!=context.dstdevicedpid.toString()">
								<then>
									<function>
										<set name="strlink" value="context.openflowserverobj.ptr.getShortestLink(context.srcdevicedpid2.toString(), context.dstdevicedpid.toString())"/>
										<log leve="1"><![CDATA[strlink=<%=context.strlink.toString()%>]]></log>
											
											<script><![CDATA[
													if (context.strlink.toString().length>0)
													{
														var info = JSON.parse(context.strlink.toString());
														if (info.paths.length==1)
														{
															context.dstport.setValue(info.paths[0].dst.port);
															context.srcport.setValue(info.paths[0].src.port);
															context.binvalidlink.setValue('true');
														}
														else 
														{	
															context.binvalidlink.setValue('false');
														}
													}
													else 
													{
														context.binvalidlink.setValue('false');
													}
											]]></script>
											<function>
												<if cond="context.binvalidlink.toString()=='true'">
													<then>
														<function>
															<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
																<jsonbody>
																	<![CDATA[
																	{
																	"event":"addLink","payload":
																	{"id":"of:<%=context.srcdevicedpid2.toString()%>/<%=context.srcport.toString()%>-of:<%=context.dstdevicedpid.toString()%>/<%=context.dstport.toString()%>",
																	"type":"direct",
																	"expected":false,
																	"online":true,
																	"linkWidth":1.2,
																	"src":"of:<%=context.srcdevicedpid2.toString()%>",
																	"srcPort":"<%=context.srcport.toString()%>",
																	"dst":"of:<%=context.dstdevicedpid.toString()%>",
																	"dstPort":"<%=context.dstport.toString()%>"
																	}
																	}
																					]]>
																</jsonbody>
															</websocket>
														</function>
													</then>
												</if>
											</function>
									</function>
								</then>
							</if>
						</for>
					</function>
				</for>
			</function>
			
			<!--
				@brief		发送device信息到前端
				@auth 		qiulei
				@date		2017/11/28
				Input:
				Output:
			-->
			<function name="SendDeviceInfoToWebClient">
				<parameters>
					<string name="transportid"/>
				</parameters>
				<string name="jsonstr"/>
				<string name="sendjsonstr"/>
				<object name="switchdevice"/>
				<list name="deviceinfolist" valuetype="string"/>
				<pair name="oneDevicePair_sendinfo" keytype="string" valuetype="object"/>
				<for var="oneDevicePair_sendinfo" in="context.deviceContainer">
					<function>
						<set name="switchdevice" value="context.oneDevicePair_sendinfo.second()"/>
						<if cond="context.switchdevice != null">
							<then>
								<function name="GetDeviceInfoJson" class="context.switchdevice">
									<parameters>
										<string name="strjson" out="jsonstr"/>
									</parameters>
								</function>
								<insert name="deviceinfolist" value="context.jsonstr.toString()"/>
							</then>
						</if>	
						
					</function>
				</for>
				<script><![CDATA[
					var json = new Object();
					var myArray=new Array();  
					
					
					//	qiulei 20170918
					var firstString=context.deviceinfolist.getFirst();
					while(firstString!=null){
						var onearray = JSON.parse(firstString);
						myArray.push(onearray);
						firstString=context.deviceinfolist.getNext();
					}
					
					json['event']='deviceDataResponse';
					
					var payload = new Object();
					payload['devices']=myArray;
					
					var annots = new Object();
					annots['no_rows_msg']='No devices found';
					payload['annots']=annots;
					json['payload']=payload;
					var strjson=JSON.stringify(json);
					context.sendjsonstr.setValue(strjson);
				]]></script>
				<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
					<jsonsrc src="sendjsonstr"/>
				</websocket>
			</function>
			
			<!--
				@brief		发送device详细信息到前端
				@auth 		qiulei
				@date		2017/11/28
				Input:
				Output:
			-->
			<function name="SendDetailDeviceInfoToWebClient">
				<parameters>
					<string name="transportid"/>
				</parameters>
				<string name="jsonstr"/>
				<string name="sendjsonstr"/>
				<object name="switchdevice"/>
				<list name="deviceinfolist" valuetype="string"/>
				<pair name="oneDevicePair_senddetail" keytype="string" valuetype="object"/>
				<for var="oneDevicePair_senddetail" in="context.deviceContainer">
					<function>
						<set name="switchdevice" value="context.oneDevicePair_senddetail.second()"/>
						<if cond="context.switchdevice != null">
							<then>
								<function name="GetDeviceInfoJson" class="context.switchdevice">
									<parameters>
										<string name="strjson" out="jsonstr"/>
									</parameters>
								</function>
							</then>
						</if>
						<insert name="deviceinfolist" value="context.jsonstr.toString()"/>
					</function>
				</for>
				<script><![CDATA[
					var json = new Object();
					var myArray=new Array();  
					
					
					//	qiulei 20170918
					var firstString=context.deviceinfolist.getFirst();
					while(firstString!=null){
						var onearray = JSON.parse(firstString);
						myArray.push(onearray);
						firstString=context.deviceinfolist.getNext();
					}
					
					json['event']='deviceDataResponse';
					
					var payload = new Object();
					payload['devices']=myArray;
					
					var annots = new Object();
					annots['no_rows_msg']='No devices found';
					payload['annots']=annots;
					json['payload']=payload;
					var strjson=JSON.stringify(json);
					context.sendjsonstr.setValue(strjson);
				]]></script>
				<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
					<jsonsrc src="sendjsonstr"/>
				</websocket>
			</function>
			
			<!--
				@brief		监听
				@auth 		qiulei
				@date		2017/11/28
				Input:
				Output:
			-->
			<function name="Detect">
				<object name="thisswitch"/>
				<string name="transportid"/>
				<log>Device Manager Detect</log>
				
				<pair name="oneDevicePair_Detect" keytype="string" valuetype="object"/>
				<for var="oneDevicePair_Detect" in="context.deviceContainer">
					<function>
						<set name="thisswitch" value="context.oneDevicePair_Detect.second()"/>
						<if cond="context.thisswitch != null">
							<then>
								<function name="TimeOut" class="context.thisswitch"/>
							</then>
						</if>
					</function>
				</for>
				<!--SendPortState-->
				<log> SendPortStateRequest !!!!!!!!!!!!!!!!!!!</log>
				<!--function name="SendPortStateRequest"/-->
												<!--function name="SendFlowRequest"/-->
			</function>
			
			<!--
				@brief		device详细请求
				@auth 		qiulei
				@date		2017/11/28
				Input:
				Output:
			-->
			<function name="DeviceDetailsReqJson">
				<parameters>
					<string name="transportid"/>
					<string name="datapathid"/>
				</parameters>
				<object name="thisswitch"/>
				<string name="sendjsonstr"/>
				<set name="thisswitch" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
				<if cond="context.thisswitch != null">
					<then>
						<function name="ForDeviceDetailReqJson" class="thisswitch">
							<parameters>
								<string name="outjson" out="sendjsonstr"/>
							</parameters>
						</function>
					</then>
				</if>
				<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
					<jsonsrc src="sendjsonstr"/>
				</websocket>
			</function>
			<!--YY sendlinks 2017-08-18 -->
			<!--
				@brief		发送links
				@auth 		yy
				@date		2017/11/28
				Input:
				Output:
			-->
			<function name="SendLinks">
				<parameters>
					<string name="transportid"/>
				</parameters>
				<boolean name="binvalidlink" value="false"/>
				<string name="srcport"/>
				<string name="srcdevicedpid"/>
				<string name="dstdevicedpid"/>
				<string name="dstport"/>
				<string name="strlink" value=""/>	
				<string name="linkarray"/>
				<list name="linklist" valuetype="string"/>
				<object name="srcdevice"/>
				<object name="dstdevice"/>
				<pair name="oneDevicePair2" keytype="string" valuetype="object"/>
				<pair name="oneDevicePair_sendlink" keytype="string" valuetype="object"/>
				<list name="listdevice" valuetype="string"/>
				<function>	
					<for var="oneDevicePair_sendlink" in="context.deviceContainer">
						<function>
						<log>2017.9.18 oneDevicePair </log>
							<set name="srcdevice" value="context.oneDevicePair_sendlink.second()"/>
							<if cond="context.srcdevice != null">
								<then>
								
									<function name="GetDatapathId" class="srcdevice">
										<parameters>
											<string name="outdatapathid" out="srcdevicedpid"/>
										</parameters>
									</function>
									<insert name="listdevice" value="context.srcdevicedpid.toString()"/>
								</then>
							</if>
						</function>
					</for>							
							<for var="srcdevicedpid" in="context.listdevice">
								<function>
								<for var="oneDevicePair2" in="context.deviceContainer">
									<set name="dstdevice" value="context.oneDevicePair2.second()"/>
									<if cond="context.dstdevice != null">
										<then>
											<function name="GetDatapathId" class="dstdevice">
												<parameters>
													<string name="outdatapathid" out="dstdevicedpid"/>
												</parameters>
											</function>
										</then>
									</if>
									<if cond="context.srcdevicedpid.toString()!=context.dstdevicedpid.toString()">
										<then>
											<function>
												<set name="strlink" value="context.openflowserverobj.ptr.getShortestLink(context.srcdevicedpid.toString(), context.dstdevicedpid.toString())"/>																		
												<script><![CDATA[
														if (context.strlink.toString().length>0)
														{
															var info = JSON.parse(context.strlink.toString());
															if (info.paths.length == 1)
															{
																var array = new Object();
																array.one = "of:" + context.srcdevicedpid.toString() + "/" + info.paths[0].src.port;
																array.two = "of:" + context.dstdevicedpid.toString() + "/" + info.paths[0].dst.port;
																array.type = "Direct";
																array._iconid_state = "active";
																array.direction = "A &harr; B";
																array.durable = "false";
																var strjson=JSON.stringify(array);
																context.linklist.addValue(strjson);
																context.binvalidlink.setValue('true');
															}
															else 
															{	
																context.binvalidlink.setValue('false');
															}
														}
														else 
														{
															context.binvalidlink.setValue('false');
														}
												]]></script>
												<function>
													<if cond="context.binvalidlink.toString()=='true'">
														<then>
															<function>
																<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
																	<jsonsrc src="linkarray"/>
																</websocket>
															</function>
														</then>
													</if>
												</function>
											</function>
										</then>
									</if>
								</for>
							</function>
						</for>
					<script><![CDATA[				
						var json = new Object();
						var myArray=new Array();
						
						//	qiulei 20170918
						var firstString=context.linklist.getFirst();
						while(firstString!=null){
							var jsoninfo = JSON.parse(firstString);
							myArray.push(jsoninfo);
							
							firstString=context.linklist.getNext();
						}
						
						json['event'] = "linkDataResponse";							
						var payload = new Object();
						payload['links'] = myArray;				
						var annots_arr = new Array();
						var paytwoarray = new Object();
						paytwoarray.no_rows_msg = "No links found";
						annots_arr.push(paytwoarray);
						payload['annots'] = annots_arr;	
						json['payload'] = payload;				
						var strjson=JSON.stringify(json);				
						context.linkarray.setValue(strjson);
						context.binvalidlink.setValue(true);
					]]></script>
				</function>
				
				
				<if cond="context.binvalidlink.toBoolean()==true">
					<then>
						<function>
							<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
								<jsonsrc src="linkarray"/>
							</websocket>
						</function>
					</then>
				</if>
			</function>
			<!--Send Request Device Detail information -->
			
			
			
			
			
			<!--hupeng 20170818 send label 4pps-->
			<!--
				@brief		link显示流量
				@auth 		qiulei
				@date		2017/11/28
				Input:
				Output:
			-->
			<function name="sendhighlights">
				<parameters>
					<string name="transportid"/>
					<string name="trafficType"/>
				</parameters>
				<boolean name="binvalidlink" value="false"/>
				<string name="srcdevicedpid"/>
				<string name="dstdevicedpid"/>
				<string name="strlink" value=""/>	
				<string name="linkarray"/>
				<list name="linklist" valuetype="string"/>
				<object name="srcdevice"/>
				<object name="dstdevice"/>
				<list name="listdevice" valuetype="string"/>
				<pair name="oneDevicePair2" keytype="string" valuetype="object"/>
				<pair name="oneDevicePair_highlight" keytype="string" valuetype="object"/>
				<function>
					<for var="oneDevicePair_highlight" in="context.deviceContainer">
						<function>
							<set name="srcdevice" value="context.oneDevicePair_highlight.second()"/>
							<if cond="context.srcdevice != null">
								<then>
									<function name="GetDatapathId" class="srcdevice">
										<parameters>
											<string name="outdatapathid" out="srcdevicedpid"/>
										</parameters>
									</function>
								<insert name="listdevice" value="context.srcdevicedpid.toString()"/>
								</then>
							</if>	
							</function>
					</for>
					<for var="srcdevicedpid" in="context.listdevice">
						<function>
								<for var="oneDevicePair2" in="context.deviceContainer">
									<set name="dstdevice" value="context.oneDevicePair2.second()"/>
									
									<if cond="context.dstdevice != null">
										<then>
											<function name="GetDatapathId" class="dstdevice">
												<parameters>
													<string name="outdatapathid" out="dstdevicedpid"/>
												</parameters>
											</function>
										</then>
									</if>
									<if cond="context.srcdevicedpid.toString()!=context.dstdevicedpid.toString()">
										<then>
											<function>
												<set name="strlink" value="context.openflowserverobj.ptr.getShortestLink(context.srcdevicedpid.toString(), context.dstdevicedpid.toString())"/>									
												<script><![CDATA[
														if (context.strlink.toString().length>0)
														{
															var info = JSON.parse(context.strlink.toString());
															if (info.paths.length == 1)
															{
																context.binvalidlink.setValue("true");										
																if (context.trafficType.toString()=="portStatsPktSec")
																{
																	var onearray = new Object();
																	onearray.id = "of:" + context.srcdevicedpid.toString()  + "/" + info.paths[0].src.port +"-of:" + context.dstdevicedpid.toString() + "/" + info.paths[0].dst.port;
																	onearray.label = "4pps";
																	onearray.css = "secondary port-traffic-green";	
																	var strjson=JSON.stringify(onearray);
																	context.linklist.addValue(strjson);
																}
																
															}
															else 
															{	
																context.binvalidlink.setValue('false');
															}
														}
														else 
														{
															context.binvalidlink.setValue('false');
														}
												
												]]></script>
												
											</function>
										</then>
									</if>
								</for>
							</function>
						</for>
					<log><![CDATA[linklist size=<%=context.linklist.size().toString()%>]]></log>
					<script><![CDATA[				
						var json = new Object();
						var myArray=new Array();
						
						//	qiulei 20170918 am
						var firstString=context.linklist.getFirst();
						while(firstString!=null){
							
							var jsoninfo = JSON.parse(firstString);
							myArray.push(jsoninfo);
							
							firstString=context.linklist.getNext();
						}
						
						json['event'] = "showHighlights";							
						var payload = new Object();
						var devices = new Array();	
						payload['devices'] = devices;	
						var hosts = new Array();
						payload['hosts'] = hosts;
						payload['links'] = myArray;						
						json['payload'] = payload;				
						var strjson=JSON.stringify(json);				
						context.linkarray.setValue(strjson);								
						
						
					]]></script>
				</function>
					<function>
							<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
								<jsonsrc src="linkarray"/>
							</websocket>
					</function>
					
			</function>
			
			<!--
				@brief		发送详情
				@auth 		qiulei
				@date		2017/11/28
				Input:
				Output:
			-->
			<function name="SendDetails">	
				<parameters>	
					<string name="transportid"/>
					<string name="datapathid"/>
				</parameters>
				<object name="deviceobject"/>
				<set name="deviceobject" value="thisclass.deviceContainer.getValue(context.datapathid.toString())"/>
				<if cond="context.deviceobject.ptr != null">
					<then>
						<function name="SendDetails" class="deviceobject">
							<parameters>
								<string name="transportid" in="context.transportid.toString()"/>
							</parameters>	
						</function>
					</then>
				</if>
			</function>
			<!--Send Packet To All Port By DeviceId-->
			<!--
				@brief		向所有端口发送报文
				@auth 		qiulei
				@date		2017/11/28
				Input:
				Output:
			-->
			<function name="PacketOutToAllPort">	
				<parameters>
					<string name="datapathid"/>
					<string name="inportid"/>
					<string name="pkoutjson"/>
					<messageblock name="msgblock"/>
				</parameters>
				<object name="device"/>
				<log>PacketOutToAllPort !!!!!!!!!!!!!!</log>
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())">
					<then>
						<set name="device" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
						<if cond="context.device != null">
							<then>
								<function name="PacketOutToAllPort" class="context.device">
									<parameters>	
										<string name="inportid" in="context.inportid.toString()"/>	
										<string name="pkoutjson" in="context.pkoutjson.toString()"/>
										<messageblock name="msgblock" in="context.msgblock"/>								
									</parameters>
								</function>	
							</then>
						</if>
					</then>
				</if>
			</function>
			
			<!--
				PacketOutToAllDevicePort function Author: qiulei
				Date: 20170912 am
				effect(作用):向所有设备上的端口发,
				thinking analysis(思路分析):通过deviceContainer 遍历所有device,
											得到device对象调用该对象的PacketOutToAllPort方法向device设备上的所有端口发,-->
			<!--
				@brief		向device设备上的所有端口发送
				@auth 		qiulei
				@date		2017/11/28
				Input:
				Output:
			-->
			<function name="PacketOutToAllDevicePort">	
				<parameters>
					<string name="inportid"/>
					<string name="pkoutjson"/>
					<messageblock name="msgblock"/>
				</parameters>
				
				<object name="device"/>
				
				<pair name="oneDevicePair_packout" keytype="string" valuetype="object"/>
				<for var="oneDevicePair_packout" in="context.deviceContainer">
					<function>
						<set name="device" value="context.oneDevicePair_packout.second()"/>
					
						<if cond="context.device != null">
							<then></then>
							<function name="PacketOutToAllPort" class="context.device">
								<parameters>	
									<string name="inportid" in="context.inportid.toString()"/>	
									<string name="pkoutjson" in="context.pkoutjson.toString()"/>
									<messageblock name="msgblock" in="context.msgblock"/>								
								</parameters>
							</function>
						</if>
					</function>
				</for>
			</function>

			
			<!--qiulei 2017.08.23   Send Packet To one Port By DeviceId   -->
			<!--
				@brief		向端口发报文
				@auth 		qiulei
				@date		2017/11/28
				Input:
				Output:
			-->
			<function name="PacketOutToPort">
				<parameters>
					<string name="outputport"/>
					<string name="pkoutjson"/>
					<messageblock name="msgblock"/>
					<string name="inportid"/>
					<string name="datapathid"/>
				</parameters>
				<object name="device"/>
				<log>PacketOutToPort !!!!!!!!!!!!!!</log>
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())">
					<then>
						<set name="device" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
						<if cond="context.device != null">
							<then>
								<function name="PacketOutToPort" class="context.device">
									<parameters>
										<string name="outputport" in="context.outputport.toString()"/>
										<string name="pkoutjson" in="context.pkoutjson.toString()"/>
										<messageblock name="msgblock" in="context.msgblock"/>
										<string name="inportid" in="context.inportid.toString()"/>
									</parameters>
								</function>
							</then>
						</if>
					</then>
				</if>
			</function>
			
			<!--
				@brief		得到datapathid,作废
				@auth 		qiulei
				@date		2017/11/28
				Input:
				Output:
			-->
			<function name="GetDatapathId">	
				<parameters>	
					<string name="transportid" />
				</parameters>
				<object name="device"/>
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())">
					<then>
						<set name="device" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
						<if cond="context.device != null">
							<then>
								<function name="PacketOutToAllPort" class="context.device">
									<parameters>	
										<string name="inportid" in="context.inportid.toString()"/>	
										<string name="pkoutjson" in="context.pkoutjson.toString()"/>	
									</parameters>
								</function>	
							</then>
						</if>	
					</then>
				</if>			
			</function>
			
			<!--
				@brief		发送流表请求
				@auth 		qiulei
				@date		2017/11/28
				Input:
				Output:
			-->
			<function name="SendTableRequest">
				<object name="device"/>
				
				
				<pair name="oneDevicePair_tablerequest" keytype="string" valuetype="object"/>
				<for var="oneDevicePair_tablerequest" in="context.deviceContainer">
					<function>
						<set name="device" value="context.oneDevicePair_tablerequest.second()"/>
						<if cond="context.device != null">
							<then>
								<function name="SendTableRequest" class="device"/>
							</then>
						</if>
					</function>
				</for>
			</function>
			
			<!--
				@brief		得到端口状态json数据
				@auth 		qiulei
				@date		2017/11/28
				Input:
				Output:
			-->
			<function name="GetPortsStateJsonData">	
				<parameters>
					<string name="datapathid"/>
					<string name="jsonstring"/>
				</parameters>
				<object name="device"/>
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())">
					<then>
						<set name="device" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
						<if cond="context.device != null">
							<then>
								<function name="GetPortsStateJsonData" class="context.device">
									<parameters>	
										<string name="jsonstring" out="context.jsonstring"/>
									</parameters>
								</function>	
							</then>
						</if>		
					</then>
				</if>
			</function>
			
			<!--
				@brief		Get device by transport id
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2017/09/01
				Input:
		   			@param transportid   transport id
		   		Output:
		   			@param onedeviceobj  device object   
			-->
			<function name="GetDeviceByTransportId">
				<parameters>
					<string name="transportid" />
					<object name="onedeviceobj" />
				</parameters>
				<function name="DumpT2d"/>				
				<string name="datapathid"/>
				<set name="datapathid" value="context.t2dContainer.getValue(context.transportid.toString())"/>
				<set name="onedeviceobj" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
			</function>
			<!--
				@brief		Print transport id from t2dContainer
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2017/09/01
		   		Output:
		   			@param t2dkey  transport id   
			-->
			<function name="DumpT2d">
				<string name="t2dkey"/>								
				<pair name="oneDevicePair_dump" keytype="string" valuetype="string"/>
				<for var="oneDevicePair_dump" in="context.t2dContainer">
					<set name="t2dkey" value="context.oneDevicePair_dump.first()"/>
					<log><![CDATA[ CDeviceManager DumpT2d t2dkey= <%=context.t2dkey.toString()%>]]></log>
				</for>
			</function>
			
			<!-- qiulei 20170912 am  Get the number of devices-->
			<function name="GetDeviceCounts">
				<parameters>
					<long name="deviceCounts"/>
				</parameters>
				<set name="deviceCounts" value="context.deviceContainer.size()"/>	
			</function>

			<!--
				@brief		通过appid得到流表
				@auth 		hu peng (hupeng@staros.xyz)
				@date		2017/11/24
				Input:
				   @param filename 	staros_api_flows.xml
				   @param xmldata   appid
				Output: 
					@param filename 	CFlowManager.xml
				  	@param xmldata   	flowjsonstr
			-->
			<function name="Getflowbyappid">
				<parameters>
					<string name="appid"/>
					<list name="flowjsonstr"/>
				</parameters>
				<pair name="onedevice" keytype="string" valuetype="object"/>
				<object name="device"/>
				<object name="flowobj"/>
				<list name="flowjsonstrs" valuetype="string"/>
				<list name="flowjsonstrlist" valuetype="string"/>
					<for var="onedevice" in="context.deviceContainer">
						<function>
							<set name="device" value="context.onedevice.second()"/>
							<if cond="context.device != null">
								<then>
										<function name="GetFlowManager" class="device">
											<parameters>
												<object name="outflowmgr" out="context.flowobj"/>
											</parameters>
										</function>
										<function name="GetFlowByappid" class="flowobj">
											<parameters>
												<string name="appid" in="context.appid.toString()"/>
												<list name="flowjsonstr" out="context.flowjsonstrs"/>
											</parameters>
										</function>
										<if cond="context.flowjsonstrs.size()!=0">
											<then>
												<set name="flowjsonstrlist" value="context.flowjsonstrs"/>
											</then>
										</if>
								</then>
							</if>
						</function>
					</for>
					<log level="100"><![CDATA[ CDevice 1305 flowjsonstrlist size!!!!!= '<%=context.flowjsonstrlist.size().toString()%>']]></log>
					<log level="100"><![CDATA[ CDevice 1306 flowjsonstrs size!!!!!= '<%=context.flowjsonstrs.size().toString()%>']]></log>
					<set name="flowjsonstr" value="context.flowjsonstrlist"/>
			</function>
			
			<!--
				@brief		通过appid删除流表
				@auth 		hu peng (hupeng@staros.xyz)
				@date		2017/11/24
				Input:
				   @param filename 	staros_api_flows.xml
				   @param xmldata   appid
				Output: 
					@param filename 	CFlowManager.xml
				  	@param xmldata   	result
			-->
			<function name="Deleteflowbyappid">
				<parameters>
					<string name="appid"/>
					<string name="result"/>
				</parameters>
				<pair name="onedevice" keytype="string" valuetype="object"/>
				<object name="device"/>
				<object name="flowobj"/>
				<string name="results"/>
				
					<for var="onedevice" in="context.deviceContainer">
						<function>
							<set name="device" value="context.onedevice.second()"/>
							<if cond="context.device != null">
								<then>
									<function name="GetFlowManager" class="device">
										<parameters>
											<object name="outflowmgr" out="context.flowobj"/>
										</parameters>
									</function>
									<if cond="context.flowobj.ptr!=null">
										<then>
											
											<function name="UnInstallFlowTableByappidRequest" class="flowobj">
												<parameters>
													<string name="appid" in="context.appid.toString()"/>
												</parameters>
											</function>
											<set name="results" value="'true'"/>
										</then>
										<else>
											<set name="results" value="'false'"/>
											<exit/>
										</else>
									</if>
								</then>
							</if>
						</function>
					</for>
					<set name="result" value="context.results.toString()"/>
			</function>

			<!--
				@brief		得到所有流表
				@auth 		hu peng (hupeng@staros.xyz)
				@date		2017/11/24
				Input:
				Output: 
					@param filename 	CFlowManager.xml
				  	@param xmldata   	flows
			-->
			<function name="Getallflows">
				<parameters>
					<list name="flows"/>
				</parameters>
				<pair name="onedevice" keytype="string" valuetype="object"/>
				<object name="device"/>
				<object name="flowobj"/>
				<string name="results"/>
				<list name="flowss" valuetype="string"/>
				<list name="allflow" valuetype="list"/>
					<for var="onedevice" in="context.deviceContainer">
						<function>
							<set name="device" value="context.onedevice.second()"/>
							<if cond="context.device.ptr!= null">
								<then>
									<function name="GetFlowManager" class="device">
										<parameters>
											<object name="outflowmgr" out="context.flowobj"/>
										</parameters>
									</function>
									<function name="getAllflow" class="flowobj">
										<parameters>
											<list name="flowjsons" out="context.flowss"/>
										</parameters>
									</function>
									<insert name="context.allflow" value="context.flowss"/>
								</then>
							</if>
						</function>
					</for>
					<log level="100"><![CDATA[ 1172 allflow size=<%=context.allflow.size()%>']]></log>
					<set name="flows" value="context.allflow"/>
			</function>

			<!--
				@brief		通过deviceiid得到流表
				@auth 		hu peng (hupeng@staros.xyz)
				@date		2017/11/24
				Input:
					@param filename 	staros_api_flows.xml
				  	@param xmldata   	deviceid
				Output: 
					@param filename 	CFlowManager.xml
				  	@param xmldata   	flowjsonstr
			-->
			<function name="GetflowBydeviceid">
				<parameters>
					<string  name="deviceid"/>
					<list name="flowjsonstr"/>
				</parameters>
				<object name="device"/>
				<object name="flowobj"/>
				<list name="flowjsonstrs" valuetype="string"/>
				<log level="100"><![CDATA[cdevice deviceContainer size=<%=context.deviceContainer.size().toString()%>]]></log>
				<if cond="context.deviceid.toString()!=''">
					<then>
						<log level="100"><![CDATA[cdevice 1192 thisdeviceid=<%=context.deviceid.toString()%>']]></log>
						<if cond="context.deviceContainer.hasValue(context.deviceid.toString())">
							<then>
								<lookup name="deviceContainer" key="context.deviceid.toString()" output="context.device"/>
								<function name="GetFlowManager" class="device">
									<parameters>
										<object name="outflowmgr" out="context.flowobj"/>
									</parameters>
								</function>
								<function name="getflowBydeviceid" class="flowobj">
										<parameters>
											<string name="deviceid" in="context.deviceid.toString()"/>
											<list name="flowjsonstr" out="context.flowjsonstrs"/>
										</parameters>
								</function>
								<set name="flowjsonstr" value="context.flowjsonstrs"/>
							</then>
							<else>
								<exit/>
							</else>
						</if>
					</then>
				</if>
			</function>
			
			<!--
				@brief		通过deviceiid和flowid得到流表
				@auth 		hu peng (hupeng@staros.xyz)
				@date		2017/11/24
				Input:
					@param filename 	staros_api_flows.xml
				  	@param xmldata   	deviceid,flowid
				Output: 
					@param filename 	CFlowManager.xml
				  	@param xmldata   	flowjsonstr
			-->
			<function name="GetflowBydeviceidflowid">
				<parameters>
					<string  name="deviceid"/>
					<string name="flowid"/>
					<string name="flowjsonstr"/>
				</parameters>
				<object name="device"/>
				<object name="flowobj"/>
				<string name="flowjsonstrs"/>
					<if cond="context.deviceid.toString()!=''">
					<then>
						<lookup name="deviceContainer" key="context.deviceid.toString()" output="context.device"/>
						<function name="GetFlowManager" class="device">
							<parameters>
								<object name="outflowmgr" out="context.flowobj"/>
							</parameters>
						</function>
								<function name="getflowBydeviceidflowid" class="flowobj">
									<parameters>
										<string name="flowid" in="context.flowid.toString()"/>
										<string name="deviceid" in="context.deviceid.toString()"/>
										<string name="flowjsonstr" out="context.flowjsonstrs"/>
									</parameters>
						</function>
						<set name="flowjsonstr" value="context.flowjsonstrs.toString()"/>
					</then>
				</if>
			</function>
				
			<!--
				@brief		通过deviceid添加流表
				@auth 		hu peng (hupeng@staros.xyz)
				@date		2017/11/24
				Input:
					@param filename 	staros_api_flows.xml
				  	@param xmldata   	deviceid，flowjsonstr
				Output: 
			-->
			<function name="AddflowBydeviceid">
				<parameters>
					<string name="deviceid" />
					<string name="appid" />
					<string name="jsonstr"/>
				</parameters>
				<object name="device"/>
				<object name="flowobj"/>
				<string name="flowjsonstrs"/>
				<string name="flowid"/>
				<string name="json"/>
				
				<if cond="context.deviceContainer.hasValue(context.deviceid.toString())==true">
					<then>
						<log level="100"> device it not null</log>
						<lookup name="deviceContainer" key="context.deviceid.toString()" output="context.device"/>
						<function name="GetFlowManager" class="device">
							<parameters>
								<object name="outflowmgr" out="context.flowobj"/>
							</parameters>
						</function>
							<script><![CDATA[			
								var json = JSON.parse(context.jsonstr.toString());
								var str="of:";
								json.flows[0].deviceid=str+context.deviceid.toString();
								var json=JSON.stringify(json.flows[0]);
								context.print("1261"+json);
								context.json.setValue(json);
								context.print(json);
								context.print(appid);
						]]></script>	
						<if cond="context.flowobj.ptr!=null">
							<then>
								<log level="100">flowobj is not null</log>
								
								<function name="InstallFlowTableRequest" class="flowobj">
									<parameters>
										<string name="outflowid" out="context.flowid"/>
										<string name="strjson" in="context.json.toString()"/>
										<string name="appId" in="context.appid.toString()"/>
									</parameters>
								</function>
								<log level="100"><![CDATA[1263 flowid= <%=context.flowid.toString()%>]]></log>
							</then>
						</if>

					</then>
					<else>
						<log level="100"> device is  null</log>
					</else>
				</if>
			</function>
			
			<!--
				@brief		通过appid添加所有流表
				@auth 		hu peng (hupeng@staros.xyz)
				@date		2017/11/24
				Input:
					@param filename 	staros_api_flows.xml
				  	@param xmldata   	appid，flowlist，flowdeviceidlist
				Output: 
			-->
			<function name="Addflows">
				<parameters>
					<string name="appid"/>
					<list name="flowlist" />
					<list name="flowdeviceidlist"/>
				</parameters>
				<object name="flowobj"/>
				<list name="flowss" valuetype="string"/>
				<object name="device" />
				<log level="100"><![CDATA[1300 CDevice flowdeviceidlist!!!!!= '<%=context.flowdeviceidlist.size().toString()%>']]></log>
				<log level="100"><![CDATA[1301 CDevice flowlist!!!!!= '<%=context.flowlist.size().toString()%>']]></log>
				<string name="oneflowjsons"/>
				<string name="flowdeviceid"/>
				<string name="flowid"/>
				<string name="thisdeviceid"/>
				<string name="oneflowjson"/>
					<for var="flowdeviceid" in="context.flowdeviceidlist">
						<function>
							<script><![CDATA[
								var flowdeviceid=context.flowdeviceid.toString();
								var thisdeviceid=flowdeviceid.split(":")[1];
								context.thisdeviceid.setValue(thisdeviceid);
							]]></script>
							<log level="100"><![CDATA[1307 CDevice flowdeviceid!!!!!= '<%=context.flowdeviceid.toString()%>']]></log>
							<lookup name="deviceContainer" key="context.thisdeviceid.toString()" output="context.device"/>
							<if cond="context.device.ptr!= null">
								<then>
									<function name="GetFlowManager" class="device">
										<parameters>
											<object name="outflowmgr" out="context.flowobj"/>
										</parameters>
									</function>
									<for var="oneflowjson" in="context.flowlist">
											<function name="InstallFlowTableRequest" class="flowobj">
												<parameters>
													<string name="outflowid" out="context.flowid"/>
													<string name="strjson" in="context.oneflowjson.toString()" />
													<string name="appId" in="context.appid.toString()" />
												</parameters>
											</function>
									</for>		
								</then>
							</if>
						</function>
					</for>
			</function>
			
			<!--
				@brief		删除所有流表
				@auth 		hu peng (hupeng@staros.xyz)
				@date		2017/11/24
				Input:
					@param filename 	staros_api_flows.xml
				  	@param xmldata   	jsonstr
				Output: 
					@param filename 	CFlowManager.xml
				  	@param xmldata   	results
			-->
			<function name="Deleteflows">
				<parameters>
					<string name="jsonstr" />
					<list name="results" />
				</parameters>
				<log level="100">cdevicemgr Deleteflows</log>
				<log><![CDATA[1136 jsonstr!!!!!= '<%=context.jsonstr.toString()%>']]></log>
				<list name="deviceidlist" valuetype="string"/>
				<list name="flowidlist" valuetype="string"/>
				<string name="deviceid" />
				<script><![CDATA[
						var json = JSON.parse(context.jsonstr.toString());
						context.print("1345!! flowslength:"+json.flows.length);
						for(var i=0;i<json.flows.length;i++){
							var deviceid =json.flows[i].deviceid;
							var thisdeviceid=deviceid.split(":")[1];
							context.print("Cdevicemgr 1346"+thisdeviceid);
							context.deviceidlist.addValue(thisdeviceid);
							context.flowidlist.addValue(json.flows[i].flowid);
							}
				]]></script>
				<object name="device"/>
				<object name="flowobj"/>
				<string name="flowid"/>
				<list name="result" valuetype="string"/>
				<for var="deviceid" in="context.deviceidlist">
					<lookup name="deviceContainer" key="context.deviceid.toString()" output="context.device"/>
					<if cond="context.device.ptr!= null">
						<then>
							<log level="100">device is not null</log>
							<function name="GetFlowManager" class="device">
								<parameters>
									<object name="outflowmgr" out="context.flowobj"/>
								</parameters>
							</function>
							<if cond="context.flowobj.ptr!=null">
								<then>
									<for var="flowid" in="flowidlist">
											<log level="100"><![CDATA[1373 flowid!!!!!= '<%=context.flowid.toString()%>']]></log>
										<function name="UnInstallFlowTableRequest" class="flowobj">
											<parameters>
												<string name="flowid" in="context.flowid.toString()" />
											</parameters>
										</function>
										<insert name="context.result" value="'true'"/>
									</for>
								</then>
								<else>
									<insert name="context.result" value="'false'"/>
								</else>
							</if>
						</then>
					</if>
				</for>
				<log level="100"><![CDATA[1390 result!!!!!= '<%=context.result.size().toString()%>']]></log>
				<set name="results" value="context.result"/>
				<log level="100"><![CDATA[1392 resultssize!!!!!= '<%=context.results.size().toString()%>']]></log>
			</function>

			<!--
				@brief		通过deviceid和flowid删除流表
				@auth 		hu peng (hupeng@staros.xyz)
				@date		2017/11/24
				Input:
					@param filename 	staros_api_flows.xml
				  	@param xmldata   	deviceid,flowid
				Output: 
					@param filename 	CFlowManager.xml
				  	@param xmldata   	result
			-->
			<function name="DeleteBydeviceidflowid">
				<parameters>
					<string name="deviceid" />
					<string name="flowid"  />
					<string name="result" />
				</parameters>
				<object name="flowobj"/>
				<object name="device"/>
				<log level="100"><![CDATA[deviceid =<%=context.deviceid.toString()%>']]></log>
				<lookup name="deviceContainer" key="context.deviceid.toString()" output="context.device"/>
					<if cond="context.device.ptr!=null">
						<then>
							<function name="GetFlowManager" class="device">
								<parameters>
									<object name="outflowmgr" out="context.flowobj"/>
								</parameters>
							</function>
							<if cond="context.flowobj.ptr!=null">
								<then>
									<function name="UnInstallFlowTableRequest" class="flowobj">
										<parameters>
											<string name="flowid" in="context.flowid.toString()" />
										</parameters>
									</function>
									<set name="result" value="'true'"/>
								</then>
								<else>
									<set name="result" value="'false'"/>
								</else>
							</if>
							
						</then>
					</if>	
			</function>
			
			<!--
				@brief		send keep alive packet to switch
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2017/11/22
			-->
			<function name="OpenFlowKeepAliveDetect">
				<pair name="onepair" keytype="string" valuetype="object"/>
				<object name="onedeviceobj"/>
				<string name="onedatapathid"/>
				<long name="onerequestcount"/>
				<log>============================================================</log>
				<log>============================================================</log>
				<log> ###### CDeviceManager OpenFlowKeepAliveDetect ######</log>
				<for var="onepair" in="thisclass.deviceContainer">
					<set name="context.onedeviceobj" value="context.onepair.second()"/>
					<if cond="context.onedeviceobj != null">
						<then>
							<function name="GetRequestCount" class="onedeviceobj">
								<parameters>
									<long name="outrequestcount" out="context.onerequestcount"/>
								</parameters>
							</function>
							<log><![CDATA[CDeviceManager onerequestcount= <%=context.onerequestcount.toLong()%>]]></log>
							<if cond="context.onerequestcount.toLong() > 10">
								<then>
									<log> CDeviceManager device is down </log>
									<function name="GetDatapathId" class="onedeviceobj">
										<parameters>
											<string name="outdatapathid" out="context.onedatapathid"/>
										</parameters>
									</function>
									<exit/>
								</then>
							</if>
							<function name="OpenFlowKeepAliveDetect" class="onedeviceobj"/>
						</then>
					</if>
				</for>
				<log><![CDATA[CDeviceManager onedatapathid= <%=context.onedatapathid.toString()%>]]></log>
				<if cond="context.onedatapathid != ''">
					<then>
						<function name="removeDevice">
							<parameters>
								<string name="datapathid" in="context.onedatapathid.toString()"/>
							</parameters>
						</function>
					</then>
				</if>	
			</function>

			<!--
				@brief		reset keepalive when receive keep alive packet from switch
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2017/11/22
			-->
			<function name="HandleKeepAliveResponse">
				<parameters>
					<string name="transportid"/>
				</parameters>	
				<object name="onedeviceobj"/>
				<log>============================================================</log>
				<log>###### CDeviceManager HandleKeepAliveResponse ######</log>

				<function name="GetDeviceByTransportId">
					<parameters>
						<string name="transportid" in="context.transportid.toString()"/>
						<object name="onedeviceobj" out="context.onedeviceobj"/>
					</parameters>
				</function>
				
				<if cond="context.onedeviceobj.ptr == null">
					<then>
						<log> HandleKeepAliveResponse onedeviceobj is null </log>
					</then>
					<else>
						<function name="ResetKeepAlive" class ="onedeviceobj"/>
					</else>
				</if>	
		    </function>
			<!--qiulei 2017/12/28-->
			<function name="getAllDeviceFlowCounts">
				<parameters>
					<long name="AllDeviceflowCounts"/>
				</parameters>
				
				<long name="AllDeviceFlowNumber" value="0"/>
				<long name="oneDeviceFlowNumber"/>
				
				<object name="deviceObj"/>
				<pair name="oneDevicePair" keytype="string" valuetype="object"/>
				
				<for var="oneDevicePair" in="context.deviceContainer">
					<function>
						<set name="deviceObj" value="context.oneDevicePair.second()"/>
						<if cond="context.deviceObj.ptr != null">
							<then>
								<function name="GetFlowCounts" class="deviceObj">
									<parameters>
										<long name="oneDeviceFlowCounts" out="context.oneDeviceFlowNumber"/>					
									</parameters>
								</function>
								<set name="AllDeviceFlowNumber" value="context.AllDeviceFlowNumber.toLong()+context.oneDeviceFlowNumber.toLong()"/>
							</then>
						</if>
					</function>
				</for>
				<set name="AllDeviceflowCounts" value="context.AllDeviceFlowNumber.toLong()"/>
			</function>
		</public>

	</class>
</starlang>