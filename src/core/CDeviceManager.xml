<?xml version="1.0" encoding="UTF-8"?>
<starlang xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">	
	<class name="CDeviceManager">
		<private>
			<hashmap name="deviceContainer" keytype="string" valuetype="object"/>
			<hashmap name="t2dContainer" keytype="string" valuetype="string"/>
		</private>
		<public>
			<function name="CDeviceManager">
				<log>CDeviceManager is create</log>
			</function>
			<function name="getDevice">
				<parameters>
					<object name="outdevice"/>
					<string name="datapathid"/>
				</parameters>
				<pair name="devicepair" keytype="string" valuetype="object"/>
				<string name="id" />
				<object name="onedevice"/>
				<for var="context.devicepair" in="context.deviceContainer">
					<set name="context.onedevice" value="context.devicepair.second()"/>
					<if cond="context.onedevice != null">
						<then>
							<function name="GetDatapathId" class="context.onedevice">
								<parameters>
									<string name="outdatapathid" out="context.id"/>
								</parameters>
							</function>
						</then>
					</if>	
				</for>
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())">
					<then>
						<function>
							<set name="outdevice" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
						</function>
						<if cond="context.outdevice==null">
							<then>
								<log>insert second if</log>
								<log>outdevice is null</log>
							</then>
						</if>
					</then>
				</if>
			</function>
			<function name="addDevice">
				<parameters>
					<string name="mfrdesc"/>
					<string name="swdesc"/>
					<string name="serialnum"/>
					<string name="dpdesc"/>
					<string name="hwdesc"/>
					<string name="transportid"/>
					<string name="datapathid"/>
					<string name="localipaddr"/>
					<string name="peeripaddr"/>
					<string name="masterid"/>
					<string name="type"/>
					<string name="online"/>
					<string name="protocol"/>	
				</parameters>
				<object name="deviceobject"/>
				<string name="outtransid"/>
				<new name="deviceobject" class="CDevice">
					<parameters>
						<string name="mfrdesc" in="context.mfrdesc.toString()"/>
						<string name="swdesc" in="context.swdesc.toString()"/>
						<string name="serialnum" in="context.serialnum.toString()"/>
						<string name="dpdesc" in="context.dpdesc.toString()"/>
						<string name="hwdesc" in="context.hwdesc.toString()"/>
						<string name="transportid" in="context.transportid.toString()"/>
						<string name="datapathid" in="context.datapathid.toString()"/>
						<string name="localipaddr" in="context.localipaddr.toString()"/>
						<string name="peeripaddr" in="context.peeripaddr.toString()"/>
						<string name="masterid" in="context.masterid.toString()"/>		
						<string name="type" in="context.type.toString()"/>
						<string name="online" in="context.online.toString()"/>
						<string name="protocol" in="context.protocol.toString()"/>	
					</parameters>
				</new>
				<insert name="deviceContainer" key="context.datapathid.toString()" value="context.deviceobject"/>
				<insert name="t2dContainer" key="context.transportid.toString()" value="context.datapathid.toString()"/>
				<string name="onlinejson"/>
				<function name="SendDefaultFlow" class="deviceobject"/>
				<function name="ToOnlineJson" class="deviceobject">
					<parameters>
						<string name="strjson" out="onlinejson"/>
					</parameters>
				</function>
				<function name="SendToAllClient" class="WebSocketManager">
					<parameters>
						<string name="strjson" in="context.onlinejson.toString()"/>
					</parameters>
				</function>
				<function name="GetTransportId" class="deviceobject">
					<parameters>
						<string name="outtransport" out="outtransid"/>
					</parameters>
				</function>
				
				
			</function>
				
			<function name="findDevice">
				<parameters>
					<string name="datapathid"/>
					<object name="deviceobject"/>
				</parameters>
				<object name="deviceinfo"/>
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())==true">
					<then>
						<function>
							<lookup name="deviceContainer" key="context.datapathid.toString()" output="context.deviceinfo"/>
						</function>
					</then>
				</if>
				<if cond="context.deviceinfo != null">
					<then>
						<set name="deviceobject" value="context.deviceinfo"/>
					</then>
				</if>	
			</function>
			
			<function name="removeDevice">
				<parameters>
					<string name="datapathid"/>
				</parameters>
				<object name="deviceobject"/>
				<string name="offlinejson"/>
				<string name="devicetransportid"/>
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())==true">
					<then>
						<function>
							<lookup name="deviceContainer" key="context.datapathid.toString()" output="context.deviceobject"/>
							<if cond="context.deviceobject.ptr == null">
								<then>
									<exit/>
								</then>
							</if>
							<function name="ToOfflineJson" class="deviceobject">
								<parameters>
									<string name="strjson" out="offlinejson"/>
								</parameters>
							</function>
							<function name="SendToAllClient" class="WebSocketManager">
								<parameters>
									<string name="strjson" in="context.offlinejson.toString()"/>
								</parameters>
							</function>
							<function name="GetTransportId" class="deviceobject">
								<parameters>
									<string name="outtransport" out="context.devicetransportid"/>
								</parameters>
							</function>
							<remove name="deviceContainer" key="context.datapathid.toString()"/>
							<remove name="t2dContainer" key="context.devicetransportid.toString()"/>
						</function>
					</then>
				</if>
			</function>
			<function name="GetDatapathIdByTransportid">
				<parameters>
					<string name="transportid"/>
					<string name="datapathid"/>
				</parameters>
				<set name="datapathid" value="context.t2dContainer.getValue(context.transportid.toString())"/>
			</function>
			<function name="GetTransportIdFromDevice">
				<parameters>
					<string name="datapathid"/>
					<string name="transportid"/>
				</parameters>
				<object name="deviceinfo"/>
				<string name="devicedatapathid"/>
				<!--qiulei 20170821 Monday am-->
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())">
					<then>
						<function>
							<set name="deviceinfo" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
							<!--qiulei 20170908 add if judge-->
							<if cond="context.deviceinfo != null">
								<then>
									<function name="GetTransportId" class="deviceinfo">
										<parameters>
											<string name="outtransport" out="transportid"/>
										</parameters>
									</function>
								</then>
							</if>
						</function>
					</then>
				</if>
			</function>
			<function name="removeDeviceByTransportId">
				<parameters>
					<string name="transportid"/>
				</parameters>
				<object name="deviceinfo"/>
				<string name="devicetransportid"/>
				<string name="devicedatapathid"/>
				<string name="oneremove"/>
				<list name="removelist" valuetype="string"/>
				
				<pair name="oneapppair" keytype="string" valuetype="object"/>
				<for var="oneapppair" in="context.deviceContainer">
					<function>
						<set name="deviceinfo" value="context.oneapppair.second()"/>
						
						<if cond="context.deviceinfo != null">
							<then>
								<function name="GetTransportId" class="deviceinfo">
									<parameters>
										<string name="outtransport" out="context.devicetransportid"/>
									</parameters>
								</function>
							</then>
						</if>
						<if cond="context.devicetransportid.toString() == context.transportid.toString()">
							<then>
								<function name="GetDatapathId" class="deviceinfo">
									<parameters>
										<string name="outdatapathid" out="context.devicedatapathid"/>
									</parameters>
								</function>
								<insert name="removelist" value="context.devicedatapathid.toString()"/>
							</then>
						</if>
					</function>
				</for>
				<for var="oneremove" in="context.removelist">
					<function>
						<function name="removeDevice">
							<parameters>
								<string name="datapathid" in="context.oneremove.toString()"/>
							</parameters>
						</function>
					</function>
				</for>
			</function>
			<function name="SendAddAllDeviceToWebClient">
				<parameters>
					<string name="transportid"/>
				</parameters>
				<string name="jsonstr"/>
				<object name="switchdevice"/>
				
				<pair name="oneapppair" keytype="string" valuetype="object"/>
				<for var="oneapppair" in="context.deviceContainer">
					<function>
						<set name="switchdevice" value="context.oneapppair.second()"/>
						
						<if cond="context.switchdevice != null">
							<then>
								<function name="ToAddDeviceJson" class="context.switchdevice">
									<parameters>
										<string name="strjson" out="jsonstr"/>
									</parameters>
								</function>
							</then>
						</if>
						<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
							<jsonsrc src="jsonstr"/>
						</websocket>
					</function>
				</for>
			</function>
			<function name="SendAddAllLinkToWebClient">
				<parameters>
					<string name="transportid"/>
				</parameters>
				<log>2017.09.18 enter CDeviceManager.SendAddAllLinkToWebClient method</log>
				<object name="srcdevice"/>
				<object name="dstdevice"/>
				<string name="srcport"/>
				<string name="srcdevicedpid"/>
				<string name="dstdevicedpid"/>
				<string name="dstport"/>
				<string name="json"/>
				<string name="strlink" value=""/>
				<string name="binvalidlink" value="false"/>
				
				
				<string name="srcdevicedpid2"/>
				<pair name="oneDevicePair2" keytype="string" valuetype="object"/>
				<pair name="oneDevicePair1" keytype="string" valuetype="object"/>
				<list name="listsrcdevice" valuetype="string"/>
				<for var="oneDevicePair1" in="context.deviceContainer">
					<function>
						<set name="srcdevice" value="context.oneDevicePair1.second()"/>
						<if cond="context.srcdevice != null">
							<then>
								<function name="GetDatapathId" class="srcdevice">
									<parameters>
										<string name="outdatapathid" out="srcdevicedpid"/>
									</parameters>
								</function>
								<insert name="listsrcdevice" value="context.srcdevicedpid.toString()"/>
							</then>
						</if>
					</function>
				</for>
				<for var="srcdevicedpid2" in="context.listsrcdevice">
					<function>
						<for var="oneDevicePair2" in="context.deviceContainer">
							<set name="dstdevice" value="context.oneDevicePair2.second()"/>
							<log>2017.09.18 enter CDeviceManager.SendAddAllLinkToWebClient method    ent inner for</log>
							<if cond="context.dstdevice != null">
								<then>
									<function name="GetDatapathId" class="dstdevice">
										<parameters>
											<string name="outdatapathid" out="dstdevicedpid"/>
										</parameters>
									</function>
								</then>
							</if>
							<if cond="context.srcdevicedpid2.toString()!=context.dstdevicedpid.toString()">
								<then>
									<function>
										<set name="strlink" value="context.openflowserverobj.ptr.getShortestLink(context.srcdevicedpid2.toString(), context.dstdevicedpid.toString())"/>
										<log leve="1"><![CDATA[strlink=<%=context.strlink.toString()%>]]></log>
											
											<script><![CDATA[
													if (context.strlink.toString().length>0)
													{
														var info = JSON.parse(context.strlink.toString());
														if (info.paths.length==1)
														{
															context.dstport.setValue(info.paths[0].dst.port);
															context.srcport.setValue(info.paths[0].src.port);
															context.binvalidlink.setValue('true');
														}
														else 
														{	
															context.binvalidlink.setValue('false');
														}
													}
													else 
													{
														context.binvalidlink.setValue('false');
													}
											]]></script>
											<function>
												<if cond="context.binvalidlink.toString()=='true'">
													<then>
														<function>
															<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
																<jsonbody>
																	<![CDATA[
																	{
																	"event":"addLink","payload":
																	{"id":"of:<%=context.srcdevicedpid2.toString()%>/<%=context.srcport.toString()%>-of:<%=context.dstdevicedpid.toString()%>/<%=context.dstport.toString()%>",
																	"type":"direct",
																	"expected":false,
																	"online":true,
																	"linkWidth":1.2,
																	"src":"of:<%=context.srcdevicedpid2.toString()%>",
																	"srcPort":"<%=context.srcport.toString()%>",
																	"dst":"of:<%=context.dstdevicedpid.toString()%>",
																	"dstPort":"<%=context.dstport.toString()%>"
																	}
																	}
																					]]>
																</jsonbody>
															</websocket>
														</function>
													</then>
												</if>
											</function>
									</function>
								</then>
							</if>
						</for>
					</function>
				</for>
			</function>
			<function name="SendDeviceInfoToWebClient">
				<parameters>
					<string name="transportid"/>
				</parameters>
				<string name="jsonstr"/>
				<string name="sendjsonstr"/>
				<object name="switchdevice"/>
				<list name="deviceinfolist" valuetype="string"/>
				<pair name="oneDevicePair_sendinfo" keytype="string" valuetype="object"/>
				<for var="oneDevicePair_sendinfo" in="context.deviceContainer">
					<function>
						<set name="switchdevice" value="context.oneDevicePair_sendinfo.second()"/>
						<if cond="context.switchdevice != null">
							<then>
								<function name="GetDeviceInfoJson" class="context.switchdevice">
									<parameters>
										<string name="strjson" out="jsonstr"/>
									</parameters>
								</function>
								<insert name="deviceinfolist" value="context.jsonstr.toString()"/>
							</then>
						</if>	
						
					</function>
				</for>
				<script><![CDATA[
					var json = new Object();
					var myArray=new Array();  
					
					
					//	qiulei 20170918
					var firstString=context.deviceinfolist.getFirst();
					while(firstString!=null){
						var onearray = JSON.parse(firstString);
						myArray.push(onearray);
						firstString=context.deviceinfolist.getNext();
					}
					
					json['event']='deviceDataResponse';
					
					var payload = new Object();
					payload['devices']=myArray;
					
					var annots = new Object();
					annots['no_rows_msg']='No devices found';
					payload['annots']=annots;
					json['payload']=payload;
					var strjson=JSON.stringify(json);
					context.sendjsonstr.setValue(strjson);
				]]></script>
				<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
					<jsonsrc src="sendjsonstr"/>
				</websocket>
			</function>
			<function name="SendDetailDeviceInfoToWebClient">
				<parameters>
					<string name="transportid"/>
				</parameters>
				<string name="jsonstr"/>
				<string name="sendjsonstr"/>
				<object name="switchdevice"/>
				<list name="deviceinfolist" valuetype="string"/>
				<pair name="oneDevicePair_senddetail" keytype="string" valuetype="object"/>
				<for var="oneDevicePair_senddetail" in="context.deviceContainer">
					<function>
						<set name="switchdevice" value="context.oneDevicePair_senddetail.second()"/>
						<if cond="context.switchdevice != null">
							<then>
								<function name="GetDeviceInfoJson" class="context.switchdevice">
									<parameters>
										<string name="strjson" out="jsonstr"/>
									</parameters>
								</function>
							</then>
						</if>
						<insert name="deviceinfolist" value="context.jsonstr.toString()"/>
					</function>
				</for>
				<script><![CDATA[
					var json = new Object();
					var myArray=new Array();  
					
					
					//	qiulei 20170918
					var firstString=context.deviceinfolist.getFirst();
					while(firstString!=null){
						var onearray = JSON.parse(firstString);
						myArray.push(onearray);
						firstString=context.deviceinfolist.getNext();
					}
					
					json['event']='deviceDataResponse';
					
					var payload = new Object();
					payload['devices']=myArray;
					
					var annots = new Object();
					annots['no_rows_msg']='No devices found';
					payload['annots']=annots;
					json['payload']=payload;
					var strjson=JSON.stringify(json);
					context.sendjsonstr.setValue(strjson);
				]]></script>
				<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
					<jsonsrc src="sendjsonstr"/>
				</websocket>
			</function>
			<function name="Detect">
				<object name="thisswitch"/>
				<string name="transportid"/>
				<log>Device Manager Detect</log>
				
				<pair name="oneDevicePair_Detect" keytype="string" valuetype="object"/>
				<for var="oneDevicePair_Detect" in="context.deviceContainer">
					<function>
						<set name="thisswitch" value="context.oneDevicePair_Detect.second()"/>
						<if cond="context.thisswitch != null">
							<then>
								<function name="TimeOut" class="context.thisswitch"/>
							</then>
						</if>
					</function>
				</for>
				<!--SendPortState-->
				<log> SendPortStateRequest !!!!!!!!!!!!!!!!!!!</log>
				<!--function name="SendPortStateRequest"/-->
												<!--function name="SendFlowRequest"/-->
			</function>
			<function name="DeviceDetailsReqJson">
				<parameters>
					<string name="transportid"/>
					<string name="datapathid"/>
				</parameters>
				<object name="thisswitch"/>
				<string name="sendjsonstr"/>
				<set name="thisswitch" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
				<if cond="context.thisswitch != null">
					<then>
						<function name="ForDeviceDetailReqJson" class="thisswitch">
							<parameters>
								<string name="outjson" out="sendjsonstr"/>
							</parameters>
						</function>
					</then>
				</if>
				<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
					<jsonsrc src="sendjsonstr"/>
				</websocket>
			</function>
			<!--YY sendlinks 2017-08-18 -->
			<function name="SendLinks">
				<parameters>
					<string name="transportid"/>
				</parameters>
				<boolean name="binvalidlink" value="false"/>
				<string name="srcport"/>
				<string name="srcdevicedpid"/>
				<string name="dstdevicedpid"/>
				<string name="dstport"/>
				<string name="strlink" value=""/>	
				<string name="linkarray"/>
				<list name="linklist" valuetype="string"/>
				<object name="srcdevice"/>
				<object name="dstdevice"/>
				<pair name="oneDevicePair2" keytype="string" valuetype="object"/>
				<pair name="oneDevicePair_sendlink" keytype="string" valuetype="object"/>
				<list name="listdevice" valuetype="string"/>
				<function>	
					<for var="oneDevicePair_sendlink" in="context.deviceContainer">
						<function>
						<log>2017.9.18 oneDevicePair </log>
							<set name="srcdevice" value="context.oneDevicePair_sendlink.second()"/>
							<if cond="context.srcdevice != null">
								<then>
								
									<function name="GetDatapathId" class="srcdevice">
										<parameters>
											<string name="outdatapathid" out="srcdevicedpid"/>
										</parameters>
									</function>
									<insert name="listdevice" value="context.srcdevicedpid.toString()"/>
								</then>
							</if>
						</function>
					</for>							
							<for var="srcdevicedpid" in="context.listdevice">
								<function>
								<for var="oneDevicePair2" in="context.deviceContainer">
									<set name="dstdevice" value="context.oneDevicePair2.second()"/>
									<if cond="context.dstdevice != null">
										<then>
											<function name="GetDatapathId" class="dstdevice">
												<parameters>
													<string name="outdatapathid" out="dstdevicedpid"/>
												</parameters>
											</function>
										</then>
									</if>
									<if cond="context.srcdevicedpid.toString()!=context.dstdevicedpid.toString()">
										<then>
											<function>
												<set name="strlink" value="context.openflowserverobj.ptr.getShortestLink(context.srcdevicedpid.toString(), context.dstdevicedpid.toString())"/>																		
												<script><![CDATA[
														if (context.strlink.toString().length>0)
														{
															var info = JSON.parse(context.strlink.toString());
															if (info.paths.length == 1)
															{
																var array = new Object();
																array.one = "of:" + context.srcdevicedpid.toString() + "/" + info.paths[0].src.port;
																array.two = "of:" + context.dstdevicedpid.toString() + "/" + info.paths[0].dst.port;
																array.type = "Direct";
																array._iconid_state = "active";
																array.direction = "A &harr; B";
																array.durable = "false";
																var strjson=JSON.stringify(array);
																context.linklist.addValue(strjson);
																context.binvalidlink.setValue('true');
															}
															else 
															{	
																context.binvalidlink.setValue('false');
															}
														}
														else 
														{
															context.binvalidlink.setValue('false');
														}
												]]></script>
												<function>
													<if cond="context.binvalidlink.toString()=='true'">
														<then>
															<function>
																<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
																	<jsonsrc src="linkarray"/>
																</websocket>
															</function>
														</then>
													</if>
												</function>
											</function>
										</then>
									</if>
								</for>
							</function>
						</for>
					<script><![CDATA[				
						var json = new Object();
						var myArray=new Array();
						
						//	qiulei 20170918
						var firstString=context.linklist.getFirst();
						while(firstString!=null){
							var jsoninfo = JSON.parse(firstString);
							myArray.push(jsoninfo);
							
							firstString=context.linklist.getNext();
						}
						
						json['event'] = "linkDataResponse";							
						var payload = new Object();
						payload['links'] = myArray;				
						var annots_arr = new Array();
						var paytwoarray = new Object();
						paytwoarray.no_rows_msg = "No links found";
						annots_arr.push(paytwoarray);
						payload['annots'] = annots_arr;	
						json['payload'] = payload;				
						var strjson=JSON.stringify(json);				
						context.linkarray.setValue(strjson);
						context.binvalidlink.setValue(true);
					]]></script>
				</function>
				
				
				<if cond="context.binvalidlink.toBoolean()==true">
					<then>
						<function>
							<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
								<jsonsrc src="linkarray"/>
							</websocket>
						</function>
					</then>
				</if>
			</function>
			<!--Send Request Device Detail information -->
			
			
			
			
			
			<!--hupeng 20170818 send label 4pps-->
			
			<function name="sendhighlights">
				<parameters>
					<string name="transportid"/>
					<string name="trafficType"/>
				</parameters>
				<boolean name="binvalidlink" value="false"/>
				<string name="srcdevicedpid"/>
				<string name="dstdevicedpid"/>
				<string name="strlink" value=""/>	
				<string name="linkarray"/>
				<list name="linklist" valuetype="string"/>
				<object name="srcdevice"/>
				<object name="dstdevice"/>
				<list name="listdevice" valuetype="string"/>
				<pair name="oneDevicePair2" keytype="string" valuetype="object"/>
				<pair name="oneDevicePair_highlight" keytype="string" valuetype="object"/>
				<function>
					<for var="oneDevicePair_highlight" in="context.deviceContainer">
						<function>
							<set name="srcdevice" value="context.oneDevicePair_highlight.second()"/>
							<if cond="context.srcdevice != null">
								<then>
									<function name="GetDatapathId" class="srcdevice">
										<parameters>
											<string name="outdatapathid" out="srcdevicedpid"/>
										</parameters>
									</function>
								<insert name="listdevice" value="context.srcdevicedpid.toString()"/>
								</then>
							</if>	
							</function>
					</for>
					<for var="srcdevicedpid" in="context.listdevice">
						<function>
								<for var="oneDevicePair2" in="context.deviceContainer">
									<set name="dstdevice" value="context.oneDevicePair2.second()"/>
									
									<if cond="context.dstdevice != null">
										<then>
											<function name="GetDatapathId" class="dstdevice">
												<parameters>
													<string name="outdatapathid" out="dstdevicedpid"/>
												</parameters>
											</function>
										</then>
									</if>
									<if cond="context.srcdevicedpid.toString()!=context.dstdevicedpid.toString()">
										<then>
											<function>
												<set name="strlink" value="context.openflowserverobj.ptr.getShortestLink(context.srcdevicedpid.toString(), context.dstdevicedpid.toString())"/>									
												<script><![CDATA[
														if (context.strlink.toString().length>0)
														{
															var info = JSON.parse(context.strlink.toString());
															if (info.paths.length == 1)
															{
																context.binvalidlink.setValue("true");										
																if (context.trafficType.toString()=="portStatsPktSec")
																{
																	var onearray = new Object();
																	onearray.id = "of:" + context.srcdevicedpid.toString()  + "/" + info.paths[0].src.port +"-of:" + context.dstdevicedpid.toString() + "/" + info.paths[0].dst.port;
																	onearray.label = "4pps";
																	onearray.css = "secondary port-traffic-green";	
																	var strjson=JSON.stringify(onearray);
																	context.linklist.addValue(strjson);
																}
																
															}
															else 
															{	
																context.binvalidlink.setValue('false');
															}
														}
														else 
														{
															context.binvalidlink.setValue('false');
														}
												
												]]></script>
												
											</function>
										</then>
									</if>
								</for>
							</function>
						</for>
					<log><![CDATA[linklist size=<%=context.linklist.size()%>]]></log>
					<script><![CDATA[				
						var json = new Object();
						var myArray=new Array();
						
						//	qiulei 20170918 am
						var firstString=context.linklist.getFirst();
						while(firstString!=null){
							
							var jsoninfo = JSON.parse(firstString);
							myArray.push(jsoninfo);
							
							firstString=context.linklist.getNext();
						}
						
						json['event'] = "showHighlights";							
						var payload = new Object();
						var devices = new Array();	
						payload['devices'] = devices;	
						var hosts = new Array();
						payload['hosts'] = hosts;
						payload['links'] = myArray;						
						json['payload'] = payload;				
						var strjson=JSON.stringify(json);				
						context.linkarray.setValue(strjson);								
						
						
					]]></script>
				</function>
					<function>
							<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
								<jsonsrc src="linkarray"/>
							</websocket>
					</function>
					
			</function>
			
			<function name="SendDetails">	
				<parameters>	
					<string name="transportid"/>
					<string name="datapathid"/>
				</parameters>
				<object name="deviceobject"/>
				<set name="deviceobject" value="thisclass.deviceContainer.getValue(context.datapathid.toString())"/>
				<if cond="context.deviceobject.ptr != null">
					<then>
						<function name="SendDetails" class="deviceobject">
							<parameters>
								<string name="transportid" in="context.transportid.toString()"/>
							</parameters>	
						</function>
					</then>
				</if>
			</function>
			<!--Send Packet To All Port By DeviceId-->
			<function name="PacketOutToAllPort">	
				<parameters>
					<string name="datapathid"/>
					<string name="inportid"/>
					<string name="pkoutjson"/>
					<messageblock name="msgblock"/>
				</parameters>
				<object name="device"/>
				<log>PacketOutToAllPort !!!!!!!!!!!!!!</log>
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())">
					<then>
						<set name="device" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
						<if cond="context.device != null">
							<then>
								<function name="PacketOutToAllPort" class="context.device">
									<parameters>	
										<string name="inportid" in="context.inportid.toString()"/>	
										<string name="pkoutjson" in="context.pkoutjson.toString()"/>
										<messageblock name="msgblock" in="context.msgblock"/>								
									</parameters>
								</function>	
							</then>
						</if>
					</then>
				</if>
			</function>
			
			<!--
				PacketOutToAllDevicePort function Author: qiulei
				Date: 20170912 am
				effect(作用):向所有设备上的端口发,
				thinking analysis(思路分析):通过deviceContainer 遍历所有device,
											得到device对象调用该对象的PacketOutToAllPort方法向device设备上的所有端口发,-->
			<function name="PacketOutToAllDevicePort">	
				<parameters>
					<string name="inportid"/>
					<string name="pkoutjson"/>
					<messageblock name="msgblock"/>
				</parameters>
				
				<object name="device"/>
				
				<pair name="oneDevicePair_packout" keytype="string" valuetype="object"/>
				<for var="oneDevicePair_packout" in="context.deviceContainer">
					<function>
						<set name="device" value="context.oneDevicePair_packout.second()"/>
					
						<if cond="context.device != null">
							<then></then>
							<function name="PacketOutToAllPort" class="context.device">
								<parameters>	
									<string name="inportid" in="context.inportid.toString()"/>	
									<string name="pkoutjson" in="context.pkoutjson.toString()"/>
									<messageblock name="msgblock" in="context.msgblock"/>								
								</parameters>
							</function>
						</if>
					</function>
				</for>
			</function>

			
			<!--qiulei 2017.08.23   Send Packet To one Port By DeviceId   -->
			<function name="PacketOutToPort">
				<parameters>
					<string name="outputport"/>
					<string name="pkoutjson"/>
					<messageblock name="msgblock"/>
					<string name="inportid"/>
					<string name="datapathid"/>
				</parameters>
				<object name="device"/>
				<log>PacketOutToPort !!!!!!!!!!!!!!</log>
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())">
					<then>
						<set name="device" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
						<if cond="context.device != null">
							<then>
								<function name="PacketOutToPort" class="context.device">
									<parameters>
										<string name="outputport" in="context.outputport.toString()"/>
										<string name="pkoutjson" in="context.pkoutjson.toString()"/>
										<messageblock name="msgblock" in="context.msgblock"/>
										<string name="inportid" in="context.inportid.toString()"/>
									</parameters>
								</function>
							</then>
						</if>
					</then>
				</if>
			</function>
			
			<function name="GetDatapathId">	
				<parameters>	
					<string name="transportid" />
				</parameters>
				<object name="device"/>
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())">
					<then>
						<set name="device" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
						<if cond="context.device != null">
							<then>
								<function name="PacketOutToAllPort" class="context.device">
									<parameters>	
										<string name="inportid" in="context.inportid.toString()"/>	
										<string name="pkoutjson" in="context.pkoutjson.toString()"/>	
									</parameters>
								</function>	
							</then>
						</if>	
					</then>
				</if>			
			</function>
			<function name="SendTableRequest">
				<object name="device"/>
				
				
				<pair name="oneDevicePair_tablerequest" keytype="string" valuetype="object"/>
				<for var="oneDevicePair_tablerequest" in="context.deviceContainer">
					<function>
						<set name="device" value="context.oneDevicePair_tablerequest.second()"/>
						<if cond="context.device != null">
							<then>
								<function name="SendTableRequest" class="device"/>
							</then>
						</if>
					</function>
				</for>
			</function>
			<function name="GetPortsStateJsonData">	
				<parameters>
					<string name="datapathid"/>
					<string name="jsonstring"/>
				</parameters>
				<object name="device"/>
				<if cond="context.deviceContainer.hasValue(context.datapathid.toString())">
					<then>
						<set name="device" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
						<if cond="context.device != null">
							<then>
								<function name="GetPortsStateJsonData" class="context.device">
									<parameters>	
										<string name="jsonstring" out="context.jsonstring"/>
									</parameters>
								</function>	
							</then>
						</if>		
					</then>
				</if>
			</function>
			
			<!-- wangkang 2017/09/01 -->
			<function name="GetDeviceByTransportId">
				<parameters>
					<string name="transportid" />
					<object name="onedeviceobj" />
				</parameters>
				<function name="DumpT2d"/>				
				<string name="datapathid"/>
				<set name="datapathid" value="context.t2dContainer.getValue(context.transportid.toString())"/>
				<set name="onedeviceobj" value="context.deviceContainer.getValue(context.datapathid.toString())"/>
			</function>
			<function name="DumpT2d">
				<string name="t2dkey"/>								
				<pair name="oneDevicePair_dump" keytype="string" valuetype="string"/>
				<for var="oneDevicePair_dump" in="context.t2dContainer">
					<set name="t2dkey" value="context.oneDevicePair_dump.first()"/>
				</for>
			</function>
			
			<!-- qiulei 20170912 am  Get the number of devices-->
			<function name="GetDeviceCounts">
				<parameters>
					<long name="deviceCounts"/>
				</parameters>
				<set name="deviceCounts" value="context.deviceContainer.size()"/>	
			</function>
		</public>
	</class>
</starlang>