<?xml version="1.0" encoding="UTF-8"?>
<starosxml xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
	<variable name="metertestid" type="string"/>
	<class name="CMeterManager">
		<private>
			<container name="merterContainer" type="hashmap" keytype="string" valuetype="string"/>
		</private>
		<public>
			<function name="InstallMeterRequest">
				<parameters>
					<parameter name="datapathid" type="string"/>
					<parameter name="strjson" type="string"/>
					<parameter name="resourceid" type="string"/>
				</parameters>
				<variable name="sresourceid" type="string"/>
				<variable name="transportid" type="string"/>
				<set name="sresourceid" value="context.allocResourceId()"/>
				<!--qiulei modify 20170807-->
				<insert name="merterContainer" key="context.sresourceid.toString()" value="context.strjson.toString()"/>
				<function name="GetTransportIdFromDevice" class="DeviceManager">
					<parameters>
						<parameter name="datapathid" type="string" in="context.datapathid"/>
						<parameter name="transportid" type="string" out="context.transportid"/>
					</parameters>
				</function>
				<function name="Send_OFPT13_METER_MOD">
					<parameters>
						<parameter name="transportid" type="string" in="context.transportid"/>
						<parameter name="strjson" type="string" in="context.strjson.toString()"/>
					</parameters>
				</function>
				<set name="resourceid" value="context.sresourceid.toString()"/>
			</function>
			<function name="UnInstallMeterRequest">
				<parameters>
					<parameter name="datapathid" type="string"/>
					<parameter name="resourceid" type="string"/>
				</parameters>
				<variable name="transportid" type="string"/>
				<variable name="switchmeter" type="string"/>
				<variable name="flowmodjson" type="string"/>
				<variable name="sendflowmodjson" type="string"/>
				<if cond="context.merterContainer.hasValue(context.resourceid.toString()) ==true">
					<then>
						<function>
							<lookup name="merterContainer" key="context.resourceid.toString()" output="context.switchmeter"/>
						</function>
					</then>
					<else>
						<function>
							<log>UnInstallMeterRequest exit</log>
							<exit/>
						</function>
					</else>
				</if>
				<log><![CDATA[switchmeter=<%=context.switchmeter.toString()%>]]></log>
				<script><![CDATA[
						var info = JSON.parse(context.switchmeter.toString());
						info.command='3';
						var strjson=JSON.stringify(info);
						context.sendflowmodjson.setValue(strjson);
				]]></script>
				<function name="GetTransportIdFromDevice" class="DeviceManager">
					<parameters>
						<parameter name="datapathid" type="string" in="context.datapathid"/>
						<parameter name="transportid" type="string" out="context.transportid"/>
					</parameters>
				</function>
				<function name="Send_OFPT13_METER_MOD">
					<parameters>
						<parameter name="transportid" type="string" in="context.transportid"/>
						<parameter name="strjson" type="string" in="context.sendflowmodjson.toString()"/>
					</parameters>
				</function>
				<remove name="merterContainer" key="context.resourceid.toString()"/>
			</function>
			<function name="testaddmeter">			
				<parameters>
						<parameter name="datapathid" type="string"/>
				</parameters>
				<variable name="modstrjson" type="string"/>
				<variable name="resourceid" type="string" value=""/>
				<reference variable="modstrjson">
					<jsonbody><![CDATA[ 
						{
							"xid":"<%=context.openflowserverobj.getIncreaseXID()%>",
							"command":"<$=OPENFLOW_METER_MOD_ADD$>",
							"flag":"1",
							"meterid":"1",
							"meterbandlist":[
								{
									"bandtype":"1",
									"rate":"1000",
									"burstsize":"1000"
								}
							]
						}	
					]]></jsonbody>
				</reference>
				<function name="InstallMeterRequest">
					<parameters>
						<parameter name="datapathid" type="string" in="context.datapathid"/>
						<parameter name="strjson" type="string" in="context.modstrjson.toString()"/>
						<parameter name="resourceid" type="string" out="context.resourceid"/>
					</parameters>
				</function>
				<log><![CDATA[testaddmeter resourceid=<%=context.resourceid.toString()%>]]></log>
				<set name="metertestid" value="context.resourceid.toString()"/>
			</function>
			<function name="testremovemeter">			
				<parameters>
					<parameter name="datapathid" type="string"/>
				</parameters>
				<function name="UnInstallMeterRequest">
					<parameters>
						<parameter name="datapathid" type="string" in="context.datapathid"/>
						<parameter name="resourceid" type="string" in="context.metertestid"/>
					</parameters>
				</function>
				<log><![CDATA[testremovemeter metertestid=<%=context.metertestid.toString()%>]]></log>
				
			</function>
		</public>
	</class>
</starosxml>