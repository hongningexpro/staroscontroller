<?xml version="1.0" encoding="UTF-8"?>
<!--
	Copyright (C) 2013-2016 Nanjing StarOS Technology Co., Ltd
	All rights reserved.
	
	@file 		CIntentManager.xml
	@brief 		流表管理
	@version 	1.1.0
	@auth 		Yijian
	@date		2018/01/24

	Licensed under the Apache License, Version 2.0 (the "License");
	you may not use this file except in compliance with the License.
	You may obtain a copy of the License at

	http://www.apache.org/licenses/LICENSE-2.0

	Unless required by applicable law or agreed to in writing, software
	distributed under the License is distributed on an "AS IS" BASIS,
	WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
	See the License for the specific language governing permissions and
	limitations under the License.
-->
<starlang xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
	<include src="/opt/staros.xyz/staroscontroller/starlang/core/intent/CIntentDeviceManager.xml"/>

	<class name="CIntentEntry">
		<private>
			<long name="m_id"/>
			<string name="m_appId"/>
			<string name="m_type"/>
			<string name="m_priority"/>
			<string name="m_inmatchjson"/>
			<string name="m_ininstructjson"/>
			<string name="m_inputdevice"/>
			<string name="m_inport"/>
			<string name="m_outputdevice"/>
			<string name="m_outport"/>
			<string name="m_outmatchjson"/>
			<string name="m_outinstructjson"/>
			<string name="m_midmatchjson"/>
			<object name="m_devicemgrobj"/>
			<boolean name="m_bisActive" value="false"/>
		</private>
		<public>
			<function name="CIntentEntry">
				<parameters>
					<long name="id"/>
					<string name="appId"/>
					<string name="type"/>
					<string name="priority"/>
					<string name="inmatchjson"/>
					<string name="ininstructjson"/>
					<string name="inputdevice"/>
					<string name="inport"/>
					<string name="outputdevice"/>
					<string name="outport"/>
					<string name="outmatchjson"/>
					<string name="outinstructjson"/>
					<string name="midmatchjson"/>				
				</parameters>	
				<set name="thisclass.m_id" value="context.id.toLong()"/>
				<set name="thisclass.m_appId" value="context.appId.toString()"/>
				<set name="thisclass.m_type" value="context.type.toString()"/>
				<set name="thisclass.m_priority" value="context.priority.toString()"/>
				<set name="thisclass.m_inmatchjson" value="context.inmatchjson.toString()"/>
				<set name="thisclass.m_ininstructjson" value="context.ininstructjson.toString()"/>	
				<set name="thisclass.m_inputdevice" value="context.inputdevice.toString()"/>
				<set name="thisclass.m_inport" value="context.inport.toString()"/>
				<set name="thisclass.m_outputdevice" value="context.outputdevice.toString()"/>
				<set name="thisclass.m_outport" value="context.outport.toString()"/>
				<set name="thisclass.m_outmatchjson" value="context.outmatchjson.toString()"/>
				<set name="thisclass.m_outinstructjson" value="context.outinstructjson.toString()"/>
				<set name="thisclass.m_midmatchjson" value="context.midmatchjson.toString()"/>	
				<new name="thisclass.m_devicemgrobj" class="CIntentDeviceManager"/>			
			<function name="Activeintent"/>
			</function>

			<function name="Activeintent">
				<if cond="thisclass.m_bisActive.toBoolean()==true">
					<then>
						<log>Intent is Active already</log>
						<exit/>
					</then>
				</if>
				<function name="InstallIntent">
					<function name="InstallFirstDevice"/>
					<function name="InstallMiddleDevice"/>
					<function name="InstallLastDevice"/>
					<set name="thisclass.m_bisActive" value="true"/>
				</function>
			</function>

			<function name="Deactiveintent">
				<if cond="thisclass.m_bisActive.toBoolean()==false">
					<then>
						<log>Intent is Deactive already</log>
						<exit/>
					</then>
				</if>
				<if cond="thisclass.m_devicemgrobj.ptr != null">
					<then>
						<function name="Deactiveintent" class="thisclass.m_devicemgrobj"/>
					</then>
				</if>
				<set name="thisclass.m_bisActive" value="false"/>
			</function>
			
			<!--
				@brief		intent object info
				@auth 		wangkang
				@date		2018/01/24 
				Input:
				Output: 
					@param IntentToJson 	获取封装后的json信息
			-->
			<function name="IntentObjectToJsonString">
				<parameters>
					<string name="IntentToJson"/>
				</parameters>
				<string name="values"/>
				<reference variable="values">
					<jsonbody><![CDATA[ 
						{	
							"id":"<%=thisclass.m_id.toString()%>",
							"appId":"<%=thisclass.m_appId.toString()%>",
							"type":"<%=thisclass.m_type.toString()%>",
							"priority":"<%=thisclass.m_priority.toString()%>",
							"inmatchjson":"<%=thisclass.m_inmatchjson.toString()%>",
							
							"ininstructjson":"<%=thisclass.m_ininstructjson.toString()%>",
							"inputdevice":"<%=thisclass.m_inputdevice.toString()%>",
							"inport":"<%=thisclass.m_inport.toString()%>",
							"outputdevice":"<%=thisclass.m_outputdevice.toString()%>",
							"outport":"<%=thisclass.m_outport.toString()%>",
							
							"outmatchjson":"<%=thisclass.m_outmatchjson.toString()%>",
							"outinstructjson":"<%=thisclass.m_outinstructjson.toString()%>",
							"midmatchjson":"<%=thisclass.m_midmatchjson.toLong().toString()%>"
						}
					]]></jsonbody>
				</reference>
				<log><![CDATA[context.values = <%=context.values.toString()%>]]></log>
				<set name="IntentToJson" value="context.values.toString()"/>
			</function>

			<!--
			/**********************************************************************
			* 函数名称：InstallFirstDevice
			* 功能描述：安装流表封装接口
			* 访问的表：无
			* 修改的表：无
			* 返 回 值：void
			* 其它说明：
			* 修改日期      版本号  修改人      修改内容
			* **********************************************************************
			* 2018/01/24    V1.1    王康        创建
			************************************************************************/
			-->
			<function name="InstallFirstDevice">
				<object name="firstdevice"/>
				<string name="deviceid"/>
				<string name="inputport"/>
				<string name="outputport"/>

				<string name="jsonin2out"/>
				<string name="jsonout2in"/>
				<string name="strmatch"/>
				<string name="straction"/>

				<string name="flowid1"/>
				<string name="flowid2"/>

				<if cond="thisclass.m_devicemgrobj.ptr == null">
					<then>
						<log>m_devicemgrobj is null</log>
						<exit/>
					</then>
				</if>
				<function name="GetFirstDevice" class="m_devicemgrobj">
					<parameters>
						<object name="firstdevice" out="context.firstdevice"/>
					</parameters>
				</function>

				<if cond="context.firstdevice.ptr == null">
					<then>
						<log>firstdevice is null</log>
						<exit/>
					</then>
				</if>
				<function name="GetIntentDeviceInfo" class="context.firstdevice">
					<parameters>
						<string name="deviceid" out="context.deviceid"/>
						<string name="inputport" out="context.inputport"/>
						<string name="outputport" out="context.outputport"/>
					</parameters>
				</function>

				<script><![CDATA[
						var json = JSON.parse(thisclass.m_ininstructjson.toString());
						var info = JSON.parse(json.instructionlist[0]);
						var oneactionlist = info.actionlist;

						var action = new Object();
						action['type'] = "0";
						action['outport'] = context.outputport.toString();
						action['maxlen'] = "0xffff";
						oneactionlist.push(action);

						info.actionlist=JSON.stringify(oneactionlist);
						json.instructionlist[0]=JSON.stringify(info);
						context.straction.setValue(JSON.stringify(json));
				]]></script>
				<script><![CDATA[
						var json = JSON.parse(thisclass.inmatchjson.toString());
						var info = JSON.parse(json.matchfieldlist[0]);
						info.inport = context.outputport.toString();
						
						json.matchfieldlist[0]=JSON.stringify(info);
						context.strmatch.setValue(JSON.stringify(json));
				]]></script>

				<reference variable="jsonin2out">
					<jsonbody><![CDATA[ 
							{
								"xid":"<%=context.openflowserverobj.ptr.getIncreaseXID().toString()%>",
								"cookie":"0",
								"cookiemask":"0",
								"tableid":"0",
								"command":"0",
								"idletimeout":"0",
								"hardtimeout":"0",
								"priority":"<%=thisclass.m_priority.toString()%>",
								"bufferid":"0xffffffff",
								"outport":"0xffffffff",
								"outgroup":"0xffffffff",
								"flags":"1",
								"match":<%=thisclass.inmatchjson.toString()%>,
								"instructionlist":<%=context.straction.toString()%>
							}
					]]></jsonbody>
				</reference>

				<reference variable="jsonout2in">
					<jsonbody><![CDATA[ 
							{
								"xid":"<%=context.openflowserverobj.ptr.getIncreaseXID().toString()%>",
								"cookie":"0",
								"cookiemask":"0",
								"tableid":"0",
								"command":"0",
								"idletimeout":"0",
								"hardtimeout":"0",
								"priority":"<%=thisclass.m_priority.toString()%>",
								"bufferid":"0xffffffff",
								"outport":"0xffffffff",
								"outgroup":"0xffffffff",
								"flags":"1",
								"match":<%=context.strmatch.toString()%>,
								"instructionlist":<%=thisclass.m_ininstructjson.toString()%>
							}
					]]></jsonbody>
				</reference>

				<function name="InstallFlow" class="flowservice">
					<parameters>
						<string name="outflowid" out="context.flowid1"/>
						<string name="strjson" in="context.jsonin2out.toString()"/>
						<string name="appId" in="thisclass.appId.toString()"/>
						<string name="datapathid" in="context.deviceid.toString()"/>
					</parameters>
				</function>
				<function name="InstallFlow" class="flowservice">
					<parameters>
						<string name="outflowid" out="context.flowid2"/>
						<string name="strjson" in="context.jsonout2in.toString()"/>
						<string name="appId" in="thisclass.appId.toString()"/>
						<string name="datapathid" in="context.deviceid.toString()"/>
					</parameters>
				</function>

				<function name="SetIntentFlowId" class="context.firstdevice">
					<parameters>
						<string name="flowid" in="context.flowid1.toString()"/>
					</parameters>
				</function>
				<function name="SetIntentFlowId" class="context.firstdevice">
					<parameters>
						<string name="flowid" in="context.flowid2.toString()"/>
					</parameters>
				</function>
			</function>

			<!--
			/**********************************************************************
			* 函数名称：InstallMiddleDevice
			* 功能描述：安装流表封装接口
			* 访问的表：无
			* 修改的表：无
			* 返 回 值：void
			* 其它说明：
			* 修改日期      版本号  修改人      修改内容
			* **********************************************************************
			* 2018/01/24    V1.1    王康        创建
			************************************************************************/
			-->
			<function name="InstallMiddleDevice">
				<list name="middlelist" valuetype="object"/>
				<object name="onemiddle"/>
				<object name="middledevice"/>
				<string name="deviceid"/>
				<string name="inputport"/>
				<string name="outputport"/>

				<string name="jsonin2out"/>
				<string name="jsonout2in"/>
				<string name="instrmatch"/>
				<string name="instraction"/>
				<string name="outstrmatch"/>
				<string name="outstraction"/>

				<string name="flowid1"/>
				<string name="flowid2"/>

				<if cond="thisclass.m_devicemgrobj.ptr == null">
					<then>
						<log>m_devicemgrobj is null</log>
						<exit/>
					</then>
				</if>
				<function name="GetMiddleDevice" class="m_devicemgrobj">
					<parameters>
						<list name="devicelist" out="context.middlelist"/>
					</parameters>
				</function>

				<if cond="context.middlelist.size() == 0">
					<then>
						<log>middlelist is null</log>
						<exit/>
					</then>
				</if>
				<for var="context.middledevice" in="context.middlelist">
					<set name="context.onemiddle" value="context.middledevice.value()"/>
					<function name="GetIntentDeviceInfo" class="context.onemiddle">
						<parameters>
							<string name="deviceid" out="context.deviceid"/>
							<string name="inputport" out="context.inputport"/>
							<string name="outputport" out="context.outputport"/>
						</parameters>
					</function>
					<!-- in2out -->
					<script><![CDATA[
							var json = JSON.parse(thisclass.m_midmatchjson.toString());
							var info = JSON.parse(json.matchfieldlist[0]);
							info.inport = context.inputport.toString();
							
							json.matchfieldlist[0]=JSON.stringify(info);
							context.instrmatch.setValue(JSON.stringify(json));
					]]></script>
					<script><![CDATA[
							var instructionlist = new Array();
							var instruct = new Object();

							var actionlist = new Array();
							var action = new Object();
							action['type'] = "0";
							action['outport'] = context.outputport.toString();
							action['maxlen'] = "0xffff";
							actionlist.push(action);

							instruct['type'] = "4";
							instruct['actionlist'] = JSON.stringify(actionlist);
							instructionlist.push(instruct);

							context.instraction.setValue(JSON.stringify(instructionlist));
					]]></script>
					<!-- out2in -->
					<script><![CDATA[
							var json = JSON.parse(thisclass.m_midmatchjson.toString());
							var info = JSON.parse(json.matchfieldlist[0]);
							info.inport = context.outputport.toString();
							
							json.matchfieldlist[0]=JSON.stringify(info);
							context.outstrmatch.setValue(JSON.stringify(json));
					]]></script>
					<script><![CDATA[
							var instructionlist = new Array();
							var instruct = new Object();

							var actionlist = new Array();
							var action = new Object();
							action['type'] = "0";
							action['outport'] = context.inputport.toString();
							action['maxlen'] = "0xffff";
							actionlist.push(action);

							instruct['type'] = "4";
							instruct['actionlist'] = JSON.stringify(actionlist);
							instructionlist.push(instruct);

							context.outstraction.setValue(JSON.stringify(instructionlist));
					]]></script>
					<reference variable="jsonin2out">
						<jsonbody><![CDATA[ 
								{
									"xid":"<%=context.openflowserverobj.ptr.getIncreaseXID().toString()%>",
									"cookie":"0",
									"cookiemask":"0",
									"tableid":"0",
									"command":"0",
									"idletimeout":"0",
									"hardtimeout":"0",
									"priority":"<%=thisclass.m_priority.toString()%>",
									"bufferid":"0xffffffff",
									"outport":"0xffffffff",
									"outgroup":"0xffffffff",
									"flags":"1",
									"match":<%=context.instrmatch.toString()%>,
									"instructionlist":<%=context.instraction.toString()%>
								}
						]]></jsonbody>
					</reference>

					<reference variable="jsonout2in">
						<jsonbody><![CDATA[ 
								{
									"xid":"<%=context.openflowserverobj.ptr.getIncreaseXID().toString()%>",
									"cookie":"0",
									"cookiemask":"0",
									"tableid":"0",
									"command":"0",
									"idletimeout":"0",
									"hardtimeout":"0",
									"priority":"<%=thisclass.m_priority.toString()%>",
									"bufferid":"0xffffffff",
									"outport":"0xffffffff",
									"outgroup":"0xffffffff",
									"flags":"1",
									"match":<%=context.outstrmatch.toString()%>,
									"instructionlist":<%=context.instraction.toString()%>
								}
						]]></jsonbody>
					</reference>

					<function name="InstallFlow" class="flowservice">
						<parameters>
							<string name="outflowid" out="context.flowid1"/>
							<string name="strjson" in="context.jsonin2out.toString()"/>
							<string name="appId" in="thisclass.appId.toString()"/>
							<string name="datapathid" in="context.deviceid.toString()"/>
						</parameters>
					</function>
					<function name="InstallFlow" class="flowservice">
						<parameters>
							<string name="outflowid" out="context.flowid2"/>
							<string name="strjson" in="context.jsonout2in.toString()"/>
							<string name="appId" in="thisclass.appId.toString()"/>
							<string name="datapathid" in="context.deviceid.toString()"/>
						</parameters>
					</function>

					<function name="SetIntentFlowId" class="context.onemiddle">
						<parameters>
							<string name="flowid" in="context.flowid1.toString()"/>
						</parameters>
					</function>
					<function name="SetIntentFlowId" class="context.onemiddle">
						<parameters>
							<string name="flowid" in="context.flowid2.toString()"/>
						</parameters>
					</function>
				</for>
			</function>

			<!--
			/**********************************************************************
			* 函数名称：InstallLastDevice
			* 功能描述：安装流表封装接口
			* 访问的表：无
			* 修改的表：无
			* 返 回 值：void
			* 其它说明：
			* 修改日期      版本号  修改人      修改内容
			* **********************************************************************
			* 2018/01/24    V1.1    王康        创建
			************************************************************************/
			-->
			<function name="InstallLastDevice">
				<object name="lastdevice"/>
				<string name="deviceid"/>
				<string name="inputport"/>
				<string name="outputport"/>

				<string name="jsonin2out"/>
				<string name="jsonout2in"/>
				<string name="strmatch"/>
				<string name="straction"/>

				<string name="flowid1"/>
				<string name="flowid2"/>

				<if cond="thisclass.m_devicemgrobj.ptr == null">
					<then>
						<log>m_devicemgrobj is null</log>
						<exit/>
					</then>
				</if>
				<function name="GetLastDevice" class="m_devicemgrobj">
					<parameters>
						<object name="lastdevice" out="context.lastdevice"/>
					</parameters>
				</function>

				<if cond="context.lastdevice.ptr == null">
					<then>
						<log>lastdevice is null</log>
						<exit/>
					</then>
				</if>
				<function name="GetIntentDeviceInfo" class="context.lastdevice">
					<parameters>
						<string name="deviceid" out="context.deviceid"/>
						<string name="inputport" out="context.inputport"/>
						<string name="outputport" out="context.outputport"/>
					</parameters>
				</function>

				<script><![CDATA[
						var json = JSON.parse(thisclass.m_outinstructjson.toString());
						var info = JSON.parse(json.instructionlist[0]);
						var oneactionlist = info.actionlist;

						var action = new Object();
						action['type'] = "0";
						action['outport'] = context.inputport.toString();
						action['maxlen'] = "0xffff";
						oneactionlist.push(action);

						info.actionlist=JSON.stringify(oneactionlist);
						json.instructionlist[0]=JSON.stringify(info);
						context.straction.setValue(JSON.stringify(json));
				]]></script>
				<script><![CDATA[
						var json = JSON.parse(thisclass.m_outmatchjson.toString());
						var info = JSON.parse(json.matchfieldlist[0]);
						info.inport = context.inputport.toString();
						
						json.matchfieldlist[0]=JSON.stringify(info);
						context.strmatch.setValue(JSON.stringify(json));
				]]></script>

				<reference variable="jsonin2out">
					<jsonbody><![CDATA[ 
							{
								"xid":"<%=context.openflowserverobj.ptr.getIncreaseXID().toString()%>",
								"cookie":"0",
								"cookiemask":"0",
								"tableid":"0",
								"command":"0",
								"idletimeout":"0",
								"hardtimeout":"0",
								"priority":"<%=thisclass.m_priority.toString()%>",
								"bufferid":"0xffffffff",
								"outport":"0xffffffff",
								"outgroup":"0xffffffff",
								"flags":"1",
								"match":<%=context.strmatch.toString()%>,
								"instructionlist":<%=thisclass.m_outinstructjson.toString()%>
							}
					]]></jsonbody>
				</reference>

				<reference variable="jsonout2in">
					<jsonbody><![CDATA[ 
							{
								"xid":"<%=context.openflowserverobj.ptr.getIncreaseXID().toString()%>",
								"cookie":"0",
								"cookiemask":"0",
								"tableid":"0",
								"command":"0",
								"idletimeout":"0",
								"hardtimeout":"0",
								"priority":"<%=thisclass.m_priority.toString()%>",
								"bufferid":"0xffffffff",
								"outport":"0xffffffff",
								"outgroup":"0xffffffff",
								"flags":"1",
								"match":<%=thisclass.m_outmatchjson.toString()%>,
								"instructionlist":<%=context.straction.toString()%>
							}
					]]></jsonbody>
				</reference>

				<function name="InstallFlow" class="flowservice">
					<parameters>
						<string name="outflowid" out="context.flowid1"/>
						<string name="strjson" in="context.jsonin2out.toString()"/>
						<string name="appId" in="thisclass.appId.toString()"/>
						<string name="datapathid" in="context.deviceid.toString()"/>
					</parameters>
				</function>
				<function name="InstallFlow" class="flowservice">
					<parameters>
						<string name="outflowid" out="context.flowid2"/>
						<string name="strjson" in="context.jsonout2in.toString()"/>
						<string name="appId" in="thisclass.appId.toString()"/>
						<string name="datapathid" in="context.deviceid.toString()"/>
					</parameters>
				</function>

				<function name="SetIntentFlowId" class="context.lastdevice">
					<parameters>
						<string name="flowid" in="context.flowid1.toString()"/>
					</parameters>
				</function>
				<function name="SetIntentFlowId" class="context.lastdevice">
					<parameters>
						<string name="flowid" in="context.flowid2.toString()"/>
					</parameters>
				</function>
			</function>

			<!--
				@brief		Get intent id
				@auth 		wangkang
				@date		2018/01/24
				Input:					
				Output:
					@param intentid 	intent id
			-->	
			<function name="GetIntentId">
				<parameters>
					<string name="intentid"/>					
				</parameters>
				<set name="context.intentid" value="thisclass.m_id.toLong()"/>
			</function>

			<!--
				@brief		If the topology changes, restart the intent
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2017/11/16
				Input:
		   			@param fromdevice 	Source Device id
		   			@param todevice 	destination Device id
			-->
			<function name="mytopchange">
				<parameters>
					<string name="fromdevice"/>
					<string name="todevice"/>
				</parameters>
				<log level="101">###### CTunnel mytopchange ######</log>
				<log>Tunnel Top channge</log>
				<log level="101"><![CDATA[CIntentEntry mytopchange fromdevice = <%=context.fromdevice.toString()%>]]></log>
				<log level="101"><![CDATA[CIntentEntry mytopchange todevice = <%=context.todevice.toString()%>]]></log>
				<if cond="context.fromdevice.toString()==thisclass.m_inputdevice.toString()">
					<then>
						<if cond="context.todevice.toString()==thisclass.m_outputdevice.toString()">
							<then>
								<function name="Deactiveintent"/>
								<function name="Activeintent"/>
							</then>
						</if>
					</then>
					<else>
						<log><![CDATA[context.fromdevice = <%=context.fromdevice.toString()%>]]></log>
						<log><![CDATA[thisclass.m_inputdevice = <%=thisclass.m_inputdevice.toString()%>]]></log>
						<log><![CDATA[context.todevice = <%=context.todevice.toString()%>]]></log>
						<log><![CDATA[thisclass.m_outputdevice = <%=thisclass.m_outputdevice.toString()%>]]></log>
					</else>			
				</if>
			</function>
		
			<function name="Is_intent">
				<parameters>
					<string name="fromdevice"/>
					<string name="todevice"/>
					<boolean name="isChange"/>
				</parameters>
				<set name="isChange" value="false"/>
				<log level="101">###### CIntentEntry Is_intent ######</log>
				<log level="101"><![CDATA[CIntentEntry Is_intent fromdevice = <%=context.fromdevice.toString()%>]]></log>
				<log level="101"><![CDATA[CIntentEntry Is_intent todevice = <%=context.todevice.toString()%>]]></log>
				<if cond="context.fromdevice.toString() == thisclass.m_inputdevice.toString()">
					<then>
						<if cond="context.todevice.toString() == thisclass.m_outputdevice.toString()">
							<then>
								<set name="context.isChange" value="true"/>	
							</then>
						</if>
					</then>
				</if>
			</function>
			
			<function name="mytopremove">
				<parameters>
					<string name="fromdevice"/>
					<string name="todevice"/>
					<string name="path"/>
				</parameters>
				<log>###### CIntentEntry mytopremove ######</log>
				<log><![CDATA[CIntentEntry mytopremove fromdevice = <%=context.fromdevice.toString()%>]]></log>
				<log><![CDATA[CIntentEntry mytopremove todevice = <%=context.todevice.toString()%>]]></log>
				<log><![CDATA[CIntentEntry mytopremove path = <%=context.path.toString()%>]]></log>
				<function name="IsMyTopChange" class="m_devicemgrobj">
					<parameters>
						<string name="fromdevice" in="context.fromdevice.toString()"/>
						<string name="todevice" in="context.todevice.toString()"/>
						<string name="path" in="context.path.toString()"/>
						<boolean name="ischanage" out="context.isChange"/>
					</parameters>
				</function>
				<if cond="context.isChange.toBoolean()==true">
					<then>
						<function name="Deactiveintent"/>
						<function name="Activeintent"/>
					</then>					
				</if>
			</function>
	
		</public>
	</class>

	<class name="CIntentManager">
		<private>
			<hashmap name="intentContainer"  keytype="long" valuetype="object"/>
			<long name="m_intentid"/>
		</private>
		<public>
			<function name="CIntentManager">
				<log>CIntentManager is create</log>
				<set name="thisclass.m_intentid" value="1"/>
			</function>
			
			<function name="GetIntentCounts">
				<parameters>
					<long name="intentCounts"/>
				</parameters>
				<set name="intentCounts" value="context.intentContainer.size()"/>
			</function>
			
			<function name="addIntent">
				<parameters>
					<long name="intentid"/>
					<string name="appId"/>
					<string name="type"/>
					<string name="priority"/>
					<string name="inmatchjson"/>
					<string name="ininstructjson"/>
					<string name="inputdevice"/>
					<string name="inport"/>
					<string name="outputdevice"/>
					<string name="outport"/>
					<string name="outmatchjson"/>
					<string name="outinstructjson"/>
					<string name="midmatchjson"/>				
				</parameters>
				<object name="intentobj"/>
				<new name="intentobj" class="CIntentEntry">
					<parameters>
						<long name="id" in="thisclass.m_intentid.toLong()"/>
						<string name="appId" in="context.appId.toString()"/>
						<string name="type" in="context.type.toString()"/>
						<string name="priority" in="context.priority.toString()"/>
						<string name="inmatchjson" in="context.inmatchjson.toString()"/>
						<string name="ininstructjson" in="context.ininstructjson.toString()"/>
						<string name="inputdevice" in="context.inputdevice.toString()"/>
						<string name="inport" in="context.inport.toString()"/>
						<string name="outputdevice" in="context.outputdevice.toString()"/>
						<string name="outport" in="context.outport.toString()"/>
						<string name="outmatchjson" in="context.outmatchjson.toString()"/>
						<string name="outinstructjson" in="context.outinstructjson.toString()"/>
						<string name="midmatchjson" in="context.midmatchjson.toString()"/>
					</parameters>
				</new>	
				<insert name="thisclass.intentContainer" key="thisclass.m_intentid.toLong()" value="context.intentobj"/>
				<set name="context.intentid" value="thisclass.m_intentid.toLong()"/>
				<set name="thisclass.m_intentid" value="thisclass.m_intentid.toLong()+1"/>
						</function>

			<!--
				@brief		删除intent
				@auth 		wangkang
				@date		2018/01/24
				Input:
					@param intentid
				Output: 
			-->
			<function name="removeintent">
				<parameters>
					<long name="intentid"/>
				</parameters>

				<if cond="context.intentContainer.hasValue(context.intentid.toLong())==true">
					<then>
						<remove name="intentContainer" key="context.intentid.toLong()"/>
					</then>
				</if>
			</function>

			<!--
				@brief		intent转换为json字符串
				@auth 		wangkang
				@date		2018/01/24
				Input:
				Output: 
					@param AllIntentJsonString
			-->
			<function name="AllIntentToJsonStr">
				<parameters>
					<string name="AllIntentJsonString"/>
				</parameters>
				<object name="intentobj"/>
				<string name="oneintentjson"/>
				<list name="intentjsonlist" valuetype="string"/>
				<pair name="i" keytype="long" valuetype="object"/>
				<for var="i" in="context.intentContainer">
					<set name="context.intentobj" value="context.i.second()"/>
					<if cond="context.intentobj != null">
						<then>
							<function name="IntentObjectToJsonString" class="context.intentobj">
								<parameters>
									<string name="IntentToJson" out="context.oneintentjson"/>
								</parameters>
							</function>
							<insert name="context.intentjsonlist" value="context.oneintentjson.toString()"/>
						</then>
					</if>
				</for>
				
				<script><![CDATA[
					var json = new Object();
					var intentarray = new Array();
					
					var first_str = context.intentjsonlist.getFirst();
					while (first_str != null){
						var jsonobj = JSON.parse(first_str);
						intentarray.push(jsonobj);
						first_str = context.intentjsonlist.getNext();
					}
					
					json['intents']=intentarray;
					json['resultCode']="0";
					json["resultDesc"]="ok";
					var strjson = JSON.stringify(json);
					context.AllIntentJsonString.setValue(strjson);
				]]></script>
				
			</function>
			
			<!--
				@brief		Get intent object
				@auth 		wangkang
				@date		2018/01/24
				Input:
					@param intentid
				Output: 
					@param intentobj
			-->
			<function name="GetOneIntentObject">
				<parameters>
					<long name="intentid"/>
					<object name="intentobj"/>
				</parameters>
				<log level="100"><![CDATA[GetOneIntentObject intentid = <%=context.intentid.toString()%>]]></log>
				<if cond="context.intentContainer.hasValue(context.intentid.toLong())==true">
					<then>
						<lookup name="intentContainer" key="context.intentid.toLong()" output="context.intentobj"/>
					</then>
					<else>
						<log level="100"> intent is null </log>
						<syslog level="FATAL"><![CDATA[intent is null intentContainer.size = <%=thisclass.intentContainer.size().toString()%>]]></syslog>
					</else>
				</if>
			</function>
			
			<!--
				@brief		mytopchange
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2018/01/24
				Input:
		   			@param fromdevice 	Source Device id
		   			@param todevice 	destination Device id
			-->
			<function name="mytopchange">
				<parameters>
					<string name="fromdevice"/>
					<string name="todevice"/>
				</parameters>
				<log level="101">###### CIntentManager mytopchange ######</log>
				<log level="101"><![CDATA[CIntentManager intentContainer.size = <%=context.intentContainer.size().toString()%>]]></log>
				<hashmap name="intentmap" keytype="long" valuetype="object"/>
				<object name="oneintent"/>

				<for var="context.intentmap" in="thisclass.intentContainer">
					<set name="oneintent" value="context.intentmap.second()"/>
					<if cond="context.oneintent.ptr == null">
						<then>
							<log level="100">CIntentManager mytopchange oneintent is null</log>
							<exit/>
						</then>
					</if>
					<function name="mytopchange" class="oneintent">
						<parameters>
							<string name="fromdevice" in="context.fromdevice.toString()"/>
							<string name="todevice" in="context.todevice.toString()"/>
						</parameters>
					</function>
				</for>
			</function>
			

			<!--
				@brief		Check whether intent exists,if the intent does not exists,add intent 
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2018/01/24
				Input:
		   			@param fromdevice 	Source Device id
		   			@param todevice 	destination Device id
		   			@param isChange     Returns the state of Check whether intent exists
										 ture: intent exists
										 false:intent does not exist
			-->
			<function name="Is_intent">
				<parameters>
					<string name="fromdevice"/>
					<string name="todevice"/>
					<boolean name="isChange"/>
				</parameters>
				<log level="101">###### CIntentManager Is_intent ######</log>
				<log level="101"><![CDATA[CIntentManager intentContainer.size = <%=context.intentContainer.size().toString()%>]]></log>
				<if cond="context.intentContainer.size() == 0">
					<then>
						<set name="context.isChange" value="false"/>
						<exit/>
					</then>
				</if>
				<hashmap name="intentmap" keytype="long" valuetype="object"/>
				<object name="oneintent"/>

				<for var="context.intentmap" in="thisclass.intentContainer">
					<set name="oneintent" value="context.intentmap.second()"/>
					<if cond="context.oneintent.ptr == null">
						<then>
							<log level="100">CIntentManager Is_intent oneintent is null</log>
							<exit/>
						</then>
					</if>
					<function name="Is_intent" class="oneintent">
						<parameters>
							<string name="fromdevice" in="context.fromdevice.toString()"/>
							<string name="todevice" in="context.todevice.toString()"/>
							<boolean name="isChange" out="context.isChange"/>
						</parameters>
					</function>
				</for>
			</function>
			
			<!--
				@brief		Start intent
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2018/01/24
			-->
			<function name="Activeintent">
				<log>CIntentManager Activeintent</log>
			</function>			
			<!--
				@brief		Close intent
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2018/01/24
			-->			
			<function name="Deactiveintent">
				<log>CIntentManager Deactiveintent</log>
			</function>
			<!--
				@brief		ergodic the intent container calls the mytopremove function in the Cintent class
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2018/01/24
				Input:
		   			@param fromdevice 	source device id
		   			@param todevice 	destination device id
		   			@param path 	JSON data of device attributes
			-->
			<function name="mytopremove">
				<parameters>
					<string name="fromdevice"/>
					<string name="todevice"/>
					<string name="path"/>
				</parameters>
				<log>###### CIntentManager mytopremove ######</log>
				<log><![CDATA[CIntentManager intentContainer.size = <%=context.intentContainer.size().toString()%>]]></log>

				<hashmap name="intentmap" keytype="long" valuetype="object"/>
				<object name="oneintent"/>

				<for var="context.intentmap" in="thisclass.intentContainer">
					<set name="oneintent" value="context.intentmap.second()"/>
					<if cond="context.oneintent.ptr == null">
						<then>
							<log>CIntentManager oneintent is null</log>
							<exit/>
						</then>
					</if>
					<function name="mytopremove" class="oneintent">
						<parameters>
							<string name="fromdevice" in="context.fromdevice.toString()"/>
							<string name="todevice" in="context.todevice.toString()"/>
							<string name="path" in="context.path.toString()"/>
						</parameters>
					</function>
				</for>
			</function>
			

			<!--
				@brief		Get intent Num
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2018/01/24
				Output:
		   			@param size 	size of intent Container
			-->
			<function name="getintentNum">
				<parameters>
					<long name="size"/>
				</parameters>
				<set name="context.size" value="thisclass.intentContainer.size()"/>
			</function>
		</public>
	</class>
</starlang>