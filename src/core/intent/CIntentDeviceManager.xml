<?xml version="1.0" encoding="UTF-8"?>
<!--
	Copyright (C) 2013-2016 Nanjing StarOS Technology Co., Ltd
	All rights reserved.
	
	@file 		CIntentDeviceManager.xml
	@brief 		Class of intent devices management
	@version 	1.1.0
	@auth 		Wang Kang (kingsalone@sina.com)
	@date		2018/01/24

	Licensed under the Apache License, Version 2.0 (the "License");
	you may not use this file except in compliance with the License.
	You may obtain a copy of the License at

	http://www.apache.org/licenses/LICENSE-2.0

	Unless required by applicable law or agreed to in writing, software
	distributed under the License is distributed on an "AS IS" BASIS,
	WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
	See the License for the specific language governing permissions and
	limitations under the License.
-->
<starlang xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
	<include src="/opt/staros.xyz/staroscontroller/starlang/core/intent/CIntentDevice.xml"/>
	<!-- wangkang 2018/01/24 -->
	<class name="CIntentDeviceManager">
		<private>
			<list name="intentdeviceContainer" valuetype="object"/>
			<string name="m_intentPath"/>
		</private>
		<public>
			<function name="CIntentDeviceManager">
				<log>CIntentDeviceManager is create</log>
			</function>
			<!--
				@brief		Add Intent Device
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2018/01/24
				Input:
		   			@param deviceid 	Device id
		   			@param inputPort 	Device inport
		   			@param outputPort 	Device outport
			-->
			<function name="addIntentDevice">
				<parameters>
					<string name="deviceid"/>
					<string name="inputPort"/>
					<string name="outputPort"/>
				</parameters>
				<log level="100"><![CDATA[CIntentDeviceManager addIntentDevice deviceid = <%=context.deviceid.toString()%>]]></log>
				<object name="intentobj"/>
				<new name="intentobj" class="CIntentDevice">
					<parameters>
						<string name="deviceid" in="context.deviceid.toString()"/>
						<string name="inputPort" in="context.inputPort.toString()"/>
						<string name="outputPort" in="context.outputPort.toString()"/>
					</parameters>
				</new>
				<insert name="intentdeviceContainer" value="context.intentobj"/>
				<log level="100"><![CDATA[CIntentDeviceManager intentdeviceContainer.size = <%=context.intentdeviceContainer.size().toString()%>]]></log>
			</function>
			<!--
				@brief		Remove Intent Device
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2018/01/24
				Input:
		   			@param deviceid 	Device id
			-->
			<function name="removeIntentDevice">
				<parameters>
					<string name="deviceid"/>
				</parameters>
				<object name="oneintentdevice"/>
				<string name="onedeviceid"/>
				<for var="oneintentdevice" in="intentdeviceContainer">
					<function name="GetIntentDeviceId" class="oneintentdevice">
						<parameters>
							<string name="outintentdeviceid" out="context.onedeviceid"/>
						</parameters>
					</function>
					<if cond="context.onedeviceid.toString() == context.deviceid.toString()">
						<then>
							<exit/>
						</then>
					</if>
				</for>
				<remove name="intentdeviceContainer" value="oneintentdevice"/>
			</function>

			<!--
				@brief		Create Intent Device
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2018/01/24
				Input:
		   			@param deviceid 	Device id
			-->
			<function name="CreateIntentDevice">
				<parameters>
					<string name="deviceid"/>
				</parameters>
				<object name="intentobj"/>
				<new name="intentobj" class="CIntentDevice">
					<parameters>
						<string name="deviceid" in="context.deviceid.toString()"/>
						<string name="inputPort" in="'null'"/>
						<string name="outputPort" in="'null'"/>
					</parameters>
				</new>
				<insert name="intentdeviceContainer" value="context.intentobj"/>
			</function>
			<!--
				@brief		Get Intent Device From Json
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2018/01/24
				Input:
		   			@param json 	JSON data of device attributes
			-->
			<function name="GetIntentDeviceFromJson">
				<parameters>
					<string name="json"/>
				</parameters>
				<log level="101">####### CIntentDeviceManager GetIntentDeviceFromJson ######</log>
				<string name="dstport"/>
				<string name="srcport"/>
				<list name="tempContainer" valuetype="hashmap"/>
				<hashmap name="onehashmap" keytype="string" valuetype="string"/>
				<hashmap name="mapContainer" keytype="string" valuetype="string"/>
				<log><![CDATA[json=<%=context.json.toString()%>]]></log>
				<set name="m_intentPath" value="context.json.toString()"/>
				<script><![CDATA[
					if (context.json.toString().length>0)
					{
						var info = JSON.parse(context.json.toString());
						var devicesize = info.paths.length;
						for(var i=0;i<devicesize;i++)
						{
							var hashcontainer = context.createHashMap("string", "string");
							hashcontainer.addValue('device', info.paths[i].device);
							hashcontainer.addValue('inport', info.paths[i].inport);
							hashcontainer.addValue('outport', info.paths[i].outport);
							context.tempContainer.addValue(hashcontainer);
							context.destroyHashMap(hashcontainer);
						}
					}
				]]></script>
				<log><![CDATA[tempContainer size=<%=context.tempContainer.size().toString()%>]]></log>
				
				<for var="context.onehashmap" in="context.tempContainer">
					<set name="mapContainer" value="context.onehashmap.value()"/>
					<function name="addIntentDevice">
						<parameters>
							<string name="deviceid" in="context.mapContainer.getValue('device').toString()"/>
							<string name="inputPort" in="context.mapContainer.getValue('inport').toString()"/>
							<string name="outputPort" in="context.mapContainer.getValue('outport').toString()"/>
						</parameters>
					</function>
				</for>
			</function>
			<!--
				@brief		Clear all intent device
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2018/01/24
			-->		
			<function name="Clearup">
				<log>##### CIntentDeviceManager function Clearup #####</log>
				<script><![CDATA[				
					context.intentdeviceContainer.clear();
				]]></script>
			</function>
			<!--
				@brief		Check that topology has changed to the path
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2018/01/24
				Input:
		   			@param fromdevice 	source device id
		   			@param todevice 	destination device id
		   			@param path 	JSON data of device attributes
		   		Output:
		   			@param ischanage Returns the state of Check that topology has changed
									 ture: topology has changed
									 false:topology is not changed
			-->
			<function name="IsMyTopChange">
				<parameters>
					<string name="fromdevice"/>
					<string name="todevice"/>
					<string name="path"/>
					<boolean name="ischanage"/>
				</parameters>
				<log>###### CIntentDeviceManager mytopremove ######</log>
				<log><![CDATA[CIntentDeviceManager intentPath = <%=thisclass.m_intentPath.toString()%>]]></log>
				<log><![CDATA[Path = <%=context.path.toString()%>]]></log>
				<if cond="topology.convertToPath(context.path.toString())==thisclass.m_intentPath.toString()">
					<then>
						<set name="context.ischanage" value="true"/>
					</then>
					<else>
						<set name="context.ischanage" value="false"/>
					</else>			
				</if>
			</function>
			<!--
				@brief		Check that topology has changed 
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2018/01/24
				Input:
		   			@param fromdevice 	source device id
		   			@param todevice 	destination device id
		   		Output:
		   			@param ischanage Returns the state of Check that topology has changed
									 ture: topology has changed
									 false:topology is not changed
			-->
			<function name="IsMyTopChange_old">
				<parameters>
					<string name="fromdevice"/>
					<string name="todevice"/>
					<boolean name="ischanage"/>
				</parameters>
				<log level="101">###### CIntentDeviceManager IsMyTopChange_old ######</log>
				<object name="firstdevice"/>
				<object name="lastdevice"/>
				<string name="firstdeviceid"/>
				<string name="lastdeviceid"/>
				<log level="101"><![CDATA[context.intentdeviceContainer.size = <%=context.intentdeviceContainer.size().toString()%>]]></log>
				<set name="firstdevice" value="context.intentdeviceContainer.front()"/>
				<set name="lastdevice" value="context.intentdeviceContainer.back()"/>
				<if cond="context.firstdevice!=null">
					<then>
						<function name="GetIntentDeviceId" class="firstdevice">
							<parameters>
								<string name="outintentdeviceid" out="context.firstdeviceid"/>
							</parameters>
						</function>
					</then>
				</if>
				<if cond="context.lastdevice!=null">
					<then>
						<function name="GetIntentDeviceId" class="lastdevice">
							<parameters>
								<string name="outintentdeviceid" out="context.lastdeviceid"/>
							</parameters>
						</function>
					</then>
				</if>
				<if cond="context.fromdevice.toString()==context.firstdeviceid.toString()">
					<then>
						<if cond="context.todevice.toString()==context.lastdeviceid.toString()">
							<then>
								<set name="context.ischanage" value="true"/>
							</then>
						</if>
					</then>
					<else>
						<log><![CDATA[context.fromdevice.toString() = <%=context.fromdevice.toString()%>]]></log>
						<log><![CDATA[context.firstdeviceid.toString() = <%=context.firstdeviceid.toString()%>]]></log>
						<log><![CDATA[context.todevice.toString() = <%=context.todevice.toString()%>]]></log>
						<log><![CDATA[context.lastdeviceid.toString() = <%=context.lastdeviceid.toString()%>]]></log>
					</else>			
				</if>
			</function>
			<!--
				@brief		Close intent and clear intent device 
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2018/01/24
			-->
			<function name="DeactiveIntent">
				<log>##### CIntentDeviceManager function DeactiveIntent #####</log>				
				<object name="intentlist"/>
				<object name="oneintent"/>
				
				<for var="context.intentlist" in="thisclass.intentdeviceContainer">
					<set name="context.oneintent" value="context.intentlist.value()"/>
					<if cond="context.oneintent.ptr != null">
						<then>
							<function name="DeactiveIntent" class="context.oneintent"/>
						</then>
					</if>
				</for>
				<function name="Clearup"/>
			</function>
			<!--
				@brief		Get first device from intent device Container
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2018/01/24
		   		Output:
		   			@param firstdevice   first device object
			-->
			<function name="GetFirstDevice">
				<parameters>
					<object name="firstdevice"/>
				</parameters>
				<log> ##### Get First Device #####</log>
				<set name="firstdevice" value="thisclass.intentdeviceContainer.front()"/>				
			</function>
			<!--
				@brief		Get last device from intent device Container
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2018/01/24
		   		Output:
		   			@param lastdevice   last device object
			-->
			<function name="GetLastDevice">
				<parameters>
					<object name="lastdevice"/>
				</parameters>
				<log> ##### Get Last Device #####</log>
				<set name="lastdevice" value="thisclass.intentdeviceContainer.back()"/>
			</function>
			<!--
				@brief		Get middle device from intent device Container
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2018/01/24
		   		Output:
		   			@param devicelist   middle device list
			-->
			<function name="GetMiddleDevice">
				<parameters>
					<list name="devicelist"/>
				</parameters>
				<log> ##### Get Middle Device List #####</log>
				<list-iterator name="beginit" valuetype="object"/>
				<list-iterator name="endit" valuetype="object"/>
				<list-iterator name="middevice" valuetype="object"/>
				<set name="beginit" value="context.intentdeviceContainer.beginNext()"/>
				<set name="endit" value="context.intentdeviceContainer.endBefore()"/>
				
				<if cond="context.intentdeviceContainer.size() > 2">
					<then>
						<for var="context.middevice" from="context.beginit" to="context.endit">
							<insert name="devicelist" value="context.middevice.value()"/>
							<log><![CDATA[devicelist size=<%=context.devicelist.size().toString()%>]]></log>		
						</for>
					</then>
					<else>
						<log>##### DeviceList is null #####</log>
					</else>
				</if>
			</function>
			<!--
				@brief		Print intent device from intent device Container
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2018/01/24
			-->
			<function name="PrintIntentDevice">
				<object name="intentlist"/>
				<object name="intentobj"/>
				<for var="intentlist" in="context.intentdeviceContainer">
					<set name="context.intentobj" value="context.intentlist.value()"/>
					<if cond="context.intentobj!=null">
						<then>
							<function name="Printintent" class="context.intentobj"/>
						</then>
					</if>
				</for>
			</function>
			<!--
				@brief		Find device from intent device Container
				@auth 		Wang Kang (kingsalone@sina.com)
				@date		2018/01/24
				Input:
		   			@param deviceid 	device id
		   		Output:
		   			@param ischanage Returns the state of find device from intent device Container
									 ture: find device
									 false:can't find device
			-->
			<function name="FindIntentDevice">
				<parameters>
					<string name="deviceid"/>
					<boolean name="ischanage"/>
				</parameters>
				<log level="101">###### CIntentDeviceManager FindDevice ######</log>
				<object name="oneintentdevice"/>
				<string name="onedeviceid"/>
				<log level="101"><![CDATA[FindDevice intentdeviceContainer.size = <%=context.intentdeviceContainer.size().toString()%>]]></log>
				<for var="oneintentdevice" in="intentdeviceContainer">
					<log level="101">FindDevice for </log>
					<function name="GetIntentDeviceId" class="oneintentdevice">
						<parameters>
							<string name="outintentdeviceid" out="context.onedeviceid"/>
						</parameters>
					</function>
					<log level="101"><![CDATA[FindDevice onedeviceid= <%=context.onedeviceid.toString()%>]]></log>
					<if cond="context.onedeviceid.toString() == context.deviceid.toString()">
						<then>
							<log level="101">The Device was found </log>
							<set name="context.ischanage" value="true"/>
						</then>
					</if>
				</for>
			</function>

		</public>
	</class>
</starlang>	
