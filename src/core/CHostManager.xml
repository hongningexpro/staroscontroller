<?xml version="1.0" encoding="UTF-8"?>
<!--
	Copyright (C) 2013-2016 Nanjing StarOS Technology Co., Ltd
	All rights reserved.
	
	@file 		CHostManager.xml
	@brief 		hostmanager
	@version 	1.1.0
	@auth 		YY
	@date		2017/11/27

	Licensed under the Apache License, Version 2.0 (the "License");
	you may not use this file except in compliance with the License.
	You may obtain a copy of the License at

	http://www.apache.org/licenses/LICENSE-2.0

	Unless required by applicable law or agreed to in writing, software
	distributed under the License is distributed on an "AS IS" BASIS,
	WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
	See the License for the specific language governing permissions and
	limitations under the License.
-->
<starlang xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
	<class name="CHost">
		<private>
			<string name="m_mac" />		
			<string name="m_ip" />	
			<string name="m_vlan" />
			<string name="m_deviceid" />	
			<string name="m_port" />
		</private>
		<public>
			<function name="CHost">
				<parameters>
					<string name="mac" />		
					<string name="ip" />	
					<string name="vlan" />
					<string name="deviceid" />	
					<string name="port" />				
				</parameters>
					<set name="thisclass.m_mac" value="context.mac.toString()"/>
					<set name="thisclass.m_ip" value="context.ip.toString()"/>
					<set name="thisclass.m_vlan" value="context.vlan.toString()"/>
					<set name="thisclass.m_deviceid" value="context.deviceid.toString()"/>
					<set name="thisclass.m_port" value="context.port.toString()"/>
				
			</function>
			<!--
				@brief		打印host信息
				@auth 		YY
				@date		2017/11/27
				Input:					
				Output:
			-->	
			<function name="printhost">
				<log><![CDATA[m_mac <%=thisclass.m_mac.toString()%>]]></log>
				<log><![CDATA[m_ip <%=thisclass.m_ip.toString()%>]]></log>
				<log><![CDATA[m_vlan <%=thisclass.m_vlan.toString()%>]]> </log>
				<log><![CDATA[m_deviceid <%=thisclass.m_deviceid.toString()%>]]> </log>
				<log><![CDATA[m_port <%=thisclass.m_port.toString()%>]]></log>
			</function>
			<!--
				@brief		获取hostjson信息
				@auth 		YY
				@date		2017/11/27
				Input:
				Output:
					@param jsonstring 	host的json信息
			-->	
			<function name="ToString">
				<parameters>
					<string name="jsonstring"  out="context.outjson"/>
				</parameters>
				<script><![CDATA[
						var onearray = new Object();
						onearray._iconid_type='hostIcon_endstation';
						onearray.id=thisclass.m_mac.toString()+"/"+thisclass.m_vlan.toString();
						onearray.mac=thisclass.m_mac.toString();
						onearray.vlan=thisclass.m_vlan.toString();
						onearray.ips=thisclass.m_ip.toString();
						onearray.location=thisclass.m_deviceid.toString()+"/"+thisclass.m_port.toString();
						var strjson=JSON.stringify(onearray);
						context.jsonstring.setValue(strjson);
					]]></script>
			</function>
			<!--
				@brief		获取hostjson信息
				@auth 		YY
				@date		2017/11/27
				Input:
				Output:
					@param strjson 	host的json信息
			-->	
			<function name="ToAddHost2Json">
				<parameters>
					<string name="strjson"/>
				</parameters>
				<string name="addhostjson" />
				<reference variable="addhostjson">
					<jsonbody>
						<![CDATA[
							{
								"event":"addHost",
								"payload":
								{
									"id":"<%=thisclass.m_mac.toString()+"/"+thisclass.m_vlan.toString()%>",
									"type":"endstation",
									"ingress":"<%=thisclass.m_mac.toString()+"/"+thisclass.m_vlan.toString()+"/"+thisclass.m_port.toString()+"-"+thisclass.m_deviceid.toString()+"/"+thisclass.m_port.toString()%>",
									"egress":"<%=thisclass.m_deviceid.toString()+"/"+thisclass.m_port.toString()+"-"+thisclass.m_mac.toString()+"/"+thisclass.m_vlan.toString()+"/"+thisclass.m_port.toString()%>",
									"cp":
									{
										"device":"<%=thisclass.m_deviceid.toString()%>",
										"port":<%=thisclass.m_port.toString()%>
									},
									"labels":
										[
											"<%=thisclass.m_ip.toString()%>",
											"<%=thisclass.m_mac.toString()%>"
										],
									"props":{},
									"metaUi":
									{
										"x":317.73021781939826,
										"y":199.57886255805693,
										"equivLoc":
										{
										"lng":-98.18860657853635,
										"lat":43.492555430485986
										}
									}
								}
							}	
						]]>
					</jsonbody>
				</reference>
				<set name="strjson" value="context.addhostjson.toString()"/>				
			</function>
		</public>
	</class>
	<class name="CHostManager" extends="CListenerBase">
		<private>
			<hashmap name="hostContainer" keytype="string" valuetype="object"/>
		</private>
		<public>
			
			<function name="CHostManager">
				<log>CHostManager is create</log>				
			</function>
			<!--
				@brief		添加一个host
				@auth 		YY
				@date		2017/11/27
				Input:
					@param mac 	host的mac信息
					@param ip 	host的ip信息
					@param vlan 	host的vlan信息
					@param deviceid 	host的deviceid信息
					@param port 	host的port信息
				Output:					
			-->	
			<function name="addHost">
				<parameters>
					<string name="mac" />		
					<string name="ip" />	
					<string name="vlan"/>
					<string name="deviceid" />	
					<string name="port"/>				
				</parameters>
				<log level="100">###### CHostManager addHost #######</log>
				<object name="hostobj"/>	
				<new name="hostobj" class="CHost">
					<parameters>
						<string name="mac"  in="context.mac.toString()"/>		
						<string name="ip" in="context.ip.toString()"/>	
						<string name="vlan"  in="context.vlan.toString()"/>
						<string name="deviceid"  in="context.deviceid.toString()"/>	
						<string name="port"  in="context.port.toString()"/>				
				</parameters>
				</new>
				<if cond="context.hostContainer.hasValue(context.mac.toString()+'/'+context.vlan.toString())">
					<then>
						<exit/>
					</then>
				</if>
				<insert name="hostContainer" key="context.mac.toString()+'/'+context.vlan.toString()" value="context.hostobj"/>
				<string name="functionname"/>
				<for var="context.functionname" in="context.listernellist">
					<function callback="functionname">
						<parameters>
								<string name="type" in="'add'"/>
								<string name="hostobject" in="context.hostobj.toString()"/>					
						</parameters>
					</function>		
				</for>
				<log level="100"><![CDATA[CHostManager hostContainer.size = <%=context.hostContainer.size().toString()%>]]></log>
			</function>
			
			<!--
				@brief		删除一个host
				@auth 		YY
				@date		2017/11/27
				Input:
					@param mac 	    host的mac信息
					@param vlan 	host的vlan信息
				Output:					
			-->	
			<function name="RemoveHost"> 
				<parameters>
					<string name="mac"/>
					<string name="vlan"/>
				</parameters>
				<string name="functionname"/>
				<object name="hostobj"/>
				<pair name="onehostpair"/>
				<if cond="context.hostContainer.hasValue(context.mac.toString()+'/'+context.vlan.toString())">
					<then>
						<function name="FindHost">
							<parameters>
								<string name="mac" in="context.mac.toString()"/>
								<string name="vlan" in="context.vlan.toString()"/>
								<object name="hostobj" out="context.hostobj"/>
							</parameters>
						</function>
						<for var="context.functionname" in="context.listernellist">
							<function callback="functionname">
								<parameters>
									<string name="type" in="'remove'"/>
									<string name="hostobject" in="context.hostobj"/>						
								</parameters>
							</function>		
						</for>
						<remove name="hostContainer" key="context.mac.toString()+'/'+context.vlan.toString()"/>
					</then>
				</if>
			</function>

			<function name="FindHost">
				<parameters>
					<string name="mac"/>
					<string name="vlan"/>
					<object name="hostobj"/>
				</parameters>
				<string name="hostcontainerkey"/>
				<pair name="onehostpair" keytype="string" valuetype="object"/>
				<for var="context.onehostpair" in="thisclass.hostContainer">
					<set name="context.hostcontainerkey" value="context.onehostpair.first().toString()"/>
					<if cond="context.hostcontainerkey.toString() == context.mac.toString()+'/'+context.vlan.toString()">
						<then>
							<set name="context.hostobj" value="context.onehostpair.second()"/>
							<exit/>
						</then>
					</if>
				</for>
			</function>
			<!--
				@brief		打印一个host信息
				@auth 		YY
				@date		2017/11/27
				Input:
				Output:					
			-->	
			<function name="printhostmanager">
				<object name="onehostinfo" />
				<pair name="onehostpair"  keytype="string" valuetype="object"/>
				<for var="onehostpair" in="context.hostContainer">
					<function>
						<set name="onehostinfo" value="context.onehostpair.second()"/>
						<if cond="context.onehostinfo.ptr == null">
							<then>
								<log>onehostinfo is null </log>
								<exit/>
							</then>
						</if>
						<function name="printhost" class="context.onehostinfo"/>
					</function>
				</for>
			</function>
			<!--
				@brief		获取所有hostjson信息
				@auth 		YY
				@date		2017/11/27
				Input:					
				Output:
					@param jsonstring 	所有hostjson信息					
			-->	
			<function name="GetHostJsonData">
				<parameters>
					<string name="jsonstring" />
				</parameters>
				<string name="outjson"/>
				<object name="onehostinfo" />
				<list name="hostlist"  valuetype="string"/>
				<pair name="onehostpair"  keytype="string" valuetype="object"/>
				<for var="onehostpair" in="context.hostContainer">
					<function>
						<set name="onehostinfo" value="context.onehostpair.second()"/>
						<if cond="context.onehostinfo.ptr == null">
							<then>
								<log>onehostinfo is null </log>
								<exit/>
							</then>
						</if>
						<function name="ToString" class="onehostinfo">
							<parameters>
								<string name="jsonstring"  out="context.outjson"/>
							</parameters>
						</function>
						<insert name="hostlist" value="context.outjson.toString()"/>
					</function>
				</for>
				<script><![CDATA[
					var json = new Object();
					var myArray=new Array(); 
					var firststr=context.hostlist.getFirst();
					while(firststr!=null){
						var host = firststr;									
						var info = JSON.parse(host);	
						myArray.push(info);
						firststr=context.hostlist.getNext();
					}

					
					json['event']='hostDataResponse';	
					var payload = new Object();
					payload['hosts']=myArray;
					json['payload']=payload;
					
					var msg = new Object();
					msg["no_rows_msg"]="No Hosts found";
					info["annots"]=msg;
					
					var strjson=JSON.stringify(json);
					context.jsonstring.setValue(strjson);
				]]></script>
			</function>
			<!--
				@brief		获取hostjson信息
				@auth 		YY
				@date		2017/11/27
				Input:	
					@param key 	key信息
					@param insts 	insts信息
					@param summary 	summary信息
					@param detail 	detail信息
					@param hosts 	hosts信息
					@param offdev 	offdev信息
					@param dlbls 	dlbls信息
					@param porthl 	porthl信息
					@param bg 	bg信息
					@param spr 	spr信息
					@param ovid 	ovid信息
					@param toolbar 	toolbar信息
					@param type 	type信息				
				Output:
					@param outjson 	获取封装后的json信息					
			-->	
			<function name="GetHostLinkJsonData">
				<parameters>
					<string name="key" />
					<string name="insts" />
					<string name="summary" />
					<string name="detail" />
					<string name="hosts" />
					<string name="offdev" />
					<string name="dlbls" />
					<string name="porthl" />
					<string name="bg" />
					<string name="spr" />
					<string name="ovid" />
					<string name="toolbar" />
					<string name="type" />
					<string name="outjson" />					
				</parameters>				
				<if cond="context.type.toString()==0">
					<then>
						<script><![CDATA[
							var json = new Object();
							json.event = "updatePrefs";
							var payload = new Object();
							var oneobject = new Object();
							oneobject.insts = context.insts.toString();
							oneobject.summary = context.summary.toString();
							oneobject.detail = context.detail.toString();
							oneobject.hosts = context.hosts.toString();
							oneobject.offdev = context.offdev.toString();
							oneobject.dlbls = context.dlbls.toString();
							oneobject.porthl = context.porthl.toString();
							oneobject.bg = context.bg.toString();
							oneobject.spr = context.spr.toString();
							oneobject.ovid = context.ovid.toString();
							oneobject.toolbar = context.toolbar.toString();
							/*
							var twoobject = new Object();
							twoobject.mapid = "usa";
							twoobject.mapscale = "1";
							twoobject.mapfilepath = "*continental_us";
							twoobject.tint = "off";
							*/
							/*
							var threeobject = new Object();
							threeobject.tx = 0;
							threeobject.ty = 0;
							threeobject.sc = 1;
							*/
							//var p_one = context.key.toString();
							payload.topo_prefs = oneobject;
							//payload[topo_mapid] = twoobject;
							//payload[topo_zoom] = threeobject;
							json.payload = payload;
							var strjson = JSON.stringify(json);
							context.outjson.setValue(strjson);							
						]]></script>
					</then>
					<else>
						<if cond="context.type.toString()==1">
							<then>
								<script><![CDATA[
									var json = new Object();
									json.event = "updatePrefs";
									var payload = new Object();
									var twoobject = new Object();
									twoobject.mapid = "usa";
									twoobject.mapscale = "1";
									twoobject.mapfilepath = "*continental_us";
									twoobject.tint = "off";
									payload.topo_mapid = twoobject;
									json.payload = payload;
									var strjson = JSON.stringify(json);
									context.outjson.setValue(strjson);									
								]]></script>
							</then>
							<else>
								<script><![CDATA[
									var json = new Object();
									json.event = "updatePrefs";
									var payload = new Object();
									var threeobject = new Object();
									threeobject.tx = 0;
									threeobject.ty = 0;
									threeobject.sc = 1;
									payload.topo_zoom = threeobject;
									json.payload = payload;
									var strjson = JSON.stringify(json);
									context.outjson.setValue(strjson);									
								]]></script>
							</else>
						</if>
					</else>
				</if>
			</function>
			<!--
				@brief		发送host信息到web前端
				@auth 		YY
				@date		2017/11/27
				Input:	
					@param transportid 	发包id			
				Output:								
			-->
			<function name="SendAddAllHostToWebClient">
				<parameters>
					<string name="transportid" />
				</parameters>
				<string name="sendjsonstr" />				
				<object name="hostobj" />	
				<pair name="onehostpair"  keytype="string" valuetype="object"/>				
				<for var="onehostpair" in="context.hostContainer">
					<set name="hostobj" value="context.onehostpair.second()"/>
					<if cond="context.hostobj.ptr!=null">
						<then>
							<function name="ToAddHost2Json" class="hostobj">
								<parameters>
									<string name="strjson"  out="context.sendjsonstr"/>
								</parameters>
							</function>
							<websocket name="restfulserver" method="SendText" transportid="context.transportid.toString()">
								<jsonsrc src="sendjsonstr"/>
							</websocket>
						</then>
					</if>										
					
				</for>				
			</function>
			
			<!-- qiulei 2017/12/28 pm  Get the number of hostContainer-->
			<function name="GetHostCounts">
				<parameters>
					<long name="hostCounts"/>
				</parameters>
				<set name="hostCounts" value="context.hostContainer.size()"/>	
			</function>
		</public>
	</class>
</starlang>
