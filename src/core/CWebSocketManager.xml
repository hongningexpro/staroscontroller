<?xml version="1.0" encoding="UTF-8"?>
<starlang xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
	<class name="CWebSocketManager">
		<private>
			<hashmap name="clientContainer" keytype="string" valuetype="string"/>
		</private>
		<public>
			<function name="addWebSocket">
				<parameters>
					<string name="transportid"/>			
				</parameters>
				<log><![CDATA[addWebSocket size=<%=context.clientContainer.size()%>]]></log>
				<if cond="context.clientContainer.hasValue(context.transportid.toString()) != true">
					<then>
						<function>
							<insert name="clientContainer" key="context.transportid.toString()" value="context.transportid.toString()"/>
						</function>
					</then>
					<else>
						<function>
							<log>addWebSocket already have the websocket</log>
						</function>
					</else>
				</if>
			</function>
			<function name="RemoveWebSocket">
				<parameters>
					<string name="transportid"/>			
				</parameters>
				<log><![CDATA[RemoveWebSocket size=<%=context.clientContainer.size()%>]]></log>
				<if cond="context.clientContainer.hasValue(context.transportid.toString())">
					<then>						
						<remove name="clientContainer" key="context.transportid.toString()"/>				
					</then>
				</if>
			</function>
			<function name="SendToAllClient">
				<parameters>
					<string name="strjson"/>			
				</parameters>
				<log><![CDATA[SendToAllClient strjson =<%=context.strjson.toString()%>]]></log>
				<string name="client"/>
				<log><![CDATA[clientContainer size =<%=context.clientContainer.size()%>]]></log>
				<pair name="oneclientContainer" keytype="string" valuetype="string"/>
				<for var="oneclientContainer" in="context.clientContainer">
					<function>
						<set name="client" value="context.oneclientContainer.second()"/>
						<log><![CDATA[oneclientContainer value =<%=context.client.toString()%>]]></log>
						<websocket name="restfulserver" method="SendText" transportid="context.client.toString()">
							<jsonsrc src="strjson"/>
						</websocket>
					</function>
				</for>
			</function>
		</public>
	</class>
</starlang>