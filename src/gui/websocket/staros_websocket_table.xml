<?xml version="1.0" encoding="UTF-8"?>
<starlang xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
<!--
	Author:
			YY
	Date:
			2017-08-31
	Copyright: 
			Nanjing StarOS Inc. All rights reserved.
-->
	<!--
		YY 20170831
		send data to web
		1) get device from eventdata.devId use DeviceManager's findDevice function
		2) get device's tabledata from device
		3) send data to web
	-->
	<function name="HandleTableDataRequest">
		<string name="deviceid"/>
		<object name="deviceobj"/>
		<string name="outjson"/>
		<script><![CDATA[
			var info = JSON.parse(event.getParam('eventdata').toString());
			var devid = info.payload.devId;
			var deviceids = devid.split(":")[1];
			context.deviceid.setValue(deviceids);
		]]></script>
		<function name="findDevice" class="DeviceManager">
			<parameters>
				<string name="datapathid" in="context.deviceid.toString()"/>
				<object name="deviceobject" out="context.deviceobj"/>
			</parameters>
		</function>
		
<if cond="context.deviceobj.ptr==null">
			<then>
				<log>deviceobj is null</log>
				<exit/>
			</then>
		</if>
		<function name="GetTableData" class="context.deviceobj">
					<parameters>				
						<string name="json" out="context.outjson"/>
					</parameters>
				</function>
					<websocket name="restfulserver" method="SendText" transportid="event.getParam('transportid').toString()">
			<jsonsrc src="outjson"/>
		</websocket>
	</function>
</starlang>