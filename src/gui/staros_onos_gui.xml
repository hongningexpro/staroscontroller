<?xml version="1.0" encoding="UTF-8"?>
<starosxml xmlns="http://www.staros.xyz/starcore" scope="application">
	<include src="/opt/staros.xyz/staroscontroller/starlang/gui/staros_websocket_handler.xml"/>
	<!--WebGUI-->
	<variable name="newSession"/>
	<variable name="nulltest" type="string"/>
	<variable name="systemparam" type="params"/>
	<variable name="requestcount" type="long"/>
	<variable name="isStop" type="boolean" value="true"/>
	<function name="Restfulserver">
		<variable name="restfulparams" type="params"/>
		<!--hu peng 2017/07/28-->
		<set name="restfulparams" paramname="listenip" value="context.GlobalSetting.getParam('guiip').toString()"/>
		<set name="restfulparams" paramname="listenport" value="context.GlobalSetting.getParam('guiport').toString()"/>
		<set name="restfulparams" paramname="protocol" value="context.GlobalSetting.getParam('guiprotocol').toString()"/>
		<set name="restfulparams" paramname="cerfile" value="context.GlobalSetting.getParam('guicerfile').toString()"/>
		<set name="restfulparams" paramname="keyfile" value="context.GlobalSetting.getParam('guikeyfile').toString()"/>
		<log>Restfulserver</log>
		<restful name="restfulserver" action="SERVER" param="restfulparams" expectevent="restfulrequest.event"/>
	</function>
	<events>
		<onevent event="restfulrequest.event">
			<variable name="usernameparam" type="string"/>
			<variable name="passwordparam" type="string"/>
			<variable name="authresult" type="string"/>
			<variable name="authjson" type="string"/>
			<variable name="httpparam" type="params"/>
			<variable name="transportid" type="string"/>
			<messageblock name="authresultmsg"/>
			<variable name="contenttype" type="string"/>
			<variable name="requestpath" type="string"/>
			<variable name="filepath" type="string"/>
			<variable name="filename" type="string"/>
			<variable name="xmldata" type="string"/>
			<variable name="appname" type="string"/>
			<variable name="isAPI" type="boolean"/>
			<function>
				<!--qiulie-->
				<set name="transportid" value="event.getParam('transportid').toString()"/>
				<set name="requestpath" value="event.getParam('requestpath').toString()"/>
				<set name="requestcount" value="context.requestcount.toLong()+1"/>
				<log dest="stdout"><![CDATA[restfulrequest eventname <%=event.getName()%>]]> </log>
				<log dest="stdout"><![CDATA[restfulrequest transportid '<%=event.getParam("transportid").toString()%>']]></log>
				<log dest="stdout"><![CDATA[restfulrequest eventdata '<%=event.getParam("eventdata").toString()%>']]></log>
				<log dest="stdout"><![CDATA[restfulrequest requestpath '<%=event.getParam("requestpath").toString()%>']]></log>
				<log dest="stdout"><![CDATA[restfulrequest method '<%=event.getParam("method").toString()%>']]></log>
				<log dest="stdout"><![CDATA[requestcount= '<%=context.requestcount.toLong()%>']]></log>
				<if cond="event.getParam('requestpath').toString() == '/onos/ui/j_security_check'">
					<then>
						<function>
							<script><![CDATA[
								var x = event.getParam("eventdata").toString();
								//j_username=karaf&j_password=karaf
								var username=(x.split("&")[0]).split("=")[1];
								var password=(x.split("&")[1]).split("=")[1];	
								context.usernameparam.setValue(username);
								context.passwordparam.setValue(password);
							  ]]></script>
							  <log><![CDATA[username= '<%=context.usernameparam.toString()%>']]></log>
							  <log><![CDATA[password= '<%=context.passwordparam.toString()%>']]></log>
							<remotecall method="AuthRequest">
								<applicationdata>
								<![CDATA[ 
								{
									"username":"<%=context.usernameparam.toString()%>",
									"password":"<%=context.passwordparam.toString()%>"
								}
								]]>
								</applicationdata>
							</remotecall>
							<wait event="event.AuthReply" timeout="1000">	
								<log dest="stdout">Got event.AuthReply</log>
								<set name="authresultmsg" value="event.getMessageBlock()"/>
								<set name="authjson" value="context.authresultmsg.toString()"/>
								<script><![CDATA[
									var info = JSON.parse(context.authjson.toString());
									context.authresult.setValue(info.result);
								]]></script>
								<log><![CDATA[auth reply json= '<%=context.authjson.toString()%>']]></log>
								<if cond="context.authresult.toString() == 'ok'">
									<then>
										<function>
											<log><![CDATA[auth ok transportid= '<%=context.transportid.toString()%>']]></log>
											<set name="httpparam" paramname="Location" value="'/onos/ui/index.html'"/>
											<restful name="restfulserver" action="RESPONSE" status="301" text="Moved Temporarily" transportid="context.transportid.toString()" httpparams="httpparam"/>
											<restful name="restfulserver" action="Disconnect" transportid="context.transportid.toString()"/>
										</function>
									</then>
									<else>
										<log>auth failure</log>
										<function>
											<set name="httpparam" paramname="Location" value="'/onos/ui/error.html'"/>
											<restful name="restfulserver" action="RESPONSE" status="301" text="Moved Temporarily" transportid="context.transportid.toString()" httpparams="httpparam"/>
											<restful name="restfulserver" action="Disconnect" transportid="context.transportid.toString()"/>
										</function>
									</else>
								</if>
							</wait>
						</function>
					</then>
					<elseif cond="context.requestpath.toString() == '/onos/ui/rs/applications/upload'">
						<function>
							<log><![CDATA[!!!!!!!!!!!!eventdata= '<%=event.getParam("eventdata").toString()%>']]></log>
							<script><![CDATA[
								var x = event.getParam("eventdata").toString();
								var Contentindex=x.indexOf("Content-Disposition");
								var Contentendindex=x.indexOf("Content-Type");
								var firsthead=x.substring(Contentindex,Contentendindex);
								var filenames=firsthead.split(";")[2];
								var filefirst=filenames.indexOf("=");
								var filelast=filenames.indexOf(".xml");
								var filename=filenames.substring(filefirst+2,filelast+4);
								context.print("filename!!!!!!!!!!!!:"+filename);
								var filenamefloderindex=filenames.indexOf("=");
								var filenamefloderlastindex=filenames.indexOf(".xml");
								var filenamefloder=filenames.substring(filenamefloderindex+2,filenamefloderlastindex);
								context.print("filenamefloder!!!!!!!!!!!!:"+filenamefloder);
								context.appname.setValue(filenamefloder);
								var absolutefilename="/opt/staros.xyz/staroscontroller/starlang/apps/"+filenamefloder+"/"+filename;
								context.filepath.setValue("/opt/staros.xyz/staroscontroller/starlang/apps/"+filenamefloder);
								context.print("absolutefilename!!!!!!!!!!!!:"+absolutefilename);
								context.filename.setValue(absolutefilename);
								var head=x.indexOf("<?xml");
								context.print("head!!!!!!!!!!!!:"+head);
								var end=x.indexOf("</starosxml>");
								var contents=x.substring(head,end+12);
								context.print("contents!!!!!!!!!!!!:"+contents);
								context.xmldata.setValue(contents);
							  ]]></script>
							  
							<log><![CDATA[filename= '<%=context.filename.toString()%>']]></log>
							<log><![CDATA[xmldata= '<%=context.xmldata.toString()%>']]></log>
							<file method="mkdir" name="context.filepath.toString()"/>
							<function name="WriteToFile">
								<parameters>
									<parameter name="filename" type="string" in="context.filename.toString()"/>
									<parameter name="xmldata" type="string" in="context.xmldata.toString()"/>
								</parameters>
							</function>
							<function name="SetCurrentappname" class="ApplicationManager">
								<parameters>
									<parameter name="inappname" type="string"  in="context.appname.toString()"/>
								</parameters>
							</function>
								<!--response 200-->
							<function name="LoadApplication" class="ApplicationManager"/>
							<set name="httpparam" paramname="Server" value="'StarOS.xyz'"/>
							<set name="httpparam" paramname="Connection" value="'Close'"/>
							<restful name="restfulserver" action="RESPONSE" status="200" text="ok" transportid="context.transportid.toString()" httpparams="httpparam"/>
							<restful name="restfulserver" action="Disconnect" transportid="context.transportid.toString()"/>
						</function>
					</elseif>
					<elseif cond="context.requestpath.toString() == '/onos/ui/websock/core'">
						<function>
							<log><![CDATA[get a web socket connect= '<%=context.transportid.toString()%>']]></log>
							<websocket name="restfulserver" method="AcceptWebSocket" transportid="context.transportid.toString()" openevent="websocketopen" dataevent="websocketdata" disconnectevent="websocketdisconnect"/>
						</function>
					</elseif>
					<elseif cond="context.requestpath.toString() == '/onos/ui/websock/core'">
						<function>
							<log><![CDATA[get a web socket connect= '<%=context.transportid.toString()%>']]></log>
							<websocket name="restfulserver" method="AcceptWebSocket" transportid="context.transportid.toString()" openevent="websocketopen" dataevent="websocketdata" disconnectevent="websocketdisconnect"/>
						</function>
					</elseif>
					<elseif cond="context.requestpath.toString() == '/onos/ui/rs/logout'">
						<function>
							<log><![CDATA[get a web socket connect= '<%=context.transportid.toString()%>']]></log>
								<set name="httpparam" paramname="Location" value="'/onos/ui/login.html'"/>
								<restful name="restfulserver" action="RESPONSE" status="301" text="Moved Temporarily" transportid="context.transportid.toString()" httpparams="httpparam"/>
								<restful name="restfulserver" action="Disconnect" transportid="context.transportid.toString()"/>
						</function>
					</elseif>
					<else>
						<function>
							<!--yige start-->
							<script><![CDATA[
								var x = context.requestpath.toString();
								if((x.indexOf("/onos/ui/rs/applications/") >= 0)&&(x.indexOf("icon") >= 0)){
									var filename="/opt/staros.xyz/staroscontroller/starlang/gui/gui/onos/ui/data/img/icon.png";
									context.filepath.setValue(filename);
									context.contenttype.setValue('image/png');
								}
								else if (x.indexOf('/api/v1/')>=0)
								{	
									context.isAPI.setValue(true);
								}
								else 
								{
									if (x.indexOf("/onos/v1/docs") >=0)
									{
										var filename="/opt/staros.xyz/staroscontroller/starlang/restfulapi"+x;
										context.filepath.setValue(filename);	
									}
									else
									{
										var filename="/opt/staros.xyz/staroscontroller/starlang/gui/gui"+x;
										context.filepath.setValue(filename);
									}
									if(x.indexOf(".html") > 0 )   
									{   
										context.contenttype.setValue('text/html');  
									} 
									else if (x.indexOf(".png")>0)
									{
										context.contenttype.setValue('image/png');
									}
									else if (x.indexOf(".js")>0)
									{
										context.contenttype.setValue('text/javascript');
									}
									else if (x.indexOf(".css")>0)
									{
										context.contenttype.setValue('text/css');
									}
									else if (x.indexOf(".gif")>0)
									{
										context.contenttype.setValue('image/gif');
									}
									else if (x.indexOf(".woff")>0)
									{
										context.contenttype.setValue('application/x-font-woff');
									}
									else if (x.indexOf(".ttf")>0)
									{
										context.contenttype.setValue('application/x-font-woff');
									}
									else 
									{
										context.contenttype.setValue('text/html'); 
									}
								}
							  ]]></script>
							<if cond="context.isAPI.toBoolean()">
								<then>
									<function name="HandleAPI">
										<parameters>
											<parameter name="reqestpath" type="string" in="event.getParam('requestpath').toString()"/>
											<parameter name="method" type="string" in="event.getParam('method').toString()"/>
											<parameter name="transportid" type="string" in="context.transportid.toString()"/>
										</parameters>
									</function>	
								</then>
								<else>
									<function>
										<!--yige end-->
										<log><![CDATA[ send filepath= <%=context.filepath.toString()%>]]></log>
										<set name="httpparam" paramname="Server" value="'StarOS.xyz'"/>
										<set name="httpparam" paramname="Connection" value="'Close'"/>
										<set name="httpparam" paramname="Content-Type" value="context.contenttype.toString()"/>
										<restful name="restfulserver" action="RESPONSE" status="200" text="ok" transportid="context.transportid.toString()" httpparams="httpparam">
											<html file="context.filepath"/>
										</restful>
										<restful name="restfulserver" action="Disconnect" transportid="context.transportid.toString()"/>
									</function>
								</else>
							</if>
						</function>
					</else>
				</if>
			</function>
		</onevent>
		<onevent event="websocketopen">
			<function>			
				<log level="1"><![CDATA[ websocketopen event <%=event.getName()%>]]> </log>				
				<log level="1"><![CDATA[ websocketopen transportid <%=event.getParam("transportid").toString()%>]]> </log>
				<!--insert name="websocketclients" value="event.getParam('transportid').toString()"/-->
				<function name="addWebSocket" class="WebSocketManager">
					<parameters>
						<parameter name="transportid" type="string" in="event.getParam('transportid').toString()"/>			
					</parameters>
				</function>
			</function>
		</onevent>
		<onevent event="websocketdisconnect">
			<function>
				<log><![CDATA[ websocketdisconnect event <%=event.getName()%>]]> </log>
				<log><![CDATA[ websocketdisconnect transportid <%=event.getParam("transportid").toString()%>]]> </log>
				<!--remove name="websocketclients" value="event.getParam('transportid').toString()"/-->
				<function name="RemoveWebSocket" class="WebSocketManager">
					<parameters>
						<parameter name="transportid" type="string" in="event.getParam('transportid').toString()"/>			
					</parameters>
				</function>
			</function>
		</onevent>
		<onevent event="websocketdata">
			<variable name="jsontype" type="string"/>
			<function>
				<script><![CDATA[
					var info = JSON.parse(event.getParam("eventdata").toString());
					context.jsontype.setValue(info.event);
				]]></script>
				<function name="HandleWebSocket">
					<parameters>
						<parameter name="websockettype" type="string" in="context.jsontype.toString()"/>
					</parameters>
				</function>
			</function>
		</onevent>
		<onevent event="*">
			<function>
			<log level="1"><![CDATA[ invalid event <%=event.getName()%>]]> </log>
			<log level="1"><![CDATA[ invalid param <%=event.getParam("eventdata").toString()%>]]> </log>
			</function>
		</onevent>
	</events>
</starosxml>