<?xml version="1.0" encoding="UTF-8"?>
<starosxml xmlns="http://www.staros.xyz/starcore" scope="application">
	<include src="/opt/staros.xyz/staroscontroller/starlang/gui/staros_api_v1.xml"/>
	<!--WebGUI-->
	<variable name="newSession"/>
	<variable name="nulltest" type="string"/>
	<variable name="systemparam" type="params"/>
	<variable name="requestcount" type="long"/>
	<variable name="isStop" type="boolean" value="true"/>
	<container name="UserSessionInfo" type="hashmap" valuetype="params"/>
	<function name="Restfulserver">
		<variable name="restfulparams" type="params"/>
		<set name="restfulparams" paramname="listenip" value="'0.0.0.0'"/>
		<set name="restfulparams" paramname="listenport" value="'9922'"/>
		<set name="restfulparams" paramname="protocol" value="'http'"/>
		<set name="restfulparams" paramname="cerfile" value="'/opt/staros.xyz/starcore/system/servercert.pem'"/>
		<set name="restfulparams" paramname="keyfile" value="'/opt/staros.xyz/starcore/system/serverkey.pem'"/>
		<log>Restfulserver</log>
		<restful name="restfulserver" action="SERVER" param="restfulparams" expectevent="restfulrequest.event"/>
		<raise name="'CheckSessionEvent'"/>
	</function>
	<function name="Redirect">
		<parameters>
		  <parameter name="transportid" type="string"/>
		  <parameter name="location" type="string"/>
		</parameters>
		<variable name="httpparam" type="params"/>
		<function>
			<set name="httpparam" paramname="Location" value="context.location.toString()"/>
			<set name="httpparam" paramname="Connection" value="'close'"/>
			<restful name="restfulserver" action="RESPONSE" status="302" text="Found" transportid="context.transportid.toString()" httpparams="httpparam"/>
		</function>
		<restful name="restfulserver" action="Disconnect" transportid="context.transportid.toString()"/>
	</function>
	<function name="HandleOtherResource">
		<variable name="httpparam" type="params"/>
		<variable name="contenttype" type="string"/>
		<variable name="filepath" type="string"/>
		<function>
			<log>HandleOtherResource</log>
			<script><![CDATA[
				var x = event.getParam('requestpath').toString();
				var filename="/opt/staros.xyz/staros/gui"+x;
				context.filepath.setValue(filename);
				if (x.indexOf(".png")>0)
				{
					context.contenttype.setValue('image/png');
				}
				else if (x.indexOf(".js")>0)
				{
					context.contenttype.setValue('text/javascript');
				}
				else if (x.indexOf(".css")>0)
				{
					context.contenttype.setValue('text/css');
				}
				else if (x.indexOf(".gif")>0)
				{
					context.contenttype.setValue('image/gif');
				}
				else if (x.indexOf(".woff")>0)
				{
					context.contenttype.setValue('application/x-font-woff');
				}
				else if (x.indexOf(".ttf")>0)
				{
					context.contenttype.setValue('application/x-font-woff');
				}else 
				{
					context.contenttype.setValue('text/html'); 
				}
			]]></script>
		</function>
		<set name="httpparam" paramname="Server" value="'StarOS'"/>
		<set name="httpparam" paramname="Connection" value="'Close'"/>
		<set name="httpparam" paramname="Content-Type" value="context.contenttype.toString()"/>
		<log><![CDATA[ send filepath= <%=context.filepath.toString()%>]]></log>
		<set name="httpparam" paramname="Server" value="'StarOS.xyz'"/>
		<set name="httpparam" paramname="Connection" value="'Close'"/>
		<function>
			<set name="httpparam" paramname="Content-Type" value="context.contenttype.toString()"/>
			<set name="httpparam" paramname="Connection" value="'close'"/>
			<restful name="restfulserver" action="RESPONSE" status="200" text="ok" transportid="event.getParam('transportid').toString()" httpparams="httpparam">
				<html file="context.filepath"/>
			</restful>
			<restful name="restfulserver" action="Disconnect" transportid="event.getParam('transportid').toString()"/>
		</function>
	</function>
	<function name="HandleMainResource">
		<parameters>
		  <parameter name="sessioneHere" type="boolean"/>
		</parameters>
		<variable name="httpparam" type="params"/>
		<variable name="contenttype" type="string"/>
		<variable name="usersession" type="string"/>
		<variable name="filepath" type="string"/>
		<variable name="username" type="string" value="'null'"/>
		<variable name="userParam" type="params"/>
		<log>HandleMainResource</log>
		<log><![CDATA[HandleMainResource sessioneHere= '<%=context.sessioneHere.toBoolean()%>']]></log>
		<if cond="context.sessioneHere.toBoolean()==false">
			<then>
				<log>cookie is null</log>
				<function>
					<set name="httpparam" paramname="Location" value="'/login.html'"/>
					<set name="httpparam" paramname="Connection" value="'close'"/>
					<restful name="restfulserver" action="RESPONSE" status="302" text="Found" transportid="event.getParam('transportid').toString()" httpparams="httpparam"/>
				</function>
				<restful name="restfulserver" action="Disconnect" transportid="event.getParam('transportid').toString()"/>
			</then>
			<else>
				<function>
					<script><![CDATA[
						var x = event.getParam('requestpath').toString();
						var filename="/opt/staros.xyz/staros/gui"+x;
						context.filepath.setValue(filename);
						if(x.indexOf(".html") > 0 )   
						{   
							context.contenttype.setValue('text/html');  
						} 
						else if (x.indexOf(".png")>0)
						{
							context.contenttype.setValue('image/png');
						}
						else if (x.indexOf(".js")>0)
						{
							context.contenttype.setValue('text/javascript');
						}
						else if (x.indexOf(".css")>0)
						{
							context.contenttype.setValue('text/css');
						}
						else if (x.indexOf(".gif")>0)
						{
							context.contenttype.setValue('image/gif');
						}
						else if (x.indexOf(".woff")>0)
						{
							context.contenttype.setValue('application/x-font-woff');
						}
						else if (x.indexOf(".ttf")>0)
						{
							context.contenttype.setValue('application/x-font-woff');
						}
						else 
						{
							context.contenttype.setValue('text/html'); 
						}
					]]></script>
					<set name="httpparam" paramname="Server" value="'StarOS'"/>
					<set name="httpparam" paramname="Connection" value="'Close'"/>
					<set name="httpparam" paramname="Content-Type" value="context.contenttype.toString()"/>
					<log><![CDATA[ send filepath= <%=context.filepath.toString()%>]]></log>
					<!--lookup name="UserSessionInfo" key="context.usersession.toString()" output="context.userParam"/-->
					<lookup name="UserSessionInfo" key="context.usersession.toString()" output="context.userParam"/>
					<set name="userParam" paramname="counter" value="0"/>
					<set name="httpparam" paramname="Content-Type" value="context.contenttype.toString()"/>
					<set name="httpparam" paramname="Connection" value="'close'"/>
					<restful name="restfulserver" action="RESPONSE" status="200" text="ok" transportid="event.getParam('transportid').toString()" httpparams="httpparam">
						<html file="context.filepath"/>
					</restful>
					<restful name="restfulserver" action="Disconnect" transportid="event.getParam('transportid').toString()"/>
				</function>
			</else>
		</if>
	</function>
	<!--handle auth request from webgui-->
	<function name="HandleAuthRequest">
		<variable name="usernameparam" type="string"/>
		<variable name="passwordparam" type="string"/>
		<variable name="transportid" type="string"/>
		<variable name="httpparam" type="params"/>
		<variable name="authresult" type="string"/>
		<variable name="authjson" type="string"/>
		<variable name="authresultmsg" type="messageblock"/>
		<variable name="sendjsessionid" type="string"/>
		<variable name="usersessionparam" type="params"/>
		<function>
			<script><![CDATA[
				var x = event.getParam("eventdata").toString();
				//j_username=karaf&j_password=karaf
				var username=(x.split("&")[0]).split("=")[1];
				var password=(x.split("&")[1]).split("=")[1];	
				context.usernameparam.setValue(username);
				context.passwordparam.setValue(password);
			]]></script>
			<set name="transportid" value="event.getParam('transportid').toString()"/>
			<log><![CDATA[username= '<%=context.usernameparam.toString()%>']]></log>
			<log><![CDATA[password= '<%=context.passwordparam.toString()%>']]></log>
			<log><![CDATA[username:ok password:ok]]></log>
			<remotecall method="AuthRequest">
				<applicationdata>
					<![CDATA[ 
					{
					"username":"<%=context.usernameparam.toString()%>",
					"password":"<%=context.passwordparam.toString()%>"
					}
					]]>
				</applicationdata>
			</remotecall>
			<wait event="event.AuthReply" timeout="1000">
				<log dest="stdout">Got event.AuthReply</log>
				<set name="authresultmsg" value="event.getMessageBlock()"/>
				<set name="authjson" value="context.authresultmsg.toString()"/>
				<script><![CDATA[
					var info = JSON.parse(context.authjson.toString());
					context.authresult.setValue(info.result);
				]]></script>
				<log><![CDATA[auth reply json= '<%=context.authjson.toString()%>']]></log>
				<if cond="context.authresult.toString() == 'ok'">
					<then>
						<function>
							<log><![CDATA[auth ok transportid= '<%=context.transportid.toString()%>']]></log>
							<set name="sendjsessionid" value="restful.randjsessionid()"/>
							<log><![CDATA[sendjsessionid= '<%=context.sendjsessionid.toString()%>']]></log>
							<set name="httpparam" paramname="Connection" value="'close'"/>
							<set name="httpparam" paramname="Set-Cookie" value="'JSESSIONID='+context.sendjsessionid.toString()+'; path=/'"/>
							<set name="usersessionparam" paramname="counter" value="0"/>
							<insert name="UserSessionInfo" key="context.sendjsessionid" value="context.usersessionparam"/>
							<set name="httpparam" paramname="Location" value="'/admin.html'"/>
							<set name="httpparam" paramname="Access-Control-Allow-Credentials" value="'true'"/>
							<set name="httpparam" paramname="Access-Control-Allow-Origin" value="'*'"/>
							<!--restful name="restfulserver" action="RESPONSE" status="200" text="ok" transportid="context.transportid.toString()" httpparams="httpparam">
								<jsonbody><![CDATA[
									{
									"code":"0"
									}
								]]></jsonbody>
							</restful-->
							
							<restful name="restfulserver" action="RESPONSE" status="302" text="Found" transportid="context.transportid.toString()" httpparams="httpparam"/>
							
							<restful name="restfulserver" action="Disconnect" transportid="context.transportid.toString()"/>
						</function>
					</then>
					<else>
						<log>auth failure</log>
						<function>
							<set name="httpparam" paramname="Connection" value="'close'"/>
							<set name="httpparam" paramname="Location" value="'/error.html'"/>
							<set name="httpparam" paramname="Access-Control-Allow-Credentials" value="'true'"/>
							<set name="httpparam" paramname="Access-Control-Allow-Origin" value="'*'"/>
							<restful name="restfulserver" action="RESPONSE" status="302" text="Found" transportid="context.transportid.toString()" httpparams="httpparam"/>
							<restful name="restfulserver" action="Disconnect" transportid="context.transportid.toString()"/>
						</function>
					</else>
				</if>
			</wait>
		</function>
	</function>
	<events>
		<onevent event="restfulrequest.event">
			<variable name="httpparam" type="params"/>
			<variable name="isappview" type="boolean" value="false"/>
			<variable name="isAPI" type="boolean" value="false"/>
			<variable name="usersession" type="string"/>
			<variable name="userParam" type="params"/>
			<variable name="sessionexist" type="boolean" value="false"/>
			<function>
				<!--qiulie-->
				<log dest="stdout"><![CDATA[restfulrequest eventname <%=event.getName()%>]]> </log>
				<log dest="stdout"><![CDATA[restfulrequest transportid '<%=event.getParam("transportid").toString()%>']]></log>
				<log dest="stdout"><![CDATA[restfulrequest eventdata '<%=event.getParam("eventdata").toString()%>']]></log>
				<log dest="stdout"><![CDATA[restfulrequest requestpath '<%=event.getParam("requestpath").toString()%>']]></log>
				<log dest="stdout"><![CDATA[restfulrequest method '<%=event.getParam("method").toString()%>']]></log>
				<log dest="stdout"><![CDATA[cookie= '<%=event.getParam("cookie").toString()%>']]></log>
				<if cond="event.getParam('cookie').toString()!=''">
					<then>
						<function>
							<script><![CDATA[
								var cookies=event.getParam('cookie').toString();
								var arraycookies = cookies.split(";");
								for(var i=0;i<arraycookies.length;i++)
								{
									var onecookie = arraycookies[i];
									var arrayparam = onecookie.split("=");
									if (arrayparam.length==2)
									{
										var paramname = arrayparam[0];
										var paramvalue = arrayparam[1];
										if (paramname=="JSESSIONID")
										{
											context.usersession.setValue(paramvalue);
											break;
										}
									}
								}
							]]></script>
							<if cond="context.UserSessionInfo.lookupItem(context.usersession.toString()) !=null">
								<then>
									<function>
										<set name="sessionexist" value="true"/>
										<lookup name="UserSessionInfo" key="context.usersession.toString()" output="context.userParam"/>
										<set name="userParam" paramname="counter" value="0"/>
										<remove name="UserSessionInfo" key="context.usersession.toString()"/>
										<insert name="UserSessionInfo" key="context.usersession.toString()" value="context.userParam"/>
									</function>
								</then>
								<else>
									<function>
										<set name="sessionexist" value="false"/>
									</function>
								</else>
							</if>
						</function>
					</then>
					<else>
						<function>
							<set name="sessionexist" value="false"/>
						</function>
					</else>
				</if>
				<log dest="stdout"><![CDATA[sessionexist= '<%=context.sessionexist.toBoolean()%>']]></log>
				<if cond="event.getParam('requestpath').toString() == '/j_security_check'">
					<then>
						<function>
							<function name="HandleAuthRequest"/>
						</function>
					</then>
					<elseif cond="event.getParam('requestpath').toString() == '/websock/core'">
						<function>
							<log><![CDATA[get a web socket connect= '<%=event.getParam("transportid").toString()%>']]></log>
							<websocket method="AcceptWebSocket" transportid="event.getParam('transportid').toString()" openevent="websocketopen" dataevent="websocketdata" disconnectevent="websocketdisconnect"/>
						</function>
					</elseif>
					<elseif cond="event.getParam('requestpath').toString() == '/logout'">
						<function>
							<log><![CDATA[get a web socket connect= '<%=event.getParam("transportid").toString()%>']]></log>
							<set name="httpparam" paramname="Location" value="'/login.html'"/>
							<set name="httpparam" paramname="Connection" value="'close'"/>
							<restful name="restfulserver" action="RESPONSE" status="302" text="Moved Temporarily" transportid="event.getParam('transportid').toString()" httpparams="httpparam"/>
						</function>
					</elseif>
					<elseif cond="event.getParam('requestpath').toString() == '/login.html'">
						<set name="httpparam" paramname="Content-Type" value="'text/html'"/>
						<set name="httpparam" paramname="Connection" value="'close'"/>
						<restful name="restfulserver" action="RESPONSE" status="200" text="ok" transportid="event.getParam('transportid').toString()" httpparams="httpparam">
							<html file="'/opt/staros.xyz/staros/gui/login.html'"/>
						</restful>
						<restful name="restfulserver" action="Disconnect" transportid="event.getParam('transportid').toString()"/>
					</elseif>
					<elseif cond="event.getParam('requestpath').toString() == '/error.html'">
						<set name="httpparam" paramname="Connection" value="'close'"/>
						<set name="httpparam" paramname="Content-Type" value="'text/html'"/>
						<restful name="restfulserver" action="RESPONSE" status="200" text="ok" transportid="event.getParam('transportid').toString()" httpparams="httpparam">
							<html file="'/opt/staros.xyz/staros/gui/error.html'"/>
						</restful>
						<restful name="restfulserver" action="Disconnect" transportid="event.getParam('transportid').toString()"/>
					</elseif>
					<elseif cond="event.getParam('requestpath').toString() == '/admin.html'">
						<function>
							<function name="HandleMainResource">
								<parameters>
									<parameter name="sessioneHere" type="boolean" in="context.sessionexist"/>
								</parameters>
							</function>
						</function>
					</elseif>
					<else>
						<function>
							<log dest="stdout">HandleOtherResource </log>
							<script><![CDATA[
								var path = event.getParam('requestpath').toString();
								if (path.indexOf('/app/view')>=0)
								{
									context.isappview.setValue('true');
								}
								if (path.indexOf('/api/v1/')>=0)
								{	
									context.isAPI.setValue('true');
								}
							]]></script>
							<if cond="context.isappview.toBoolean() == true">
								<then>
									<function name="HandleMainResource">
										<parameters>
											<parameter name="sessioneHere" type="boolean" in="context.sessionexist"/>
										</parameters>
									</function>
								</then>
								<else>
									<log>is not view</log>
									<if cond="context.isAPI.toBoolean() == true">
										<then>
											<log>is api</log>
											<function name="HandleAPI">
												<parameters>
													<parameter name="reqestpath" type="string" in="event.getParam('requestpath').toString()"/>
												</parameters>
											</function>
										</then>
										<else>
											<log>no api</log>
											<function>
												<function name="HandleOtherResource"/>
											</function>
										</else>
									</if>
								</else>
							</if>
						</function>
					</else>
				</if>
			</function>
		</onevent>
		<onevent event="CheckSessionEvent">
			<container name="deletesessionlist" type="list" valuetype="string"/>
			<variable name="sessionParam" type="params"/>
			<variable name="keyname" type="string"/>
			<variable name="Counter" type="long"/>
			<function>
				<log level="1"><![CDATA[CheckSessionEvent size= <%=context.UserSessionInfo.size()%>]]> </log>
				<for var="i" from="0" to="context.UserSessionInfo.size()-1">
					<function>
						<log level="1"><![CDATA[key= <%=context.UserSessionInfo.getKey(context.i.toLong()).toString()%>]]> </log>
						<set name="keyname" value="context.UserSessionInfo.getKey(context.i.toLong()).toString()"/>
						<lookup name="UserSessionInfo" key="context.keyname.toString()" output="context.sessionParam"/>
						<set name="Counter" value="context.sessionParam.getParam('counter')"/>
						<log level="1"><![CDATA[Counter= <%=context.Counter%>]]> </log>
						<script><![CDATA[
							if (context.Counter>2)
							{
								context.deletesessionlist.insertItem(context.keyname.toString());
							}
							else 
							{
								var is = context.Counter;
								is++;
								context.sessionParam.setParam('counter', is);
							}
						]]></script>
						<remove name="UserSessionInfo" key="context.keyname.toString()"/>
						<insert name="UserSessionInfo" key="context.keyname.toString()" value="context.sessionParam"/>
						<!--insert name="deletesessionlist" value="context.UserSessionInfo.getKey(context.i.toLong())"/-->
					</function>
				</for>
				<log level="1"><![CDATA[deletesessionlist size= <%=context.deletesessionlist.size()%>]]> </log>
				<for var="i" from="0" to="context.deletesessionlist.size()-1">
					<function>
						<remove name="UserSessionInfo" key="context.deletesessionlist.getItem(context.i.toLong()).toString()"/>
					</function>
				</for>
				<wait event="Invalidevent_1" timeout="3000"/>
				<raise name="'CheckSessionEvent'"/>
			</function>
		</onevent>
		<onevent event="websocketopen">
			<function>
			<log level="1"><![CDATA[ websocketopen event <%=event.getName()%>]]> </log>
			<log level="1"><![CDATA[ websocketopen param <%=event.getParam("eventdata").toString()%>]]> </log>
			</function>
		</onevent>
		<onevent event="websocketdisconnect">
			<function>
				<log level="1"><![CDATA[ websocketdisconnect event <%=event.getName()%>]]> </log>
				<log level="1"><![CDATA[ websocketdisconnect param <%=event.getParam("eventdata").toString()%>]]> </log>
			</function>
		</onevent>
		<onevent event="websocketdata">
			<variable name="jsontype" type="string"/>
			<function>
				<script><![CDATA[
									var info = JSON.parse(event.getParam("eventdata").toString());
									context.jsontype.setValue(info.event);
								]]>
				</script>
				<if cond="context.jsontype.toString() == 'clusterDataRequest'">
					<then>
						<function>
							<websocket method="SendText" transportid="event.getParam('transportid').toString()">
								<jsonbody>
								<![CDATA[
									{"event":"clusterDataResponse","payload":{"clusters":[{"id":"192.168.2.106","ip":"192.168.2.106","tcp":"9876","_iconid_state":"active","_iconid_started":"active","updated":"060249"}],"annots":{"no_rows_msg":"No cluster nodes found"}}}
								]]>
								</jsonbody>
							</websocket>
						</function>
					</then>
				</if>
			</function>
		</onevent>
		<onevent event="*">
			<function>
			<log level="1"><![CDATA[ invalid event <%=event.getName()%>]]> </log>
			<log level="1"><![CDATA[ invalid param <%=event.getParam("eventdata").toString()%>]]> </log>
			</function>
		</onevent>
	</events>
</starosxml>