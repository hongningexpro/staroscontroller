<?xml version="1.0" encoding="UTF-8"?>
<starosxml xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
<!--
	Author:
			YY
	Date:
			2017-07-28
	Copyright: 
			Nanjing StarOS Inc. All rights reserved.
-->
	<function name="SendOpenFlowFeatures">
		<log dest="stdout">SendOpenFlowFeatures</log>
		
		<variable name="auxiliaryid" type="string"/>
		<variable name="buffers" type="string"/>
		<variable name="capabilities" type="string"/>
		<variable name="datapathid" type="string"/>
		<variable name="tables" type="string"/>
		<variable name="xid" type="long"/>
		<container name="thisswitch" type="hashmap" keytype="string" valuetype="string"/>
		
		<set name="xid" value="context.openflowserverobj.getIncreaseXID()"/>
		<log><![CDATA[OpenFlowEcho xid=<%=context.xid.toLong()%>]]></log>
		<variable name="jsonvariable" type="string"/>
		<reference variable="jsonvariable">
			<jsonbody><![CDATA[ 
					{
						"xid":"<%=context.xid.toLong()%>"
					}
			]]></jsonbody>
		</reference>
		<function name="Send_OFPT13_FEATURES_REQUEST">
			<parameters>
				<parameter name="transportid" type="string" in="event.getParam('transportid').toString()"/>
				<parameter name="strjson" type="string" in="context.jsonvariable.toString()"/>
			</parameters>
		</function>	
		<wait event="openflow.OFPT13_FEATURES_REPLY" transportid="event.getParam('transportid').toString()" xid="context.xid.toLong()">
			<function>
				
				<log><![CDATA[Recieve Features Reply:=<%=event.getParam('eventdata').toString()%>]]></log>
				
				<script>
					<![CDATA[
							var info = JSON.parse(event.getParam('eventdata').toString());
							context.thisswitch.addValue('auxiliaryid', info.auxiliaryid);
							context.thisswitch.addValue('buffers', info.buffers);
							context.thisswitch.addValue('capabilities', info.capabilities);
							context.thisswitch.addValue('datapathid', info.datapathid);
							context.thisswitch.addValue('tables', info.tables);
							context.thisswitch.addValue('id', 'of:' + info.datapathid);
							context.thisswitch.addValue('transportid', event.getParam('transportid').toString());
					]]>
				</script>				
				
			</function>
		</wait>
		
		
		<variable name="desc" type="string"/>
		<reference variable="desc">
			<jsonbody><![CDATA[ 
					{
						"xid":"<%=context.xid.toLong()%>"
					}
			]]></jsonbody>
		</reference>
		<function name="Send_OFPT13_MULTIPART_REQUEST.OFP13MP_DESC">
			<parameters>
				<parameter name="transportid" type="string" in="event.getParam('transportid').toString()"/>
				<parameter name="strjson" type="string" in="context.desc.toString()"/>
			</parameters>
		</function>
		<wait event="openflow.OFPT13_MULTIPART_REPLY.OFP13MP_DESC" transportid="event.getParam('transportid').toString()" xid="context.xid.toLong()">
			<function>				
				<script>
					<![CDATA[
							var info = JSON.parse(event.getParam('eventdata').toString());
							context.thisswitch.addValue('mfrdesc', info.mfrdesc);
							context.thisswitch.addValue('swdesc', info.swdesc);	
							context.thisswitch.addValue('serialnum', info.serialnum);	
							context.thisswitch.addValue('dpdesc', info.dpdesc);	
							context.thisswitch.addValue('hwdesc', info.hwdesc);								
					]]>
				</script>
				
			</function>
		</wait>
		
		<function name="addDevice">
			<parameters>
				<parameter name="datapathid" type="string" in="context.thisswitch.getValue('datapathid').toString()"/>		
				<parameter name="deviceobject" type="hashmap" in="context.thisswitch"/>			
			</parameters>
		</function>
		
		<!--qiulei 20170807 -->
		
		<log dest="stdout">执行InstallDefaultFlow 2017.8.07</log>
		<function name="InstallDefaultFlow">
			<parameters>
				<parameter name="datapathid" type="string" in="context.thisswitch.getValue('datapathid').toString()"/>
			</parameters>
		</function>
		
	</function>
	
	<function name="OpenFlowFeatures">
		<function name="SendOpenFlowFeatures"/>	
	</function>
	
	<function name="switchOnline">
		<parameters>
			<parameter name="device" type="object"/>			
		</parameters>
		
		<variable name="onlinejson" type="string"/>
		<variable name="isTorF" type="string" value="false"/>
		<script><![CDATA[
			if (context.device.hasParam('datapathid'))
			{
				context.isTorF.setValue("true");				
				var json = new Object();
				json['event'] = "updateDevice";
				var payload = new Object();			
				payload['id'] = "of:" + context.device.getParam('datapathid').toString();
				payload['type'] = "switch";
				payload['online'] = "true";
				payload['master'] = context.device.getParam('masterid').toString();
				var onearray = new Array();
				onearray.push("");
				onearray.push("of:" + context.device.getParam('datapathid').toString());
				onearray.push("of:" + context.device.getParam('datapathid').toString());
				payload['labels'] = onearray;
				var twoarray = new Object();
				twoarray['managementAddress'] = context.device.getParam('localipaddr').toString();
				twoarray['protocol'] = "OF_13";
				twoarray['channelId'] = context.device.getParam('peeripaddr').toString();
				payload['props'] = twoarray;
				var threearray = new Object();
				threearray['x'] = 0;
				threearray['y'] = 0;
				var three_one_array = new Object();
				three_one_array['lng'] = 0;
				three_one_array['lat'] = 0;
				threearray['equivLoc'] = three_one_array;
				payload['metaUi'] = threearray;
				json['payload'] = payload;			
				var strjson = JSON.stringify(json);
				context.onlinejson.setValue(strjson);
			}
		]]></script>
		<if cond="context.isTorF.toString() == 'true'">
			<then>			
				<function name="sendtoAllWebsocketclient">
					<parameters>
						<parameter name="jsonbody" type="string" in="context.onlinejson.toString()"/>
					</parameters>
				</function>
			</then>
		</if>
	</function>
	
	<function name="switchOffline">
		<parameters>
			<parameter name="device" type="object"/>			
		</parameters>
		
		<variable name="offlinejson" type="string"/>
		<variable name="isTorF" type="string" value="false"/>
		<script><![CDATA[
			if (context.device.hasParam('datapathid'))
			{
				context.isTorF.setValue("true");		
				var json = new Object();
				json['event'] = "updateDevice";
				var payload = new Object();
				payload['id'] = "of:" + context.device.getParam('datapathid').toString();
				payload['type'] = "switch";
				payload['online'] = "false";
				payload['master'] = context.device.getParam('masterid').toString();
				var onearray = new Array();
				onearray.push("");
				onearray.push("of:" + context.device.getParam('datapathid').toString());
				onearray.push("of:" + context.device.getParam('datapathid').toString());
				payload['labels'] = onearray;
				
				var twoarray = new Object();
				twoarray['managementAddress'] = context.device.getParam('localipaddr').toString();
				twoarray['protocol'] = "OF_13";
				twoarray['channelId'] = context.device.getParam('peeripaddr').toString();
				payload['props'] = twoarray;
				
				var threearray = new Object();
				threearray['x'] = 0;
				threearray['y'] = 0;
				var three_one_array = new Object();
				three_one_array['lng'] = 0;
				three_one_array['lat'] = 0;
				threearray['equivLoc'] = three_one_array;
				payload['metaUi'] = threearray;
				json['payload'] = payload;
				
				var strjson = JSON.stringify(json);
				context.offlinejson.setValue(strjson);
			}
		]]></script>
		<if cond="context.isTorF.toString() == 'true'">
			<then>			
				<function name="sendtoAllWebsocketclient">
					<parameters>
						<parameter name="jsonbody" type="string" in="context.onlinejson.toString()"/>
					</parameters>
				</function>
			</then>
		</if>
	</function>
	
</starosxml>