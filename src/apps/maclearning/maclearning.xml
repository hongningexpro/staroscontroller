<?xml version="1.0" encoding="UTF-8"?>
<starlang xmlns="http://www.staros.xyz/staros" scope="application">
<!--
	Author:
			YY
	Date:
			2017-08-11
	Copyright: 
			Nanjing StarOS Inc. All rights reserved.
-->
	<object name="applicationmgr" reference="global.ApplicationManager"/>
	<object name="devicemgr" reference="global.DeviceManager"/>
	<object name="flowservice" reference="global.FlowService"/>
	<list name="resourceid_list" valuetype="string"/>
	<hashmap name="machashmap" keytype="string" valuetype="string"/>
	<function name="installflow">
		<parameters>
			<string name="outport"/>
			<string name="dstmac"/>
			<string name="datapathid"/>
		</parameters>
		<string name="modstrjson"/>
		<reference variable="modstrjson">
			<jsonbody><![CDATA[ 
					{
						"xid":"<%=context.openflowserverobj.ptr.getIncreaseXID().toString()%>",
						"cookie":"0",
						"cookiemask":"0",
						"tableid":"0",
						"command":"0",
						"idletimeout":"0",
						"hardtimeout":"0",
						"priority":"40000",
						"bufferid":"0xffffffff",
						"outport":"0xffffffff",
						"outgroup":"0xffffffff",
						"flags":"1",
						"match":{
								"type":"1",
								"matchfieldlist":[
									{
										"oxmclass":"0x8000",
										"oxmfield":"3",
										"hasmask":"false",
										"dstmac":"<%=context.dstmac.toString()%>"
									},
									{
										"oxmclass":"0x8000",
										"oxmfield":"5",
										"hasmask":"false",
										"ethtype":"0x0800"
									}
								]
							},
						"instructionlist":[
							{
								"type":"4",
								"actionlist":[
									{
										"type":"0",
										"outport":"<%=context.outport.toString()%>",
										"maxlen":"0xffff"
									}
								]
							}
						]
					}
			]]></jsonbody>
		</reference>
		<string name="resourceid"/>
		<if cond="context.flowservice==null">
			<then>
				<log>flowservice is null</log>
			</then>
		</if>
		<function name="InstallFlow" class="context.flowservice">
			<parameters>
				<string name="outflowid" out="context.resourceid"/>
				<string name="strjson" in="context.modstrjson.toString()"/>
				<string name="appId" in="'maclearning'"/>
				<string name="datapathid" in="context.datapathid.toString()"/>
			</parameters>
		</function>
		<insert name="resourceid_list" value="context.resourceid.toString()"/>
	</function>
	<function name="uninstallflow">
		<parameters>
			<string name="datapathid"/>
		</parameters>
		<string name="resourceid"/>
		<for var="context.resourceid" in="context.resourceid_list">			
			<function name="UnInstallFlow" class="context.flowservice">
				<parameters>
					<string name="datapathid" in="context.datapathid.toString()"/>			
					<string name="flowid" in="context.resourceid.toString()"/>
				</parameters>
			</function>
		</for>
	</function>
	<events>
		<onevent event="bundleapp.startup">			
			<!-- YY 2017-08-21 -->
			<function name="RegistApplication" class="context.applicationmgr">
				<parameters>
					<string name="id" in="'maclearning'"/>
					<string name="version" in="'1.0.0'"/>
					<string name="category" in="'starosapp'"/>
					<string name="origin" in="'Nanjing StarOS Inc.'"/>
					<string name="title" in="'app for maclearning'"/>
					<string name="desc" in="'2.10.10.0'"/>		
					<string name="url" in="'192.168.228.128'"/>
					<long name="bundleid" in="context.getCurrentBundleId()"/>
				</parameters>
			</function>			
			
					
			
			<function name="addTopoListener" class="TopoService">				
				<parameters>
					<string name="appid" in="'maclearning'"/>
					<string name="add_eventname" in="'mytopadd'"/>
					<string name="remove_eventname" in="'mytopremove'"/>
				</parameters>
			</function>	
			
			<log>maclearning app startup</log>
		</onevent>	
		
		<onevent event="bundleapp.active">
			<function name="addProcessor" class="PacketService">				
				<parameters>
					<string name="app_name" in="'maclearning'"/>
					<string name="event_name" in="'PacketInEvent'"/>					
					<string name="eth_type" in="'0x0800'"/>					
				</parameters>
			</function>	
		</onevent>
		
		<onevent event="~bundleapp.deactive">
			<function name="removeProcessor" class="PacketService">				
				<parameters>
					<string name="app_name" in="'maclearning'"/>									
				</parameters>
			</function>
		</onevent>
		
		<onevent event="mytopadd">
			
		</onevent>
		<onevent event="mytopremove">
			
		</onevent>
		
		<onevent event="~bundleapp.shutdown">
			<!-- YY 2017-08-21 -->
			
			
			<function name="removeTopoListener" class="TopoService">
				<parameters>
					<string name="appid" in="'maclearning'"/>
				</parameters>
			</function>
			
			<!--function name="uninstallflow">
				<parameters>
					<string name="datapathid" in="event.getParam('datapathid').toString()"/>
				</parameters>
			</function-->
		</onevent>
		<onevent event="PacketInEvent">
			<!-- YY 2017-08-21 -->
			<messageblock name="packetmsgblock"/>
			<string name="inportid"/>
			<string name="pkoutjson"/>
			<string name="srcmac"/>
			<string name="dstmac"/>
			<string name="ethtype"/>
			<string name="result_mac"/>
			<script><![CDATA[
				var info = JSON.parse(event.getParam('eventdata').toString());
				if (info.match != null) {
					var inport_id = info.match.matchfieldlist[0].inport;					
					context.inportid.setValue(inport_id);
				}
				if (info.payload != null) {
					var pay_load = info.payload;
					var strjson=JSON.stringify(pay_load);
					context.pkoutjson.setValue(strjson);
					var src_mac = info.payload.smac;
					var dst_mac = info.payload.dmac;
					var eth = info.payload.ethtype;
					context.srcmac.setValue(src_mac);
					context.dstmac.setValue(dst_mac);
					context.ethtype.setValue(eth);										
				}

			]]></script>
			<set name="packetmsgblock" value="event.getMessageBlock()"/>			
			<if cond="context.ethtype.toString()=='2054'">
				<then>
					<if cond="context.dstmac.toString()=='ff:ff:ff:ff:ff:ff'">
						<then>
							<function name="PacketOutToAllPort" class="context.devicemgr">
								<parameters>
									<string name="datapathid" in="event.getParam('datapathid').toString()"/>
									<string name="inportid" in="context.inportid.toString()"/>	
									<string name="pkoutjson" in="context.pkoutjson.toString()"/>	
									<messageblock name="msgblock" in="context.packetmsgblock"/>	
								</parameters>
							</function>
						</then>					
						<else>
							<if cond="context.machashmap.hasValue(context.dstmac.toString())==false">
								<then>		
									<function name="PacketOutToAllPort" class="context.devicemgr">
										<parameters>
											<string name="datapathid" in="event.getParam('datapathid').toString()"/>
											<string name="inportid" in="context.inportid.toString()"/>	
											<string name="pkoutjson" in="context.pkoutjson.toString()"/>	
											<messageblock name="msgblock" in="context.packetmsgblock"/>	
										</parameters>
									</function>
								</then>
								<else>																
									<function name="PacketOutToPort" class="context.devicemgr">
										<parameters>	
											<string name="outputport" in="context.machashmap.getValue(context.dstmac.toString()).toString()"/>
											<string name="pkoutjson" in="context.pkoutjson.toString()"/>						
											<messageblock name="msgblock" in="context.packetmsgblock"/>
											<string name="inportid" in="context.inportid.toString()"/>	
											<string name="datapathid" in="event.getParam('datapathid').toString()"/>	
										</parameters>
									</function>							
								</else>
							</if>
						</else>
					</if>
					<if cond="context.machashmap.hasValue(context.srcmac.toString())==false">
				<then>
					<insert name="machashmap" key="context.srcmac.toString()" value="context.inportid.toString()"/>
				</then>
			</if>
			</then>
				<else>					
					<if cond="context.machashmap.hasValue(context.dstmac.toString())==false">
						<then>																					
							<function name="PacketOutToAllPort" class="context.devicemgr">
								<parameters>
									<string name="datapathid" in="event.getParam('datapathid').toString()"/>
									<string name="inportid" in="context.inportid.toString()"/>	
									<string name="pkoutjson" in="context.pkoutjson.toString()"/>	
									<messageblock name="msgblock" in="context.packetmsgblock"/>	
								</parameters>
							</function>
						</then>
						<else>					
							<function name="PacketOutToPort" class="context.devicemgr">
								<parameters>	
									<string name="outputport" in="context.machashmap.getValue(context.dstmac.toString()).toString()"/>
									<string name="pkoutjson" in="context.pkoutjson.toString()"/>						
									<messageblock name="msgblock" in="context.packetmsgblock"/>
									<string name="inportid" in="context.inportid.toString()"/>	
									<string name="datapathid" in="event.getParam('datapathid').toString()"/>		
								</parameters>
							</function>
							<function name="installflow">
								<parameters>
									<string name="outport" in="context.machashmap.getValue(context.dstmac.toString()).toString()"/>
									<string name="dstmac" in="context.dstmac.toString()"/>
									<string name="datapathid" in="event.getParam('datapathid').toString()"/>
								</parameters>
							</function>
						</else>
					</if>	
					<if cond="context.machashmap.hasValue(context.srcmac.toString())==false">
						<then>
							<insert name="machashmap" key="context.srcmac.toString()" value="context.inportid.toString()"/>
						</then>
					</if>
				</else>
			</if>
		</onevent>
		
		<onevent event="*">
			<function>
			<log level="1"><![CDATA[ invalid event <%=event.getName().toString()%>]]> </log>
			<log level="1"><![CDATA[ invalid param <%=event.getParam("eventdata").toString()%>]]> </log>
			</function>
		</onevent>
	</events>
</starlang>