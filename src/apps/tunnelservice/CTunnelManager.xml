<?xml version="1.0" encoding="UTF-8"?>
<starosxml xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
	<!--
			Author:
					qiulei
			Date:
					20170913
			Copyright: 
					Nanjing StarOS Inc. All rights reserved.
		-->	
	<class name="CTunnelManager">
		<private>
			<container name="tunnelContainer" type="hashmap" keytype="long" valuetype="class"/>
			<variable name="id" type="long"/>
			
			<variable name="invlan" type="long"/>
			<variable name="outvlan" type="long"/>
		</private>
		
		<public>
			<function name="CTunnelManager">
				<set name="thisclass.id" value="0" />
				<set name="thisclass.invlan" value="0" />
				<set name="thisclass.outvlan" value="0" />
				<log>CTunnelManager is create</log>
			</function>
			
			<!--qiulei 20170913-->
			<function name="addTunnel">
				<parameters>
					<parameter name="id" type="long"/>
					<parameter name="username" type="string"/>
					<parameter name="inputPort" type="string"/>
					<parameter name="outputPort" type="string"/>
					<parameter name="invlan" type="long"/>
					<parameter name="outvlan" type="long"/>
					<parameter name="type" type="string"/>
					<parameter name="state" type="string"/>
					<parameter name="inputvlanid" type="long"/>
					<parameter name="outputvlanid" type="long"/>
					<parameter name="bandwidth" type="long"/>
					<parameter name="inmeterid" type="long"/>
					<parameter name="outmeterid" type="long"/>
				</parameters>
				
				<!--qiulei 20170919 pm-->
				<set name="thisclass.invlan" value="thisclass.invlan.toLong()+1" />
				<set name="thisclass.outvlan" value="thisclass.outvlan.toLong()+1" />
				<if cond="thisclass.invlan > 4000">
					<then>
						<function>
							<set name="thisclass.invlan" value="1" />
						</function>
					</then>
				</if>
				
				<if cond="thisclass.outvlan > 4000">
					<then>
						<function>
							<set name="thisclass.outvlan" value="1" />
						</function>
					</then>
				</if>

				<set name="thisclass.id" value="thisclass.id.toLong()+1" />
				<!--set name="context.id" value="thisclass.id.toLong()" /-->
				
				<variable name="tunnelObject" type="class"/>
				<new name="tunnelObject" class="CTunnel">
					<parameters>
						<parameter name="id" type="long" in="thisclass.id.toLong()"/>
						<parameter name="username" type="string" in="context.username.toString()"/>
						<parameter name="inputPort" type="string" in="context.inputPort.toString()"/>
						<parameter name="outputPort" type="string" in="context.outputPort.toString()"/>
						<parameter name="invlan" type="long" in="thisclass.invlan.toLong()"/>
						<parameter name="outvlan" type="long" in="thisclass.outvlan.toLong()"/>
						<parameter name="type" type="string" in="context.type.toString()"/>
						<parameter name="state" type="string" in="context.state.toString()"/>
						<parameter name="inputvlanid" type="long" in="context.inputvlanid.toLong()"/>
						<parameter name="outputvlanid" type="long" in="context.outputvlanid.toLong()"/>
						<parameter name="bandwidth" type="long" in="context.bandwidth.toLong()"/>
						<parameter name="inmeterid" type="long" in="context.inmeterid.toLong()"/>
						<parameter name="outmeterid" type="long" in="context.outmeterid.toLong()"/>
					</parameters>
				</new>
				
				<insert name="tunnelContainer" key="thisclass.id.toLong()" value="context.tunnelObject"/>
				<set name="context.id" value="thisclass.id.toLong()"/>
			</function>
			<!--qiulei 20170913-->
			<function name="removeTunnel">
				<parameters>
					<parameter name="tunnel_id" type="long"/>
				</parameters>

				<if cond="context.tunnelContainer.hasValue(context.tunnel_id.toLong())==true">
					<then>
						<function>
							<remove name="tunnelContainer" key="context.tunnel_id.toLong()"/>
						</function>
					</then>
				</if>
			</function>
			
			<function name="AllTunnelToJsonStr">
				<parameters>
					<parameter name="AllTunnelJsonString" type="string"/>
				</parameters>
				<variable name="tunnelObject" type="class"/>
				<variable name="OneTunnelJsonString" type="string"/>
				<container name="tunnelJsonString_List" type="list" valuetype="string" />
				<container name="i" type="pair" keytype="long" valuetype="class"/>
				<for var="i" in="context.tunnelContainer">
					<function>
						<set name="context.tunnelObject" value="context.i.second()"/>
						<if cond="context.tunnelObject != null">
							<then>
								<function name="OneTunnelObjectToJsonString" class="context.tunnelObject">
									<parameters>
										<parameter name="TunnelObjectToJson" type="string" out="context.OneTunnelJsonString"/>
									</parameters>
								</function>
								<insert name="context.tunnelJsonString_List" value="context.OneTunnelJsonString.toString()"/>
							</then>
						</if>
					</function>
				</for>
				
				<script><![CDATA[
					var jsonroot = new Object();
					var tunnelsArray = new Array();
					
					var first_str = context.tunnelJsonString_List.getFirst();
					while (first_str != null){
						var jsonobj = JSON.parse(first_str);
						tunnelsArray.push(jsonobj);
						first_str = context.tunnelJsonString_List.getNext();
						
					}
					
					jsonroot['tunnels']=tunnelsArray;
					jsonroot['resultCode']="0";
					jsonroot["resultDesc"]="ok";
					var strjson = JSON.stringify(jsonroot);
					context.AllTunnelJsonString.setValue(strjson);
				]]></script>
				
			</function>
			<!--qiulei 20170914 am get one tunnel object-->
			<function name="GetOneTunnelObject">
				<parameters>
					<parameter name="tunnel_id" type="long"/>
					<parameter name="TunnelObject" type="class"/>
				</parameters>

				<if cond="context.tunnelContainer.hasValue(context.tunnel_id.toLong())==true">
					<then>
						<function>
							<lookup name="tunnelContainer" key="context.tunnel_id.toLong()" output="context.TunnelObject"/>
						</function>
					</then>
				</if>
			</function>
			
			
			
			
			
			<function name="ActiveTunnel">
				<log>CTunnelManager ActiveTunnel</log>
			</function>
			
			
			
			
			<function name="DeactiveTunnel">
				<log>CTunnelManager DeactiveTunnel</log>
			</function>
		</public>
	</class>
</starosxml>