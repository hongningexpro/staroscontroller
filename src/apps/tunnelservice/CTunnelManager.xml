<?xml version="1.0" encoding="UTF-8"?>
<starosxml xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
	<!--
			Author:
					qiulei
			Date:
					20170913
			Copyright: 
					Nanjing StarOS Inc. All rights reserved.
		-->	
	<class name="CTunnelManager">
		<private>
			<container name="tunnelContainer" type="hashmap" keytype="long" valuetype="class"/>
			<variable name="id" type="long"/>
			
			<variable name="invlan" type="long"/>
			<variable name="outvlan" type="long"/>
		</private>
		
		<public>
			<function name="CTunnelManager">
				<set name="thisclass.id" value="0" />
				<set name="thisclass.invlan" value="0" />
				<set name="thisclass.outvlan" value="2000" />
				<log>CTunnelManager is create</log>
			</function>
			
			<!--qiulei 20170913-->
			<function name="addTunnel">
				<parameters>
					<parameter name="id" type="long"/>
					<parameter name="username" type="string"/>
					<parameter name="inputPort" type="string"/>
					<parameter name="outputPort" type="string"/>
					<!--parameter name="invlan" type="long"/>
					<parameter name="outvlan" type="long"/-->
					<parameter name="type" type="string"/>
					<parameter name="state" type="string"/>
					<parameter name="inputvlanid" type="long"/>
					<parameter name="outputvlanid" type="long"/>
					<parameter name="bandwidth" type="long"/>
					<!--parameter name="inmeterid" type="long"/>
					<parameter name="outmeterid" type="long"/-->
				</parameters>
				
				<!--qiulei 20170919 pm-->
				<set name="thisclass.invlan" value="thisclass.invlan.toLong()+1" />
				<set name="thisclass.outvlan" value="thisclass.outvlan.toLong()+1" />
				<if cond="thisclass.invlan > 2000">
					<then>
						<function>
							<set name="thisclass.invlan" value="1" />
						</function>
					</then>
				</if>
				
				<if cond="thisclass.outvlan > 4000">
					<then>
						<function>
							<set name="thisclass.outvlan" value="2001" />
						</function>
					</then>
				</if>

				<set name="thisclass.id" value="thisclass.id.toLong()+1" />
				<set name="context.id" value="thisclass.id.toLong()"/>
				
				<variable name="tunnelObject" type="class"/>
				<new name="tunnelObject" class="CTunnel">
					<parameters>
						<parameter name="id" type="long" in="thisclass.id.toLong()"/>
						<parameter name="username" type="string" in="context.username.toString()"/>
						<parameter name="inputPort" type="string" in="context.inputPort.toString()"/>
						<parameter name="outputPort" type="string" in="context.outputPort.toString()"/>
						<parameter name="invlan" type="long" in="thisclass.invlan.toLong()"/>
						<parameter name="outvlan" type="long" in="thisclass.outvlan.toLong()"/>
						<parameter name="type" type="string" in="context.type.toString()"/>
						<parameter name="state" type="string" in="context.state.toString()"/>
						<parameter name="inputvlanid" type="long" in="context.inputvlanid.toLong()"/>
						<parameter name="outputvlanid" type="long" in="context.outputvlanid.toLong()"/>
						<parameter name="bandwidth" type="long" in="context.bandwidth.toLong()"/>
						<!--parameter name="inmeterid" type="long" in="context.inmeterid.toLong()"/>
						<parameter name="outmeterid" type="long" in="context.outmeterid.toLong()"/-->
					</parameters>
				</new>
				
				<insert name="tunnelContainer" key="thisclass.id.toLong()" value="context.tunnelObject"/>
				
			</function>
			<!--qiulei 20170913-->
			<function name="removeTunnel">
				<parameters>
					<parameter name="tunnel_id" type="long"/>
				</parameters>

				<if cond="context.tunnelContainer.hasValue(context.tunnel_id.toLong())==true">
					<then>
						<function>
							<remove name="tunnelContainer" key="context.tunnel_id.toLong()"/>
						</function>
					</then>
				</if>
			</function>
			
			<function name="AllTunnelToJsonStr">
				<parameters>
					<parameter name="AllTunnelJsonString" type="string"/>
				</parameters>
				<variable name="tunnelObject" type="class"/>
				<variable name="OneTunnelJsonString" type="string"/>
				<container name="tunnelJsonString_List" type="list" valuetype="string" />
				<container name="i" type="pair" keytype="long" valuetype="class"/>
				<for var="i" in="context.tunnelContainer">
					<function>
						<set name="context.tunnelObject" value="context.i.second()"/>
						<if cond="context.tunnelObject != null">
							<then>
								<function name="OneTunnelObjectToJsonString" class="context.tunnelObject">
									<parameters>
										<parameter name="TunnelObjectToJson" type="string" out="context.OneTunnelJsonString"/>
									</parameters>
								</function>
								<insert name="context.tunnelJsonString_List" value="context.OneTunnelJsonString.toString()"/>
							</then>
						</if>
					</function>
				</for>
				
				<script><![CDATA[
					var jsonroot = new Object();
					var tunnelsArray = new Array();
					
					var first_str = context.tunnelJsonString_List.getFirst();
					while (first_str != null){
						var jsonobj = JSON.parse(first_str);
						tunnelsArray.push(jsonobj);
						first_str = context.tunnelJsonString_List.getNext();
						
					}
					
					jsonroot['tunnels']=tunnelsArray;
					jsonroot['resultCode']="0";
					jsonroot["resultDesc"]="ok";
					var strjson = JSON.stringify(jsonroot);
					context.AllTunnelJsonString.setValue(strjson);
				]]></script>
				
			</function>
			<!--qiulei 20170914 am get one tunnel object-->
			<function name="GetOneTunnelObject">
				<parameters>
					<parameter name="tunnel_id" type="long"/>
					<parameter name="TunnelObject" type="class"/>
				</parameters>

				<if cond="context.tunnelContainer.hasValue(context.tunnel_id.toLong())==true">
					<then>
						<function>
							<lookup name="tunnelContainer" key="context.tunnel_id.toLong()" output="context.TunnelObject"/>
						</function>
					</then>
				</if>
			</function>
						
			<function name="ActiveTunnel">
				<log>CTunnelManager ActiveTunnel</log>
			</function>			
						
			<function name="DeactiveTunnel">
				<log>CTunnelManager DeactiveTunnel</log>
			</function>
			<!--yijian add-->
			<function name="mytopremove">
				<parameters>
					<parameter name="fromdevice" type="string"/>
					<parameter name="todevice" type="string"/>
					<parameter name="path" type="string"/>
				</parameters>
				<log>CTunnelManager mytopremove</log>
				<iterator name="tunnelContaineriterator" type="hashmap" keytype="long" valuetype="class"/>
				<iterator name="tunnelContainerfirst" type="hashmap" keytype="long" valuetype="class"/>
				<iterator name="tunnelContainerend" type="hashmap" keytype="long" valuetype="class"/>
				<variable name="onetunnel" type="class"/>
				<set name="tunnelContainerfirst" value="context.tunnelContainer.begin()"/>
				<set name="tunnelContainerend" value="context.tunnelContainer.end()"/>
				<for var="context.tunnelContaineriterator" from="context.tunnelContainerfirst" to="context.tunnelContainerend">
					<set name="onetunnel" value="context.tunnelContaineriterator.second()"/>
					<function name="mytopremove" class="onetunnel">
						<parameters>
							<parameter name="fromdevice" type="string" in="context.fromdevice.toString()"/>
							<parameter name="todevice" type="string" in="context.todevice.toString()"/>
							<parameter name="path" type="string" in="context.path.toString()"/>
						</parameters>
					</function>
				</for>
			</function>

			<function name="IsHasValue">
				<parameters>
					<parameter name="style" type="string"/>
					<parameter name="data" type="string"/>
					<parameter name="result" type="boolean"/>
				</parameters>
				<variable name="final_result" type="boolean"/>
				<if cond="context.style.toString()=='inport'">
					<then>
						<function name="IsHasInPort">
							<parameters>
								<parameter name="data" type="string" in="context.data.toString()"/>
								<parameter name="result" type="boolean" out="context.final_result"/>
							</parameters>
						</function>
					</then>
					<elseif cond="context.style.toString()=='outport'">
						<function name="IsHasOutPort">
							<parameters>
								<parameter name="data" type="string" in="context.data.toString()"/>
								<parameter name="result" type="boolean" out="context.final_result"/>
							</parameters>
						</function>
					</elseif>
					<elseif cond="context.style.toString()=='invlan'">
						<function name="IsHasInVlan">
							<parameters>
								<parameter name="data" type="string" in="context.data.toString()"/>
								<parameter name="result" type="boolean" out="context.final_result"/>
							</parameters>
						</function>
					</elseif>
					<else>
						<function name="IsHasOutVlan">
							<parameters>
								<parameter name="data" type="string" in="context.data.toString()"/>
								<parameter name="result" type="boolean" out="context.final_result"/>
							</parameters>
						</function>
					</else>
				</if>
				<set name="context.result" value="context.final_result.toBoolean()"/>
			</function>
			
			<function name="IsHasInPort">
				<parameters>
					<parameter name="data" type="string"/>
					<parameter name="result" type="boolean"/>
				</parameters>
				<variable name="final_result" type="boolean" value="false"/>
				<container name="tunnelpair" type="pair" keytype="long" valuetype="class"/>
				<variable name="tunnel" type="class"/>
				<variable name="port" type="string"/>
				<for var="context.tunnelpair" in="thisclass.tunnelContainer">
					<set name="context.tunnel" value="context.tunnelpair.second()"/>
					<function name="GetTunnel_inputPort" class="context.tunnel">
						<parameters>
							<parameter name="t_inputPort" type="string" out="context.port"/>
						</parameters>
					</function>
					<if cond="context.port.toString() == context.data.toString()">
						<then>
							<set name="context.final_result" value="true"/>
							<exit/>
						</then>
					</if>
				</for>
				<set name="context.result" value="context.final_result.toBoolean()"/>
			</function>
			<function name="IsHasOutPort">
				<parameters>
					<parameter name="data" type="string"/>
					<parameter name="result" type="boolean"/>
				</parameters>
				<variable name="final_result" type="boolean" value="false"/>
				<container name="tunnelpair" type="pair" keytype="long" valuetype="class"/>
				<variable name="tunnel" type="class"/>
				<variable name="port" type="string"/>
				<for var="context.tunnelpair" in="thisclass.tunnelContainer">
					<set name="context.tunnel" value="context.tunnelpair.second()"/>
					<function name="GetTunne_outputPort" class="context.tunnel">
						<parameters>
							<parameter name="t_outputPort" type="string" out="context.port"/>
						</parameters>
					</function>
					<if cond="context.port.toString() == context.data.toString()">
						<then>
							<set name="context.final_result" value="true"/>
							<exit/>
						</then>
					</if>
				</for>
				<set name="context.result" value="context.final_result.toBoolean()"/>
			</function>
			<function name="IsHasInVlan">
				<parameters>
					<parameter name="data" type="string"/>
					<parameter name="result" type="boolean"/>
				</parameters>
				<variable name="final_result" type="boolean" value="false"/>
				<container name="tunnelpair" type="pair" keytype="long" valuetype="class"/>
				<variable name="tunnel" type="class"/>
				<variable name="vlan" type="long"/>
				<for var="context.tunnelpair" in="thisclass.tunnelContainer">
					<set name="context.tunnel" value="context.tunnelpair.second()"/>
					<function name="GetTunnel_inputvlanid" class="context.tunnel">
						<parameters>
							<parameter name="t_inputvlanid" type="long" out="context.vlan"/>
						</parameters>
					</function>
					<if cond="context.vlan.toString() == context.data.toString()">
						<then>
							<set name="context.final_result" value="true"/>
							<exit/>
						</then>
					</if>
				</for>
				<set name="context.result" value="context.final_result.toBoolean()"/>
			</function>
			<function name="IsHasOutVlan">
				<parameters>
					<parameter name="data" type="string"/>
					<parameter name="result" type="boolean"/>
				</parameters>
				<variable name="final_result" type="boolean" value="false"/>
				<container name="tunnelpair" type="pair" keytype="long" valuetype="class"/>
				<variable name="tunnel" type="class"/>
				<variable name="vlan" type="long"/>
				<for var="context.tunnelpair" in="thisclass.tunnelContainer">
					<set name="context.tunnel" value="context.tunnelpair.second()"/>
					<function name="GetTunnel_outputvlanid" class="context.tunnel">
						<parameters>
							<parameter name="t_outputvlanid" type="long" out="context.vlan"/>
						</parameters>
					</function>
					<if cond="context.vlan.toString() == context.data.toString()">
						<then>
							<set name="context.final_result" value="true"/>
							<exit/>
						</then>
					</if>
				</for>
				<set name="context.result" value="context.final_result.toBoolean()"/>
			</function>
			<function name="getTunnelNum">
				<parameters>
					<parameter name="size" type="long"/>
				</parameters>
				<set name="context.size" value="thisclass.tunnelContainer.size()"/>
			</function>
		</public>
	</class>
</starosxml>