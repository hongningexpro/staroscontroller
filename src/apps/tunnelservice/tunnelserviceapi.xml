<?xml version="1.0" encoding="UTF-8"?>
<starosxml xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
	<function name="RegisterHandler">
		<function name="RegisterAPIHandler" class="restfulservice">
			<parameters>
				<parameter name="bundleid" type="long" in="context.getCurrentBundleId()"/>			
				<parameter name="handleevent" type="string" in="'processactiverequest'"/>
				<parameter name="requestpathtest" type="string" in="'/onos/v1/tunnelservice/active'"/>			
			</parameters>
		</function>
		<function name="RegisterAPIHandler" class="restfulservice">
			<parameters>
				<parameter name="bundleid" type="long" in="context.getCurrentBundleId()"/>			
				<parameter name="handleevent" type="string" in="'processdeactiverequest'"/>
				<parameter name="requestpathtest" type="string" in="'/onos/v1/tunnelservice/deactive'"/>			
			</parameters>
		</function>
		<function name="RegisterAPIHandler" class="restfulservice">
			<parameters>
				<parameter name="bundleid" type="long" in="context.getCurrentBundleId()"/>			
				<parameter name="handleevent" type="string" in="'processrequest'"/>
				<parameter name="requestpathtest" type="string" in="'/onos/v1/tunnelservice/tunnels'"/>			
			</parameters>
		</function>
	</function>
	<events>
		<onevent event="processactiverequest">
			<log>tunnelserviceapi processactiverequest</log>
			<function name="activeTunnel" class="context.tunnelManagerObject"/>
			<variable name="outjson" type="string"/>
			<script><![CDATA[
				var json = new Object();
				var one = new Object();
				one.resourceId = 0;
				one.code = 0;
				one.description = "ok";						
				json.result = one;
				var strjson=JSON.stringify(json);												
				context.outjson.setValue(strjson);
			]]></script>
			<function name="SendResponse" class="RestfulService">
				<parameters>
					<parameter name="transportid" type="string" in="event.getParam('transportid').toString()"/>
					<parameter name="json" type="string" in="context.outjson.toString()"/>
				</parameters>
			</function>
		</onevent>
		<onevent event="processdeactiverequest">
			<log>tunnelserviceapi processdeactiverequest</log>
			<function name="deactiveTunnel" class="context.tunnelManagerObject"/>
			<variable name="outjson" type="string"/>
			<script><![CDATA[
				var json = new Object();
				var one = new Object();
				one.resourceId = 0;
				one.code = 0;
				one.description = "ok";						
				json.result = one;
				var strjson=JSON.stringify(json);												
				context.outjson.setValue(strjson);
			]]></script>
			<function name="SendResponse" class="RestfulService">
				<parameters>
					<parameter name="transportid" type="string" in="event.getParam('transportid').toString()"/>
					<parameter name="json" type="string" in="context.outjson.toString()"/>
				</parameters>
			</function>
		</onevent>
		<onevent event="processrequest">
			<log>tunnelserviceapi processrequest</log>
			<variable name="path" type="long"/>
			<script><![CDATA[
				var local_path = event.getParam('requestpath').toString();
				var final_path = "/onos/v1/tunnelservice/tunnels";
				context.print(local_path.indexOf(final_path));
				if (local_path.indexOf(final_path) >= 0)
					context.path.setValue(1);
			]]></script>
			<if cond="context.path.toLong()==1">
				<then>					
					<if cond="event.getParam('method').toString()=='GET'">
						<then>
							<variable name="outjson" type="string"/>
							<function name="GetTunnelsJson" class="context.tunnelManagerObject">
								<parameters>
									<parameter name="json" type="string" out="context.outjson"/>
								</parameters>
							</function>
							<function name="SendResponse" class="RestfulService">
								<parameters>
									<parameter name="transportid" type="string" in="event.getParam('transportid').toString()"/>
									<parameter name="json" type="string" in="context.outjson.toString()"/>
								</parameters>
							</function>
						</then>
						<else>
							<if cond="event.getParam('method').toString()=='PUT'">
								<then>
									<variable name="resourceid" type="long"/>
									<script><![CDATA[
										var str = event.getParam('requestpath').toString();
										var array[] = str.split("/");
										var local_id = array[array.length-1];
										context.resourceid.setValue(local_id);
									]]></script>
									<variable name="tunnel" type="class"/>
									<function name="GetTunnel" class="context.tunnelManagerObject">
										<parameters>
											<parameter name="resourceid" type="string" in="context.resourceid.toString()"/>
											<parameter name="tunnel" type="class" out="context.tunnel"/>
										</parameters>
									</funtion>
									<!--
										{
											"tunnel": {
												"type": "vlan",
												"inputPort": "sdfsdf/22",
												"username": "test",
												"outputPort": "sfgdfdd/33",
												"inputvlanid": "44",
												"outputvlanid": "44",
												"bandwidth": "44333"
											}
										}
									-->
									<function name="updateTunnel" class="context.tunnel">
										
									</funtion>
									<variable name="outjson" type="string"/>
									<script><![CDATA[
										var json = new Object();
										var one = new Object();
										one.resourceId = context.resourceid.toLong();
										one.code = 0;
										one.description = "ok";						
										json.result = one;
										var strjson=JSON.stringify(json);												
										context.outjson.setValue(strjson);
									]]></script>
									<function name="SendResponse" class="RestfulService">
										<parameters>
											<parameter name="transportid" type="string" in="event.getParam('transportid').toString()"/>
											<parameter name="json" type="string" in="context.outjson.toString()"/>
										</parameters>
									</function>																
								</then>
								<else>
									<if cond="event.getParam('method').toString()=='POST'">
										<then>																						
											<variable name="username" type="string"/>
											<variable name="inputPort" type="string"/>
											<variable name="outputPort" type="string"/>
											<variable name="invlan" type="long"/>
											<variable name="outvlan" type="long"/>
											<variable name="type" type="string"/>
											<variable name="state" type="string"/>
											<variable name="inputvlanid" type="long"/>
											<variable name="outputvlanid" type="long"/>
											<variable name="bandwidth" type="long"/>
											<variable name="inmeterid" type="long"/>
											<variable name="outmeterid" type="long"/>
											<variable name="resourceid" type="long"/>
											<variable name="outjson" type="string"/>
											<script><![CDATA[									
												var json = JSON.parse(event.getParam('eventdata').toString());
												var local_username = json.tunnel.username;
												var local_inputport = json.tunnel.inputPort;
												var local_outputPort = json.tunnel.outputPort;
												var local_invlan = 100;
												var local_outvlan = 100;
												var local_type = json.tunnel.type;
												var local_state = "active";
												var local_inputvlanid = json.tunnel.inputvlanid;
												var local_outputvlanid = json.tunnel.outputvlanid;
												var local_bandwidth = json.tunnel.bandwidth;
												var local_inmeterid = 200;
												var local_outmeterid = 200;
												context.username.setValue(local_username);
												context.inputPort.setValue(local_inputport);
												context.outputPort.setValue(local_outputPort);
												context.invlan.setValue(local_invlan);
												context.outvlan.setValue(local_outvlan);
												context.type.setValue(local_type);
												context.state.setValue(local_state);
												context.inputvlanid.setValue(local_inputvlanid);
												context.outputvlanid.setValue(local_outputvlanid);
												context.bandwidth.setValue(local_bandwidth);
												context.inmeterid.setValue(local_inmeterid);
												context.outmeterid.setValue(local_outmeterid);
											]]></script>
											<function name="addTunnel" class="context.tunnelManagerObject">
												<parameters>
													<parameter name="id" type="long" out="context.resourceid"/>
													<parameter name="username" type="string" in="context.username.toString()"/>
													<parameter name="inputPort" type="string" in="context.inputPort.toString()"/>
													<parameter name="outputPort" type="string" in="context.outputPort.toString()"/>
													<parameter name="invlan" type="long" in="context.invlan.toLong()"/>
													<parameter name="outvlan" type="long" in="context.outvlan.toLong()"/>
													<parameter name="type" type="string" in="context.type.toString()"/>
													<parameter name="state" type="string" in="context.state.toString()"/>
													<parameter name="inputvlanid" type="long" in="context.inputvlanid.toLong()"/>
													<parameter name="outputvlanid" type="long" in="context.outputvlanid.toLong()"/>
													<parameter name="bandwidth" type="long" in="context.bandwidth.toLong()"/>
													<parameter name="inmeterid" type="long" in="context.inmeterid.toLong()"/>
													<parameter name="outmeterid" type="long" in="context.outmeterid.toLong()"/>													
												</parameters>
											</function>
											<script><![CDATA[
												var json = new Object();
												var one = new Object();
												one.resourceId = context.resourceid.toLong();
												one.code = 0;
												one.description = "ok";						
												json.result = one;
												var strjson=JSON.stringify(json);												
												context.outjson.setValue(strjson);
											]]></script>
											<function name="SendResponse" class="RestfulService">
												<parameters>
													<parameter name="transportid" type="string" in="event.getParam('transportid').toString()"/>
													<parameter name="json" type="string" in="context.outjson.toString()"/>
												</parameters>
											</function>
										</then>
										<else>
											<variable name="id" type="long"/>
											<script><![CDATA[
												var json = JSON.parse(event.getParam('eventdata').toString());
												var local_id = json.tunnel.id;
												context.id.setValue(local_id);
											]]></script>
											<function name="removeTunnel">
												<parameters>
													<parameter name="tunnel_id" type="long" in="context.id.toLong()"/>
												</parameters>
											</function>
											<script><![CDATA[
												var json = new Object();
												var one = new Object();
												one.resourceId = context.resourceid.toLong();
												one.code = 0;
												one.description = "ok";						
												json.result = one;
												var strjson=JSON.stringify(json);												
												context.outjson.setValue(strjson);
											]]></script>
											<function name="SendResponse" class="RestfulService">
												<parameters>
													<parameter name="transportid" type="string" in="event.getParam('transportid').toString()"/>
													<parameter name="json" type="string" in="context.outjson.toString()"/>
												</parameters>
											</function>
										</else>
									</if>
								</else>
							</if>
						</else>				
					</if>
				</then>
			</if>
		</onevent>
	</events>
	
</starosxml>