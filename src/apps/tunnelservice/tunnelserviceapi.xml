<?xml version="1.0" encoding="UTF-8"?>
<starosxml xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
	<!--
		Author:
				YY
		Date:
				2017-09-14
		Copyright: 
				Nanjing StarOS Inc. All rights reserved.
	-->	
	<function name="RegisterHandler">
		<log>insert tunnelserviceapi RegisterHandler</log>
		
		
		<function name="RegisterAPIHandler" class="restfulservice">
			<parameters>
				<parameter name="bundleid" type="long" in="context.getCurrentBundleId()"/>			
				<parameter name="handleevent" type="string" in="'processactiverequest'"/>
				<parameter name="requestpathtest" type="string" in="'/onos/v1/tunnelservice/tunnels/active'"/>			
			</parameters>
		</function>
		<function name="RegisterAPIHandler" class="restfulservice">
			<parameters>
				<parameter name="bundleid" type="long" in="context.getCurrentBundleId()"/>			
				<parameter name="handleevent" type="string" in="'processdeactiverequest'"/>
				<parameter name="requestpathtest" type="string" in="'/onos/v1/tunnelservice/tunnels/deactive'"/>			
			</parameters>
		</function>
		<function name="RegisterAPIHandler" class="restfulservice">
			<parameters>
				<parameter name="bundleid" type="long" in="context.getCurrentBundleId()"/>			
				<parameter name="handleevent" type="string" in="'processtunnelsrequest'"/>
				<parameter name="requestpathtest" type="string" in="'/onos/v1/tunnelservice/tunnels'"/>			
			</parameters>
		</function>
		<function name="RegisterAPIHandler" class="restfulservice">
			<parameters>
				<parameter name="bundleid" type="long" in="context.getCurrentBundleId()"/>			
				<parameter name="handleevent" type="string" in="'processrequest'"/>
				<parameter name="requestpathtest" type="string" in="'/onos/v1/tunnelservice/tunnel'"/>			
			</parameters>
		</function>
	</function>
	
	<function name="UnRegisterHandler">
		<function name="UnRegisterAPIHandler" class="restfulservice">
			<parameters>
				<parameter name="requestpath" type="string" in="'/onos/v1/tunnelservice/tunnels/active'"/>			
			</parameters>
		</function>
		<function name="UnRegisterAPIHandler" class="restfulservice">
			<parameters>
				<parameter name="requestpath" type="string" in="'/onos/v1/tunnelservice/tunnels/deactive'"/>			
			</parameters>
		</function>
		<function name="UnRegisterAPIHandler" class="restfulservice">
			<parameters>
				<parameter name="requestpath" type="string" in="'/onos/v1/tunnelservice/tunnels'"/>			
			</parameters>
		</function>
		<function name="UnRegisterAPIHandler" class="restfulservice">
			<parameters>
				<parameter name="requestpath" type="string" in="'/onos/v1/tunnelservice/tunnel'"/>			
			</parameters>
		</function>
	</function>
	
	<events>
		<onevent event="processactiverequest">
			<log>tunnelserviceapi processactiverequest</log>
			<function name="ActiveTunnel" class="context.tunnelManagerObject"/>
			<variable name="outjson" type="string"/>
			<script><![CDATA[
				var json = new Object();
				var one = new Object();
				one.resourceId = 0;
				one.code = 0;
				one.description = "ok";						
				json.result = one;
				var strjson=JSON.stringify(json);												
				context.outjson.setValue(strjson);
			]]></script>
			<function name="SendResponse" class="RestfulService">
				<parameters>
					<parameter name="transportid" type="string" in="event.getParam('transportid').toString()"/>
					<parameter name="json" type="string" in="context.outjson.toString()"/>
				</parameters>
			</function>
		</onevent>
		<onevent event="processdeactiverequest">
			<log>tunnelserviceapi processdeactiverequest</log>
			<function name="DeactiveTunnel" class="context.tunnelManagerObject"/>
			<variable name="outjson" type="string"/>
			<script><![CDATA[
				var json = new Object();
				var one = new Object();
				one.resourceId = 0;
				one.code = 0;
				one.description = "ok";						
				json.result = one;
				var strjson=JSON.stringify(json);												
				context.outjson.setValue(strjson);
			]]></script>
			<function name="SendResponse" class="RestfulService">
				<parameters>
					<parameter name="transportid" type="string" in="event.getParam('transportid').toString()"/>
					<parameter name="json" type="string" in="context.outjson.toString()"/>
				</parameters>
			</function>
		</onevent>
		<onevent event="processtunnelsrequest">
			<log>tunnelserviceapi processtunnelsrequest</log>					
			<function name="getAllTunnels"/>				
		</onevent>
		<onevent event="processrequest">
			<log>tunnelserviceapi processrequest</log>			
			<if cond="event.getParam('method').toString()=='GET'">
				<then>
					<log>insert method get</log>
					<function name="getTunnel"/>
				</then>
				<elseif cond="event.getParam('method').toString()=='PUT'">
					<log>insert method put</log>										
					<function name="updateTunnel"/>
				</elseif>
				<elseif cond="event.getParam('method').toString()=='POST'">
					<log>insert method post</log>	
					<function name="addTunnel"/>
				</elseif>
				<else>
					<log>insert method delete</log>
					<function name="deleteTunnel"/>
				</else>									
			</if>				
		</onevent>
	</events>
	<function name="getAllTunnels">		
		<log>insert getAllTunnels</log>
		<variable name="outjson" type="string"/>
		<function name="AllTunnelToJsonStr" class="context.tunnelManagerObject">
			<parameters>
				<parameter name="AllTunnelJsonString" type="string" out="context.outjson"/>
			</parameters>
		</function>
		<function name="SendResponse" class="RestfulService">
			<parameters>
				<parameter name="transportid" type="string" in="event.getParam('transportid').toString()"/>
				<parameter name="json" type="string" in="context.outjson.toString()"/>
			</parameters>
		</function>
	</function>
	<function name="getTunnel">
		<log>insert method == get</log>
		<variable name="resourceid" type="long"/>
		<variable name="tunnel" type="class"/>
		<variable name="outjson" type="string"/>
		<script><![CDATA[
			var str = event.getParam('requestpath').toString();
			var array = str.split("/");
			var local_id = array[array.length-1];
			context.resourceid.setValue(local_id);
		]]></script>		
		<function name="GetOneTunnelObject" class="context.tunnelManagerObject">
			<parameters>
				<parameter name="tunnel_id" type="long" in="context.resourceid.toLong()"/>
				<parameter name="TunnelObject" type="class" out="context.tunnel"/>
			</parameters>
		</function>
		<function name="OneTunnelObjectToJsonString" class="context.tunnel">
			<parameters>
				<parameter name="TunnelObjectToJson" type="string" out="context.outjson"/>
			</parameters>
		</function>
		<function name="SendResponse" class="RestfulService">
			<parameters>
				<parameter name="transportid" type="string" in="event.getParam('transportid').toString()"/>
				<parameter name="json" type="string" in="context.outjson.toString()"/>
			</parameters>
		</function>
	</function>
	<function name="updateTunnel">		
		<log>insert method == put</log>
		<variable name="resourceid" type="long"/>
		<variable name="tunnel" type="class"/>
		<variable name="outjson" type="string"/>
		<variable name="username" type="string"/>
		<variable name="inputPort" type="string"/>
		<variable name="outputPort" type="string"/>
		<variable name="type" type="string"/>
		<variable name="state" type="string"/>
		<variable name="inputvlanid" type="long"/>
		<variable name="outputvlanid" type="long"/>
		<variable name="bandwidth" type="long"/>
		<variable name="putindexof" type="long" value="0"/>
		<script><![CDATA[
			var str = event.getParam('requestpath').toString();
			var array = str.split("/");
			var local_id = array[array.length-1];
			context.resourceid.setValue(local_id);
		]]></script>		
		<function name="GetOneTunnelObject" class="context.tunnelManagerObject">
			<parameters>
				<parameter name="tunnel_id" type="long" in="context.resourceid.toLong()"/>
				<parameter name="TunnelObject" type="class" out="context.tunnel"/>
			</parameters>
		</function>
		<script><![CDATA[									
			var json = JSON.parse(event.getParam('eventdata').toString());
			var local_username = json.username;
			var local_inputport = json.inputPort;
			var local_outputPort = json.outputPort;
			var local_type = json.type;
			var local_state = "active";
			var local_inputvlanid = json.inputvlanid;
			var local_outputvlanid = json.outputvlanid;
			var local_bandwidth = json.bandwidth;
			context.username.setValue(local_username);
			context.inputPort.setValue(local_inputport);
			context.outputPort.setValue(local_outputPort);
			context.type.setValue(local_type);
			context.state.setValue(local_state);
			context.inputvlanid.setValue(local_inputvlanid);
			context.outputvlanid.setValue(local_outputvlanid);
			context.bandwidth.setValue(local_bandwidth);
			if ((local_inputport.indexOf("of:") != -1) && (local_outputPort.indexOf("of:") != -1))
			{
				context.putindexof.setValue(1);
			}
		]]></script>
		<if cond="context.putindexof.toLong()!=1">
			<then>
				<function name="ErrorResponse">
					<parameters>
						<parameter name="resourceid" type="long" in="context.resourceid.toLong()"/>
						<parameter name="transportid" type="string" in="event.getParam('transportid').toString()"/>
					</parameters>
				</function>
				<exit/>
			</then>
		</if>
		<function name="UpdateTunnel" class="context.tunnel">
			<parameters>											
				<parameter name="username" type="string" in="context.username.toString()"/>
				<parameter name="inputPort" type="string" in="context.outputPort.toString()"/>
				<parameter name="outputPort" type="string" in="context.outputPort.toString()"/>
				<parameter name="type" type="string" in="context.type.toString()"/>
				<parameter name="state" type="string" in="context.state.toString()"/>
				<parameter name="inputvlanid" type="long" in="context.inputvlanid.toLong()"/>
				<parameter name="outputvlanid" type="long" in="context.outputvlanid.toLong()"/>	
				<parameter name="bandwidth" type="long" in="context.bandwidth.toLong()"/>
			</parameters>
		</function>			
		<script><![CDATA[
			var json = new Object();
			var one = new Object();
			one.resourceId = ""+context.resourceid.toLong();
			one.code = "0";
			one.description = "ok";						
			json.result = one;
			var strjson=JSON.stringify(json);												
			context.outjson.setValue(strjson);
		]]></script>
		<function name="SendResponse" class="RestfulService">
			<parameters>
				<parameter name="transportid" type="string" in="event.getParam('transportid').toString()"/>
				<parameter name="json" type="string" in="context.outjson.toString()"/>
			</parameters>
		</function>
	</function>
	<function name="addTunnel">
		<variable name="username" type="string"/>
		<variable name="inputPort" type="string"/>
		<variable name="outputPort" type="string"/>
		<variable name="type" type="string"/>
		<variable name="state" type="string"/>
		<variable name="inputvlanid" type="long"/>
		<variable name="outputvlanid" type="long"/>
		<variable name="bandwidth" type="long"/>
		<variable name="resourceid" type="long"/>
		<variable name="outjson" type="string"/>
		<variable name="tunnel" type="class"/>
		<variable name="putindexof" type="long" value="0"/>
		<script><![CDATA[									
			var json = JSON.parse(event.getParam('eventdata').toString());
			var local_username = json.username;
			var local_inputport = json.inputPort;
			var local_outputPort = json.outputPort;
			var local_type = json.type;
			var local_state = "active";
			var local_inputvlanid = json.inputvlanid;
			var local_outputvlanid = json.outputvlanid;
			var local_bandwidth = json.bandwidth;
			context.username.setValue(local_username);
			context.inputPort.setValue(local_inputport);
			context.outputPort.setValue(local_outputPort);
			context.type.setValue(local_type);
			context.state.setValue(local_state);
			context.inputvlanid.setValue(local_inputvlanid);
			context.outputvlanid.setValue(local_outputvlanid);
			context.bandwidth.setValue(local_bandwidth);
			if ((local_inputport.indexOf("of:") != -1) && (local_outputPort.indexOf("of:") != -1))
			{
				context.putindexof.setValue(1);
			}
		]]></script>
		<if cond="context.putindexof.toLong()!=1">
			<then>
				<function name="ErrorResponse">
					<parameters>
						<parameter name="resourceid" type="long" in="-1"/>
						<parameter name="transportid" type="string" in="event.getParam('transportid').toString()"/>
					</parameters>
				</function>
				<exit/>
			</then>
		</if>
		<function name="addTunnel" class="context.tunnelManagerObject">
			<parameters>
				<parameter name="id" type="long" out="context.resourceid"/>
				<parameter name="username" type="string" in="context.username.toString()"/>
				<parameter name="inputPort" type="string" in="context.inputPort.toString()"/>
				<parameter name="outputPort" type="string" in="context.outputPort.toString()"/>
				<parameter name="type" type="string" in="context.type.toString()"/>
				<parameter name="state" type="string" in="context.state.toString()"/>
				<parameter name="inputvlanid" type="long" in="context.inputvlanid.toLong()"/>
				<parameter name="outputvlanid" type="long" in="context.outputvlanid.toLong()"/>
				<parameter name="bandwidth" type="long" in="context.bandwidth.toLong()"/>
			</parameters>
		</function>
		<function name="GetOneTunnelObject" class="context.tunnelManagerObject">
			<parameters>
				<parameter name="tunnel_id" type="long" in="context.resourceid.toLong()"/>
				<parameter name="TunnelObject" type="class" out="context.tunnel"/>
			</parameters>			
		</function>
		<if cond="context.tunnel==null">
			<then>
				<log>tunnel is null</log>
			</then>
			<else>
				<function name="ActiveTunnel" class="context.tunnel"/>
			</else>
		</if>		
		<script><![CDATA[
			var json = new Object();
			var one = new Object();
			one.resourceId = ""+context.resourceid.toLong();
			one.code = "0";
			one.description = "ok";						
			json.result = one;
			var strjson=JSON.stringify(json);												
			context.outjson.setValue(strjson);
		]]></script>
		<function name="SendResponse" class="RestfulService">
			<parameters>
				<parameter name="transportid" type="string" in="event.getParam('transportid').toString()"/>
				<parameter name="json" type="string" in="context.outjson.toString()"/>
			</parameters>
		</function>
	</function>
	<function name="deleteTunnel">
		<variable name="resourceid" type="long"/>
		<variable name="outjson" type="string"/>
		<variable name="tunnel" type="class"/>
		<script><![CDATA[
			var str = event.getParam('requestpath').toString();
			var array = str.split("/");			
			var local_id = array[array.length-1];
			context.resourceid.setValue(local_id);			
		]]></script>
		<function name="GetOneTunnelObject" class="context.tunnelManagerObject">
			<parameters>
				<parameter name="tunnel_id" type="long" in="context.resourceid.toLong()"/>
				<parameter name="TunnelObject" type="class" out="context.tunnel"/>
			</parameters>			
		</function>
		<if cond="context.tunnel==null">
			<then>
				<log>tunnel is null</log>
			</then>
			<else>
				<function name="DeactiveTunnel" class="context.tunnel"/>
			</else>
		</if>			
		<function name="removeTunnel" class="context.tunnelManagerObject">
			<parameters>
				<parameter name="tunnel_id" type="long" in="context.resourceid.toLong()"/>
			</parameters>
		</function>		
		<script><![CDATA[
			var json = new Object();
			var one = new Object();
			one.resourceId = ""+context.resourceid.toLong();
			one.code = "0";
			one.description = "ok";						
			json.result = one;
			var strjson=JSON.stringify(json);												
			context.outjson.setValue(strjson);
		]]></script>
		<function name="SendResponse" class="RestfulService">
			<parameters>
				<parameter name="transportid" type="string" in="event.getParam('transportid').toString()"/>
				<parameter name="json" type="string" in="context.outjson.toString()"/>
			</parameters>
		</function>
	</function>
	<function name="ErrorResponse">
		<parameters>
			<parameter name="resourceid" type="long"/>
			<parameter name="transportid" type="string"/>
		</parameters>
		<variable name="outjson" type="string"/>
		<script><![CDATA[
			var json = new Object();
			var one = new Object();
			one.resourceId = ""+context.resourceid.toLong();
			one.code = "-1";
			one.description = "Port id is wrong!";						
			json.result = one;
			var strjson=JSON.stringify(json);												
			context.outjson.setValue(strjson);
		]]></script>
		<function name="SendResponse" class="RestfulService">
			<parameters>
				<parameter name="transportid" type="string" in="context.transportid.toString()"/>
				<parameter name="json" type="string" in="context.outjson.toString()"/>
			</parameters>
		</function>
	</function>
</starosxml>