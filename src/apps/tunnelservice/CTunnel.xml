<?xml version="1.0" encoding="UTF-8"?>
<starosxml xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
	<!--wangkang 2017/09/13 -->
	<class name="CTunnel">
		<private>
			<variable name="m_id" type="long"/>
			<variable name="m_username" type="string"/>
			<variable name="m_inputPort" type="string"/>
			<variable name="m_outputPort" type="string"/>
			
			<variable name="m_serviceinvlan" type="long"/>			
			<variable name="m_serviceoutvlan" type="long"/>
			<variable name="m_type" type="string"/>
			<variable name="m_state" type="string"/>
			<variable name="m_inputvlanid" type="long"/>
			<variable name="m_outputvlanid" type="long"/>
			
			<variable name="m_bandwidth" type="long"/>
			<variable name="m_tunneldevicemgr" type="class"/>
			<variable name="m_bisActive" type="boolean" value="false"/>
			
			<variable name="m_fromdevice" type="string"/>
			<variable name="m_fromdeviceport" type="string"/>
			<variable name="m_todevice" type="string"/>
			<variable name="m_todeviceport" type="string"/>
		</private>
		<public>
			<function name="CTunnel">
				<parameters>
					<parameter name="id" type="long"/>
					<parameter name="username" type="string"/>
					<parameter name="inputPort" type="string"/>
					<parameter name="outputPort" type="string"/>
					<parameter name="invlan" type="long"/>
					
					<parameter name="outvlan" type="long"/>
					<parameter name="type" type="string"/>
					<parameter name="state" type="string"/>
					<parameter name="inputvlanid" type="long"/>
					<parameter name="outputvlanid" type="long"/>
					
					<parameter name="bandwidth" type="long"/>
				</parameters>
				<set name="thisclass.m_id" value="context.id.toLong()"/>
				<set name="thisclass.m_username" value="context.username.toString()"/>
				<set name="thisclass.m_inputPort" value="context.inputPort.toString()"/>
				<set name="thisclass.m_outputPort" value="context.outputPort.toString()"/>
				<set name="thisclass.m_serviceinvlan" value="context.invlan.toLong()"/>
				<set name="thisclass.m_serviceoutvlan" value="context.outvlan.toLong()"/>
				<set name="thisclass.m_type" value="context.type.toString()"/>
				<set name="thisclass.m_state" value="context.state.toString()"/>
				<set name="thisclass.m_inputvlanid" value="context.inputvlanid.toLong()"/>
				<set name="thisclass.m_outputvlanid" value="context.outputvlanid.toLong()"/>
				<set name="thisclass.m_bandwidth" value="context.bandwidth.toLong()"/>
				<new name="m_tunneldevicemgr" class="CTunnelDeviceManager"/>
				<script><![CDATA[
					var inputport = thisclass.m_inputPort.toString();
					var oneinputid = (inputport.split("/")[0]).split(":")[1];	
					var inputport = inputport.split("/")[1];			
					var outputport = thisclass.m_outputPort.toString();
					var oneoutputid = (outputport.split("/")[0]).split(":")[1];
					var outputport = outputport.split("/")[1];
					thisclass.m_fromdevice.setValue(oneinputid);
					thisclass.m_todevice.setValue(oneoutputid);
					thisclass.m_fromdeviceport.setValue(inputport);
					thisclass.m_todeviceport.setValue(outputport);
				]]></script>
			</function>
			<function name="GetTunnelId">
				<parameters>
					<parameter name="outid" type="long"/>
				</parameters>
				<set name="outid" value="thisclass.m_id.toLong()"/>
			</function>
			<!--qiulei 20170913 pm-->
			<function name="GetTunnel_username">
				<parameters>
					<parameter name="t_username" type="string"/>
				</parameters>
				<set name="t_username" value="thisclass.m_username.toString()"/>
			</function>
			
			<function name="GetTunnel_inputPort">
				<parameters>
					<parameter name="t_inputPort" type="string"/>
				</parameters>
				<set name="t_inputPort" value="thisclass.m_inputPort.toString()"/>
			</function>
			
			
			<function name="GetTunne_outputPort">
				<parameters>
					<parameter name="t_outputPort" type="string"/>
				</parameters>
				<set name="t_outputPort" value="thisclass.m_outputPort.toString()"/>
			</function>
			
			<function name="GetTunne_invlan">
				<parameters>
					<parameter name="t_invlan" type="long"/>
				</parameters>
				<set name="t_invlan" value="thisclass.m_invlan.toLong()"/>
			</function>
			
			<function name="GetTunnel_outvlan">
				<parameters>
					<parameter name="t_outvlan" type="long"/>
				</parameters>
				<set name="t_outvlan" value="thisclass.m_outvlan.toLong()"/>
			</function>
			
			<function name="GetTunnel_type">
				<parameters>
					<parameter name="t_type" type="string"/>
				</parameters>
				<set name="t_type" value="thisclass.m_type.toString()"/>
			</function>
			
			<function name="GetTunnel_state">
				<parameters>
					<parameter name="t_state" type="string"/>
				</parameters>
				<set name="t_state" value="thisclass.m_state.toString()"/>
			</function>
			
			<function name="GetTunnel_inputvlanid">
				<parameters>
					<parameter name="t_inputvlanid" type="long"/>
				</parameters>
				<set name="t_inputvlanid" value="thisclass.m_inputvlanid.toLong()"/>
			</function>
			
			<function name="GetTunnel_outputvlanid">
				<parameters>
					<parameter name="t_outputvlanid" type="long"/>
				</parameters>
				<set name="t_outputvlanid" value="thisclass.m_outputvlanid.toLong()"/>
			</function>
			
			<function name="GetTunnel_bandwidth">
				<parameters>
					<parameter name="t_bandwidth" type="long"/>
				</parameters>
				<set name="t_bandwidth" value="thisclass.m_bandwidth.toLong()"/>
			</function>
			
			<!--qiulei 20170913-->

			<function name="OneTunnelObjectToJsonString">
				<parameters>
					<parameter name="TunnelObjectToJson" type="string"/>
				</parameters>
				<log>insert CTunnel OneTunnelObjectToJsonString</log>
				<variable name="values" type="string" />
				<reference variable="values">
					<jsonbody><![CDATA[ 
						{	
							"id":"<%=thisclass.m_id.toLong()%>",
							"username":"<%=thisclass.m_username.toString()%>",
							"inputPort":"<%=thisclass.m_inputPort.toString()%>",
							"outputPort":"<%=thisclass.m_outputPort.toString()%>",
							"invlan":"<%=thisclass.m_serviceinvlan.toLong()%>",
							
							"outvlan":"<%=thisclass.m_serviceoutvlan.toLong()%>",
							"type":"<%=thisclass.m_type.toString()%>",
							"state":"<%=thisclass.m_state.toString()%>",
							"inputvlanid":"<%=thisclass.m_inputvlanid.toLong()%>",
							"outputvlanid":"<%=thisclass.m_outputvlanid.toLong()%>",
							
							"bandwidth":"<%=thisclass.m_bandwidth.toLong()%>"
						}
					]]></jsonbody>
				</reference>
				<log><![CDATA[context.values = <%=context.values.toString()%>]]></log>
				<set name="TunnelObjectToJson" value="context.values.toString()"/>
			</function>
			
			<!--qiulei 20170913 update Tunnel-->
			<function name="UpdateTunnel">
				<parameters>
					<parameter name="username" type="string"/>
					<parameter name="inputPort" type="string"/>
					<parameter name="outputPort" type="string"/>
					<parameter name="invlan" type="long"/>
					
					<parameter name="outvlan" type="long"/>
					<parameter name="type" type="string"/>
					<parameter name="state" type="string"/>
					<parameter name="inputvlanid" type="long"/>
					<parameter name="outputvlanid" type="long"/>
					<parameter name="bandwidth" type="long"/>
				</parameters>
				
				<set name="thisclass.m_username" value="context.username.toString()"/>
				<set name="thisclass.m_inputPort" value="context.inputPort.toString()"/>
				<set name="thisclass.m_outputPort" value="context.outputPort.toString()"/>
				<set name="thisclass.m_serviceinvlan" value="context.invlan.toLong()"/>
				<set name="thisclass.m_serviceoutvlan" value="context.outvlan.toLong()"/>
				<set name="thisclass.m_type" value="context.type.toString()"/>
				<set name="thisclass.m_state" value="context.state.toString()"/>
				<set name="thisclass.m_inputvlanid" value="context.inputvlanid.toLong()"/>
				<set name="thisclass.m_outputvlanid" value="context.outputvlanid.toLong()"/>
				<set name="thisclass.m_bandwidth" value="context.bandwidth.toLong()"/>
			</function>
			
			<!-- wangkang 2017/09/15 -->
			<function name="ActiveTunnel">
				<variable name="firstdevice" type="class"/>
				<variable name="lastdevice" type="class"/>
				<variable name="onedevice" type="class"/>
				<container name="middevice" type="list" valuetype="class"/>
				<iterator name="middeviceiterator" type="list" valuetype="class"/>
				<iterator name="middevicefirst" type="list" valuetype="class"/>
				<iterator name="middeviceend" type="list" valuetype="class"/>
				<variable name="getpathresult" type="boolean"/>
				<log>==============================</log>
				<log>##### Active Tunnel #####</log>
				<if cond="thisclass.m_bisActive.toBoolean()==true">
					<then>
						<function>
							<log>Tunnel is Active already</log>
							<exit/>
						</function>
					</then>
				</if>
				<!--
				<function name="InstallMeter"/>
				<function name="InstallFlow"/>
				-->

				<function name="GetShortPath">
					<parameters>
						<parameter name="result" type="boolean" out="context.getpathresult"/>
					</parameters>
				</function>
				<if cond="context.getpathresult.toBoolean()==false">
					<then>
						<log>getpathresult is false</log>
						<exit/>
					</then>
				</if>
				<if cond="thisclass.m_tunneldevicemgr != null">
					<then>
						<log>##### m_tunneldevicemgr is not null #####</log>
						<function name="GetFirstDevice" class="m_tunneldevicemgr">
							<parameters>
								<parameter name="firstdevice" type="class" out="context.firstdevice"/>
							</parameters>
						</function>
						
						<function name="GetLastDevice" class="m_tunneldevicemgr">
							<parameters>
								<parameter name="lastdevice" type="class" out="context.lastdevice"/>
							</parameters>
						</function>
						
						<function name="GetMiddleDevice" class="m_tunneldevicemgr">
							<parameters>
								<parameter name="devicelist" type="list" out="context.middevice"/>
							</parameters>							
						</function>
					</then>
				</if>
				<if cond="context.firstdevice==context.lastdevice">
					<then>
						<function name="installRuleAtSameDevice" class="firstdevice">
							<parameters>
								<parameter name="inport" type="string" in="thisclass.m_fromdeviceport.toString()"/>
								<parameter name="invlan" type="string" in="thisclass.m_inputvlanid.toString()"/>
								<parameter name="outport" type="string" in="thisclass.m_todeviceport.toString()"/>
								<parameter name="outvlan" type="string" in="thisclass.m_outputvlanid.toString()"/>
								<parameter name="bandwith" type="long" in="thisclass.m_bandwidth.toLong()"/>
							</parameters>
						</function>
						<exit/>
					</then>
				</if>
				<function name="installRuleStart" class="firstdevice">
					<parameters>
						<parameter name="inport" type="string" in="thisclass.m_fromdeviceport.toString()"/>
						<parameter name="invlan" type="string" in="thisclass.m_inputvlanid.toString()"/>
						<parameter name="serviceinvlan" type="string" in="thisclass.m_serviceinvlan.toString()"/>
						<parameter name="serviceoutvlan" type="string" in="thisclass.m_serviceoutvlan.toString()"/>
						<parameter name="bandwith" type="long" in="thisclass.m_bandwidth.toLong()"/>
					</parameters>
				</function>
				<function name="installRuleEnd" class="lastdevice">
					<parameters>
						<parameter name="inport" type="string" in="thisclass.m_fromdeviceport.toString()"/>
						<parameter name="invlan" type="string" in="thisclass.m_inputvlanid.toString()"/>
						<parameter name="serviceinvlan" type="string" in="thisclass.m_serviceinvlan.toString()"/>
						<parameter name="serviceoutvlan" type="string" in="thisclass.m_serviceoutvlan.toString()"/>
						<parameter name="bandwith" type="long" in="thisclass.m_bandwidth.toLong()"/>
					</parameters>
				</function>
				<set name="middevicefirst" value="context.middevice.begin()"/>
				<set name="middeviceend" value="context.middevice.end()"/>				
				<for var="context.middeviceiterator" from="context.middevicefirst" to="context.middeviceend">
					<set name="onedevice" value="context.middeviceiterator.value()"/>
					<function name="installRuleMid" class="onedevice">
						<parameters>
							<parameter name="serviceinvlan" type="string" in="thisclass.m_serviceinvlan.toString()"/>
							<parameter name="serviceoutvlan" type="string" in="thisclass.m_serviceoutvlan.toString()"/>
						</parameters>
					</function>
				</for>
				<set name="m_bisActive" value="true"/>
			</function>
			<function name="DeactiveTunnel">
				<log>##### Deactive Tunnel #####</log>
				<if cond="thisclass.m_bisActive.toBoolean()==false">
					<then>
						<function>
							<log>Tunnel is Deactive already</log>
							<exit/>
						</function>
					</then>
				</if>
				<if cond="thisclass.m_tunneldevicemgr != null">
					<then>
						<function name="DeactiveTunnel" class="m_tunneldevicemgr"/>
					</then>
				</if>
				<set name="m_bisActive" value="false"/>
			</function>
			
			<function name="GetShortPath">
				<parameters>
					<parameter name="result" type="boolean"/>
				</parameters>
				<log>##### Get Shortest Path #####</log>
				<variable name="strlink" type="string"/>
				<set name="strlink" value="context.openflowserverobj.getShortestPath2(thisclass.m_fromdevice.toString(), thisclass.m_todevice.toString())"/>
				<log>============= START =================</log>
				<log><![CDATA[strlink=<%=context.strlink.toString()%>]]></log>
				<log>=============  END  =================</log>
				<if cond="context.strlink.toString()!=''">
					<then>
						<function name="GetTunnelDeviceFromJson" class="thisclass.m_tunneldevicemgr">
							<parameters>
								<parameter name="json" type="string" in="context.strlink.toString()"/>
							</parameters>
						</function>
						<log>result true</log>
						<set name="result" value="true"/>
					</then>
					<else>
						<log>result false</log>
						<set name="result" value="false"/>
					</else>
				</if>
			</function>
			
			<!-- wangkang 2017/09/21-->
			<function name="FindTunnelDeviceFromlist">
				<parameters>
					<parameter name="json" type="string"/>
				</parameters>
				<variable name="dstport" type="string"/>
				<variable name="srcport" type="string"/>
				<variable name="oneinputport" type="string"/>
				<variable name="oneoutputport" type="string"/>
				<variable name="onedeviceid" type="string"/>
				<variable name="onetunneldevice" type="class"/>
				<log><![CDATA[json=<%=context.json.toString()%>]]></log>
				<script><![CDATA[
					if (context.json.toString().length>0)
					{
						var info = JSON.parse(context.json.toString());
						if (info.paths.length==1)
						{
							context.dstport.setValue(info.paths[0].dst.port);
							context.srcport.setValue(info.paths[0].src.port);
						}
					}
				]]></script>
				
				<for var="onetunneldevice" in="thisclass.m_tunneldevicemgr.tunneldeviceContainer">
					<function name="GetInputPort" class="context.onetunneldevice">
						<parameters>
							<parameter name="inputPort" type="string" out="context.oneinputport"/>
						</parameters>
					</function>
					<function name="GetOutputPort" class="context.onetunneldevice">
						<parameters>
							<parameter name="outputPort" type="string" out="context.oneoutputport"/>
						</parameters>
					</function>
					<if cond="context.srcport.toString() == context.inputport.toString()">
						<then>
							<if cond="context.dstport.toString() == context.outputport.toString()">
								<then>
									<log>TunnelDevice is Find From List</log>
									<function name="GetTunnelDeviceId" class="context.onetunneldevice">
										<parameters>
											<parameter name="outtunneldeviceid" type="string" out="context.onedeviceid"/>
										</parameters>
									</function>
									<exit/>
								</then>
							</if>
						</then>
					</if>
				</for>
				<function name="removeTunnelDevice" class="thisclass.m_tunneldevicemgr">
					<parameters>
						<parameter name="deviceid" type="string" in="context.onedeviceid"/>
					</parameters>
				</function>
				<function name="GetShortPath"/>
			</function>
			
			<!--Topology change-->
			<function name="mytopremove">
				<parameters>
					<parameter name="fromdevice" type="string"/>
					<parameter name="todevice" type="string"/>
					<parameter name="path" type="string"/>
				</parameters>
				<variable name="isChange" type="boolean" value="false"/>
				<log>Tunnel Top channge</log>
				<function name="IsMyTopChange" class="m_tunneldevicemgr">
					<parameters>
						<parameter name="fromdevice" type="string" in="context.fromdevice.toString()"/>
						<parameter name="todevice" type="string" in="context.todevice.toString()"/>
						<parameter name="path" type="string" in="context.path.toString()"/>
						<parameter name="ischanage" type="boolean" out="context.isChange"/>
					</parameters>
				</function>
				<if cond="context.isChange.toBoolean()==true">
					<then>
						<function name="DeactiveTunnel"/>
						<function name="ActiveTunnel"/>
					</then>
				</if>
			</function>
			
		</public>
	</class>
</starosxml>