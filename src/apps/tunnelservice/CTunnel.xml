<?xml version="1.0" encoding="UTF-8"?>
<starosxml xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
	<!--wangkang 2017/09/13 -->
	<class name="CTunnel">
		<private>
			<variable name="m_id" type="long"/>
			<variable name="m_username" type="string"/>
			<variable name="m_inputPort" type="string"/>
			<variable name="m_outputPort" type="string"/>
			<variable name="m_invlan" type="long"/>
			
			<variable name="m_outvlan" type="long"/>
			<variable name="m_type" type="string"/>
			<variable name="m_state" type="string"/>
			<variable name="m_inputvlanid" type="long"/>
			<variable name="m_outputvlanid" type="long"/>
			
			<variable name="m_bandwidth" type="long"/>
			<variable name="m_inmeterid" type="long"/>
			<variable name="m_outmeterid" type="long"/>
		</private>
		<public>
			<function name="CTunnel">
				<parameters>
					<parameter name="id" type="long"/>
					<parameter name="username" type="string"/>
					<parameter name="inputPort" type="string"/>
					<parameter name="outputPort" type="string"/>
					<parameter name="invlan" type="long"/>
					
					<parameter name="outvlan" type="long"/>
					<parameter name="type" type="string"/>
					<parameter name="state" type="string"/>
					<parameter name="inputvlanid" type="long"/>
					<parameter name="outputvlanid" type="long"/>
					
					<parameter name="bandwidth" type="long"/>
					<parameter name="inmeterid" type="long"/>
					<parameter name="outmeterid" type="long"/>
				</parameters>
				<set name="thisclass.m_id" value="context.id.toLong()"/>
				<set name="thisclass.m_username" value="context.username.toString()"/>
				<set name="thisclass.m_inputPort" value="context.inputPort.toString()"/>
				<set name="thisclass.m_outputPort" value="context.outputPort.toString()"/>
				<set name="thisclass.m_invlan" value="context.invlan.toLong()"/>
				<set name="thisclass.m_outvlan" value="context.outvlan.toLong()"/>
				<set name="thisclass.m_type" value="context.type.toString()"/>
				<set name="thisclass.m_state" value="context.state.toString()"/>
				<set name="thisclass.m_inputvlanid" value="context.inputvlanid.toLong()"/>
				<set name="thisclass.m_outputvlanid" value="context.outputvlanid.toLong()"/>
				<set name="thisclass.m_bandwidth" value="context.bandwidth.toLong()"/>
				<set name="thisclass.m_inmeterid" value="context.inmeterid.toLong()"/>
				<set name="thisclass.m_outmeterid" value="context.outmeterid.toLong()"/>
			</function>
			<function name="GetTunnelId">
				<parameters>
					<parameter name="outid" type="long"/>
				</parameters>
				<set name="outid" value="thisclass.m_id.toLong()"/>
			</function>
			<!--qiulei 20170913 pm-->
			<function name="GetTunnel_username">
				<parameters>
					<parameter name="t_username" type="string"/>
				</parameters>
				<set name="t_username" value="thisclass.m_username.toString()"/>
			</function>
			
			<function name="GetTunnel_inputPort">
				<parameters>
					<parameter name="t_inputPort" type="string"/>
				</parameters>
				<set name="t_inputPort" value="thisclass.m_inputPort.toString()"/>
			</function>
			
			
			<function name="GetTunne_outputPort">
				<parameters>
					<parameter name="t_outputPort" type="string"/>
				</parameters>
				<set name="t_outputPort" value="thisclass.m_outputPort.toString()"/>
			</function>
			
			<function name="GetTunne_invlan">
				<parameters>
					<parameter name="t_invlan" type="long"/>
				</parameters>
				<set name="t_invlan" value="thisclass.m_invlan.toLong()"/>
			</function>
			
			<function name="GetTunnel_outvlan">
				<parameters>
					<parameter name="t_outvlan" type="long"/>
				</parameters>
				<set name="t_outvlan" value="thisclass.m_outvlan.toLong()"/>
			</function>
			
			<function name="GetTunnel_type">
				<parameters>
					<parameter name="t_type" type="string"/>
				</parameters>
				<set name="t_type" value="thisclass.m_type.toString()"/>
			</function>
			
			<function name="GetTunnel_state">
				<parameters>
					<parameter name="t_state" type="string"/>
				</parameters>
				<set name="t_state" value="thisclass.m_state.toString()"/>
			</function>
			
			<function name="GetTunnel_inputvlanid">
				<parameters>
					<parameter name="t_inputvlanid" type="long"/>
				</parameters>
				<set name="t_inputvlanid" value="thisclass.m_inputvlanid.toLong()"/>
			</function>
			
			<function name="GetTunnel_outputvlanid">
				<parameters>
					<parameter name="t_outputvlanid" type="long"/>
				</parameters>
				<set name="t_outputvlanid" value="thisclass.m_outputvlanid.toLong()"/>
			</function>
			
			<function name="GetTunnel_bandwidth">
				<parameters>
					<parameter name="t_bandwidth" type="long"/>
				</parameters>
				<set name="t_bandwidth" value="thisclass.m_bandwidth.toLong()"/>
			</function>
			
			<function name="GetTunnelI_inmeterid">
				<parameters>
					<parameter name="t_inmeterid" type="long"/>
				</parameters>
				<set name="t_inmeterid" value="thisclass.m_inmeterid.toLong()"/>
			</function>
			
			<function name="GetTunnelI_outmeterid">
				<parameters>
					<parameter name="t_outmeterid" type="long"/>
				</parameters>
				<set name="t_outmeterid" value="thisclass.m_outmeterid.toLong()"/>
			</function>
			
			<!--qiulei 20170913-->

			<function name="OneTunnelObjectToJsonString">
				<parameters>
					<parameter name="TunnelObjectToJson" type="string"/>
				</parameters>
				<log>insert CTunnel OneTunnelObjectToJsonString</log>
				<variable name="values" type="string" />
				<reference variable="values">
					<jsonbody><![CDATA[ 
						{	
							"id":"<%=thisclass.m_id.toLong()%>",
							"username":"<%=thisclass.m_username.toString()%>",
							"inputPort":"<%=thisclass.m_inputPort.toString()%>",
							"outputPort":"<%=thisclass.m_outputPort.toString()%>",
							"invlan":"<%=thisclass.m_invlan.toLong()%>",
							
							"outvlan":"<%=thisclass.m_outvlan.toLong()%>",
							"type":"<%=thisclass.m_type.toString()%>",
							"state":"<%=thisclass.m_state.toString()%>",
							"inputvlanid":"<%=thisclass.m_inputvlanid.toLong()%>",
							"outputvlanid":"<%=thisclass.m_outputvlanid.toLong()%>",
							
							"bandwidth":"<%=thisclass.m_bandwidth.toLong()%>",
							"inmeterid":"<%=thisclass.m_inmeterid.toLong()%>",
							"outmeterid":"<%=thisclass.m_outmeterid.toLong()%>"
						}
					]]></jsonbody>
				</reference>
				<log><![CDATA[context.values = <%=context.values.toString()%>]]></log>
				<set name="TunnelObjectToJson" value="context.values.toString()"/>
			</function>
			
			<!--qiulei 20170913 update Tunnel-->
			<function name="UpdateTunnel">
				<parameters>
					
					<parameter name="username" type="string"/>
					<parameter name="inputPort" type="string"/>
					<parameter name="outputPort" type="string"/>
					<parameter name="invlan" type="long"/>
					
					<parameter name="outvlan" type="long"/>
					<parameter name="type" type="string"/>
					<parameter name="state" type="string"/>
					<parameter name="inputvlanid" type="long"/>
					<parameter name="outputvlanid" type="long"/>
					
					<parameter name="bandwidth" type="long"/>
					<parameter name="inmeterid" type="long"/>
					<parameter name="outmeterid" type="long"/>
				</parameters>
				
				<set name="thisclass.m_username" value="context.username.toString()"/>
				<set name="thisclass.m_inputPort" value="context.inputPort.toString()"/>
				<set name="thisclass.m_outputPort" value="context.outputPort.toString()"/>
				<set name="thisclass.m_invlan" value="context.invlan.toLong()"/>
				<set name="thisclass.m_outvlan" value="context.outvlan.toLong()"/>
				<set name="thisclass.m_type" value="context.type.toString()"/>
				<set name="thisclass.m_state" value="context.state.toString()"/>
				<set name="thisclass.m_inputvlanid" value="context.inputvlanid.toLong()"/>
				<set name="thisclass.m_outputvlanid" value="context.outputvlanid.toLong()"/>
				<set name="thisclass.m_bandwidth" value="context.bandwidth.toLong()"/>
				<set name="thisclass.m_inmeterid" value="context.inmeterid.toLong()"/>
				<set name="thisclass.m_outmeterid" value="context.outmeterid.toLong()"/>
			</function>
			
			<!-- wangkang 2017/09/15 -->
			<function name="ActiveTunnel">
				<log>Active Tunnel</log>
				<function name="InstallMeter"/>
				<function name="InstallFlow"/>
			</function>
			<function name="DeactiveTunnel">
				<log>Deactive Tunnel</log>
				<function name="UnInstallMeter"/>
				<function name="UnInstallFlow"/>
			</function>
			
			<function name="FindMeterManager">
				<parameters>
					<parameter name="outmetermgrobj" type="class"/>
				</parameters>
				<variable name="deviceobj" type="class"/>
				<log><![CDATA[transportid=<%=event.getParam('transportid').toString()%>]]></log>
				
				<function name="GetDeviceByTransportId" class="DeviceManager">
					<parameters>
						<parameter name="transportid" type="string" in="event.getParam('transportid').toString()"/>
						<parameter name="onedeviceobj" type="class" out="context.deviceobj"/>
					</parameters>
				</function>
				<if cond="context.deviceobj != null">
					<then>
						<log>##### Deviceobj is not null #####</log>
						<function name="GetMeterManager" class="context.deviceobj">
							<parameters>
								<parameter name="outmetermgr" type="class" out="context.outmetermgrobj"/>
							</parameters>
						</function>
					</then>
				</if>
			</function>
			
			<function name="FindFlowManager">
				<parameters>
					<parameter name="outflowmgrobj" type="class"/>
				</parameters>
				<variable name="deviceobj" type="class"/>
				<log><![CDATA[transportid=<%=event.getParam('transportid').toString()%>]]></log>
				
				<function name="GetDeviceByTransportId" class="DeviceManager">
					<parameters>
						<parameter name="transportid" type="string" in="event.getParam('transportid').toString()"/>
						<parameter name="onedeviceobj" type="class" out="context.deviceobj"/>
					</parameters>
				</function>
				<if cond="context.deviceobj != null">
					<then>
						<log>##### Deviceobj is not null #####</log>
						<function name="GetFlowManager" class="context.deviceobj">
							<parameters>
								<parameter name="outflowmgr" type="class" out="context.outflowmgrobj"/>
							</parameters>
						</function>
					</then>
				</if>
			</function>
			
			<function name="InstallMeter">			
				<variable name="modstrjson" type="string"/>
				<variable name="resourceid" type="string" value=""/>
				<variable name="onemetermgr" type="class"/>
				<reference variable="modstrjson">
					<jsonbody><![CDATA[ 
						{
							"xid":"<%=context.openflowserverobj.getIncreaseXID()%>",
							"command":"<$=OPENFLOW_METER_MOD_ADD$>",
							"flag":"1",
							"meterid":"1",
							"meterbandlist":[
								{
									"bandtype":"1",
									"rate":"<%=thisclass.m_bandwidth%>",
									"burstsize":"0"
								}
							]
						}	
					]]></jsonbody>
				</reference>
				<function name="FindMeterManager">
					<parameters>
						<parameter name="outmetermgrobj" type="class" out="context.onemetermgr"/>
					</parameters>
				</function>
				<if cond="context.onemetermgr != null">
					<then>
						<function name="InstallMeterRequest" class="context.onemetermgr">
							<parameters>
								<parameter name="strjson" type="string" in="context.modstrjson.toString()"/>
								<parameter name="meterid" type="long" out="thisclass.m_inmeterid"/>
								<parameter name="appid" type="string" in="'core'"/>
							</parameters>
						</function>	
					</then>	
				</if>
			</function>
			
			<function name="UnInstallMeter">
				<variable name="onemetermgr" type="class"/>
				<function name="FindMeterManager">
					<parameters>
						<parameter name="outmetermgrobj" type="class" out="context.onemetermgr"/>
					</parameters>
				</function>
				<if cond="context.onemetermgr != null">
					<then>
						<function name="UnInstallMeterRequest" class="context.onemetermgr">
							<parameters>
								<parameter name="meterid" type="long" in="thisclass.m_inmeterid.toLong()"/>
							</parameters>
						</function>
					</then>	
				</if>
			</function>
			
			<function name="InstallFlow">
				<log dest="stdout">InstallFlow wangkang 2017/09/15</log>
				<variable name="modstrjson" type="string"/>
				<variable name="oneflowmgr" type="class"/>
				<reference variable="modstrjson">
					<jsonbody><![CDATA[ 
							{
								"xid":"<%=context.openflowserverobj.getIncreaseXID()%>",
								"cookie":"0",
								"cookiemask":"0",
								"tableid":"0",
								"command":"0",
								"idletimeout":"0",
								"hardtimeout":"0",
								"priority":"40000",
								"bufferid":"0xffffffff",
								"outport":"0xffffffff",
								"outgroup":"0xffffffff",
								"flags":"1",
								"match":{
										"type":"1",
										"matchfieldlist":[
											{
												"oxmclass":"0x8000",
												"oxmfield":"5",
												"hasmask":"false",
												"ethtype":"0x0806"
											}
										]
									},
								"instructionlist":[
									{
										"type":"4",
										"actionlist":[
											{
												"type":"0",
												"outport":"0xfffffffd",
												"maxlen":"0xffff"
											}
										]
									}
								]
							}
					]]></jsonbody>
				</reference>
				<function name="FindFlowManager">
					<parameters>
						<parameter name="outflowmgrobj" type="class" out="context.oneflowmgr"/>
					</parameters>
				</function>
				<if cond="context.oneflowmgr != null">
					<then>
						<log>InstallFlowTableRequest</log>
						<!--
						<function name="InstallFlowTableRequest" class="context.oneflowmgr">
								
						</function>	
						-->
					</then>	
				</if>
			</function>
			
			<function name="UnInstallFlow">
				<variable name="oneflowmgr" type="class"/>
				<function name="FindFlowManager">
					<parameters>
						<parameter name="outflowmgrobj" type="class" out="context.oneflowmgr"/>
					</parameters>
				</function>
				<if cond="context.oneflowmgr != null">
					<then>
						<log>UnInstallFlowTableRequest</log>
						<!--
						<function name="UnInstallFlowTableRequest" class="context.oneflowmgr">

						</function>
						-->
					</then>	
				</if>
			</function>
		</public>
	</class>
</starosxml>