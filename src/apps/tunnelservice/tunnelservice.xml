<?xml version="1.0" encoding="UTF-8"?>
<starlang xmlns="http://www.staros.xyz/staros" scope="application">
	
	<!--qiulei 20170913-->
	<include src="/opt/staros.xyz/staroscontroller/starlang/apps/tunnelservice/CTunnel.xml"/>
	<include src="/opt/staros.xyz/staroscontroller/starlang/apps/tunnelservice/CTunnelManager.xml"/>
	<include src="/opt/staros.xyz/staroscontroller/starlang/apps/tunnelservice/tunnelserviceapi.xml"/>
	<!--qiulei 20170915 Friday pm-->
	<include src="/opt/staros.xyz/staroscontroller/starlang/apps/tunnelservice/tunnelServiceDocsApi.xml"/>
	<!-- wangkang 2017/09/20 -->
	<include src="/opt/staros.xyz/staroscontroller/starlang/apps/tunnelservice/CTunnelDevice.xml"/>
	<include src="/opt/staros.xyz/staroscontroller/starlang/apps/tunnelservice/CTunnelDeviceManager.xml"/>
	<include src="/opt/staros.xyz/staroscontroller/starlang/apps/tunnelservice/CTunnelIDManager.xml"/>
	
<!--
	Author:
			YY
	Date:
			2017-08-11
	Copyright: 
			Nanjing StarOS Inc. All rights reserved.
-->
	<object name="applicationmgr" value="global.ApplicationManager" reference="true"/>
	<object name="devicemgr" value="global.DeviceManager" reference="true"/>
	<object name="flowservice" value="global.FlowService" reference="true"/>
	<object name="meterservice" value="global.MeterService" reference="true"/>
	<object name="restfulservice" value="global.RestfulService" reference="true"/>
	<object name="toposervice" value="global.TopoService" reference="true"/>
	<!--qiulei 20170913-->
	<object name="tunnelManagerObject"/>
	<object name="tunnelDeviceManagerObject"/>
	<events>
		<onevent event="bundleapp.startup">			
			<!-- YY 2017-08-21 -->
			<long name="bundleid" value="context.getCurrentBundleId()"/>
			<function name="RegistApplication" class="context.applicationmgr">
				<parameters>
					<string name="id" in="'tunnelservice'"/>
					<string name="version" in="'1.0.0'"/>
					<string name="category" in="'staros application'"/>
					<string name="origin" in="'Nanjing StarOS Inc.'"/>
					<string name="title" in="'Tunnel Service'"/>
					<string name="desc" in="'Tunnel Service for Staros-controller'"/>		
					<string name="url" in="'http://www.staros.xyz'"/>
					<long name="bundleid" in="context.bundleid.toLong()"/>
				</parameters>
			</function>
			<activebundle bundleid="context.bundleid.toLong()"/>
			
			
			<log>tunnelservice app startup</log>
		</onevent>	
		
		<onevent event="bundleapp.active">
			<log>tunnelservice bundleapp.active</log>			
			<new name="tunnelManagerObject" class="CTunnelManager"/>
			<new name="tunnelDeviceManagerObject" class="CTunnelDeviceManager"/>
			<function name="RegisterHandler"/>
			
			<!--qiulei 20170915-->
			<function name="AddDocsAPITunnel"/>

			<function name="addTopoListener" class="toposervice">				
				<parameters>
					<string name="appid" in="'tunnelservice'"/>
					<string name="add_eventname" in="'mytopadd'"/>
					<string name="remove_eventname" in="'mytopremove'"/>
				</parameters>
			</function>

		</onevent>
		
		<onevent event="~bundleapp.deactive">
			<log>tunnelservice bundleapp.deactive</log>
			<delete name="tunnelManagerObject"/>
			<function name="UnRegisterHandler"/>
			<function name="RemoveDocsAPITunnel"/>
			<function name="removeTopoListener" class="toposervice">
				<parameters>
					<string name="appid" in="'tunnelservice'"/>
				</parameters>
			</function>
		</onevent>

		<onevent event="mytopadd">
			<function>
				<log>tunnelservice mytopadd</log>
				<log><![CDATA[fromdevice <%=event.getParam('fromdevice').toString()%>]]> </log>
				<log><![CDATA[todevice <%=event.getParam('todevice').toString()%>]]> </log>
				<log><![CDATA[path<%=event.getParam('path').toString()%>]]> </log>
			</function>
		</onevent>
		<onevent event="mytopremove">
			<function>
				<log>###### tunnelservice mytopremove ######</log>
				<log><![CDATA[fromdevice <%=event.getParam('fromdevice').toString()%>]]> </log>
				<log><![CDATA[todevice <%=event.getParam('todevice').toString()%>]]> </log>
				<log><![CDATA[path<%=event.getParam('path').toString()%>]]> </log>
				<function name="mytopremove" class="tunnelManagerObject">
					<parameters>
						<string name="fromdevice" in="event.getParam('fromdevice').toString()"/>
						<string name="todevice" in="event.getParam('todevice').toString()"/>
						<string name="path" in="event.getParam('path').toString()"/>
					</parameters>
				</function>
			</function>
		</onevent>
		
		<onevent event="*">
			<function>
			<log level="1"><![CDATA[ invalid event <%=event.getName().toString()%>]]> </log>
			<log level="1"><![CDATA[ invalid param <%=event.getParam("eventdata").toString()%>]]> </log>
			</function>
		</onevent>
	</events>
</starlang>