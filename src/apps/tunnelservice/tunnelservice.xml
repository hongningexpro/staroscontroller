<?xml version="1.0" encoding="UTF-8"?>
<starosxml xmlns="http://www.staros.xyz/staros" scope="application">
	
	<!--qiulei 20170913-->
	<include src="/opt/staros.xyz/staroscontroller/starlang/apps/tunnelservice/CTunnel.xml"/>
	<include src="/opt/staros.xyz/staroscontroller/starlang/apps/tunnelservice/CTunnelManager.xml"/>
	<include src="/opt/staros.xyz/staroscontroller/starlang/apps/tunnelservice/tunnelserviceapi.xml"/>
	<!--qiulei 20170915 Friday pm-->
	<include src="/opt/staros.xyz/staroscontroller/starlang/apps/tunnelservice/tunnelServiceDocsApi.xml"/>
	<!-- wangkang 2017/09/20 -->
	<include src="/opt/staros.xyz/staroscontroller/starlang/apps/tunnelservice/CTunnelDevice.xml"/>
	<include src="/opt/staros.xyz/staroscontroller/starlang/apps/tunnelservice/CTunnelDeviceManager.xml"/>
	
<!--
	Author:
			YY
	Date:
			2017-08-11
	Copyright: 
			Nanjing StarOS Inc. All rights reserved.
-->
	<variable name="applicationmgr" reference="global.ApplicationManager"/>
	<variable name="devicemgr" reference="global.DeviceManager"/>
	<variable name="flowservice" reference="global.FlowService"/>
	<variable name="meterservice" reference="global.MeterService"/>
	<variable name="restfulservice" reference="global.RestfulService"/>
	<variable name="toposervice" reference="global.TopoService"/>
	<!--qiulei 20170913-->
	<variable name="tunnelManagerObject" type="class"/>
	<variable name="tunnelDeviceManagerObject" type="class"/>
	<events>
		<onevent event="bundleapp.startup">			
			<!-- YY 2017-08-21 -->
			<variable name="bundleid" type="long" value="context.getCurrentBundleId()"/>
			<function name="RegistApplication" class="context.applicationmgr">
				<parameters>
					<parameter name="id" type="string" in="'tunnelservice'"/>
					<parameter name="version" type="string" in="'1.0.0'"/>
					<parameter name="category" type="string" in="'staros application'"/>
					<parameter name="origin" type="string" in="'Nanjing StarOS Inc.'"/>
					<parameter name="title" type="string" in="'Tunnel Service'"/>
					<parameter name="desc" type="string" in="'Tunnel Service for Staros-controller'"/>		
					<parameter name="url" type="string" in="'http://www.staros.xyz'"/>
					<parameter name="bundleid" type="long" in="context.bundleid.toLong()"/>
				</parameters>
			</function>
			<activebundle bundleid="context.bundleid.toLong()"/>
			
			
			<log>tunnelservice app startup</log>
		</onevent>	
		
		<onevent event="bundleapp.active">
			<log>tunnelservice bundleapp.active</log>			
			<new name="tunnelManagerObject" class="CTunnelManager"/>
			<new name="tunnelDeviceManagerObject" class="CTunnelDeviceManager"/>
			<function name="RegisterHandler"/>
			
			<!--qiulei 20170915-->
			<function name="AddDocsAPITunnel"/>

			<function name="addTopoListener" class="toposervice">				
				<parameters>
					<parameter name="appid" type="string" in="'tunnelservice'"/>
					<parameter name="add_eventname" type="string" in="'mytopadd'"/>
					<parameter name="remove_eventname" type="string" in="'mytopremove'"/>
				</parameters>
			</function>

		</onevent>
		
		<onevent event="~bundleapp.deactive">
			<log>tunnelservice bundleapp.deactive</log>
			<delete name="tunnelManagerObject"/>
			<function name="UnRegisterHandler"/>
			<function name="RemoveDocsAPITunnel"/>
			<function name="removeTopoListener" class="toposervice">
				<parameters>
					<parameter name="appid" type="string" in="'tunnelservice'"/>
				</parameters>
			</function>
		</onevent>

		<onevent event="mytopadd">
			<function>
				<log>tunnelservice mytopadd</log>
				<log><![CDATA[fromdevice <%=event.getParam('fromdevice').toString()%>]]> </log>
				<log><![CDATA[todevice <%=event.getParam('todevice').toString()%>]]> </log>
				<log><![CDATA[path<%=event.getParam('path').toString()%>]]> </log>
			</function>
		</onevent>
		<onevent event="mytopremove">
			<function>
				<log>tunnelservice mytopremove</log>
				<log><![CDATA[fromdevice <%=event.getParam('fromdevice').toString()%>]]> </log>
				<log><![CDATA[todevice <%=event.getParam('todevice').toString()%>]]> </log>
				<log><![CDATA[path<%=event.getParam('path').toString()%>]]> </log>
				<function name="mytopremove" class="tunnelManagerObject">
					<parameters>
						<parameter name="fromdevice" type="string" in="event.getParam('fromdevice').toString()"/>
						<parameter name="todevice" type="string" in="event.getParam('todevice').toString()"/>
						<parameter name="path" type="string" in="event.getParam('path').toString()"/>
					</parameters>
				</function>
			</function>
		</onevent>
		
		<onevent event="*">
			<function>
			<log level="1"><![CDATA[ invalid event <%=event.getName()%>]]> </log>
			<log level="1"><![CDATA[ invalid param <%=event.getParam("eventdata").toString()%>]]> </log>
			</function>
		</onevent>
	</events>
</starosxml>