<?xml version="1.0" encoding="UTF-8"?>
<starlang xmlns="http://www.staros.xyz/staros" scope="application">
<!--
	Author:
			YY
	Date:
			2017-08-11
	Copyright: 
			Nanjing StarOS Inc. All rights reserved.
-->
	<object name="applicationmgr" reference="global.ApplicationManager"/>
	<object name="devicemgr" reference="global.DeviceManager"/>
	<events>
		<onevent event="bundleapp.startup">			
			<!-- YY 2017-08-21 -->
			<function name="RegistApplication" class="context.applicationmgr">
				<parameters>
					<string name="id" in="'forwarding'"/>
					<string name="version" in="'1.0.0'"/>
					<string name="category" in="'starosapp'"/>
					<string name="origin" in="'Nanjing StarOS Inc.'"/>
					<string name="title" in="'app for forwarding'"/>
					<string name="desc" in="'2.10.10.0'"/>		
					<string name="url" in="'192.168.228.128'"/>
					<long name="bundleid" in="context.getCurrentBundleId()"/>
					<string name="pathname" in="event.getParam('pathname').toString()"/>
				</parameters>
			</function>			
			
			
			<log>forwarding app startup</log>
		</onevent>
		
		<onevent event="bundleapp.active">
			<function name="addProcessor" class="PacketService">				
				<parameters>
					<string name="app_name" in="'forwarding'"/>
					<string name="event_name" in="'PacketInEvent'"/>
					<string name="eth_type" in="'0x0806'"/>
				</parameters>
			</function>
		</onevent>
		
		<onevent event="~bundleapp.deactive">
			<function name="removeProcessor" class="PacketService">				
				<parameters>
					<string name="app_name" in="'nullapp'"/>									
				</parameters>
			</function>
		</onevent>
		
		<onevent event="~bundleapp.shutdown">
			<!-- YY 2017-08-21 -->
			
		</onevent>
		<onevent event="PacketInEvent">
			<!-- YY 2017-08-21 -->		
			<messageblock name="packetmsgblock"/>
			<string name="inportid"/>
			<string name="pkoutjson"/>
			<script><![CDATA[
				var info = JSON.parse(event.getParam('eventdata').toString());
				if (info.match != null) {
					var inport_id = info.match.matchfieldlist[0].inport;					
					context.inportid.setValue(inport_id);
				}
				if (info.payload != null) {
					var pay_load = info.payload;
					var strjson=JSON.stringify(pay_load);
					context.pkoutjson.setValue(strjson);
				}
			]]></script>
			<set name="packetmsgblock" value="event.getMessageBlock()"/>
			<log><![CDATA[packetmsgblock size=<%=context.packetmsgblock.getChainedLength().toString()%>]]></log>
			<function name="PacketOutToAllPort" class="context.devicemgr">
				<parameters>	
					<string name="datapathid" in="event.getParam('datapathid').toString()"/>
					<string name="inportid" in="context.inportid.toString()"/>	
					<string name="pkoutjson" in="context.pkoutjson.toString()"/>	
					<messageblock name="msgblock" in="context.packetmsgblock"/>	
				</parameters>
			</function>
		</onevent>
		
		<onevent event="*">
			<function>
			<log level="1"><![CDATA[ invalid event <%=event.getName().toString()%>]]> </log>
			<log level="1"><![CDATA[ invalid param <%=event.getParam("eventdata").toString()%>]]> </log>
			</function>
		</onevent>
	</events>
</starlang>