<?xml version="1.0" encoding="UTF-8"?>
<!--
	Copyright (C) 2013-2016 Nanjing StarOS Technology Co., Ltd
	All rights reserved.
	
	@file 		staros.xml
	@brief 		控制器主入口
	@version 	1.1.0
	@auth 		Yi Jian (yijian@staros.xyz)
	@date		2017/11/24

	Licensed under the Apache License, Version 2.0 (the "License");
	you may not use this file except in compliance with the License.
	You may obtain a copy of the License at

	http://www.apache.org/licenses/LICENSE-2.0

	Unless required by applicable law or agreed to in writing, software
	distributed under the License is distributed on an "AS IS" BASIS,
	WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
	See the License for the specific language governing permissions and
	limitations under the License.
-->
<starlang xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
	<include src="/opt/staros.xyz/staroscontroller/starlang/utils/function_callback.xml"/>
	<include src="/opt/staros.xyz/staroscontroller/starlang/gui/staros_http.xml"/>
	<include src="/opt/staros.xyz/staroscontroller/starlang/setting/setting.xml"/>
	<include src="/opt/staros.xyz/staroscontroller/starlang/protocols/openflow/openflow_app.xml"/>
	<!--qiulei 20170811-->
	<include src="/opt/staros.xyz/staroscontroller/starlang/localcall/localcall.xml"/>
	<include src="/opt/staros.xyz/staroscontroller/starlang/resource/global_resource.xml"/>
	<include src="/opt/staros.xyz/staroscontroller/starlang/utils/define.xml"/>
	<include src="/opt/staros.xyz/staroscontroller/starlang/utils/utils.xml"/>
	<include src="/opt/staros.xyz/staroscontroller/starlang/utils/oxm_match_fields_map.xml"/>
	<include src="/opt/staros.xyz/staroscontroller/starlang/utils/actions_map.xml"/>
	<include src="/opt/staros.xyz/staroscontroller/starlang/utils/instrunction_map.xml"/>
	<include src="/opt/staros.xyz/staroscontroller/starlang/utils/group_type_map.xml"/>
	
	<!--qiulei 20170929-->
	<include src="/opt/staros.xyz/staroscontroller/starlang/apidocs/apidocs.xml"/>
	
	
	<object name="openflowserverobj"  global="true"/>
	<object name="restfulserver"  global="true"/>
	
	<logconfig dest="stdout" level="10" filename="/opt/staros.xyz/staroscontroller/logs/starosapps.log" logturnoff="false"/>
	<boolean name="isAPIAuth"  value="false"/>
	<object name="globaltimer"/>
	<events>
		<!--
			@brief		控制器入口事件处理
			@date		2017/09/06
		-->
		<onevent event="bundleapp.startup">
			<long name="calloutSession" />
			<string name="outjson"/>
			<string name="injson" />
			<!--qiulei 20170828 Monday-->
			<string name="eventname"/>
			<function>
				<set name="injson" value="'[]'"/>
				<syslog level="INFO">Hello StarOS</syslog>
				<log level="100">##########STAROS application start#######</log>
				<localcall method="hellotest" inparam="context.injson" outparam="context.outjson"/>
				<log><![CDATA[ localcall output value <%=context.outjson.toString()%>]]></log>
				<remotecall method="DiscoveryTestMethod">
						<applicationdata>
							<![CDATA[ 
							hello world;
							]]>
						</applicationdata>
				</remotecall>
				<wait event="hellorequest" timeout="1000"/>
				<!--1.初始化全局变量 -->
				<function name="InitGlobalResource"/>
				<!--2.初始化全局数据MAP表 -->
				<function name="InitAPIMapFunction"/>
				<!--3.hu peng 2017/07/28  change setting-->
				<function name="InitSetting"/>
				<!--4.初始化WebSocket处理表 -->
				<function name="InitWebSocketHandlerMap"/>
				<!--5.Start GUI and Restful API Service-->
				<function name="Restfulserver"/>
				<!--6.Start OpenFlow Controller protocol-->
				<function name="startopenflow"/>
				<function name="testcallback"/>
				<!--function name="addhostest"/-->
				<!--function name="startnullapp"/-->
				<!--InitOpenFlow OXM Match Filed Map-->
				<function name="InitOXMMatchFieldMap"/>
				<function name="InitOXMMatchFieldNameMap"/>
				<function name="InitInstrunctionMap"/>
				<function name="InitActionsMap"/>
				<function name="InitActionsNameMap"/>

				<!--qiulei 20170828 Monday-->
				<set name="eventname"  value="'TimeOutEvent'"/>
				<!--启动定时器-->
				<timer name="context.globaltimer" method="StartTimer" event="'TimeOutEvent'" timeout="2000"/>
				<!--启动自动拓扑发现-->
				<function name="startDiscovery" class="TopoManager"/> 
				
				<!--qiulei 201700929 Monday-->
				<function name="RegisterAddDocsAPITopology"/>
			</function>
		</onevent>
		<!--Session Shutdown-->
		<onevent event="~bundleapp.shutdown">
		  <function>
			<log>##########~bundleapp.shutdown#######</log>
			
			<!--qiulei 201700929 Monday-->
			<function name="DestoryRemoveDocsAPITopology"/>
		  </function>
		</onevent>
		
		<!--qiulei 20170828 Monday-->
		<onevent event="TimeOutEvent">
			<function >
				<log>staros TimeOutEvent 2017.08.28</log>
				<function name="OpenFlowDetect"/>
				<!-- wangkang 2017/11/22 -->
				<function name="OpenFlowKeepAliveDetect" class="DeviceManager"/>
				<function name="Timeout" class="SessionManager"/>
				<long name="toposize" />	
				<function name="GettopoSize" class="TopoManager">
					<parameters>
						<long name="toposize" out="context.toposize"/>
					</parameters>
				</function>
				<log leve="1"><![CDATA[toposize= '<%=context.toposize.toString()%>']]></log>
			<!--wait event="InvalidEvent" timeout="2000"/-->
				<!--raise name="'TimeOutEvent'"/-->
			</function>
		</onevent>
		<onevent event="*">
			<function>
				<log>insert staroscontroller onevent *</log>
				<log><![CDATA[result = <%=event.getParam('result').toString()%>]]></log>
				<log><![CDATA[description = <%=event.getParam('description').toString()%>]]></log>
				<log><![CDATA[transportid = <%=event.getParam('transportid').toString()%>]]></log>
				<log><![CDATA[eventdata = <%=event.getParam('eventdata').toString()%>]]></log>
			</function>
		</onevent>
	</events>
</starlang>