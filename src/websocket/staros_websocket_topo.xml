<?xml version="1.0" encoding="UTF-8"?>
<starosxml>
	<function name="HandleUpdatePrefReq">
		<function>
			<websocket name="restfulserver" method="SendText" transportid="event.getParam('transportid').toString()">
				<jsonbody>
				<![CDATA[
{"event":"updatePrefs","payload":{"topo_prefs":{"insts":1,"summary":1,"detail":1,"hosts":0,"offdev":1,"dlbls":0,"porthl":1,"bg":0,"spr":0,"ovid":"traffic","toolbar":0},"topo_mapid":{"mapid":"usa","mapscale":1,"mapfilepath":"*continental_us","tint":"off"},"topo_zoom":{"tx":0,"ty":0,"sc":1}}}
				]]>
				</jsonbody>
			</websocket>
		</function>
	</function>
	<function name="HandletopoSelectOverlay">
		<function>
			<function name="SendAddInstance"/>
			<function name="SendAddAllDevice"/>
				<function name="SendAddAllDevice1"/>
			<function name="SendAddAllLink"/>
		</function>
	</function>
	<function name="HandletopoStart">
		<function>
			<function name="SendAddInstance"/>
			<function name="SendAddAllDevice"/>
				<function name="SendAddAllDevice1"/>
			<function name="SendAddAllLink"/>
			<function name="topoStartDone"/>
		</function>
	</function>
	<function name="HandleRequestSummary">
		<function name="ShowSummary"/>
	</function>
	<function name="SendAddInstance">
		<variable name="sendstrjson" type="string"/>
		<function>
			<function name="AddInstanceRequest" class="gInstanceManager">
				<parameters>
					<parameter name="transportid" type="string" in="event.getParam('transportid').toString()"/>						
				</parameters>
			</function>
		</function>
	</function>
	<function name="SendAddAllLink">
		<container name="srcdevice" type="hashmap" keytype="string" valuetype="string"/>
		<container name="dstdevice" type="hashmap" keytype="string" valuetype="string"/>
		<variable name="srcport" type="string"/>
		<variable name="dstport" type="string"/>
		<variable name="transportid" type="string"/>
		<variable name="strlink" type="string" value=""/>
		<variable name="binvalidlink" type="string" value="false"/>
		<for var="i" from="0" to="context.deviceContainer.size()-1">
			<log><![CDATA[deviceLength=<%=context.deviceContainer.size()%>]]></log>
			<function>
				<set name="srcdevice" value="context.deviceContainer.getValueByIndex(context.i.toLong())"/>
				<if cond="context.srcdevice!=null">
					<then>
						<function>
							<set name="transportid" value="context.srcdevice.getValue('transportid')"/>
							<for var="j" from="0" to="context.deviceContainer.size()-1">
								<set name="dstdevice" value="context.deviceContainer.getValueByIndex(context.j.toLong())"/>
								<if cond="context.dstdevice!=context.srcdevice">
									<then>
										<function>
								<set name="strlink" value="context.openflowserverobj.getShortestPath(context.srcdevice.getValue('datapathid').toString(), context.dstdevice.getValue('datapathid').toString())"/>
								<log><![CDATA[strlink=<%=context.strlink.toString()%>]]></log>
					<script><![CDATA[
							if (context.strlink.toString().length>0)
							{
								var info = JSON.parse(context.strlink.toString());
								if (info.paths.length==1)
								{
									context.dstport.setValue(info.paths[0].dst.port);
									context.srcport.setValue(info.paths[0].src.port);
									context.binvalidlink.setValue('true');
								}
								else 
								{	
									context.binvalidlink.setValue('false');
								}
							}
							else 
							{
								context.binvalidlink.setValue('false');
							}
					]]></script>
									<function>
										<if cond="context.binvalidlink.toString()=='true'">
											<then>
												<function>
													<websocket name="restfulserver" method="SendText" transportid="event.getParam('transportid').toString()">
														<jsonbody>
										<![CDATA[
						{
						"event":"addLink","payload":
						{"id":"of:<%=context.srcdevice.getValue('datapathid').toString()%>/<%=context.srcport.toString()%>-of:<%=context.dstdevice.getValue('datapathid').toString()%>/<%=context.dstport.toString()%>",
						"type":"direct",
						"expected":false,
						"online":true,
						"linkWidth":1.2,
						"src":"of:<%=context.srcdevice.getValue('datapathid').toString()%>",
						"srcPort":"<%=context.srcport.toString()%>",
						"dst":"of:<%=context.dstdevice.getValue('datapathid').toString()%>",
						"dstPort":"<%=context.dstport.toString()%>"
						}
						}
										]]>
														</jsonbody>
													</websocket>
												</function>
											</then>
										</if>
									</function>
									</function>
									</then>
								</if>
							</for>
						</function>
					</then>
				</if>
			</function>
		</for>
	</function>
	<function name="SendAddAllDevice1">
		<function>
			<websocket name="restfulserver" method="SendText" transportid="event.getParam('transportid').toString()">
				<jsonbody>
					<![CDATA[
						{
							"event":"addDevice",
							"payload":
							{
								"id":"of:3434",
								"type":"switch",
								"online":true,
								"master":"10.1.1.1",
								"labels":
									[
									"","of:3434",
									"of:3434"
									],
								"props":
									{
										"managementAddress":"10.1.1.1",
										"protocol":"OF_13",
										"channelId":"10.1.1.1"
									},
								"metaUi":
								{
									"equivLoc":
										{
										"lng":-98.18860657853635,
										"lat":43.492555430485986
										}
								}
							}
						}	
					]]>
				</jsonbody>
			</websocket>
		</function>
	</function>
	<function name="SendAddAllDevice">
		<container name="switchdevice" type="hashmap" keytype="string" valuetype="string"/>
		<variable name="transportid" type="string"/>
		<for var="i" from="0" to="context.deviceContainer.size()-1">
			<log><![CDATA[deviceLength=<%=context.deviceContainer.size()%>]]></log>
			<function>
				<set name="switchdevice" value="context.deviceContainer.getValueByIndex(context.i.toLong())"/>
				<set name="transportid" value="context.switchdevice.getValue('transportid')"/>
				<if cond="context.switchdevice!=null">
					<then>
						<function>
							<websocket name="restfulserver" method="SendText" transportid="event.getParam('transportid').toString()">
								<jsonbody>
									<![CDATA[
										{
											"event":"addDevice",
											"payload":
											{
												"id":"of:<%=context.switchdevice.getValue('datapathid').toString()%>",
												"type":"switch",
												"online":true,
												"master":"<%=context.switchdevice.getValue('datapathid').toString()%>",
												"labels":
													[
													"","of:<%=context.switchdevice.getValue('datapathid')%>",
													"of:<%=context.switchdevice.getValue('datapathid')%>"
													],
												"props":
													{
														"managementAddress":"<%=context.switchdevice.getValue('localipaddr').toString()%>",
														"protocol":"OF_13",
														"channelId":"<%=context.switchdevice.getValue('peeripaddr').toString()%>"
													},
												"metaUi":
												{
													"equivLoc":
														{
														"lng":-98.18860657853635,
														"lat":43.492555430485986
														}
												}
											}
										}	
									]]>
								</jsonbody>
							</websocket>
						</function>
					</then>
				</if>
			</function>
		</for>
	</function>

	<function name="ShowSummary">
		<variable name="sendstrjson" type="string"/>
		<function>
			<websocket name="restfulserver" method="SendText" transportid="event.getParam('transportid').toString()">
				<jsonbody>
				<![CDATA[
						{
						"event":"showSummary",
						"payload":
						{"title":"ONOS Summary",
						"type":"node",
						"id":null,
						"propOrder":
						["Version",
						"-",
						"Devices",
						"Links",
						"Hosts",
						"Topology SCCs",
						"-",
						"Intents",
						"Tunnels",
						"Flows"
						],
						"props":
						{
						"Version":"1.10.0",
						"-":"",
						"Devices":"<%=context.deviceContainer.size()%>",
						"Links":"0",
						"Hosts":"0",
						"Topology SCCs":"1",
						"Intents":"0",
						"Tunnels":"0",
						"Flows":"12"},
						"buttons":[]}}
					]]>
				</jsonbody>
			</websocket>
		</function>
	</function>
	<function name="topoStartDone">
		<variable name="sendstrjson" type="string"/>
		<function>
			<websocket name="restfulserver" method="SendText" transportid="event.getParam('transportid').toString()">
				<jsonbody>
				<![CDATA[
					{"event":"topoStartDone","payload":{}}
					]]>
				</jsonbody>
			</websocket>
		</function>
	</function>
</starosxml>