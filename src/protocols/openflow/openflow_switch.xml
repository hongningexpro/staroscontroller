<?xml version="1.0" encoding="UTF-8"?>
<starlang xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
<!--
	Author:
			YY
	Date:
			2017-07-28
	Copyright: 
			Nanjing StarOS Inc. All rights reserved.
-->
	<function name="SendOpenFlowFeatures">
		<log>SendOpenFlowFeatures</log>
		
		<string name="mfrdesc"/>
		<string name="swdesc"/>
		<string name="serialnum"/>
		<string name="dpdesc"/>
		<string name="hwdesc"/>
		<string name="transportid"/>
		<string name="localipaddr"/>
		<string name="peeripaddr"/>
		<string name="masterid"/>
		<string name="type"/>
		<string name="online"/>
		<string name="protocol"/>
		<string name="auxiliaryid"/>
		<string name="buffers"/>
		<string name="capabilities"/>
		<string name="datapathid"/>
		<string name="tables"/>
		<long name="xid"/>
		<object name="openflowdevice"/>
		<set name="openflowdevice" value="context.openflowserverobj.getValue().getDevice(event.getParam('transportid').toString())"/>
		<set name="localipaddr" value="context.openflowdevice.ptr.getParam('localipaddr').toString()"/>
		<set name="peeripaddr" value="context.openflowdevice.ptr.getParam('peeripaddr').toString()"/>
		<set name="masterid" value="context.openflowdevice.ptr.getParam('masterid').toString()"/>
		<set name="xid" value="context.openflowserverobj.ptr.getIncreaseXID()"/>
		<log><![CDATA[OpenFlowEcho xid=<%=context.xid.toLong()%>]]></log>
		<string name="jsonvariable"/>
		<reference variable="jsonvariable">
			<jsonbody><![CDATA[ 
					{
						"xid":"<%=context.xid.toLong()%>"
					}
			]]></jsonbody>
		</reference>
		<function name="Send_OFPT13_FEATURES_REQUEST">
			<parameters>
				<string name="transportid" in="event.getParam('transportid').toString()"/>
				<string name="strjson" in="context.jsonvariable.toString()"/>
			</parameters>
		</function>	
		<wait event="openflow.OFPT13_FEATURES_REPLY" transportid="event.getParam('transportid').toString()" xid="context.xid.toLong()">
			<function>
				
				<log><![CDATA[Recieve Features Reply:=<%=event.getParam('eventdata').toString()%>]]></log>
				
				<script>
					<![CDATA[
							var info = JSON.parse(event.getParam('eventdata').toString());
							context.auxiliaryid.setValue(info.auxiliaryid);
							context.buffers.setValue(info.buffers);
							context.capabilities.setValue(info.capabilities);
							context.datapathid.setValue(info.datapathid);
							context.tables.setValue(info.tables);
							context.transportid.setValue(event.getParam('transportid').toString());
					]]>
				</script>				
				
			</function>
		</wait>
		
		
		<string name="desc"/>
		<reference variable="desc">
			<jsonbody><![CDATA[ 
					{
						"xid":"<%=context.xid.toLong()%>"
					}
			]]></jsonbody>
		</reference>
		<function name="Send_OFPT13_MULTIPART_REQUEST.OFP13MP_DESC">
			<parameters>
				<string name="transportid" in="event.getParam('transportid').toString()"/>
				<string name="strjson" in="context.desc.toString()"/>
			</parameters>
		</function>
		<wait event="openflow.OFPT13_MULTIPART_REPLY.OFP13MP_DESC" transportid="event.getParam('transportid').toString()" xid="context.xid.toLong()">
			<function>				
				<script>
					<![CDATA[
							var info = JSON.parse(event.getParam('eventdata').toString());
							context.mfrdesc.setValue(info.mfrdesc);
							context.swdesc.setValue(info.swdesc);	
							context.serialnum.setValue(info.serialnum);	
							context.dpdesc.setValue(info.dpdesc);	
							context.hwdesc.setValue(info.hwdesc);								
					]]>
				</script>
				
			</function>
		</wait>
		
		<function name="addDevice" class="DeviceManager">
			<parameters>
				<string name="mfrdesc" in="context.mfrdesc.toString()"/>
				<string name="swdesc" in="context.swdesc.toString()"/>
				<string name="serialnum" in="context.serialnum.toString()"/>
				<string name="dpdesc" in="context.dpdesc.toString()"/>
				<string name="hwdesc" in="context.hwdesc.toString()"/>
				<string name="transportid" in="context.transportid.toString()"/>
				<string name="datapathid" in="context.datapathid.toString()"/>
				<string name="localipaddr" in="context.localipaddr.toString()"/>
				<string name="peeripaddr" in="context.peeripaddr.toString()"/>
				<string name="masterid" in="context.masterid.toString()"/>	
				<string name="type" in="'switch'"/>
				<string name="online" in="'true'"/>
				<string name="protocol" in="'OF_13'"/>					
			</parameters>
		</function>
		
		<!--qiulei 20170807 -->
		
		<log>执行InstallDefaultFlow 2017.8.07</log>
		<!--function name="InstallDefaultFlow">
			<parameters>
				<string name="datapathid" in="context.datapathid.toString()"/>
			</parameters>
		</function-->
		
		<!--qiulei 20170818 pm 发送测试报文 group-->
		<!--function name="testaddgroup" class="GroupManager">
			<parameters>
					<string name="datapathid" in="context.datapathid.toString()"/>
			</parameters>
		</function-->
		<!--function name="testremovegroup" class="GroupManager">	
			<parameters>
				<string name="datapathid" in="context.datapathid.toString()"/>
			</parameters>
		</function-->
		<!--function name="testaddmeter" class="MeterManager">	
			<parameters>
				<string name="datapathid" in="context.datapathid.toString()"/>
			</parameters>
		</function -->
		<!--function name="testremovemeter" class="MeterManager">	
			<parameters>
				<string name="datapathid" in="context.datapathid.toString()"/>
			</parameters>
		</function-->
	
	</function>
	
	<function name="OpenFlowFeatures">
		<function name="SendOpenFlowFeatures"/>	
	</function>
	
</starlang>