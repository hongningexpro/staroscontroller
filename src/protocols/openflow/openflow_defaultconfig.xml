<?xml version="1.0" encoding="UTF-8"?>
<starlang xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
<!--
	Author:
			YY
	Date:
			2017-07-27
	Copyright: 
			Nanjing StarOS Inc. All rights reserved.
-->
	
	<function name="SendOpenFlowConfig">
		<log>SendOpenFlowConfig</log>
		
		<long name="xid"/>
		<string name="msl"/>
		<string name="fflags"/>
		<boolean name="isMax"/>
		
		<set name="xid" value="context.openflowserverobj.ptr.getIncreaseXID()"/>
		
		<!--if cond="context.isMax.toBoolean() == false">
			<then>
				<function>
					<log>is max is false</log>
					<string name="jsonvalue"/>
					<reference variable="jsonvalue">
						<jsonbody><![CDATA[ 
								{
									"flags":"0",
									"misssendlen":"0xffff"
								}
						]]></jsonbody>
					</reference>
					<function name="Send_OFPT13_SET_CONFIG">
						<parameters>
							<string name="transportid" in="event.getParam('transportid').toString()"/>
							<string name="strjson" in="context.jsonvalue.toString()"/>
						</parameters>
					</function>
				</function>
			</then>
		</if-->
		
		<string name="jsonvalue"/>
		<reference variable="jsonvalue">
			<jsonbody><![CDATA[ 
					{
						"xid":"<%=context.xid.toLong()%>",
						"flags":"0",
						"misssendlen":"0xffff"
					}
			]]></jsonbody>
		</reference>
		<function name="Send_OFPT13_SET_CONFIG">
			<parameters>
				<string name="transportid" in="event.getParam('transportid').toString()"/>
				<string name="strjson" in="context.jsonvalue.toString()"/>
			</parameters>
		</function>
	</function>
	<function name="SendGetConfigRequest">
		<long name="xid"/>
		<string name="jsonvariable"/>
		<set name="xid" value="context.openflowserverobj.ptr.getIncreaseXID()"/>
		<reference variable="jsonvariable">
			<jsonbody><![CDATA[ 
					{
						"xid":"<%=context.xid.toLong()%>"
					}
			]]></jsonbody>
		</reference>
		<function name="Send_OFPT13_GET_CONFIG_REQUEST">
			<parameters>
				<string name="transportid" in="event.getParam('transportid').toString()"/>
				<string name="strjson" in="context.jsonvariable.toString()"/>
			</parameters>
		</function>	
		<wait event="openflow.OFPT13_GET_CONFIG_REPLY" transportid="event.getParam('transportid').toString()" xid="context.xid.toLong()">
			<function>
				<script>
					<![CDATA[
							var info = JSON.parse(event.getParam('eventdata').toString());							
							if (info.misssendlen.toString() != 0xffff)
							{								
								context.print("not 0xffff");
							}
							else
							{
								context.print("is 0xffff");
							}
					]]>
				</script>				
								
			</function>
						
		</wait>
	</function>		
	<function name="SendBRRequest">
		<long name="xid"/>
		<string name="jsonvariable"/>
		<set name="xid" value="context.openflowserverobj.ptr.getIncreaseXID()"/>
		<reference variable="jsonvariable">
			<jsonbody><![CDATA[ 
					{
						"xid":"<%=context.xid.toLong()%>"
					}
			]]></jsonbody>
		</reference>
		<function name="Send_OFPT13_BARRIER_REQUEST">
			<parameters>
				<string name="transportid" in="event.getParam('transportid').toString()"/>
				<string name="strjson" in="context.jsonvariable.toString()" />
			</parameters>
		</function>
		<wait event="openflow.OFPT13_BARRIER_REPLY" transportid="event.getParam('transportid').toString()"  xid="context.xid.toLong()" timeout="5000">
				<function>
						<log><![CDATA[event name=<%=event.getName().toString()%>]]></log>
						<log><![CDATA[event data=<%=event.getParam('eventdata').toString()%>]]></log>
				</function>
		</wait>
	</function>
	
	<function name="DefaultConfig">
		<function name="SendOpenFlowConfig"/>
	    <function name="SendBRRequest"/>
		<function name="SendGetConfigRequest"/>
	</function>
	
</starlang>