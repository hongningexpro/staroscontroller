<?xml version="1.0" encoding="UTF-8"?>
<starosxml xmlns="http://www.staros.xyz/starcore/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" scope="application">
<!--
	Author:
			YY
	Date:
			2017-08-28
	Copyright: 
			Nanjing StarOS Inc. All rights reserved.
-->
	<class name="CS2S">
		<private>
			<variable name="m_srcdpid" type="string"/>
			<variable name="m_srcport" type="string"/>
			<variable name="m_dstdpid" type="string"/>
			<variable name="m_dstport" type="string"/>
		</private>
		<public>
			<function name="CS2S">
				<parameters>
					<parameter name="srcdpid" type="string"/>
					<parameter name="srcport" type="string"/>
					<parameter name="dstdpid" type="string"/>
					<parameter name="dstport" type="string"/>
				</parameters>		
				<set name="thisclass.m_srcdpid" value="context.srcdpid.toString()"/>				
				<set name="thisclass.m_srcport" value="context.srcport.toString()"/>				
				<set name="thisclass.m_dstdpid" value="context.dstdpid.toString()"/>				
				<set name="thisclass.m_dstport" value="context.dstport.toString()"/>				
			</function>
			<function name="toString">
				<parameters>
					<parameter name="str" type="string"/>
				</parameters>
				<set name="str" value="'of:'+thisclass.m_srcdpid.toString()+'/'+thisclass.m_srcport.toString()+'-of:'+thisclass.m_dstdpid.toString()+'/'+thisclass.m_dstport.toString()"/>
			</function>
		</public>
	</class>
	<class name="CTopology">
		<private>
			<variable name="appid" type="string"/>
			<variable name="add_eventname" type="string"/>	
			<variable name="remove_eventname" type="string"/>				
		</private>
		<public>
			<function name="CTopology">
				<parameters>
					<parameter name="appid" type="string"/>
					<parameter name="add_eventname" type="string"/>
					<parameter name="remove_eventname" type="string"/>
				</parameters>
				<set name="thisclass.appid" value="context.appid.toString()"/>
				<set name="thisclass.add_eventname" value="context.add_eventname.toString()"/>
				<set name="thisclass.remove_eventname" value="context.remove_eventname.toString()"/>
			</function>
			<function name="GetAddEventName">
				<parameters>
					<parameter name="event_name" type="string"/>
				</parameters>
				<set name="event_name" value="thisclass.add_eventname.toString()"/>
			</function>
			<function name="GetRemoveEventName">
				<parameters>
					<parameter name="event_name" type="string"/>
				</parameters>
				<set name="event_name" value="thisclass.remove_eventname.toString()"/>
			</function>
		</public>
	</class>
	<class name="CTopoService">		
		<private>
			<container name="TopoContainer" type="hashmap" keytype="string" valuetype="class"/>
		<container name="portlist" type="list" valuetype="class"/>
		</private>
		<public>
		
			<function name="addTopoListener">				
				<parameters>
					<parameter name="appid" type="string"/>
					<parameter name="add_eventname" type="string"/>
					<parameter name="remove_eventname" type="string"/>
				</parameters>				
				<if cond="context.TopoContainer.hasValue(context.appid.toString())==false">
					<then>
						<variable name="topoobj" type="class"/>
						<new name="topoobj" class="CTopology">
							<parameters>
								<parameter name="appid" type="string" in="context.appid.toString()"/>
								<parameter name="add_eventname" type="string" in="context.add_eventname.toString()"/>
								<parameter name="remove_eventname" type="string" in="context.remove_eventname.toString()"/>
							</parameters>
						</new>
						<insert name="TopoContainer" key="context.appid.toString()" value="context.topoobj"/>						
					</then>
				</if>
			</function>
			<function name="removeTopoListener">
				<parameters>
					<parameter name="appid" type="string"/>
				</parameters>
				<remove name="TopoContainer" key="context.appid.toString()"/>
			</function>
			<function name="FindTopoListener">
				<parameters>
					<parameter name="appid" type="string"/>
					<parameter name="topoobj" type="class"/>
				</parameters>
				<set name="topoobj" value="thisclass.TopoContainer.getValue(context.appid.toString())"/>
			</function>
			
			<function name="ProcessAddTopoEvent">
				<parameters>
					<parameter name="fromdevice" type="string"/>
					<parameter name="todevice" type="string"/>
					<parameter name="path" type="string"/>
				</parameters>				
				<variable name="id" type="string"/>
				<variable name="data" type="class"/>
				<variable name="eventparam" type="params"/>
				<variable name="m_bundleid" type="long"/>
				<variable name="eventname" type="string"/>
				<for var="i" from="0" to="context.TopoContainer.size()-1">
					<set name="id" value="context.TopoContainer.getKeyByIndex(context.i.toLong())"/>
					<set name="data" value="context.TopoContainer.getValueByIndex(context.i.toLong())"/>
					<function name="GetBundleID" class="ApplicationManager">
						<parameters>
							<parameter name="appid" type="string" in="context.id.toString()"/>
							<parameter name="bundleid" type="long" out="context.m_bundleid"/>
						</parameters>
					</function>
					<function name="GetAddEventName" class="context.data">
						<parameters>
							<parameter name="event_name" type="string" out="context.eventname"/>
						</parameters>						
					</function>
					<set name="eventparam" paramname="fromdevice" value="context.fromdevice.toString()" reset="true"/>
					<set name="eventparam" paramname="todevice" value="context.todevice.toString()"/>
					<set name="eventparam" paramname="path" value="context.path.toString()"/>
					<raise name="context.eventname.toString()" bundleid="context.m_bundleid.toLong()" param="context.eventparam"/>
				</for>
			</function>
			
			<function name="ProcessRemoveTopoEvent">
				<parameters>
					<parameter name="fromdevice" type="string"/>
					<parameter name="todevice" type="string"/>
					<parameter name="path" type="string"/>
				</parameters>
				<variable name="id" type="string"/>
				<variable name="data" type="class"/>
				<variable name="eventparam" type="params"/>
				<variable name="m_bundleid" type="long"/>
				<variable name="eventname" type="string"/>
				<for var="i" from="0" to="context.TopoContainer.size()-1">
					<set name="id" value="context.TopoContainer.getKeyByIndex(context.i.toLong())"/>
					<set name="data" value="context.TopoContainer.getValueByIndex(context.i.toLong())"/>
					<function name="GetBundleID" class="ApplicationManager">
						<parameters>
							<parameter name="appid" type="string" in="context.id.toString()"/>
							<parameter name="bundleid" type="long" out="context.m_bundleid"/>
						</parameters>
					</function>
					<function name="GetRemoveEventName" class="context.data">
						<parameters>
							<parameter name="event_name" type="string" out="context.eventname"/>
						</parameters>						
					</function>
					<set name="eventparam" paramname="fromdevice" value="context.fromdevice.toString()" reset="true"/>
					<set name="eventparam" paramname="todevice" value="context.todevice.toString()"/>
					<set name="eventparam" paramname="path" value="context.path.toString()"/>
					<raise name="context.eventname.toString()" bundleid="context.m_bundleid.toLong()" param="context.eventparam"/>
				</for>
			</function>
					
			
			<function name="getShortestPath">
				<parameters>
					<parameter name="link" type="string"/>
					<parameter name="outjson" type="string"/>
				</parameters>
				<variable name="srcdatapathid" type="string"/>
				<variable name="srcport" type="string"/>
				<variable name="dstdatapathid" type="string"/>
				<variable name="dstport" type="string"/>
				<script><![CDATA[
					if (context.link.toString().length>0)
					{
						var info = JSON.parse(context.link.toString());
						if (info.paths.length == 1)
						{
							context.srcdatapathid.setValue(info.paths[0].src.dpid);
							context.srcport.setValue(info.paths[0].src.port);
							context.dstdatapathid.setValue(info.paths[0].dst.dpid);
							context.dstport.setValue(info.paths[0].dst.port);
						}					
					}
				]]></script>
				<variable name="s2s" type="class"/>
				<new name="s2s" class="CS2S">
					<parameters>
						<parameter name="srcdpid" type="string" in="context.srcdatapathid.toString()"/>
						<parameter name="srcport" type="string" in="context.srcport.toString()"/>
						<parameter name="dstdpid" type="string" in="context.dstdatapathid.toString()"/>
						<parameter name="dstport" type="string" in="context.dstport.toString()"/>
					</parameters>
				</new>
				<variable name="str" type="string"/>
				<if cond="context.s2s==null">
					<then>
						<log>s2s is null</log>
					</then>
					<else>						
						<function name="toString" class="s2s">
							<parameters>
								<parameter name="str" type="string" out="context.str"/>
							</parameters>
						</function>						
						<set name="outjson" value="context.str.toString()"/>
						<insert name="context.portlist" value="context.s2s"/>
						<log>#########################################</log>
						<log><![CDATA[context.portlist.size() = <%=context.portlist.size()%>]]></log>
					</else>
				</if>
			</function>
		</public>
	</class>
</starosxml>